SET ANSI_NULLS OFF;
GO
SET QUOTED_IDENTIFIER OFF;
GO
/*************************************************************************/  
/* Stored Procedure: ispCBORDBTH01                                       */  
/* Creation Date: 07-Aug-2020                                            */  
/* Copyright: LFL                                                        */  
/* Written by: WLChooi                                                   */  
/*                                                                       */  
/* Purpose: WMS-14579 - Combine Order Consigneekey + Userdefine04        */  
/*                                                                       */  
/* Called By: isp_CombineOrderByMultiBatchSP_Wrapper                     */  
/*                                                                       */  
/* GitLab Version: 1.1                                                   */  
/*                                                                       */  
/* Version: 5.4                                                          */  
/*                                                                       */  
/* Data Modifications:                                                   */  
/*                                                                       */  
/* Updates:                                                              */  
/* Date         Author   Ver  Purposes                                   */  
/* 2020-09-14   WLChooi  1.1  Bug Fix - Change to BIGINT (WL01)          */
/*************************************************************************/   
CREATE PROCEDURE [dbo].[ispCBORDBTH01]  
      @c_OrderList          NVARCHAR(MAX) 
   ,  @b_Success            INT OUTPUT    
   ,  @n_Err                INT OUTPUT
   ,  @c_Errmsg             NVARCHAR(255) OUTPUT
   ,  @c_FromOrderkeyList   NVARCHAR(MAX) OUTPUT

AS  
BEGIN  
   SET NOCOUNT ON   
   SET QUOTED_IDENTIFIER OFF   
   SET ANSI_NULLS OFF   
   SET CONCAT_NULL_YIELDS_NULL OFF  
   
   DECLARE @c_SPCode            NVARCHAR(50)
         , @c_SQL               NVARCHAR(MAX)
         , @c_authority         NVARCHAR(10) 
         , @b_debug             INT = 0

         , @d_Trace_StartTime   DATETIME
         , @d_Trace_EndTime     DATETIME
         , @c_UserName          NVARCHAR(100)

         , @n_Continue          INT = 1
         , @n_starttcnt         INT

         , @c_MinBuyerPO        NVARCHAR(20)
         , @c_Consigneekey      NVARCHAR(15)
         , @c_UserDefine05      NVARCHAR(20)
         , @c_FromOrderkey      NVARCHAR(10)
         , @c_ToOrderkey        NVARCHAR(10)
         , @c_facility          NVARCHAR(10)
         , @c_StorerKey         NVARCHAR(15)
         , @c_OrderkeyList      NVARCHAR(MAX)
         , @n_CheckBuyerPO      INT

   SET @n_err        = 0
   SET @b_Success    = 1
   SET @c_errmsg     = ''

   SET @n_Continue   = 1
   SET @c_SPCode     = ''
   SET @c_StorerKey  = ''
   SET @c_SQL        = ''

   SET @c_FromOrderkeyList = ''

   SELECT @n_starttcnt  = @@TRANCOUNT

   SET @d_Trace_StartTime = GETDATE()

   --set @c_FromOrderkeyList = '0000007383,0000007382,0000007381,0000007380,0000007379,0000007378,0000007377,0000007376,0000007375,0000007374,0000007373,0000007372,0000007371,0000007370,0000007369,0000007368,0000007367,0000007366,0000007365,0000007364,0000007363,0000007362,0000007361,0000007360,0000007359,0000007358,0000007357,0000007356,0000007355,0000007354,0000007353,0000007352,0000007351,0000007350,0000007349,0000007348,0000007347,0000007346,0000007345,0000007344,0000007343,0000007342,0000007341,0000007340,0000007339,0000007338,0000007337,0000007336,0000007335,0000007334,0000007333,0000007332,0000007331,0000007330,0000007329,0000007328,0000007327,0000007326,0000007325,0000007324,0000007323,0000007322,0000007321,0000007320,0000007319,0000007318,0000007317,0000007316,0000007315,0000007314,0000007313,0000007312,0000007311,0000007310,0000007309,0000007308,0000007307,0000007306,0000007305,0000007304,0000007303,0000007302,0000007301,0000007300,0000007299,0000007298,0000007297,0000007296,0000007295,0000007294,0000007293,0000007292,0000007291,0000007290,0000007289,0000007288,0000007287,0000007286,0000007285,0000007284,0000007283,0000007282,0000007281,0000007280,0000007279,0000007278,0000007277,0000007276,0000007275,0000007274,0000007273,0000007272,0000007271,0000007270,0000007269,0000007268,0000007267,0000007266,0000007265,0000007264,0000007263,0000007262,0000007261,0000007260,0000007259,0000007258,0000007257,0000007256,0000007255,0000007254,0000007253,0000007252,0000007251,0000007250,0000007249,0000007248,0000007247,0000007246,0000007245,0000007244,0000007243,0000007242,0000007241,0000007240,0000007239,0000007238,0000007237,0000007236,0000007235,0000007234,0000007233,0000007232,0000007231,0000007230,0000007229,0000007228,0000007227,0000007226,0000007225,0000007224,0000007223,0000007222,0000007221,0000007220,0000007219,0000007218,0000007217,0000007216,0000007215,0000007214,0000007213,0000007212,0000007211,0000007210,0000007209,0000007208,0000007207,0000007206,0000007205,0000007204,0000007203,0000007202,0000007201,0000007200,0000007199,0000007198,0000007197,0000007196,0000007195,0000007194,0000007193,0000007192,0000007191,0000007190,0000007189,0000007188,0000007187,0000007186,0000007185,0000007184,0000007183,0000007182,0000007181,0000007180,0000007179,0000007178,0000007177,0000007176,0000007175,0000007174,0000007173,0000007172,0000007171,0000007170,0000007169,0000007168,0000007167,0000007166,0000007165,0000007164,0000007163,0000007162,0000007161,0000007160,0000007159,0000007158,0000007157,0000007156,0000007155,0000007154,0000007153,0000007152,0000007151,0000007150,0000007149,0000007148,0000007147,0000007146,0000007145,0000007144,0000007143,0000007142,0000007141,0000007140,0000007139,0000007138,0000007137,0000007136,0000007135,0000007134,0000007133,0000007132,0000007131,0000007130,0000007129,0000007128,0000007127,0000007126,0000007125,0000007124,0000007123,0000007122,0000007121,0000007120,0000007119,0000007118,0000007117,0000007116,0000007115,0000007114,0000007113,0000007112,0000007111,0000007110,0000007109,0000007108,0000007107,0000007106,0000007105,0000007104,0000007103,0000007102,0000007101,0000007100,0000007099,0000007098,0000007097,0000007096,0000007095,0000007094,0000007093,0000007092,0000007091,0000007090,0000007089,0000007088,0000007087,0000007086,0000007085,0000007084,0000007083,0000007082,0000007081,0000007080,0000007079,0000007078,0000007077,0000007076,0000007075,0000007074,0000007073,0000007072,0000007071,0000007070,0000007069,0000007068,0000007067,0000007066,0000007065,0000007064,0000007063,0000007062,0000007061,0000007060,0000007059,0000007058,0000007057,0000007056,0000007055,0000007054,0000007053,0000007052,0000007051,0000007050,0000007049,0000007048,0000007047,0000007046,0000007045,0000007044,0000007043,0000007042,0000007041,0000007040,0000007039,0000007038,0000007037,0000007036,0000007035,0000007034,0000007033,0000007032,0000007031,0000007030,0000007029,0000007028,0000007027,0000007026,0000007025,0000007024,0000007023,0000007022,0000007021,0000007020,0000007019,0000007018,0000007017,0000007016,0000007015,0000007014,0000007013,0000007012,0000007011,0000007010,0000007009,0000007008,0000007007,0000007006,0000007005,0000007004,0000007003,0000007002,0000007001,0000007000,0000006999,0000006998,0000006997,0000006996,0000006995,0000006994,0000006993,0000006992,0000006991,0000006990,0000006989,0000006988,0000006987,0000006986,0000006985,0000006984,0000006983,0000006982,0000006981,0000006980,0000006979,0000006978,0000006977,0000006976,0000006975,0000006974,0000006973,0000006972,0000006971,0000006970,0000006969,0000006968,0000006967,0000006966,0000006965,0000006964,0000006963,0000006962,0000006961,0000006960,0000006959,0000006958,0000006957,0000006956,0000006955,0000006954,0000006953,0000006952,0000006951,0000006950,0000006949,0000006948,0000006947,0000006946,0000006945,0000006944,0000006943,0000006942,0000006941,0000006940,0000006939,0000006938,0000006937,0000006936,0000006935,0000006934,0000006933,0000006932,0000006931,0000006930,0000006929,0000006928,0000006927,0000006926,0000006925,0000006924,0000006923,0000006922,0000006921,0000006920,0000006919,0000006918,0000006917,0000006916,0000006915,0000006914,0000006913,0000006912,0000006911,0000006910,0000006909,0000006908,0000006907,0000006906,0000006905,0000006904,0000006903,0000006902,0000006901,0000006900,0000006899,0000006898,0000006897,0000006896,0000006895,0000006894,0000006893,0000006892,0000006891,0000006890,0000006889,0000006888,0000006887,0000006886,0000006885,0000006884,0000006883,0000006882,0000006881,0000006880,0000006879,0000006878,0000006877,0000006876,0000006875,0000006874,0000006873,0000006872,0000006871,0000006870,0000006869,0000006868,0000006867,0000006866,0000006865,0000006864,0000006863,0000006862,0000006861,0000006860,0000006859,0000006858,0000006857,0000006856,0000006855,0000006854,0000006853,0000006852,0000006851,0000006850,0000006849,0000006848,0000006847,0000006846,0000006845,0000006844,0000006843,0000006842,0000006841,0000006840,0000006839,0000006838,0000006837,0000006836,0000006835,0000006834,0000006833,0000006832,0000006831,0000006830,0000006829,0000006828,0000006827,0000006826,0000006825,0000006824,0000006823,0000006822,0000006821,0000006820,0000006819,0000006818,0000006817,0000006816,0000006815,0000006814,0000006813,0000006812,0000006811,0000006810,0000006809,0000006808,0000006807,0000006806,0000006805,0000006804,0000006803,0000006802,0000006801,0000006800,0000006799,0000006798,0000006797,0000006796,0000006795,0000006794,0000006793,0000006792,0000006791,0000006790,0000006789,0000006788,0000006787,0000006786,0000006785,0000006784,0000006783,0000006782,0000006781,0000006780,0000006779,0000006778,0000006777,0000006776,0000006775,0000006774,0000006773,0000006772,0000006771,0000006770,0000006769,0000006768,0000006767,0000006766,0000006765,0000006764,0000006763,0000006762,0000006761,0000006760,0000006759,0000006758,0000006757,0000006756,0000006755,0000006754,0000006753,0000006752,0000006751,0000006750,0000006749,0000006748,0000006747,0000006746,0000006745,0000006744,0000006743,0000006742,0000006741,0000006740,0000006739,0000006738,0000006737,0000006736,0000006735,0000006734,0000006733,0000006732,0000006731,0000006730,0000006729,0000006728,0000006727,0000006726,0000006725,0000006724,0000006723,0000006722,0000006721,0000006720,0000006719,0000006718,0000006717,0000006716,0000006715,0000006714,0000006713,0000006712,0000006711,0000006710,0000006709,0000006708,0000006707,0000006706,0000006705,0000006704,0000006703,0000006702,0000006701,0000006700,0000006699,0000006698,0000006697,0000006696,0000006695,0000006694,0000006693,0000006692,0000006691,0000006690,0000006689,0000006688,0000006687,0000006686,0000006685,0000006684,0000006683,0000006682,0000006681,0000006680,0000006679,0000006678,0000006677,0000006676,0000006675,0000006674,0000006673,0000006672,0000006671,0000006670,0000006669,0000006668,0000006667,0000006666,0000006665,0000006664,0000006663,0000006662,0000006661,0000006660,0000006659,0000006658,0000006657,0000006656,0000006655,0000006654,0000006653,0000006652,0000006651,0000006650,0000006649,0000006648,0000006647,0000006646,0000006645,0000006644,0000006643,0000006642,0000006641,0000006640,0000006639,0000006638,0000006637,0000006636,0000006635,0000006634,0000006633,0000006632,0000006631,0000006630,0000006629,0000006628,0000006627,0000006626,0000006625,0000006624,0000006623,0000006622,0000006621,0000006620,0000006619,0000006618,0000006617,0000006616,0000006615,0000006614,0000006613,0000006612,0000006611,0000006610,0000006609,0000006608,0000006607,0000006606,0000006605,0000006604,0000006603,0000006602,0000006601,0000006600,0000006599,0000006598,0000006597,0000006596,0000006595,0000006594,0000006593,0000006592,0000006591,0000006590,0000006589,0000006588,0000006587,0000006586,0000006585,0000006584,0000006583,0000006582,0000006581,0000006580,0000006579,0000006578,0000006577,0000006576,0000006575,0000006574,0000006573,0000006572,0000006571,0000006570,0000006569,0000006568,0000006567,0000006566,0000006565,0000006564,0000006563,0000006562,0000006561,0000006560,0000006559,0000006558,0000006557,0000006556,0000006555,0000006554,0000006553,0000006552,0000006551,0000006550,0000006549,0000006548,0000006547,0000006546,0000006545,0000006544,0000006543,0000006542,0000006541,0000006540,0000006539,0000006538,0000006537,0000006536,0000006535,0000006534,0000006533,0000006532,0000006531,0000006530,0000006529,0000006528,0000006527,0000006526,0000006525,0000006524,0000006523,0000006522,0000006521,0000006520,0000006519,0000006518,0000006517,0000006516,0000006515,0000006514,0000006513,0000006512,0000006511,0000006510,0000006509,0000006508,0000006507,0000006506,0000006505,0000006504,0000006503,0000006502,0000006501,0000006500,0000006499,0000006498,0000006497,0000006496,0000006495,0000006494,0000006493,0000006492,0000006491,0000006490,0000006489,0000006488,0000006487,0000006486,0000006485,0000006484,0000006483,0000006482,0000006481,0000006480,0000006479,0000006478,0000006477,0000006476,0000006475,0000006474,0000006473,0000006472,0000006471,0000006470,0000006469,0000006468,0000006467,0000006466,0000006465,0000006464,0000006463,0000006462,0000006461,0000006460,0000006459,0000006458,0000006457,0000006456,0000006455,0000006454,0000006453,0000006452,0000006451,0000006450,0000006449,0000006448,0000006447,0000006446,0000006445,0000006444,0000006443,0000006442,0000006441,0000006440,0000006439,0000006438,0000006437,0000006436,0000006435,0000006434,0000006433,0000006432,0000006431,0000006430,0000006429,0000006428,0000006427,0000006426,0000006425,0000006424,0000006423,0000006422,0000006421,0000006420,0000006419,0000006418,0000006417,0000006416,0000006415,0000006414,0000006413,0000006412,0000006411,0000006410,0000006409,0000006408,0000006407,0000006406,0000006405,0000006404,0000006403,0000006402,0000006401,0000006400,0000006399,0000006398,0000006397,0000006396,0000006395,0000006394,0000006393,0000006392,0000006391,0000006390,0000006389,0000006388,0000006387,0000006386,0000006385,0000006384' 
   --GOTO QUIT_SP

   --Check if Buyerpo is numerical number, if yes, need to sort by CAST(BuyerPO AS INT), if not below situation will happpen:
   --Given BuyerPO 123, 1000
   --MIN(CAST(BuyerPO AS INT)) will be 123
   --MIN(BuyerPO) will be 1000 -- which is wrong

   SET @n_CheckBuyerPO = 0

   SELECT TOP 1 @n_CheckBuyerPO = ISNUMERIC(BuyerPO)
   FROM ORDERS ORD (NOLOCK)
   WHERE ORD.Orderkey IN (SELECT DISTINCT ColValue 
                       FROM fnc_DelimSplit(',',@c_OrderList)) 
   AND ISNUMERIC(BuyerPO) = 0

   CREATE TABLE #TMP_Orders (
      MinBuyerPO      NVARCHAR(20),
      ConsigneeKey    NVARCHAR(15),
      UserDefine05    NVARCHAR(20),
      ToOrderkey      NVARCHAR(10),
      OrderkeyList    NVARCHAR(MAX)
   )

   --Group the orders with consigneekey + userdefine05
   IF @n_CheckBuyerPO = 1 --Do not convert to INT
   BEGIN
      INSERT INTO #TMP_Orders (MinBuyerPO, ConsigneeKey, UserDefine05, ToOrderkey, OrderkeyList)
      SELECT MIN(ORD.BuyerPO) AS MinBuyerPO, ORD.Consigneekey, ORD.UserDefine05
         , (SELECT MAX(Orderkey) FROM ORDERS (NOLOCK) 
            WHERE Orderkey IN (SELECT DISTINCT ColValue 
                               FROM fnc_DelimSplit(',',@c_OrderList)) 
            AND BuyerPO = MIN(ORD.BuyerPO) 
            AND ConsigneeKey = ORD.ConsigneeKey) AS ToOrderkey
         , (STUFF((SELECT ',' + RTRIM(Orderkey) 
                   FROM ORDERS (NOLOCK) WHERE Orderkey IN (SELECT DISTINCT ColValue 
                                                           FROM fnc_DelimSplit(',',@c_OrderList)) 
                                          AND ConsigneeKey = ORD.ConsigneeKey
                                          AND UserDefine05 = ORD.UserDefine05
                   ORDER BY Orderkey FOR XML PATH('')),1,1,'' )) AS OrderKeyList
      FROM ORDERS ORD (NOLOCK)
      WHERE ORD.Orderkey IN (SELECT DISTINCT ColValue 
                             FROM fnc_DelimSplit(',',@c_OrderList))  
      GROUP BY ORD.Consigneekey, ORD.UserDefine05
   END
   ELSE
   BEGIN
      INSERT INTO #TMP_Orders (MinBuyerPO, ConsigneeKey, UserDefine05, ToOrderkey, OrderkeyList)
      SELECT MIN(CAST(ORD.BuyerPO AS BIGINT)) AS MinBuyerPO, ORD.Consigneekey, ORD.UserDefine05   --WL01
         , (SELECT MAX(Orderkey) FROM ORDERS (NOLOCK) 
            WHERE Orderkey IN (SELECT DISTINCT ColValue 
                               FROM fnc_DelimSplit(',',@c_OrderList)) 
            AND BuyerPO = MIN(CAST(ORD.BuyerPO AS BIGINT))   --WL01
            AND ConsigneeKey = ORD.ConsigneeKey) AS ToOrderkey
         , (STUFF((SELECT ',' + RTRIM(Orderkey) 
                   FROM ORDERS (NOLOCK) WHERE Orderkey IN (SELECT DISTINCT ColValue 
                                                           FROM fnc_DelimSplit(',',@c_OrderList)) 
                                          AND ConsigneeKey = ORD.ConsigneeKey
                                          AND UserDefine05 = ORD.UserDefine05
                   ORDER BY Orderkey FOR XML PATH('')),1,1,'' )) AS OrderKeyList
      FROM ORDERS ORD (NOLOCK)
      WHERE ORD.Orderkey IN (SELECT DISTINCT ColValue 
                             FROM fnc_DelimSplit(',',@c_OrderList))  
      GROUP BY ORD.Consigneekey, ORD.UserDefine05
   END

   --select * from #TMP_Orders

   DECLARE CUR_LOOP CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
   SELECT DISTINCT MinBuyerPO, ConsigneeKey, UserDefine05, ToOrderkey, OrderkeyList
   FROM #TMP_Orders

   OPEN CUR_LOOP

   FETCH NEXT FROM CUR_LOOP INTO @c_MinBuyerPO, @c_Consigneekey, @c_UserDefine05, @c_ToOrderkey, @c_OrderkeyList

   WHILE @@FETCH_STATUS <> -1
   BEGIN
      EXEC isp_PreCombineOrder_Wrapper
         @c_ToOrderkey = @c_ToOrderkey
       , @c_OrderList  = @c_OrderkeyList
       , @b_Success    = @b_Success OUTPUT
       , @n_Err        = @n_Err     OUTPUT
       , @c_ErrMsg     = @c_ErrMsg  OUTPUT

      IF @b_Success = 0 AND @c_ErrMsg <> ''
      BEGIN
         SET @n_Continue = 3   
         GOTO QUIT_SP
      END
      
      SELECT @c_facility  = Facility
           , @c_StorerKey = Storerkey
      FROM ORDERS (NOLOCK)
      WHERE OrderKey = @c_ToOrderkey

      SELECT @c_SPCode = SValue
      FROM STORERCONFIG WITH (NOLOCK)
      WHERE Storerkey = @c_StorerKey
      AND Configkey = 'CombineOrderSP'   --'CombineOrderByMultiBatchSP'
      AND (Facility = @c_facility OR ISNULL(RTRIM(Facility),'') = '')
      ORDER BY CASE WHEN Facility = '' THEN 2 ELSE 1 END

      IF NOT EXISTS (SELECT 1 FROM dbo.sysobjects WITH (NOLOCK) WHERE name = RTRIM(@c_SPCode) AND type = 'P')
      BEGIN
         SET @n_Continue = 3  
         SET @n_Err = 62205
         SELECT @c_ErrMsg = 'NSQL' + CONVERT(NVARCHAR(5), @n_Err)  
                          + ': Storerconfig CombineOrderSP - Stored Proc name invalid ('+RTRIM(ISNULL(@c_SPCode,''))
                          + '). (iispCBORDBTH01)'  
         GOTO QUIT_SP
      END

      DECLARE CUR_FromOrderkey CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
      SELECT DISTINCT ColValue 
      FROM fnc_DelimSplit(',',@c_OrderkeyList)

      OPEN CUR_FromOrderkey

      FETCH NEXT FROM CUR_FromOrderkey INTO @c_FromOrderkey

      WHILE @@FETCH_STATUS <> -1
      BEGIN
         IF @c_FromOrderkey <> @c_ToOrderkey
         BEGIN
            --SELECT @c_FromOrderkey, @c_ToOrderkey

            SET @c_SQL = 'EXEC ' + @c_SPCode + ' @c_FromOrderkey, @c_ToOrderkey, @b_Success OUTPUT, @n_Err OUTPUT, @c_ErrMsg OUTPUT'

            EXEC sp_executesql @c_SQL 
               ,  N'@c_FromOrderkey NVARCHAR(10), @c_ToOrderkey NVARCHAR(10), @b_Success INT OUTPUT, @n_Err INT OUTPUT, @c_ErrMsg NVARCHAR(255) OUTPUT' 
               ,  @c_FromOrderkey
               ,  @c_ToOrderkey
               ,  @b_Success OUTPUT   
               ,  @n_Err OUTPUT
               ,  @c_ErrMsg OUTPUT

            IF @b_Success = 0 AND @c_ErrMsg <> ''
            BEGIN
               SET @n_Continue = 3   
               GOTO QUIT_SP
            END

            IF @c_FromOrderkeyList = ''
            BEGIN
               SET @c_FromOrderkeyList = @c_FromOrderkey
            END
            ELSE
            BEGIN
               SET @c_FromOrderkeyList = @c_FromOrderkeyList + ',' + @c_FromOrderkey
            END
         END

         FETCH NEXT FROM CUR_FromOrderkey INTO @c_FromOrderkey
      END

      IF CURSOR_STATUS('LOCAL', 'CUR_FromOrderkey') IN (0 , 1)
      BEGIN
         CLOSE CUR_FromOrderkey
         DEALLOCATE CUR_FromOrderkey   
      END

      FETCH NEXT FROM CUR_LOOP INTO @c_MinBuyerPO, @c_Consigneekey, @c_UserDefine05, @c_ToOrderkey, @c_OrderkeyList
   END
QUIT_SP:
   SET @d_Trace_EndTime = GETDATE()
   SET @c_UserName = SUSER_SNAME()

   IF OBJECT_ID('tempdb..#TMP_Orders') IS NOT NULL
      DROP TABLE #TMP_Orders

   IF CURSOR_STATUS('LOCAL', 'CUR_LOOP') IN (0 , 1)
   BEGIN
      CLOSE CUR_LOOP
      DEALLOCATE CUR_LOOP   
   END

   IF @n_continue=3  -- Error Occured - Process And Return  
   BEGIN  
     SELECT @b_success = 0  
     IF @@TRANCOUNT = 1 and @@TRANCOUNT > @n_starttcnt  
     BEGIN  
        ROLLBACK TRAN  
     END  
     ELSE  
     BEGIN  
        WHILE @@TRANCOUNT > @n_starttcnt  
        BEGIN  
           COMMIT TRAN  
        END  
     END  
     execute nsp_logerror @n_err, @c_errmsg, "ispCBORDBTH01"  
     RAISERROR (@c_errmsg, 16, 1) WITH SETERROR    -- SQL2012  
     RETURN  
   END  
   ELSE  
   BEGIN  
     SELECT @b_success = 1  
     WHILE @@TRANCOUNT > @n_starttcnt  
     BEGIN  
        COMMIT TRAN  
     END  
     RETURN  
   END   
END

GO