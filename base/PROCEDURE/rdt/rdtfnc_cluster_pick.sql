SET ANSI_NULLS OFF;
GO
SET QUOTED_IDENTIFIER OFF;
GO

/***************************************************************************/
/* Store procedure: rdtfnc_Cluster_Pick                                    */
/* Copyright      : IDS                                                    */
/* FBR: 116248                                                             */
/* Purpose: COT Cluster Pick                                               */
/*                                                                         */
/* Modifications log:                                                      */
/*                                                                         */
/* Date         Rev  Author     Purposes                                   */
/* 15-Sep-2008  1.0  James      Created                                    */
/* 05-Dec-2008  1.1  Vicky      Add (NOLOCK) to Update statment and        */
/*                              UPPER to ID checking                       */
/* 12-Dec-2008  1.1  Vicky      Add TraceInfo (Vicky02)                    */
/* 03-Feb-2009  1.2  James      SOS127539 - Merged with Pharma             */
/*                              Cluster Pick                               */
/* 19-Mar-2009  1.3  James      SOS131967 - Insert short picked qty        */
/* 23-Apr-2009  1.4  James      SOS133222 - Add STD Short Pick screen      */
/* 19-Jun-2009  1.5  Vicky      Performance Tuning (Vicky03)               */
/* 24-Aug-2009  1.6  James      SOS145455 - Add DropID checking(james01)   */
/* 28-Aug-2009  1.7  Vicky      Add in EventLog (Vicky06)                  */
/* 29-Sep-2009  1.8  James      SOS147577 - TTL O/S Qty failed to show     */
/*                              the total Qty to pick (james02)            */
/* 30-Sep-2009  1.9  James      SOS149089 - Add Close Case scn (james03)   */
/* 14-Oct-2009  1.10 James      Include Mobile when insert into            */
/*                              RDTPicklock (James01)                      */
/* 08-Nov-2009  1.11 James      Add Configkey 'ClusterPickInsPackDt' to    */
/*                              control insertion of PackHeader(James05)   */
/* 11-Nov-2009  1.12 James      SOS152582-Add Generic printing (james04)   */
/* 30-Apr-2010  1.13 James      Add in Conso PS scan in/Out (james06)      */
/* 03-May-2010  1.14 James      SOS170848 - Picking by Conso  (james07)    */
/* 20-May-2010  1.15 James      SOS172041 - L'Oreal enhancement(james08)   */
/*                              1. Change Drop ID flow, add new screen     */
/*                              2. Add Anti-diversion screen               */
/* 07-June-2010 1.16 James      SOS176144 - Change filter of storerkey     */
/*                              to orderdetail (james09)                   */
/* 07-Jun-2010  1.17 Leong      SOS# 173419 - Bug Fix on Drop Id update    */
/* 24-June-2010 1.18 Leong      SOS# 176144 - Bug Fix                      */
/* 07-Jul-2010  1.19 Shong      Update PickingInfo with TrafficCop         */
/* 08-Jul-2010  1.20 Vicky      Fix PickingInfo Update (Vicky07)           */
/* 21-July-2010 1.21 James      Add new Configkey                          */
/*                              'InsDiscretePackHdrInfo' (james10)         */
/* 13-Aug-2010  1.21 ChewKP     Should allow Pick to Different DropID      */
/*                              for same SKU (ChewKP01)                    */
/* 02-Dec-2010  1.22 James      SOS197651 -                                */
/*                              1. Show packey configuration               */
/*                              2. Show error msg in new scn               */
/*                              3. Allow to skip scan SKU (james11)        */
/* 04-Mar-2011  1.23 James      Add decode label (james12)                 */
/* 11-Mar-2011  1.24 James      Bug fix (james13)                          */
/* 15-Mar-2011  1.25 Leong      SOS# 208635 - Bug fix                      */
/* 17-Mar-2011  1.26 James      SOS209194 - Show ttl qty picked/unpick     */
/*                                          on orders (james14)            */
/* 17-Mar-2011  1.26 James      SOS207999 - NIKE Enhancement (james15)     */
/* 19-May-2011  1.27 James      SOS216118 - US Enhancement (james16)       */
/*                              Limit no of orders per user to pick        */
/* 17-Jun-2011  1.27 James      SOS216485 - Check over pick (james17)      */
/*                              Add SHOWQTYPICK/UNPICK on CONSO pick       */
/* 15-Aug-2011  1.27 James      Perfomance tuning (james_tune)             */
/* 14-Dec-2011  1.28 TLTING     Deadlock Tune (TLTING02)                   */
/* 21-Feb-2012  1.29 Leong      SOS# 237003 - Fine tune to allow display   */
/*                                            more than 10 PutAwayZone     */
/* 05-Mar-2012  1.30 Ung        SOS232145 Fix data truncation issue on     */
/*                              RDT.RDTPickLock.OrderLineNumber            */
/* 05-Mar-2012  1.31 Audrey     SOS237778 - Bug fixed            (ang01)   */
/* 09-Apr-2011  1.32 TLTING     Performance Tune (TLTING03)                */
/* 07-May-2012  1.33 James      SOS242497 - Confirm skipped SKU if         */
/*                              config turned on (james18)                 */
/* 12-Dec-2012  1.34 James      SOS263803 - New config key                 */
/*                              CLUSTERPICKCONFIRMLOC (james19)            */
/* 21-Feb-2013  1.35 James      SOS270278 - Use codelkup to determine      */
/*                              whether need capture serial no (james20)   */
/* 25-Feb-2013  1.36 James      SOS269625 - Use rdt config to skip drop    */
/*                              id screen if it is exists (james21)        */
/* 04-Apr-2013  1.37 James      SOS274284 - Bug fix (james22)              */
/* 23-Apr-2013  1.38 James      SOS276154 - Bug fix (james23)              */
/* 30-Apr-2013  1.40 James      SOS276235 - Allow multi storer (james25)   */
/* 22-May-2013  1.41 James      SOS278790 - Bug fix (james26)              */
/* 28-Apr-2013  1.42 James      SOS270278 - Use rdt storerconfig to ctrl   */
/*                              which field store ADCode (james27)         */
/* 19-Jun-2013  1.43 James      Enhance short pick selection (james28)     */
/* 26-Jun-2013  1.45 James      Remove Archivecop and mbol carton count    */
/*                              back to packheader trigger (james29)       */
/* 04-Jul-2013  1.46 Shong      Serial Capture fixes  (Shong01)            */
/* 12-Jul-2013  1.47 James      AEO enhancement (james30)                  */
/* 04-Sep-2013  1.48 James      Bug fix on SKIP task (james31)             */
/* 11-Sep-2013  1.49 James      Consolidate ver from HK & TH (james32)     */
/* 22-Oct-2013  1.50 James      SOS291607 - Scan Lot02 & enable case       */
/*                              & piece qty (james32)                      */
/* 03-Dec-2013  1.51 James      SOS295906-Enhance UOM display (james33)    */
/* 27-Dec-2013  1.52 James      SOS294366 - Add msg queue after picking    */
/*                              completed (james34)                        */
/* 23-Jan-2014  1.53 James      SOS297732 - Add new print type (james35)   */
/* 11-Feb-2014  1.54 James      SOS302650 - Bug fix (james35)              */
/* 13-Feb-2014  1.55 James      SOS303010 - Add config to control short    */
/*                              pick and display msg when picking not      */
/*                              complete (james36)                         */
/* 05-Mar-2014  1.56 James      SOS304794 - Bug fix (james37)              */
/* 01-Apr-2014  1.57 Leong      SOS# 307304 - Include StorerKey.           */
/*                                          - Reset variable at Step_4.    */
/*                                          - Add TraceInfo to Step_3.     */
/* 05-May-2014  1.58 James      SOS304353-Bug fix on qty keyin (james38)   */
/*                              Add extended update in orderkey screen     */
/* 19-Jun-2014  1.59 James      SOS304353-Add ExtendedUpdateSP (james39)   */
/*                              Change Dropid to 20 chars                  */
/* 04-Sep-2014  1.60 Chee       Bug Fix - Allow reuse of DropID, check     */
/*                              dropid status, pickslipno (Chee01)         */
/* 29-Oct-2014  1.61 James      SOS323916-Add ExtendedInfoSP (james40)     */
/* 04-Mar-2015  1.62 SPChin     SOS334125 - Enhance Prefer UOM QTY         */
/* 									  				  Display   						   */
/* 05-Jun-2015  1.63 James      SOS342111-ExtendedValidateSP (james41)     */
/*                              Add confirm task sub sp                    */
/* 03-Jul-2015  1.64 James      SOS342407-Capture carton type (james42)    */
/* 21-Jul-2015  1.65 James      Performance tuning (james41)               */
/* 07-Oct-2015  1.66 James      Enhance pickinginfo scan in (james43)      */
/* 19-Nov-2015  1.67 James      SOS356971 - Enhance RDTLBLRPT (james44)    */
/*                              Add extendedvalidate in step 3             */
/*                              Enhance prompt close case logic            */
/* 07-Mar-2016  1.68 James      SOS365449- Bug fix on Step10 screen        */
/*                              Order count & picked qty not show          */
/*                              correctly (james45)                        */
/* 05-May-2016  1.69 James      SOS364904 - Enhance dropid display         */
/*                              by ClusterPickPromtBlankDropID             */
/*                              Add ExtendedUpdateSP in step 7 (james46)   */
/* 13-Jun-2016  1.70 James      SOS371620 - Add DecodeSP (james47)         */
/* 02-Sep-2016  1.71 James      SOS375742 - Rearrage display @ step 8      */
/*                              by config (james48)                        */
/* 15-Sep-2016  1.72 James      WMS319-Add rdtIsValidFormat to validate    */
/*                              Drop ID (james49)                          */
/* 30-Sep-2016  1.73 Ung        Performance tuning                         */
/* 08-Feb-2017  1.74 James      WMS1016 - Add hold/unhold picking          */
/*                              function (james50)                         */
/*                              Bug fix on variable                        */
/* 25-Apr-2017  1.75 James      Perf tuning (james51)                      */
/* 21-Jul-2017  1.76 James      WMS2447 - Pick using pref uom (james52)    */
/* 03-Nov-2016  1.76 James      Fix pickzone issue (james53)               */
/* 26-Jul-2017  1.77 SPChin     IN00416131 - Bug Fixed                     */
/* 01-Nov-2017  1.78 James      WMS3356 - Add custom fetch task for        */
/*                              consolidated pick (james54)                */
/* 05-Dec-2017  1.79 James      WMS3572-Change ClusterPickNIKE config      */
/*                              to configurable stored proc (james55)      */
/* 15-Dec-2017  1.80 James      Bug fix. Need group orderkey+lot for       */
/*                              conso pick (james56)                       */
/* 16-Jan-2017  1.81 ChewKP     WMS-3767-Call rdt.rdtPrintJob (ChewKP02)   */
/* 23-Feb-2018  1.82 CheeMun    INC0139851-Extend Pack.CaseCnt length 5    */
/* 04-Apr-2018  1.82 James      WMS4338-Add config auto gen id (james57)   */
/* 06-Jul-2018  1.83 James      INC0295949 - Perfomance tuning (james58)   */
/* 29-Oct-2018  1.84 James      WMS-6843-Add extendedinfo @ screen 1875    */
/*                              (james58)                                  */
/* 06-Dec-2018  1.85 James      Bug fix (james59)                          */
/* 16-Jan-2019  1.86 James      WMS7588-Add Loc.Descr (james60)            */
/* 28-Feb-2019  1.87 James      WMS7944-Add ExtendedValidateSP @           */
/*                              @ screen 1 & 2 (james61)                   */
/* 08-Mar-2019  1.88 James      WMS8143-Add SKU attr display (james62)     */
/* 09-May-2019  1.89 James      WMS8817-Use config to decide what field    */
/*                              to show as SKU on screen (james63)         */
/* 12-Jun-2019  1.90 James      WMS9227-Fix cursor issue @ step 8          */
/*                              Rearrange V_String portion (james64)       */
/* 15-Aug-2019  1.91 James      WMS-10274 Add extended packcfm (james65)   */
/* 24-Aug-2020  1.92 James      WMS-14577 Add extended update to close     */
/*                              case screen (james66)                      */
/* 21-Dec-2020  1.93 James      WMS-15813 Fix cannot dropid cannot mix     */
/*                              orders logic (james67)                     */
/* 07-Sep-2020  1.94 James      WMS-14783 Allow skip loc when RDT config   */
/*                              ClusterPickConfirmLoc turned on(james67)   */
/* 02-Oct-2020  1.95 James      WMS-15409 Enhance packcfm (james68)        */
/* 27-Oct-2020  1.96 James      WMS-15548 Add DecodeDropIDSP (james69)     */
/* 25-Feb-2021  1.97 LZG        INC1436470 - Bug fix (ZG01)                */
/* 02-Sep-2020  1.98 James      WMS-14944 Add MultiSKUBarcode (james70)    */
/* 13-Jan-2021  1.99 james01    INC1408845 - Fixed overpick issue          */
/* 05-Mar-2021  2.0 James       WMS-16417 Add config to enable (james71)   */
/*                              AssignPackLabelToOrdCfg                    */
/* 22-Apr-2021  2.1 James       WMS-16756 Add ExtendedUpdateSP to          */
/*                              step 10 (james72)                          */
/* 26-Jan-2022  2.2 yeekung     WMS-18619 Add ExtendedWCS SP               */
/* 17-Jun-2022  2.3 yeekung     WMS-18523 Add defaultloadplan (yeekung01)  */
/* 28-Jul-2022  2.4 LZG         JSM-84937 - Disallowed option if config    */
/*                              is disabled (ZG02)                         */
/* 27-Sep-2023  2.5 James       WMS-23735 Enhance check cannot mix         */
/*                              orderkey in dropid (james73)               */
/* 05-Dec-2023  2.6 James       WMS-24341 When pref qty turn on, set       */
/*                              default cursor (james74)                   */
/*                              Default SKU on input field when screen     */
/*                              waiting for qty input                      */
/* 26-Feb-2024  2.7   James        UWP-15502 - Invalid Drop ID Error       */
/* 03-Mar-2024  2.7.1 James       UWP-15502 - Invalid Drop ID Error, fix   */
/*                               multiple orders in one drop id error      */
/* 01-Jan-2025  2.8.0 James        FCR-2435 Merge 2.5, 2.6 from V0         */
/***************************************************************************/

CREATE   PROC [RDT].[rdtfnc_Cluster_Pick](
   @nMobile    int,
   @nErrNo     int  OUTPUT,
   @cErrMsg    NVARCHAR(1024) OUTPUT -- screen limitation, 20 NVARCHAR max
)
AS

SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
SET ANSI_NULLS OFF
SET CONCAT_NULL_YIELDS_NULL OFF

-- RDT.RDTMobRec variables
DECLARE
   @nFunc          INT,
   @nScn           INT,
   @nStep  INT,
   @cLangCode      NVARCHAR( 3),
   @nInputKey      INT,
   @nMenu          INT,
   @nCurScn        INT,  -- Current screen variable
   @nCurStep       INT,  -- Current step variable

   @cStorerKey     NVARCHAR( 15),
   @cUserName      NVARCHAR( 18),
   @cFacility      NVARCHAR( 5),
   @cPrinter       NVARCHAR( 10),

   @cWaveKey       NVARCHAR( 10),
   @cLoadKey       NVARCHAR( 10),
   @cOrderKey      NVARCHAR( 10),
   @cNewOrderKey   NVARCHAR( 10),
   @cLastOrderKey  NVARCHAR( 10),
   @cCurrentOrderKey NVARCHAR( 10),
   @cPickSlipNo    NVARCHAR( 10),
   @cPutAwayZone   NVARCHAR( 10),
   @cPutAwayZone01 NVARCHAR( 10),
   @cPutAwayZone02 NVARCHAR( 10),
   @cPutAwayZone03 NVARCHAR( 10),
   @cPutAwayZone04 NVARCHAR( 10),
   @cPutAwayZone05 NVARCHAR( 10),
   @cPickZone      NVARCHAR( 10),
   @cOption        NVARCHAR( 1),
   @cLOC           NVARCHAR( 10),
   @cNewLOC        NVARCHAR( 10),
   @cLot           NVARCHAR( 10),
   @cSKU           NVARCHAR( 20),
   @cRetailSKU     NVARCHAR( 20),
   @cSKU_Descr     NVARCHAR( 60),
   @cStyle         NVARCHAR( 20),
   @cColorNSize    NVARCHAR( 20),
   @cColor         NVARCHAR( 10),
   @cSize          NVARCHAR( 5),
   @cColor_Descr   NVARCHAR( 20),
   @cBUSR6         NVARCHAR( 30),
   @cDropID        NVARCHAR( 20),
   @cScan_SKU      NVARCHAR( 20),
   @cActSKU        NVARCHAR( 20),
   @cConsigneeKey  NVARCHAR( 15),
   @cExternOrderKey NVARCHAR( 20),
   @cLottable01    NVARCHAR( 18),
   @cLottable02    NVARCHAR( 18),
   @cLottable03    NVARCHAR( 18),
   @dLottable04    DATETIME,
   @dLottable05    DATETIME,
   @cNewLottable02 NVARCHAR( 18),
   @dNewLottable04 DATETIME,
	@cExtendedWCSSP  NVARCHAR(20),

   @cPickQTY               NVARCHAR( 5),
   @cDefaultPickQty        NVARCHAR( 5),
   @cDefaultToAllocatedQty NVARCHAR( 5),
   @cActQty                NVARCHAR( 7),

   @nQtyToPick       INT,
   @nTotalPickQty    INT,
   @nActQty          INT,
   @nOrdCount        INT,
   @nOrderCnt        INT,
   @nDropIDCnt       INT,
   @nTTL_Alloc_Qty   INT,
   @nLoop            INT,
   @cUCCNo           NVARCHAR( 20),
   @cCongsineeKey    NVARCHAR( 15),
   @cCartonNo        NVARCHAR( 4),
   @cDataWindow      NVARCHAR( 50),
   @cTargetDB        NVARCHAR( 10),
   @nFocusField      INT,
   @nRDTMobile       INT,
   @nTTL_Qty         INT,
   @nTTL_Ord         INT,
   @nSKUCnt          INT,
   @nZoneCount       INT,
   @nOrderPicked     INT,
   @nTTL_PickedQty   INT,
   @nRowRef          INT,
   @b_success        INT,
   @n_err            INT,
   @c_errmsg         NVARCHAR( 255),
   @cPickSlipType    NVARCHAR( 10),
   @nShortPickedQty  INT,
   @cPackUOM3        NVARCHAR( 10),
   @cReportType      NVARCHAR( 10),
   @cPrintJobName    NVARCHAR( 50),
   @cOS_Qty          NVARCHAR( 20),
   @nTTL_Pick_ORD    INT,
   @nTTL_UnPick_ORD  INT,

   @cAllowableIdleTime        NVARCHAR( 3),
   @cClusterPickLockQtyToPick NVARCHAR( 1),
   @cClusterPickScanDropID    NVARCHAR( 1),
   @cAutoPromptDropID         NVARCHAR( 20),
   @cClusterPickPrintLabel    NVARCHAR( 1),
   @cNot_Check_ID_Prefix      NVARCHAR( 1),
   @cAutoPackConfirm          NVARCHAR( 20),
   @cSHOWSHTPICKRSN           NVARCHAR( 1),

   @cDisPlay        NVARCHAR( 20),   -- (james11)
   @cPackCfg        NVARCHAR( 20),   -- (james11)
   @cNewSKU         NVARCHAR( 20),   -- (james11)
   @fPack_Qty       FLOAT,
   @fPack_InnerPack FLOAT,
   @fPack_CaseCnt   FLOAT,

   --(james01)
   @cSQLStatement   NVARCHAR(2000),
   @cSQLParms       NVARCHAR(2000),
   @cCheckDropID_SP NVARCHAR(20),
   @nValid          INT,

   @cReasonCode     NVARCHAR( 10),
   @cModuleName     NVARCHAR( 45),
   @cID             NVARCHAR( 18),
   @cPUOM           NVARCHAR( 1),
   @nQTY            INT,
   @nUpdatePickQty  INT, -- SOS# 208635

   -- SOS170848
   @cLoadDefaultPickMethod NVARCHAR( 1),   -- (james07)
   @cConso_Orders   NVARCHAR( 10),         -- (james07)
   @cPriority       NVARCHAR( 10),         -- (james07)
   @nQty2Offset     INT,               -- (james07)
   @nPD_Qty         INT,               -- (james07)
   @nRPL_Qty        INT,               -- (james07)
   @nPickQty        INT,               -- (james07)

   -- SOS172041
   @cADCode         NVARCHAR( 18),         -- (james08)
   @cSerialNoKey    NVARCHAR( 10),         -- (james08)
   @cNotes          NVARCHAR( 45),         -- (james08)
   @nOtherUnit2     INT,               -- (james08)
   @nSum_PickQty    INT,               -- (james08)
   @nCount_SerialNo INT,               -- (james08)
   @nCartonNo       INT,               -- (james08)
   @nSumPackQTY     INT,               -- (james10)
   @nSumPickQTY     INT,               -- (james10)
   @cPOrderKey      NVARCHAR(10),      -- (james10)
   @nStartTranCnt   INT,               -- (james10)
   @nDeletedCnt     INT,               -- (james_tune)

   @cPSFlag         NVARCHAR( 1),  -- (Vicky07)
   @cPSOrderkey     NVARCHAR( 10), -- (Vicky07)
   @cPSLoadkey      NVARCHAR( 10), -- (Vicky07)
   @cPSWavekey      NVARCHAR( 10), -- (Vicky07)
   @nRDTPickLockQTY INT, -- (ChewKP01)
   @cLogicalLoc     NVARCHAR( 18),

   @cClusterPickGetNextTask_SP   NVARCHAR( 30),     -- (james15)
   @cTemp_String                 NVARCHAR( 20),     -- (james15)
   @cTemp_UOM                    NVARCHAR( 20),     -- (james15)
   @cTemp_PrePackIndicator       NVARCHAR( 30),     -- (james15)
   @nTemp_PackQtyIndicator       INT,           -- (james15)
   @nNew_TTLPickQty              INT,           -- (james15)

   @cErrMsg1        NVARCHAR( 20),         -- (james11)
   @cErrMsg2        NVARCHAR( 20),         -- (james11)
   @cErrMsg3        NVARCHAR( 20),         -- (james11)
   @cErrMsg4        NVARCHAR( 20),         -- (james11)
   @cErrMsg5        NVARCHAR( 20),         -- (james11)
   @cLastPAZone     NVARCHAR( 10),         -- SOS# 237003
   @nNo_Of_Ord      INT,               -- (james16)
   @nTranCount      INT,               -- (james16)
   @cTemp_OrderKey  NVARCHAR(10),          -- (james16)
   @cPickDetailKey  NVARCHAR(10),          -- (james17)
   @cPrevLOC        NVARCHAR(10),          -- (james19)

   @nCount           INT,              -- (james05)
   @cSKUFieldName    NVARCHAR( 30),    -- (james05)
   @cExecStatements  NVARCHAR( 4000),  -- (james05)
   @cExecArguments   NVARCHAR( 4000),  -- (james05)

   @nMultiStorer     INT,              -- (james25)
   @cORD_StorerKey   NVARCHAR( 15),    -- (james25)
   @cOrder_Status    NVARCHAR( 1),     -- (james25)
   @cPrint_OrderKey  NVARCHAR( 15),    -- (james25)
   @cTDropID         NVARCHAR( 20),    -- (james30)
   @cScanLOT02       NVARCHAR( 1),     -- (james32)
   @cPrefUOM         NVARCHAR( 1),     -- (james32)
   @cPrefQty         NVARCHAR( 5),     -- (james32)

   @nPrefQty         INT,              -- (james32)
   @nPrefUOM_Div     INT,              -- (james32)
   @nPrefQTY2Pick    INT,              -- (james32)
   @nMstQTY2Pick     INT,              -- (james32)
   @nPrefQTYPicked   INT,              -- (james32)
   @nMstQTYPicked    INT,              -- (james32)

   @cPreferQty2Display  NVARCHAR( 20), -- (james32), SOS334125
   @cDefaultPrefPickQty NVARCHAR( 5),  -- (james32)
   @cSP                 NVARCHAR( 20), -- (james35)
   @cParam1             NVARCHAR( 20), -- (james35)
   @cParam2             NVARCHAR( 20), -- (james35)
   @cParam3             NVARCHAR( 20), -- (james35)
   @cParam4             NVARCHAR( 20), -- (james35)
   @cParam5             NVARCHAR( 20), -- (james35)
   @cPickNotFinish      NVARCHAR( 20), -- (james36)
   @cExtendedUpdateSP   NVARCHAR( 20), -- (james39)
   @cExtendedInfoSP     NVARCHAR( 20), -- (james40)
   @cExtendedInfo       NVARCHAR( 20), -- (james40)
   @cSQL                NVARCHAR( MAX),-- (james40)
   @cSQLParam           NVARCHAR( MAX),-- (james40)

   @cExtendedValidateSP NVARCHAR( 20), -- (james41)
   @cPickConfirm_SP     NVARCHAR( 20), -- (james41)
   @cStatus             NVARCHAR( 1),  -- (james41)
   @cCartonType         NVARCHAR( 10), -- (james42)
   @cCaptureCtnType     NVARCHAR( 1),  -- (james42)
   @cPickHeaderKey      NVARCHAR( 10), -- (james43)
   @cPromptCloseCase    NVARCHAR( 20), -- (james44)
   @cDecodeSP           NVARCHAR( 20), -- (james47)
   @cBarcode            NVARCHAR( 60), -- (james47)
   @cUPC                NVARCHAR( 30), -- (james47)
   @cFromID             NVARCHAR( 18), -- (james47)
   @cReceiptKey         NVARCHAR( 10), -- (james47)
   @cPOKey              NVARCHAR( 10), -- (james47)
   @cToLOC              NVARCHAR( 10), -- (james47)
   @cLottable06         NVARCHAR( 30), -- (james47)
   @cLottable07         NVARCHAR( 30), -- (james47)
   @cLottable08         NVARCHAR( 30), -- (james47)
   @cLottable09         NVARCHAR( 30), -- (james47)
   @cLottable10         NVARCHAR( 30), -- (james47)
   @cLottable11         NVARCHAR( 30), -- (james47)
   @cLottable12         NVARCHAR( 30), -- (james47)
   @dLottable13         DATETIME,      -- (james47)
   @dLottable14         DATETIME,      -- (james47)
   @dLottable15         DATETIME,      -- (james47)
   @cUserDefine01       NVARCHAR( 60),
   @cUserDefine02       NVARCHAR( 60),
   @cUserDefine03       NVARCHAR( 60),
   @cUserDefine04       NVARCHAR( 60),
   @cUserDefine05       NVARCHAR( 60),
   @nOutScn             INT,           -- (james50)
   @nOutStep            INT,           -- (james50)
   @nFunctionKey        INT,           -- (james50)
   @cFunctionKey        NVARCHAR( 3),  -- (james50)
   @cExtendedFuncKeySP  NVARCHAR( 20), -- (james50)
   @cPickUsingPrefUOM   NVARCHAR( 1),  -- (james52)
   @cClusterPickNIKE    NVARCHAR( 20), -- (james52)
   @cExtendedInfo2      NVARCHAR( 20), -- (james52)
   @cRPL_LOT            NVARCHAR( 10),
   @cClusterPickGenDropID  NVARCHAR( 1),
   @nPromptDropIDScn    INT,
   @cAutoPromptDropIDIfIDChanged NVARCHAR( 20),
   @nIDShortPickedQty   INT,
   @cLocShowDescr       NVARCHAR( 1),  -- (james60)
   @cLocDescr           NVARCHAR( 20), -- (james60)
   @cAttribute01        NVARCHAR( 20), -- (james60)
   @cAttribute02        NVARCHAR( 20), -- (james60)
   @cAttribute03        NVARCHAR( 20), -- (james60)
   @cAttribute04        NVARCHAR( 20), -- (james60)
   @cAttribute05        NVARCHAR( 20), -- (james60)
   @cAttribute06        NVARCHAR( 20), -- (james60)
   @cAttribute07        NVARCHAR( 20), -- (james60)
   @cAttribute08        NVARCHAR( 20), -- (james60)
   @cAttribute09        NVARCHAR( 20), -- (james60)
   @cAttribute10        NVARCHAR( 20), -- (james60)
   @cPrevSKU            NVARCHAR( 20), -- (james60)
   @cAltSKU             NVARCHAR( 20), -- (james63)
   @tAutoPackCfm        VariableTable, -- (james65)
   @cClusterPickAllowSkipLoc  NVARCHAR( 1), -- (james67)
   @cDecodeDropIDSP     NVARCHAR( 20), -- (james69)
   @cMultiSKUBarcode    NVARCHAR( 1),  -- (james70)
   @nRowCount           INT,
   @cAssignPackLabelToOrdCfg NVARCHAR( 1),

   @cInField01 NVARCHAR( 60),   @cOutField01 NVARCHAR( 60),
   @cInField02 NVARCHAR( 60),   @cOutField02 NVARCHAR( 60),
   @cInField03 NVARCHAR( 60),   @cOutField03 NVARCHAR( 60),
   @cInField04 NVARCHAR( 60),   @cOutField04 NVARCHAR( 60),
   @cInField05 NVARCHAR( 60),   @cOutField05 NVARCHAR( 60),
   @cInField06 NVARCHAR( 60),   @cOutField06 NVARCHAR( 60),
   @cInField07 NVARCHAR( 60),   @cOutField07 NVARCHAR( 60),
   @cInField08 NVARCHAR( 60),   @cOutField08 NVARCHAR( 60),
   @cInField09 NVARCHAR( 60),   @cOutField09 NVARCHAR( 60),
   @cInField10 NVARCHAR( 60),   @cOutField10 NVARCHAR( 60),
   @cInField11 NVARCHAR( 60),   @cOutField11 NVARCHAR( 60),
   @cInField12 NVARCHAR( 60),   @cOutField12 NVARCHAR( 60),
   @cInField13 NVARCHAR( 60),   @cOutField13 NVARCHAR( 60),
   @cInField14 NVARCHAR( 60),   @cOutField14 NVARCHAR( 60),
   @cInField15 NVARCHAR( 60),   @cOutField15 NVARCHAR( 60),

   @cFieldAttr01 NVARCHAR( 1), @cFieldAttr02 NVARCHAR( 1),
   @cFieldAttr03 NVARCHAR( 1), @cFieldAttr04 NVARCHAR( 1),
   @cFieldAttr05 NVARCHAR( 1), @cFieldAttr06 NVARCHAR( 1),
   @cFieldAttr07 NVARCHAR( 1), @cFieldAttr08 NVARCHAR( 1),
   @cFieldAttr09 NVARCHAR( 1), @cFieldAttr10 NVARCHAR( 1),
   @cFieldAttr11 NVARCHAR( 1), @cFieldAttr12 NVARCHAR( 1),
   @cFieldAttr13 NVARCHAR( 1), @cFieldAttr14 NVARCHAR( 1),
   @cFieldAttr15 NVARCHAR( 1)

DECLARE @curReleaseLock  CURSOR
DECLARE @curPickingInfo  CURSOR
DECLARE @curUpdRPL       CURSOR

DECLARE
   @c_oFieled01 NVARCHAR(20), @c_oFieled02 NVARCHAR(20),
   @c_oFieled03 NVARCHAR(20), @c_oFieled04 NVARCHAR(20),
   @c_oFieled05 NVARCHAR(20), @c_oFieled06 NVARCHAR(20),
   @c_oFieled07 NVARCHAR(20), @c_oFieled08 NVARCHAR(20),
   @c_oFieled09 NVARCHAR(20), @c_oFieled10 NVARCHAR(20),
   @c_oFieled11 NVARCHAR(20), @c_oFieled12 NVARCHAR(20),
   @c_oFieled13 NVARCHAR(20), @c_oFieled14 NVARCHAR(20),
   @c_oFieled15 NVARCHAR(20),
   @cDecodeLabelNo       NVARCHAR( 20),
   @c_LabelNo            NVARCHAR( 32)

DECLARE @c_ExecStatements     nvarchar(4000)
      , @c_ExecArguments      nvarchar(4000)

-- TraceInfo (Vicky02) - Start
DECLARE    @d_StartTime    datetime,
           @d_EndTime      datetime,
           @d_step1        datetime,
           @d_step2        datetime,
           @d_step3        datetime,
           @d_step4        datetime,
           @d_step5        datetime,
           @c_Col1         NVARCHAR(20),
           @c_Col2         NVARCHAR(20),
           @c_Col3         NVARCHAR(20),
           @c_Col4         NVARCHAR(20),
           @c_Col5         NVARCHAR(20),
           @c_TraceName    NVARCHAR(80)
         , @c_TraceUserId  NVARCHAR(20) -- SOS# 307304
         , @c_TraceNotes   NVARCHAR(20) -- SOS# 307304

SET @d_StartTime = getdate()

SET @c_TraceName = 'rdtfnc_Cluster_Pick'
-- TraceInfo (Vicky02) - End

-- Getting Mobile information
SELECT
   @nFunc            = Func,
   @nScn             = Scn,
   @nStep            = Step,
   @nInputKey        = InputKey,
   @nMenu            = Menu,
   @cLangCode        = Lang_code,

   @cStorerKey       = StorerKey,
   @cFacility        = Facility,
   @cUserName        = UserName,
   @cPrinter         = Printer,

   @nActQty          = V_Integer1,
   @nOrdCount        = V_Integer2,
   @nOrderCnt        = V_Integer3,
   @nTTL_Alloc_Qty   = V_Integer4,
   @nTTL_Ord         = V_Integer5,
   @nQtyToPick       = V_Integer6,
   @nTotalPickQty    = V_Integer7,
   @nTTL_Qty         = V_Integer8,
   @nMultiStorer     = V_Integer9,
   @nFunctionKey     = V_Integer10,

   @nCurScn          = V_FromScn,
   @nCurStep         = V_FromStep,

   @cPickSlipNo      = V_PickSlipNo,
   @cOrderKey        = V_OrderKey,
   @cLoadKey         = V_LoadKey,
   @cLOC             = V_LOC,
   @cLOT             = V_LOT,
   @cID              = V_ID,
   @cConsigneeKey    = V_ConsigneeKey,
   @cSKU             = V_SKU,
   @cSKU_Descr       = V_SKUDescr,
   @cLottable02      = V_Lottable02,
   @dLottable04      = V_Lottable04,

   @cWaveKey         = V_String1,
   @cAltSKU          = V_String2,
   @cPutAwayZone01   = V_String3,
   @cPutAwayZone02   = V_String4,
   @cPutAwayZone03   = V_String5,
   @cPutAwayZone04   = V_String6,
   @cPutAwayZone05   = V_String7,
   @cLastOrderKey    = V_String8,
   @cAttribute01     = V_String9,
   @cPutAwayZone     = V_String10,
   @cPickZone        = V_String11,
   @cExternOrderKey  = V_String12,
   @cStyle           = V_String13,
   @cColor           = V_String14,
   @cSize            = V_String15,
   @cColor_Descr     = V_String16,
   @cDropID          = V_String17,
   @cScanLOT02       = V_String18,
   @cMultiSKUBarcode = V_String19,
   @cDefaultPickQty  = V_String20,
   @cCurrentOrderKey = V_String25,
   @cClusterPickAllowSkipLoc = V_String26,
   @cClusterPickScanDropID    = V_String27,
   @cClusterPickLockQtyToPick = V_String28,
   @cAutoPromptDropID         = V_String29,
   @cDefaultToAllocatedQty    = V_String30,
   @cClusterPickPrintLabel    = V_String31,
   @cPickUsingPrefUOM         = V_String32,
   @cNot_Check_ID_Prefix    = V_String33,
   @cDecodeDropIDSP           = V_String34,
   @cAssignPackLabelToOrdCfg  = V_String35,
   @cLoadDefaultPickMethod    = V_String36,  -- (james07)
   @cPrefUOM                  = V_String38,  -- (james32)
   @cCartonType               = V_String39,  -- (james42)
   @cClusterPickNIKE          = V_String41,  -- (james55)
   @cClusterPickGenDropID     = V_String42,
   @cExtendedInfoSP           = V_String43,
   @cExtendedUpdateSP         = V_String44,
   @cExtendedValidateSP       = V_String45,
   @cAutoPromptDropIDIfIDChanged = V_String46,
   @cLocShowDescr             = V_String47,
   @cLocDescr                 = V_String48,
   @cAttribute02              = V_String49,
   @cAttribute03              = V_String50,
	@cExtendedWCSSP				= V_String21,

   @cInField01 = I_Field01,   @cOutField01 = O_Field01,
   @cInField02 = I_Field02,   @cOutField02 = O_Field02,
   @cInField03 = I_Field03,   @cOutField03 = O_Field03,
   @cInField04 = I_Field04,   @cOutField04 = O_Field04,
   @cInField05 = I_Field05,   @cOutField05 = O_Field05,
   @cInField06 = I_Field06,   @cOutField06 = O_Field06,
   @cInField07 = I_Field07,   @cOutField07 = O_Field07,
   @cInField08 = I_Field08,   @cOutField08 = O_Field08,
   @cInField09 = I_Field09,   @cOutField09 = O_Field09,
   @cInField10 = I_Field10,   @cOutField10 = O_Field10,
   @cInField11 = I_Field11,   @cOutField11 = O_Field11,
   @cInField12 = I_Field12,   @cOutField12 = O_Field12,
   @cInField13 = I_Field13,   @cOutField13 = O_Field13,
   @cInField14 = I_Field14,   @cOutField14 = O_Field14,
   @cInField15 = I_Field15,   @cOutField15 = O_Field15,

   @cFieldAttr01  = FieldAttr01,    @cFieldAttr02   = FieldAttr02,
   @cFieldAttr03 =  FieldAttr03,    @cFieldAttr04   = FieldAttr04,
   @cFieldAttr05 =  FieldAttr05,    @cFieldAttr06   = FieldAttr06,
   @cFieldAttr07 =  FieldAttr07,    @cFieldAttr08   = FieldAttr08,
   @cFieldAttr09 =  FieldAttr09,    @cFieldAttr10   = FieldAttr10,
   @cFieldAttr11 =  FieldAttr11,    @cFieldAttr12   = FieldAttr12,
   @cFieldAttr13 =  FieldAttr13,    @cFieldAttr14   = FieldAttr14,
   @cFieldAttr15 =  FieldAttr15

FROM rdt.rdtMobRec (NOLOCK)
WHERE Mobile = @nMobile

SET @c_Col1 = @cWaveKey
SET @c_Col2 = @cOrderKey
SET @c_Col3 = @cPickZone
SET @c_Col4 = @cDropID
SET @c_Col5 = @cSKU

IF @nFunc IN (1620, 1621, 1628)  -- 1620 for carment; 1621 for pharma; 1628 for grouping by conso
BEGIN
   -- Redirect to respective screen
   IF @nStep = 0   GOTO Step_0 -- Menu. Func = 910
   IF @nStep = 1   GOTO Step_1 -- Scn = 1870. WaveKey
   IF @nStep = 2   GOTO Step_2 -- Scn = 1871. LoadKey
   IF @nStep = 3   GOTO Step_3 -- Scn = 1872. OrderKey
   IF @nStep = 4   GOTO Step_4 -- Scn = 1873. PutAwayZone
   IF @nStep = 5   GOTO Step_5 -- Scn = 1874. PickZone
   IF @nStep = 6   GOTO Step_6 -- Scn = 1875. Start Picking
   IF @nStep = 7   GOTO Step_7 -- Scn = 1876, 1882, 1887. Drop ID
   IF @nStep = 8   GOTO Step_8 -- Scn = 1877, 1883, 1888. SKU, Qty
   IF @nStep = 9   GOTO Step_9 -- Scn = 1878, 1884, 1889. Confirm Short Pick
   IF @nStep = 10  GOTO Step_10 -- Scn = 1879. Picking completed
   IF @nStep = 11  GOTO Step_11 -- Scn = 1880. Exit Picking
   IF @nStep = 12  GOTO Step_12 -- Scn = 1881. Confirm Short Pick/Cancel Pick
   IF @nStep = 13  GOTO Step_13 -- Scn = 1885. Print Label
   IF @nStep = 14  GOTO Step_14 -- Scn = STD short pick
   IF @nStep = 15  GOTO Step_15 -- Scn = 1886. Close Case
   IF @nStep = 16  GOTO Step_16 -- Scn = 1890. New Drop ID
   IF @nStep = 17  GOTO Step_17 -- Scn = 1891. Anti-Diversion code
   IF @nStep = 18  GOTO Step_18 -- Scn = Anti-Diversion code (Short Pick)
   IF @nStep = 19  GOTO Step_19 -- Scn = 1892. Get Carton Size
   IF @nStep = 20  GOTO Step_20 -- Scn = 4790. Picking on hold
   IF @nStep = 21  GOTO Step_21 -- Scn = 3570. Multi SKU Barocde
END

RETURN -- Do nothing if incorrect step

/********************************************************************************
Step_Start. Func = 1620
********************************************************************************/
Step_0:
BEGIN
   -- Get prefer UOM
   SELECT @cPrefUOM = IsNULL( DefaultUOM, '6') -- If not defined, default as EA
   FROM RDT.rdtMobRec M WITH (NOLOCK)
      INNER JOIN RDT.rdtUser U WITH (NOLOCK) ON (M.UserName = U.UserName)
   WHERE M.Mobile = @nMobile

	SET @cExtendedWCSSP = rdt.RDTGetConfig( @nFunc, 'ExtendedWCSSP', @cStorerKey)
   IF @cExtendedWCSSP = '0'
      SET @cExtendedWCSSP = ''
   -- (james25)
   SET @nMultiStorer = 0
   IF EXISTS (SELECT 1 FROM dbo.StorerGroup WITH (NOLOCK) WHERE StorerGroup = @cStorerKey)
      SET @nMultiStorer = 1

   -- Clear the uncompleted task for the same login
   DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
   SELECT ROWREF FROM RDT.RDTPickLock WITH (NOLOCK)
   WHERE [Status] IN ('1', 'X')
   AND   AddWho = @cUserName
   OPEN CUR_DEL
   FETCH NEXT FROM CUR_DEL INTO @nRowRef
   WHILE @@FETCH_STATUS <> -1
   BEGIN
      DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE RowRef = @nRowRef
      FETCH NEXT FROM CUR_DEL INTO @nRowRef
   END
   CLOSE CUR_DEL
   DEALLOCATE CUR_DEL

   -- If config turned on, not allow to change Qty To Pick
   SET @cClusterPickLockQtyToPick  = rdt.RDTGetConfig( @nFunc, 'ClusterPickLockQtyToPick', @cStorerKey)

   -- If config turned on, DropID field is mandatory
   SET @cClusterPickScanDropID = rdt.RDTGetConfig( @nFunc, 'ClusterPickScanDropID', @cStorerKey)

   -- If config turned on, auto go back to DropID field
   SET @cAutoPromptDropID = rdt.RDTGetConfig( @nFunc, 'AutoPromptDropID', @cStorerKey)

   -- If config turned on, auto go back the qty to pick is defaulted to QtyAllocated field
   SET @cDefaultToAllocatedQty = rdt.RDTGetConfig( @nFunc, 'DefaultToAllocatedQty', @cStorerKey)

   -- If config turned on, auto go to Print label screen
   SET @cClusterPickPrintLabel = rdt.RDTGetConfig( @nFunc, 'ClusterPickPrintLabel', @cStorerKey)

   -- If config turned on, auto go to Print label screen
   SET @cAllowableIdleTime = rdt.RDTGetConfig( @nFunc, 'AllowableIdleTime', @cStorerKey)

   -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'
   SET @cNot_Check_ID_Prefix = rdt.RDTGetConfig( @nFunc, 'Not_Check_ID_Prefix', @cStorerKey)

   -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'
   SET @cLoadDefaultPickMethod = rdt.RDTGetConfig( @nFunc, 'LoadDefaultPickMethod', @cStorerKey)

   SET @cClusterPickGenDropID = rdt.RDTGetConfig( @nFunc, 'ClusterPickGenDropID', @cStorerKey)

   -- If config turned on, pick using user preferred uom (rdtuser.defaultuom)
   SET @cPickUsingPrefUOM = rdt.RDTGetConfig( @nFunc, 'PickUsingPrefUOM', @cStorerKey)
   IF @cPickUsingPrefUOM <> '1'
      SET @cPickUsingPrefUOM = ''
   ELSE
   BEGIN
      IF @cPrefUOM = ''
         SET @cPickUsingPrefUOM = '6'
      ELSE
         SET @cPickUsingPrefUOM = @cPrefUOM
   END

   SET @cClusterPickNIKE = rdt.RDTGetConfig( @nFunc, 'ClusterPickNIKE', @cStorerKey)
   IF @cClusterPickNike = '0'
      SET @cClusterPickNike = ''

   SET @cFunctionKey = rdt.RDTGetConfig( @nFunc, 'FunctionKey', @cStorerKey)
   IF @cFunctionKey NOT IN ('', '0')
      SELECT @nFunctionKey = RDT.rdtGetFuncKey(@cFunctionKey)
   ELSE
      SET @nFunctionKey = 99  -- Set to some other value than 1 = ENTER; 0 = ESC

   -- (james71)
   SET @cAssignPackLabelToOrdCfg = rdt.RDTGetConfig( @nFunc, 'RDT_AssignPackLabelToOrdCfg', @cStorerKey)

   IF @nFunctionKey IN (11, 12, 13, 14)
   BEGIN
      SET @cExtendedFuncKeySP = rdt.RDTGetConfig( @nFunc, 'ExtendedFuncKeySP', @cStorerkey)
      IF @cExtendedFuncKeySP NOT IN ('0', '') AND
         EXISTS (SELECT 1 FROM sys.objects o WHERE NAME = @cExtendedFuncKeySP AND TYPE = 'P')
      BEGIN
         SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedFuncKeySP) +
            ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @nFunctionKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
            ' @cPutAwayZone, @cPickZone, @cDropID, @cCartonType, @cLOC, @cSKU, @nQty,' +
            ' @nOutScn OUTPUT, @nOutStep OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '

         SET @cSQLParms =
            '@nMobile         INT,           ' +
            '@nFunc           INT,           ' +
            '@cLangCode       NVARCHAR( 3),  ' +
            '@nStep           INT,           ' +
            '@nInputKey       INT,           ' +
            '@nFunctionKey    INT,           ' +
            '@cStorerkey      NVARCHAR( 15), ' +
            '@cWaveKey        NVARCHAR( 10), ' +
            '@cLoadKey        NVARCHAR( 10), ' +
            '@cOrderKey       NVARCHAR( 10), ' +
            '@cPutAwayZone    NVARCHAR( 10), ' +
            '@cPickZone       NVARCHAR( 10), ' +
            '@cDropID         NVARCHAR( 20), ' +
            '@cCartonType     NVARCHAR( 10), ' +
            '@cLOC            NVARCHAR( 10), ' +
            '@cSKU            NVARCHAR( 20), ' +
            '@nQty            INT,           ' +
            '@nOutScn         INT           OUTPUT,  ' +
            '@nOutStep        INT           OUTPUT,  ' +
            '@nErrNo          INT           OUTPUT,  ' +
            '@cErrMsg         NVARCHAR( 20) OUTPUT   '

         EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @nFunctionKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
               @cPutAwayZone,  @cPickZone, @cDropID, @cCartonType, @cLOC, @cSKU, @nQty,
               @nOutScn OUTPUT, @nOutStep OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT

         IF @nErrNo <> 0
            GOTO Quit
      END

      SET @nCurScn = 1870
      SET @nCurStep = 1

      IF @nOutScn > @nCurScn AND @nOutStep > @nCurStep
      BEGIN
         -- Goto function key screen
         SET @cOutField01 = @cFunctionKey
         SET @nScn = @nOutScn
         SET @nStep = @nOutStep
         GOTO Quit
      END
   END

   -- Get stored proc name for extended info (james40)
   SET @cExtendedInfoSP = rdt.RDTGetConfig( @nFunc, 'ExtendedInfoSP', @cStorerKey)
   IF @cExtendedInfoSP = '0'
      SET @cExtendedInfoSP = ''

   SET @cExtendedUpdateSP = rdt.RDTGetConfig( @nFunc, 'ExtendedUpdateSP', @cStorerkey)
   IF @cExtendedUpdateSP = '0'
      SET @cExtendedUpdateSP = ''

   SET @cExtendedValidateSP = rdt.RDTGetConfig( @nFunc, 'ExtendedValidateSP', @cStorerkey)
   IF @cExtendedValidateSP = '0'
      SET @cExtendedValidateSP = ''

   SET @cAutoPromptDropIDIfIDChanged = rdt.RDTGetConfig( @nFunc, 'AutoPromptDropIDIfIDChanged', @cStorerkey)
   IF @cAutoPromptDropIDIfIDChanged = '0'
      SET @cAutoPromptDropIDIfIDChanged = ''

   SET @cLocShowDescr = rdt.RDTGetConfig( @nFunc, 'LocShowDescr', @cStorerkey)

   SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'ScanLOT02', @cStorerkey)
   IF @cScanLOT02 <> '1'
      SET @cScanLOT02 = '0'

   SET @cClusterPickAllowSkipLoc = rdt.RDTGetConfig( @nFunc, 'ClusterPickAllowSkipLoc', @cStorerkey)

   -- (james69)
   SET @cDecodeDropIDSP = rdt.RDTGetConfig( @nFunc, 'DecodeDropIDSP', @cStorerkey)

   -- (james70)
   SET @cMultiSKUBarcode = rdt.RDTGetConfig( @nFunc, 'MultiSKUBarcode', @cStorerKey)

   -- (Vicky06) EventLog - Sign In Function
   EXEC RDT.rdt_STD_EventLog
      @cActionType = '1', -- Sign in function
      @cUserID     = @cUserName,
      @nMobileNo   = @nMobile,
      @nFunctionID = @nFunc,
      @cFacility   = @cFacility,
      @cStorerKey  = @cStorerKey

   -- Prepare next screen var
   SET @cOutField01 = '' -- WaveKey

   -- Go to WaveKey screen
   SET @nScn = 1870
   SET @nStep = 1
END
GOTO Quit

/********************************************************************************
Step 1. Screen = 1870
   WaveKey     (field01, input)
********************************************************************************/
Step_1:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cWaveKey = @cInField01

      --if input is blank, goto next screen
      IF ISNULL(@cWaveKey, '') = ''
      BEGIN
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickWaveKeyReq', @cStorerKey) = 1  -- (james15)
         BEGIN
            SET @nErrNo = 69355
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --WAVEKEY Is Req
            GOTO Step_1_Fail
         END
         ELSE
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = '' --WaveKey
            SET @cOutField02 = '' --LoadKey

            -- Go to next screen
            SET @nScn  = 1871
            SET @nStep = 2

            DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT RowRef FROM RDT.RDTPICKLOCK WITH (NOLOCK)
            WHERE ADDWHO = @cUserName
            AND   Status < '9'
            OPEN CUR_DEL
            FETCH NEXT FROM CUR_DEL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               DELETE FROM RDT.RDTPICKLOCK WITH (ROWLOCK) WHERE RowRef = @nRowRef
               FETCH NEXT FROM CUR_DEL INTO @nRowRef
            END
            CLOSE CUR_DEL
            DEALLOCATE CUR_DEL

            GOTO Quit
         END
      END

      IF @cWaveKey <> ''
      BEGIN
         IF NOT EXISTS (SELECT 1 FROM dbo.Wave WITH (NOLOCK) WHERE WaveKey = @cWaveKey)
         BEGIN
            SET @nErrNo = 65901
            SET @cErrMsg = rdt.rdtgetmessage( 65901, @cLangCode, 'DSP') --Bad WAVEKEY
            GOTO Step_1_Fail
         END
      END

      IF @cExtendedValidateSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.objects WHERE name = @cExtendedValidateSP AND type = 'P')
         BEGIN
            SET @nErrNo = 0
            SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedValidateSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cLoc                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@nQty                      INT, '           +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                  @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

            IF @nErrNo <> 0
               GOTO Step_1_Fail
         END
      END

      -- Prep next screen var
      SET @cOutField01 = @cWaveKey --WaveKey
      SET @cOutField02 = '' --LoadKey

      -- Go to next screen
      SET @nScn  = 1871
      SET @nStep = 2

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- (Vicky06) EventLog - Sign Out Function
      EXEC RDT.rdt_STD_EventLog
         @cActionType = '9', -- Sign Out function
         @cUserID     = @cUserName,
         @nMobileNo   = @nMobile,
         @nFunctionID = @nFunc,
         @cFacility   = @cFacility,
         @cStorerKey  = @cStorerkey

      -- Back to menu
      SET @nFunc = @nMenu
      SET @nScn  = @nMenu
      SET @nStep = 0
      SET @cOutField01 = '' -- WaveKey
   END

   GOTO Quit

   Step_1_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 2. Screen = 1871
   WaveKey  (field01)
   LoadKey     (field02, input)
********************************************************************************/
Step_2:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cLoadKey = @cInField02

      --if input is blank, goto next screen
      IF ISNULL(@cLoadKey, '') = ''
      BEGIN
         -- If using conso pick then scanning loadkey is mandatory   (james07)
         IF @nFunc = 1628
         BEGIN
            SET @nErrNo = 65902
            SET @cErrMsg = rdt.rdtgetmessage( 65902, @cLangCode, 'DSP') --Bad LOADKEY
            GOTO Step_2_Fail
         END
         ELSE
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickLoadKeyReq', @cStorerKey) = 1  -- (james16)
         BEGIN
            SET @nErrNo = 69356
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --LOADKEY Is Req
            GOTO Step_2_Fail
         END

         -- Prep next screen var
         SET @cOutField01 = CASE WHEN ISNULL(@cWaveKey, '') = '' THEN '' ELSE @cWaveKey END--WaveKey
         SET @cOutField02 = '' --LoadKey
         SET @cOutField03 = '' --OrderKey
         SET @cOutField04 = ''
         SET @cOutField05 = '0'
         SET @nOrdCount = 0

         SET @cOrderKey = ''
         SET @cLastOrderKey = ''

         -- Go to next screen
         SET @nScn  = 1872
         SET @nStep = 3

         GOTO Quit
      END

      IF @cLoadKey <> ''
      BEGIN
         IF NOT EXISTS (SELECT 1 FROM dbo.LoadPlan WITH (NOLOCK) WHERE LoadKey = @cLoadKey)
         BEGIN
            SET @nErrNo = 65902
            SET @cErrMsg = rdt.rdtgetmessage( 65902, @cLangCode, 'DSP') --Bad LOADKEY
            GOTO Step_2_Fail
         END

         IF ISNULL(@cLoadDefaultPickMethod,'') IN('','0') --(yeekung01)
         BEGIN
            -- (james07)
            SELECT @cLoadDefaultPickMethod = LoadPickMethod
            FROM dbo.LoadPlan WITH (NOLOCK)
            WHERE LoadKey = @cLoadKey
         END

         -- If using conso pick but loadplan pick method <> 'C' then prompt error
         IF @nFunc = 1628 AND @cLoadDefaultPickMethod <> 'C'
         BEGIN
            SET @nErrNo = 65902
            SET @cErrMsg = rdt.rdtgetmessage( 65902, @cLangCode, 'DSP') --Bad LOADKEY
            GOTO Step_2_Fail
         END
      END

      IF @cWaveKey <> '' AND @cLoadKey <> ''
      BEGIN
         IF NOT EXISTS (SELECT 1 FROM dbo.ORDERS WITH (NOLOCK)
         WHERE UserDefine09 = @cWaveKey
            AND LoadKey = @cLoadKey)
         BEGIN
            SET @nErrNo = 65903
            SET @cErrMsg = rdt.rdtgetmessage( 65903, @cLangCode, 'DSP') --Load not in Wave
            GOTO Step_2_Fail
         END
      END

      IF @cExtendedValidateSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.objects WHERE name = @cExtendedValidateSP AND type = 'P')
         BEGIN
            SET @nErrNo = 0
            SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedValidateSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cLoc                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@nQty                      INT, '           +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                  @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

            IF @nErrNo <> 0
               GOTO Step_2_Fail
         END
      END

      -- Prep next screen var
      SET @cOutField01 = CASE WHEN ISNULL(@cWaveKey, '') = '' THEN '' ELSE @cWaveKey END --WaveKey
      SET @cOutField02 = CASE WHEN ISNULL(@cLoadKey, '') = '' THEN '' ELSE @cLoadKey END --LoadKey
      SET @cOutField03 = ''
      SET @cOutField04 = ''
      SET @cOutField05 = '0'
      SET @nOrdCount = 0

      -- Go to next screen
      SET @nScn  = 1872
      SET @nStep = 3

      SET @cOrderKey = ''
      SET @cLastOrderKey = ''

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- Go to prev screen
      SET @nScn  = 1870
      SET @nStep = 1

      SET @cWaveKey = ''
      SET @cLoadKey = ''

      SET @cOutField01 = ''
   END

   GOTO Quit

   Step_2_Fail:
   BEGIN
      SET @cOutField01 = CASE WHEN ISNULL(@cWaveKey, '') = '' THEN '' ELSE @cWaveKey END --WaveKey
      SET @cOutField02 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 3. Screen = 1872
   WaveKey     (field01)
   LoadKey     (field02)
   OrderKey    (field03, input)
   Last OrderKey (field04)
   OrderKey Count (field05)
********************************************************************************/
Step_3:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cOrderKey = @cInField03

      -- If all 3 input is blank
      IF ISNULL(@cWaveKey, '') = '' AND ISNULL(@cLoadKey, '') = '' AND ISNULL(@cOrderKey, '') = '' AND ISNULL(@cLastOrderKey, '') = ''
      BEGIN
         SET @nErrNo = 65904
         SET @cErrMsg = rdt.rdtgetmessage( 65904, @cLangCode, 'DSP') --NeedWav/Load/Ord
         GOTO Step_3_Fail
      END

      -- If either WaveKey/LoadKey entered, check OrderKey exists in Wave/LoadPlan
      IF ISNULL(@cOrderKey, '') <> ''
      BEGIN
         IF ISNULL(@cWaveKey, '') <> ''
         BEGIN
            IF NOT EXISTS (SELECT 1 FROM dbo.WaveDetail WITH (NOLOCK)
                           WHERE WaveKey = @cWaveKey
                          AND OrderKey = @cOrderKey)
            BEGIN
               SET @nErrNo = 65905
               SET @cErrMsg = rdt.rdtgetmessage( 65905, @cLangCode, 'DSP') --Bad OrderKey
               GOTO Step_3_Fail
            END
         END

         IF ISNULL(@cWaveKey, '') = '' AND ISNULL(@cLoadKey, '') <> ''
         BEGIN
            IF NOT EXISTS (SELECT 1 FROM dbo.LoadPlanDetail WITH (NOLOCK)
            WHERE LoadKey = @cLoadKey
               AND OrderKey = @cOrderKey)
            BEGIN
               SET @nErrNo = 65906
               SET @cErrMsg = rdt.rdtgetmessage( 65906, @cLangCode, 'DSP') --Bad OrderKey
               GOTO Step_3_Fail
            END
         END
      END

      IF ISNULL(@cOrderKey, '') <> ''
      BEGIN
         IF @nMultiStorer = 1
         BEGIN
            SET @cOrder_Status = ''
            SELECT @cOrder_Status = MIN(OD.Status)
            FROM dbo.OrderDetail OD WITH (NOLOCK)
            JOIN StorerGroup SG WITH (NOLOCK) ON (OD.StorerKey = SG.StorerKey)
            WHERE SG.StorerGroup = @cStorerKey
            AND   OrderKey = @cOrderKey

            IF ISNULL(@cOrder_Status, '') = ''
            BEGIN
               SET @nErrNo = 69375
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --INVALID ORDERS
               GOTO Step_3_Fail
            END

            IF ISNULL(@cOrder_Status, '') = '0' OR ISNULL(@cOrder_Status, '') >= '5'
            BEGIN
               SET @nErrNo = 69376
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --Bad Order Status
               GOTO Step_3_Fail
            END
         END
         ELSE
         BEGIN
            IF NOT EXISTS (SELECT 1 FROM dbo.OrderDetail WITH (NOLOCK)  -- (james09)
               WHERE StorerKey = @cStorerKey
                  AND OrderKey = @cOrderKey
                  AND Status >= '1'
                  AND Status < '5')
            BEGIN
               SET @nErrNo = 65907
               SET @cErrMsg = rdt.rdtgetmessage( 65907, @cLangCode, 'DSP') --Bad Order Status
               GOTO Step_3_Fail
            END
         END

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey =  @cOrderKey

         -- (james39)
         IF @cExtendedUpdateSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedUpdateSP AND type = 'P')
            BEGIN
               SET @nErrNo = 0
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedUpdateSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                  ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

               SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cLoc                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@nQty                      INT, '           +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                    @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

               IF @nErrNo <> 0
                  GOTO Step_3_Fail
            END
         END

         SET @cPickSlipNo = ''

         -- check discrete first    (james23)
         SELECT TOP 1 @cPickSlipNo = PickHeaderKey
         FROM dbo.PickHeader PH WITH (NOLOCK)
         WHERE PH.OrderKey = @cOrderKey
            AND PH.Status = '0'

         -- not discrete pick, look in wave
         IF ISNULL(@cPickSlipNo, '') = ''
         BEGIN
            SELECT TOP 1 @cPickSlipNo = PickHeaderKey
            FROM dbo.PickHeader PH WITH (NOLOCK)
            JOIN dbo.Orders O WITH (NOLOCK) ON (PH.WaveKey = O.UserDefine09 AND PH.OrderKey = O.OrderKey)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey    -- (james09)
            WHERE (( @nMultiStorer = 1 AND OD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND OD.StorerKey = @cStorerKey))
               AND O.OrderKey = @cOrderKey
               AND PH.Status = '0'
               AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
         END

         -- If not wave plan, look in loadplan
         IF ISNULL(@cPickSlipNo, '') = ''
         BEGIN
            SELECT TOP 1 @cPickSlipNo = PickHeaderKey
            FROM dbo.PickHeader PH WITH (NOLOCK)
            JOIN dbo.Orders O WITH (NOLOCK) ON (PH.ExternOrderKey = O.LoadKey  AND PH.ExternOrderKey <> '')
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey     -- (james09)
            WHERE (( @nMultiStorer = 1 AND OD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND OD.StorerKey = @cStorerKey))
               AND O.OrderKey = @cOrderKey
               AND PH.Status = '0'
               AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
         END

         -- Check if pickslip printed
         IF ISNULL(@cPickSlipNo, '') = ''
         BEGIN
            SET @nErrNo = 65908
            SET @cErrMsg = rdt.rdtgetmessage( 65908, @cLangCode, 'DSP') --PKSLIPNotPrinted
            GOTO Step_3_Fail
         END

         -- Check if pickslip scanned out
         IF EXISTS ( SELECT 1 FROM dbo.PickingInfo WITH (NOLOCK)
                    WHERE PickSlipNo = @cPickSlipNo
                     AND ScanOutDate IS NOT NULL)
         BEGIN
            SET @nErrNo = 65909
            SET @cErrMsg = rdt.rdtgetmessage( 65909, @cLangCode, 'DSP') --PS Scanned Out
            GOTO Step_3_Fail
         END

      END   -- IF ISNULL(@cOrderKey, '') <> ''

      -- SOS# 307304 (Start)
      SET @d_StartTime   = GETDATE()
      SET @d_EndTime     = GETDATE()
      SET @c_TraceUserId = SUSER_SNAME()
      SET @c_TraceNotes  = '1a/' + CAST(@nMobile AS VARCHAR(10))
      EXEC isp_InsertTraceInfo
           @c_TraceCode = 'CLUSTERPICK'
         , @c_TraceName = 'rdtfnc_Cluster_Pick'
         , @c_StartTime = @d_StartTime
         , @c_EndTime   = @d_EndTime
         , @c_Step1     = @cOrderKey
         , @c_Step2     = @cWaveKey
         , @c_Step3     = @cLoadKey
         , @c_Step4     = @nMultiStorer
         , @c_Step5     = @cPickSlipNo
         , @c_Col1      = @cPickSlipType
         , @c_Col2      = @cORD_StorerKey
         , @c_Col3      = @cStorerKey
         , @c_Col4      = @c_TraceNotes
         , @c_Col5      = @c_TraceUserId
         , @b_Success   = 1
         , @n_Err       = 0
         , @c_ErrMsg    = ''
      -- SOS# 307304 (End)

      -- If no orderkey is keyed in then pickslipno will be blank
      -- Make sure pickslipno is selected properly    (jamesxx)
      --IF ISNULL(@cPickSlipNo, '') = ''           -- (james37)
      --BEGIN
      IF ISNULL(@cOrderKey, '') <> ''  -- By OrderKey
      BEGIN
         SELECT @cPickSlipNo = PickHeaderKey
         FROM dbo.PickHeader PH WITH (NOLOCK)
         JOIN dbo.Orders O WITH (NOLOCK) ON PH.WaveKey = O.UserDefine09 AND PH.OrderKey = O.OrderKey
         JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey
         WHERE (( @nMultiStorer = 1 AND OD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND OD.StorerKey = @cStorerKey))
            AND O.OrderKey = @cOrderKey
            AND PH.Status = '0'

         -- If not wave plan, look in loadplan
         IF ISNULL(@cPickSlipNo, '') = ''
         BEGIN
            SELECT @cPickSlipNo = PickHeaderKey
            FROM dbo.PickHeader PH WITH (NOLOCK)
            JOIN dbo.Orders O WITH (NOLOCK) ON PH.ExternOrderKey = O.LoadKey
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey
            WHERE (( @nMultiStorer = 1 AND OD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND OD.StorerKey = @cStorerKey))
               AND O.OrderKey = @cOrderKey
               AND PH.Status = '0'
         END

         -- Not in wave, not in load then check 4 discrete pickslip
         IF ISNULL(@cPickSlipNo, '') = ''
         BEGIN
            SELECT @cPickSlipNo = PickHeaderKey
            FROM dbo.PickHeader PH WITH (NOLOCK)
            WHERE PH.OrderKey = @cOrderKey
               AND PH.Status = '0'
         END
      END
      ELSE
      IF ISNULL(@cLoadKey, '') <> ''   -- By LoadKey
      BEGIN
         SELECT @cPickSlipNo = PickHeaderKey
         FROM dbo.PickHeader WITH (NOLOCK)
         WHERE ExternOrderKey = @cLoadKey
         AND   Status = '0'
      END
      ELSE
      IF ISNULL(@cWaveKey, '') <> ''   -- SOS# 307304
      BEGIN                            -- By WaveKey
         SELECT @cPickSlipNo = PickHeaderKey
         FROM dbo.PickHeader WITH (NOLOCK)
         WHERE WaveKey = @cWaveKey
         AND   Status = '0'
      END
      --END

      -- Auto scan in pickslip if config turned on (james30)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickAutoScanIn', @cStorerKey) = '1' AND
         ISNULL( @cPickSlipNo, '') <> ''
      BEGIN
         -- if key in orderkey then do scanning
         IF ISNULL(@cOrderKey, '') <> '' OR
            -- if no orderkey key in, no prev orderkey key in and 1 of the wave or load key in
            ( ISNULL(@cOrderKey, '') = '' AND ISNULL(@cLastOrderKey, '') = '' AND
            ( ISNULL(@cWaveKey, '') <> '' OR ISNULL(@cLoadKey, '') <> ''))
         BEGIN
            IF ISNULL(@cOrderKey, '') <> ''
            BEGIN
               --Check if PickSlipNo exists in pickinginfo
               IF NOT EXISTS ( SELECT 1
                               FROM dbo.PickingInfo WITH (NOLOCK)
                               WHERE PickSlipNo = @cPickSlipNo)
               BEGIN
                  INSERT INTO dbo.PickingInfo
                  (PickSlipNo, ScanInDate, PickerID )
                  Values(@cPickSlipNo, GETDATE(), sUser_sName())

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 69379
                     SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'SCAN IN FAIL'
                     GOTO Step_3_Fail
                  END
               END   -- Insert pickinginfo
               ELSE
               BEGIN
                  UPDATE dbo.PickingInfo WITH (ROWLOCK) SET
                     ScanInDate = GETDATE(),
                     PickerID = sUser_sName()
                  WHERE PickSlipNo = @cPickSlipNo
                  AND   ScanInDate IS NULL

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 69380
                     SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'SCAN IN FAIL'
                     GOTO Step_3_Fail
                  END
               END   -- Update pickinginfo
            END
            ELSE
            BEGIN
               -- Rules. If key in wavekey as filter then pickslip must have wavekey stamp and loadkey is optional
               --        If key in loadkey as filter then pickslip must have externorderkey stamp and 1 loadkey will not have 2 wavekey
               IF ISNULL( @cWaveKey, '') <> '' AND ISNULL( @cLoadKey, '') <> ''
                  DECLARE CUR_PICKINGINFO CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
                  SELECT PickHeaderKey FROM dbo.PickHeader WITH (NOLOCK)
                  WHERE WaveKey = @cWaveKey
                  AND   ExternOrderKey = @cLoadKey
                  AND   [Status] = '0'

               IF ISNULL( @cWaveKey, '') <> '' AND ISNULL( @cLoadKey, '') = ''
                  DECLARE CUR_PICKINGINFO CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
                  SELECT PickHeaderKey FROM dbo.PickHeader WITH (NOLOCK)
                  WHERE WaveKey = @cWaveKey
                  AND   [Status] = '0'

               IF ISNULL( @cWaveKey, '') = '' AND ISNULL( @cLoadKey, '') <> ''
               -- Rules. If key in loadkey as filter then pickslip must have externorderkey stamp and 1 loadkey will not have 2 wavekey
                  DECLARE CUR_PICKINGINFO CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
                  SELECT PickHeaderKey FROM dbo.PickHeader WITH (NOLOCK)
                  WHERE ExternOrderKey = @cLoadKey
                  AND   [Status] = '0'

               OPEN CUR_PICKINGINFO
               FETCH NEXT FROM CUR_PICKINGINFO INTO @cPickHeaderKey
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  --Check if PickSlipNo exists in pickinginfo
                  IF NOT EXISTS ( SELECT 1
                                  FROM dbo.PickingInfo WITH (NOLOCK)
                                  WHERE PickSlipNo = @cPickHeaderKey)
                  BEGIN
                     INSERT INTO dbo.PickingInfo
                     (PickSlipNo, ScanInDate, PickerID )
                     Values(@cPickHeaderKey, GETDATE(), sUser_sName())

                     IF @@ERROR <> 0
                     BEGIN
                        SET @nErrNo = 69379
                        SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'SCAN IN FAIL'
                        GOTO Step_3_Fail
                     END
                  END   -- Insert pickinginfo
                  ELSE
                  BEGIN
                     UPDATE dbo.PickingInfo WITH (ROWLOCK) SET
                        ScanInDate = GETDATE(),
                        PickerID = sUser_sName()
                     WHERE PickSlipNo = @cPickHeaderKey
                     AND   ScanInDate IS NULL

                     IF @@ERROR <> 0
                     BEGIN
                        SET @nErrNo = 69380
                        SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'SCAN IN FAIL'
                        GOTO Step_3_Fail
                     END   -- Update pickinginfo
                  END

                  FETCH NEXT FROM CUR_PICKINGINFO INTO @cPickHeaderKey
               END
               CLOSE CUR_PICKINGINFO
               DEALLOCATE CUR_PICKINGINFO
            END
         END
      END

      -- This part only for discrete pick slip
      IF EXISTS ( SELECT 1
                  FROM dbo.PickHeader PH WITH (NOLOCK)
                  WHERE PH.PickHeaderKey = @cPickSlipNo    -- SOS# 176144
                  AND ISNULL(RTRIM(PH.ORderkey), '') = '') -- SOS# 176144
      BEGIN
         SET @cPickSlipType = 'CONSO'
      END
      ELSE
      BEGIN
         SET @cPickSlipType = 'SINGLE'
      END

      IF EXISTS (SELECT 1 FROM dbo.LoadPlan WITH (NOLOCK)
                 WHERE LoadKey = @cLoadKey
                 AND LoadPickMethod = 'C')
      BEGIN
         SET @cPickSlipType = 'CONSO'
      END

      -- SOS# 307304 (Start)
      SET @d_StartTime   = GETDATE()
      SET @d_EndTime     = GETDATE()
      SET @c_TraceUserId = SUSER_SNAME()
      SET @c_TraceNotes  = '1b/' + CAST(@nMobile AS VARCHAR(10))
      EXEC isp_InsertTraceInfo
           @c_TraceCode = 'CLUSTERPICK'
         , @c_TraceName = 'rdtfnc_Cluster_Pick'
         , @c_StartTime = @d_StartTime
         , @c_EndTime   = @d_EndTime
         , @c_Step1     = @cOrderKey
         , @c_Step2     = @cWaveKey
         , @c_Step3     = @cLoadKey
         , @c_Step4     = @nMultiStorer
         , @c_Step5     = @cPickSlipNo
         , @c_Col1      = @cPickSlipType
         , @c_Col2      = @cORD_StorerKey
         , @c_Col3      = @cStorerKey
         , @c_Col4      = @c_TraceNotes
         , @c_Col5      = @c_TraceUserId
         , @b_Success   = 1
         , @n_Err       = 0
         , @c_ErrMsg    = ''
      -- SOS# 307304 (End)

      -- If configkey turned on, start insert Pack Header (James05)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickInsPackDt', @cStorerKey) = '1'
      BEGIN
         IF rdt.RDTGetConfig( @nFunc, 'InsDiscretePackHdrInfo', @cStorerKey) <> '1'
         BEGIN
            IF @cPickSlipType = 'SINGLE'
            BEGIN
               IF NOT EXISTS (SELECT 1 FROM dbo.PackHeader WITH (NOLOCK) WHERE Pickslipno = @cPickSlipNo)
               BEGIN
                  BEGIN TRAN

                  INSERT INTO dbo.PackHeader
                  (Route, OrderKey, OrderRefNo, Loadkey, Consigneekey, StorerKey, PickSlipNo)
                  SELECT O.Route, O.OrderKey, SUBSTRING(O.ExternOrderKey, 1, 18), O.LoadKey, O.ConsigneeKey, O.Storerkey, @cPickSlipNo -- SOS# 176144
                  FROM  dbo.PickHeader PH WITH (NOLOCK)
                  JOIN  dbo.Orders O WITH (NOLOCK) ON (PH.Orderkey = O.Orderkey)
                  WHERE PH.PickHeaderKey = @cPickSlipNo
                    AND (( @nMultiStorer = 1 AND O.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND O.StorerKey = @cStorerKey))

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65962
                     SET @cErrMsg = rdt.rdtgetmessage( 65962, @cLangCode, 'DSP') --'InsPHdrFail'
                     ROLLBACK TRAN
                     GOTO Step_3_Fail
                  END

                  COMMIT TRAN
               END
            END
            ELSE  -- IF @cPickSlipType = 'CONSO'
            BEGIN
               IF NOT EXISTS (SELECT 1 FROM dbo.PackHeader WITH (NOLOCK) WHERE Pickslipno = @cPickSlipNo)
               BEGIN
                  BEGIN TRAN

                  INSERT INTO dbo.PackHeader
                  (Route, OrderKey, OrderRefNo, Loadkey, Consigneekey, StorerKey, PickSlipNo)
                  SELECT DISTINCT ISNULL(LP.Route,''), '', '', LP.LoadKey, '', O.StorerKey, @cPickSlipNo
                  FROM  dbo.LOADPLANDETAIL LPD WITH (NOLOCK)
                  JOIN  dbo.LOADPLAN LP WITH (NOLOCK) ON (LP.LoadKey = LPD.LoadKey)
                  JOIN  dbo.ORDERS O WITH (NOLOCK) ON (O.OrderKey = LPD.OrderKey)
                  JOIN  dbo.PICKHEADER PH WITH (NOLOCK) ON (PH.ExternOrderKey = LPD.LoadKey)
                  WHERE PH.PickHeaderKey = @cPickSlipNo
                    AND (( @nMultiStorer = 1 AND O.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND O.StorerKey = @cStorerKey))

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65974
                     SET @cErrMsg = rdt.rdtgetmessage( 65974, @cLangCode, 'DSP') --'InsPHdrFail'
                     ROLLBACK TRAN
                     GOTO Step_3_Fail
                  END

                  COMMIT TRAN
               END
            END
         END  -- 'InsDiscretePackHdrInfo'
      END   -- 'ClusterPickInsPackDt'

      -- If LoadKey is blank, retrieve respective loadkey (james04)
      IF ISNULL(@cLoadKey, '') = ''
      BEGIN
         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey
      END

      -- (james41)
      IF @cExtendedValidateSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.objects WHERE name = @cExtendedValidateSP AND type = 'P')
         BEGIN
            SET @nErrNo = 0
            SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedValidateSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cLoc                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@nQty                      INT, '           +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                  @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

            IF @nErrNo <> 0
               GOTO Step_3_Fail
         END
      END

      -- If blank OrderKey and at least scanned one OrderKey
      IF ISNULL(@cOrderKey, '') = '' AND ISNULL(@cLastOrderKey, '') <> ''
      BEGIN
         GOTO Get_PutAwayZone
      END

      -- If blank OrderKey and no scanned OrderKey
      IF ISNULL(@cOrderKey, '') = '' AND ISNULL(@cLastOrderKey, '') = ''
      BEGIN
         IF NOT EXISTS (SELECT 1 FROM dbo.PickDetail PD WITH (NOLOCK)
                        JOIN dbo.OrderDetail OD WITH (NOLOCK) ON PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber
                        JOIN dbo.Orders O WITH (NOLOCK) ON OD.OrderKey = O.OrderKey
                        WHERE (( @nMultiStorer = 1) OR ( PD.StorerKey = @cStorerKey))
                           AND (( @nMultiStorer = 1) OR ( O.StorerKey = @cStorerKey))
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                           AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                           AND PD.Status = '0')
         -- If no task
         BEGIN
            SET @nErrNo = 65913
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'No more task'
            GOTO Step_3_Fail
         END

         IF ISNULL( @cWaveKey, '') <> '' AND ISNULL( @cLoadKey, '') <> ''
         BEGIN
            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
            , LOT, LOC, Status, AddWho, AddDate, PickSlipNo, Mobile)
            SELECT O.UserDefine09, ISNULL(RTRIM(O.LoadKey),''), O.OrderKey, '', O.StorerKey, '', '', O.OrderKey
            , '', '', '1', @cUserName AS UserName, GETDATE(), @cPickSlipNo AS PickSlipNo, @nMobile as Mobile
            FROM dbo.Orders O WITH (NOLOCK)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (O.OrderKey = OD.OrderKey) -- (james07) & (james09)
            WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
               AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
               AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
               AND OD.Status >= '1'
               AND OD.Status < '5'
            GROUP BY O.UserDefine09, O.LoadKey, O.OrderKey, O.Storerkey
         END
         ELSE IF ISNULL( @cWaveKey, '') <> '' AND ISNULL( @cLoadKey, '') = ''
         BEGIN
            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
            , LOT, LOC, Status, AddWho, AddDate, PickSlipNo, Mobile)
            SELECT O.UserDefine09, ISNULL(RTRIM(O.LoadKey),''), O.OrderKey, '', O.StorerKey, '', '', O.OrderKey
            , '', '', '1', @cUserName AS UserName, GETDATE(), @cPickSlipNo AS PickSlipNo, @nMobile as Mobile
            FROM dbo.Orders O WITH (NOLOCK)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (O.OrderKey = OD.OrderKey) -- (james07) & (james09)
            WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
               AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
               AND OD.Status >= '1'
               AND OD.Status < '5'
               AND NOT EXISTS ( SELECT 1 FROM RDT.rdtPickLock RPL WITH (NOLOCK)    -- INC1408845
                                WHERE RPL.Orderkey = O.OrderKey
                                AND   RPL.WaveKey = O.UserDefine09
                                AND   RPL.Storerkey = O.StorerKey
                                AND   RPL.[Status] = '1'
                                AND   RPL.AddWho = @cUserName)
            GROUP BY O.UserDefine09, O.LoadKey, O.OrderKey, O.Storerkey
         END
         ELSE
         BEGIN
            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
            , LOT, LOC, Status, AddWho, AddDate, PickSlipNo, Mobile)
            SELECT O.UserDefine09, ISNULL(RTRIM(O.LoadKey),''), O.OrderKey, '', O.StorerKey, '', '', O.OrderKey
            , '', '', '1', @cUserName AS UserName, GETDATE(), @cPickSlipNo AS PickSlipNo, @nMobile as Mobile
            FROM dbo.Orders O WITH (NOLOCK)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (O.OrderKey = OD.OrderKey) -- (james07) & (james09)
            WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
               AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
               AND OD.Status >= '1'
               AND OD.Status < '5'
            GROUP BY O.UserDefine09, O.LoadKey, O.OrderKey, O.Storerkey
         END

         GOTO Get_PutAwayZone
      END

      IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                     WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
                     AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                     AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                     AND OrderKey = @cOrderKey
                     AND AddWho = @cUserName
                     AND Status = '1')
      BEGIN
         BEGIN TRAN

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

         -- Insert OrderKey scanned to picklock
         INSERT INTO RDT.RDTPickLock
         (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
         PutAwayZone, PickZone, PickDetailKey
         , LOT, LOC, Status, AddWho, AddDate, PickSlipNo, Mobile)
         VALUES
         (@cWaveKey, @cLoadKey, @cOrderKey, '*', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
         '', '', @cOrderKey
         , '', '', '1', @cUserName, GETDATE(), @cPickSlipNo, @nMobile)

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65910
            SET @cErrMsg = rdt.rdtgetmessage( 65910, @cLangCode, 'DSP') --'LockOrdersFail'
            ROLLBACK TRAN
            GOTO Step_3_Fail
         END

         COMMIT TRAN

         SET @nOrdCount = @nOrdCount + 1
         SET @cLastOrderKey = @cOrderKey

         SET @cOutField01 = CASE WHEN ISNULL(@cWaveKey, '') = '' THEN '' ELSE @cWaveKey END --WaveKey
         SET @cOutField02 = CASE WHEN ISNULL(@cLoadKey, '') = '' THEN '' ELSE @cLoadKey END --LoadKey
         SET @cOutField03 = ''
         SET @cOutField04 = @cLastOrderKey
         SET @cOutField05 = @nOrdCount
         GOTO Quit
   END
   ELSE
   BEGIN
      SET @nErrNo = 65911
      SET @cErrMsg = rdt.rdtgetmessage( 65911, @cLangCode, 'DSP') --'OrdersAlrdLocked'
      GOTO Step_3_Fail
   END

   GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      SET @nTranCount = @@TRANCOUNT

      BEGIN TRAN
      SAVE TRAN Step3_Update

      -- Release orders scanned from RDTPickLock
      DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
      SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE AddWho = @cUserName
      AND   Status IN ('1', 'X')
      AND   (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
      OPEN CUR_DEL
      FETCH NEXT FROM CUR_DEL INTO @nRowRef
      WHILE @@FETCH_STATUS <> -1
      BEGIN
         DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE RowRef = @nRowRef

         IF @@ERROR <> 0
         BEGIN
            ROLLBACK TRAN Step3_Update
            WHILE @@TRANCOUNT > @nTranCount
               COMMIT TRAN

            CLOSE CUR_DEL
            DEALLOCATE CUR_DEL
            SET @nErrNo = 65912
            SET @cErrMsg = rdt.rdtgetmessage( 65912, @cLangCode, 'DSP') --'ReleaseMobFail'
            GOTO Quit
         END
         FETCH NEXT FROM CUR_DEL INTO @nRowRef
      END
      CLOSE CUR_DEL
      DEALLOCATE CUR_DEL

      DECLARE CUR_UPD CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
      SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE ADDWHO = @cUserName
      AND   PickDetailKey <> ''
      OPEN CUR_UPD
      FETCH NEXT FROM CUR_UPD INTO @nRowRef
      WHILE @@FETCH_STATUS <> -1
      BEGIN
         UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
            PickDetailKey = ''
         WHERE RowRef = @nRowRef

         IF @@ERROR <> 0
         BEGIN
            ROLLBACK TRAN Step3_Update
            WHILE @@TRANCOUNT > @nTranCount
               COMMIT TRAN

            CLOSE CUR_UPD
            DEALLOCATE CUR_UPD
            SET @nErrNo = 65912
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'ReleaseMobFail'
            GOTO Quit
         END
         FETCH NEXT FROM CUR_UPD INTO @nRowRef
      END
      CLOSE CUR_UPD
      DEALLOCATE CUR_UPD

      COMMIT TRAN Step3_Update
      WHILE @@TRANCOUNT > @nTranCount
            COMMIT TRAN

      -- Go to prev screen
      SET @nScn  = 1871
      SET @nStep = 2

      SET @cOutField01 = CASE WHEN ISNULL(@cWaveKey, '') = '' THEN '' ELSE @cWaveKey END
      SET @cOutField02 = ''

      SET @cLoadKey = ''
   END

   GOTO Quit

   Step_3_Fail:
   BEGIN
      SET @cOutField01 = CASE WHEN ISNULL(@cWaveKey, '') = '' THEN '' ELSE @cWaveKey END --WaveKey
      SET @cOutField02 = CASE WHEN ISNULL(@cLoadKey, '') = '' THEN '' ELSE @cLoadKey END --LoadKey
      SET @cOutField03 = ''
      SET @cOrderKey = ''
   END
   GOTO Quit

   Get_PutAwayZone:
   BEGIN TRAN
   -- If configkey turned on then insert packheader with discrete order information (james10)
   IF rdt.RDTGetConfig( @nFunc, 'InsDiscretePackHdrInfo', @cStorerKey) = '1'
   BEGIN
      DECLARE CUR_INSPACKHDR CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
      SELECT DISTINCT OrderKey FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
         AND AddWho = @cUserName
         AND Status = '1'
      OPEN CUR_INSPACKHDR
      FETCH NEXT FROM CUR_INSPACKHDR INTO @cOrderKey
      WHILE @@FETCH_STATUS <> -1
      BEGIN
         IF NOT EXISTS (SELECT 1 FROM dbo.PackHeader WITH (NOLOCK) WHERE OrderKey = @cOrderKey)
         BEGIN
            INSERT INTO dbo.PackHeader
            (Route, OrderKey, OrderRefNo, Loadkey, Consigneekey, StorerKey, PickSlipNo)
            SELECT O.Route, O.OrderKey, SUBSTRING(O.ExternOrderKey, 1, 18), O.LoadKey, O.ConsigneeKey, O.Storerkey, PH.PickHeaderKey
            FROM  dbo.PickHeader PH WITH (NOLOCK)
            JOIN  dbo.Orders O WITH (NOLOCK) ON (PH.Orderkey = O.Orderkey)
            WHERE (( @nMultiStorer = 1) OR ( O.StorerKey = @cStorerKey))
               AND O.OrderKey = @cOrderKey
               AND NOT EXISTS (SELECT 1 FROM dbo.PackHeader PAH WITH (NOLOCK)
                  WHERE PAH.StorerKey = O.StorerKey AND O.OrderKey = PAH.OrderKey)
         END

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 69347
            SET @cErrMsg = rdt.rdtgetmessage( 69347, @cLangCode, 'DSP') --'InsPHdrFail'
            ROLLBACK TRAN
            GOTO Step_3_Fail
         END

         FETCH NEXT FROM CUR_INSPACKHDR INTO @cOrderKey
      END
      CLOSE CUR_INSPACKHDR
      DEALLOCATE CUR_INSPACKHDR
   END

   COMMIT TRAN

   -- Clear the output first
   SET @cOutField07 = ''
   SET @cOutField08 = ''
   SET @cOutField09 = ''
   SET @cOutField10 = ''
   SET @cOutField11 = ''


   -- Clear the variable first
   SET @nLoop = 0
   SET @cPutAwayZone = ''
   SET @cPutAwayZone01 = ''
   SET @cPutAwayZone02 = ''
   SET @cPutAwayZone03 = ''
   SET @cPutAwayZone04 = ''
   SET @cPutAwayZone05 = ''
   SET @cLastPAZone = '' -- SOS# 237003

   IF EXISTS ( SELECT 1 FROM dbo.CODELKUP WITH (NOLOCK) WHERE ListName = 'CLPLOCTYPE' AND ISNULL( CODE, '') <> '' AND StorerKey = @cStorerKey)
      DECLARE curPutAwayZone CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
      SELECT DISTINCT L.PutawayZone
      FROM RDT.RDTPickLock RPL WITH (NOLOCK)
      JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.OrderKey = PD.OrderKey)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
      JOIN dbo.CODELKUP CLK WITH (NOLOCK) ON ( L.LocationType = CLK.Code AND PD.StorerKey = CLK.Storerkey AND ListName = 'CLPLOCTYPE')
      WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
         AND (( ISNULL( @cWaveKey, '') = '') OR ( RPL.WaveKey = @cWaveKey))
         AND (( ISNULL(@cLoadKey, '') = '') OR ( RPL.LoadKey = @cLoadKey))
         AND RPL.Status = '1'
         AND RPL.AddWho = @cUserName
         AND PD.Status = '0'
         AND L.Facility = @cFacility
      ORDER BY L.PutawayZone
   ELSE
      DECLARE curPutAwayZone CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
      SELECT DISTINCT L.PutawayZone
      FROM RDT.RDTPickLock RPL WITH (NOLOCK)
      JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.OrderKey = PD.OrderKey)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
      WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
         AND (( ISNULL( @cWaveKey, '') = '') OR ( RPL.WaveKey = @cWaveKey))
         AND (( ISNULL(@cLoadKey, '') = '') OR ( RPL.LoadKey = @cLoadKey))
         AND RPL.Status = '1'
         AND RPL.AddWho = @cUserName
         AND PD.Status = '0'
         AND L.Facility = @cFacility
      ORDER BY L.PutawayZone

   OPEN curPutAwayZone
   FETCH NEXT FROM curPutAwayZone INTO @cPutAwayZone
   WHILE @@FETCH_STATUS <> -1
   BEGIN
      IF @nLoop = 0
      BEGIN
         SET @cOutField07 = @cPutAwayZone
         SET @cPutAwayZone01 = @cPutAwayZone
         SET @cOutField15 = @cPutAwayZone -- SOS# 237003
      END
      IF @nLoop = 1
      BEGIN
         SET @cOutField08 = @cPutAwayZone
         SET @cPutAwayZone02 = @cPutAwayZone
         SET @cOutField15 = @cPutAwayZone -- SOS# 237003
      END
      IF @nLoop = 2
      BEGIN
         SET @cOutField09 = @cPutAwayZone
         SET @cPutAwayZone03 = @cPutAwayZone
         SET @cOutField15 = @cPutAwayZone -- SOS# 237003
      END
      IF @nLoop = 3
      BEGIN
         SET @cOutField10 = @cPutAwayZone
         SET @cPutAwayZone04 = @cPutAwayZone
         SET @cOutField15 = @cPutAwayZone -- SOS# 237003
      END
      IF @nLoop = 4
      BEGIN
         SET @cOutField11 = @cPutAwayZone
         SET @cPutAwayZone05 = @cPutAwayZone
         SET @cOutField15 = @cPutAwayZone -- SOS# 237003
      END

      SET @nLoop = @nLoop + 1
      IF @nLoop = 5 BREAK

      FETCH NEXT FROM curPutAwayZone INTO @cPutAwayZone
   END
   CLOSE curPutAwayZone
   DEALLOCATE curPutAwayZone

   -- If no task
   IF ISNULL(@cOutField07, '') = ''
   BEGIN
      SET @nErrNo = 65913
      SET @cErrMsg = rdt.rdtgetmessage( 65913, @cLangCode, 'DSP') --'No more task'
      GOTO Step_3_Fail
   END

   IF EXISTS ( SELECT 1 FROM dbo.CODELKUP WITH (NOLOCK) WHERE ListName = 'CLPLOCTYPE' AND ISNULL( CODE, '') <> '' AND StorerKey = @cStorerKey)
   BEGIN
      SET @cOutField01 = ''
      SET @cOutField12 = ''
      SET @cFieldAttr01 = 'O'
      SET @cFieldAttr12 = 'O'
   END
   ELSE
   BEGIN
      SET @cOutField01 = ''
      SET @cOutField12 = 'ALL'
      EXEC rdt.rdtSetFocusField @nMobile, 1
   END

   SET @cOutField02 = ''
   SET @cOutField03 = ''
   SET @cOutField04 = ''
   SET @cOutField05 = ''
   SET @cOutField06 = ''

   SET @cInField01 = ''
   SET @cInField02 = ''
   SET @cInField03 = ''
   SET @cInField04 = ''
   SET @cInField05 = ''
   SET @cInField06 = ''

   -- Go to next screen
   SET @nScn  = 1873
   SET @nStep = 4

   GOTO Quit
END
GOTO Quit

/********************************************************************************
Step 4. Screen = 1873
   ALL     (field01, input)
   PutAwayZone01   (field02, input)
   PutAwayZone03   (field03, input)
   PutAwayZone04   (field04, input)
   PutAwayZone05   (field05, input)
   PutAwayZone06   (field06, input)
********************************************************************************/
Step_4:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      -- If blank option selected, retrieve next 5 putawayzone
      IF ISNULL(@cInField01, '') = ''   -- All
      AND ISNULL(@cInField02, '') = ''   -- PutAwayZone01
      AND ISNULL(@cInField03, '') = ''   -- PutAwayZone02
      AND ISNULL(@cInField04, '') = ''   -- PutAwayZone03
      AND ISNULL(@cInField05, '') = ''   -- PutAwayZone04
      AND ISNULL(@cInField06, '') = ''   -- PutAwayZone05
      BEGIN
         GOTO Get_Next5PutAwayZone
      END

      -- If not '1' or blank
     IF (ISNULL(@cInField01, '') <> '' AND @cInField01 <> '1' )   -- All
      OR (ISNULL(@cInField02, '') <> '' AND @cInField02 <> '1' )   -- PutAwayZone01
      OR (ISNULL(@cInField03, '') <> '' AND @cInField03 <> '1' )   -- PutAwayZone02
      OR (ISNULL(@cInField04, '') <> '' AND @cInField04 <> '1' )   -- PutAwayZone03
      OR (ISNULL(@cInField05, '') <> '' AND @cInField05 <> '1' )   -- PutAwayZone04
      OR (ISNULL(@cInField06, '') <> '' AND @cInField06 <> '1' )   -- PutAwayZone05
      BEGIN
         SET @nErrNo = 65914
         SET @cErrMsg = rdt.rdtgetmessage( 65914, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_4_Fail
      END

      -- If non of the option selected
      IF @cInField01 <> '1'   -- All
      AND @cInField02 <> '1'   -- PutAwayZone01
      AND @cInField03 <> '1'   -- PutAwayZone02
      AND @cInField04 <> '1'   -- PutAwayZone03
      AND @cInField05 <> '1'   -- PutAwayZone04
      AND @cInField06 <> '1'   -- PutAwayZone05
      BEGIN
         SET @nErrNo = 65915
         SET @cErrMsg = rdt.rdtgetmessage( 65915, @cLangCode, 'DSP') --No Selection
         GOTO Step_4_Fail
      END

      -- If more than one option selected
      IF (@cInField01 = '1' AND (@cInField02 = '1' OR @cInField03 = '1' OR @cInField04 = '1' OR @cInField05 = '1' OR @cInField06 = '1'))
         OR (@cInField02 = '1' AND (@cInField01 = '1' OR @cInField03 = '1' OR @cInField04 = '1' OR @cInField05 = '1' OR @cInField06 = '1'))
         OR (@cInField03 = '1' AND (@cInField01 = '1' OR @cInField02 = '1' OR @cInField04 = '1' OR @cInField05 = '1' OR @cInField06 = '1'))
         OR (@cInField04 = '1' AND (@cInField01 = '1' OR @cInField02 = '1' OR @cInField03 = '1' OR @cInField05 = '1' OR @cInField06 = '1'))
         OR (@cInField05 = '1' AND (@cInField01 = '1' OR @cInField02 = '1' OR @cInField03 = '1' OR @cInField04 = '1' OR @cInField06 = '1'))
         OR (@cInField06 = '1' AND (@cInField01 = '1' OR @cInField02 = '1' OR @cInField03 = '1' OR @cInField04 = '1' OR @cInField05 = '1'))
      BEGIN
         SET @nErrNo = 65916
         SET @cErrMsg = rdt.rdtgetmessage( 65916, @cLangCode, 'DSP') --Only1ZoneAllow
         GOTO Step_4_Fail
      END

      IF @cInField01 = '1'
      BEGIN
         SET @nTranCount = @@TRANCOUNT

         BEGIN TRAN
         SAVE TRAN Step4_Update

         SET @cPutAwayZone = 'ALL'

         DECLARE CUR_UPD CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE Status = '1'
         AND   AddWho = @cUserName
         OPEN CUR_UPD
         FETCH NEXT FROM CUR_UPD INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
               PutAwayZone = @cPutAwayZone
            WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               ROLLBACK TRAN Step4_Update
               WHILE @@TRANCOUNT > @nTranCount
                  COMMIT TRAN

               CLOSE CUR_UPD
               DEALLOCATE CUR_UPD
               SET @nErrNo = 65917
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'UPDPWZoneFail'
               GOTO Step_4_Fail
            END
            FETCH NEXT FROM CUR_UPD INTO @nRowRef
         END
         CLOSE CUR_UPD
         DEALLOCATE CUR_UPD

         COMMIT TRAN Step4_Update
         WHILE @@TRANCOUNT > @nTranCount
               COMMIT TRAN
      END
      ELSE
      BEGIN
         IF ISNULL(@cInField02, '') = '1'
            SET @cPutAwayZone = @cOutField07

         IF ISNULL(@cInField03, '') = '1'
            SET @cPutAwayZone = @cOutField08

         IF ISNULL(@cInField04, '') = '1'
            SET @cPutAwayZone = @cOutField09

         IF ISNULL(@cInField05, '') = '1'
            SET @cPutAwayZone = @cOutField10

         IF ISNULL(@cInField06, '') = '1'
            SET @cPutAwayZone = @cOutField11

         BEGIN TRAN

         -- Update only respective orders with putawayzone
         UPDATE RPL WITH (ROWLOCK) SET
            RPL.PutAwayZone = @cPutAwayZone
         FROM RDT.RDTPickLock RPL
         JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey) -- (Vicky01)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC) -- (Vicky01)
         WHERE RPL.Status = '1'
            AND RPL.AddWho = @cUserName
            AND (( @nMultiStorer = 1) OR ( PD.StorerKey = @cStorerKey))
            AND PD.Status = '0'
            AND L.Facility = @cFacility
            AND L.PutAwayZone = @cPutAwayZone

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65918
            SET @cErrMsg = rdt.rdtgetmessage( 65918, @cLangCode, 'DSP') --'UPDPWZoneFail'
            ROLLBACK TRAN
            GOTO Step_4_Fail
         END

         COMMIT TRAN
      END

      -- If there exists any handheld has been idle more than allowable time, release locking
      SET @cAllowableIdleTime = rdt.RDTGetConfig( @nFunc, 'AllowableIdleTime', @cStorerKey)
      IF CAST(@cAllowableIdleTime AS INT) > 0
      BEGIN
         SET @curReleaseLock = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
         SELECT MOBILE FROM RDT.RDTMobRec WITH (NOLOCK)
         WHERE Facility = @cFacility
            AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND DATEDIFF(HH, EditDate, GETDATE()) >= CAST(@cAllowableIdleTime AS INT)
            AND Step > 0
         OPEN @curReleaseLock
         FETCH NEXT FROM @curReleaseLock INTO @nRDTMobile
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            BEGIN TRAN

            UPDATE RDT.RDTMobRec WITH (ROWLOCK) SET
            Scn = 0, Step = 0, Menu = 0, Func = 0
            WHERE Mobile = @nRDTMobile

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65919
               SET @cErrMsg = rdt.rdtgetmessage( 65919, @cLangCode, 'DSP') --'ReleaseMobFail'
               ROLLBACK TRAN
               CLOSE @curReleaseLock
               DEALLOCATE @curReleaseLock
               GOTO Step_4_Fail
            END

            DELETE RPL
            FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN RDT.RDTMobRec RMB WITH (NOLOCK) ON (RPL.StorerKey = RMB.StorerKey AND RPL.AddWho = RMB.UserName)
            WHERE RMB.Mobile = @nRDTMobile
               AND (( @nMultiStorer = 1) OR ( RMB.StorerKey = @cStorerKey))
               AND RPL.Status < '9'

            IF @@ERROR <> 0
               BEGIN
               SET @nErrNo = 65920
               SET @cErrMsg = rdt.rdtgetmessage( 65920, @cLangCode, 'DSP') --'ReleaseMobFail'
               ROLLBACK TRAN
               CLOSE @curReleaseLock
               DEALLOCATE @curReleaseLock
               GOTO Step_4_Fail
            END

            COMMIT TRAN

            FETCH NEXT FROM @curReleaseLock INTO @nRDTMobile
         END
         CLOSE @curReleaseLock
         DEALLOCATE @curReleaseLock
      END

      -- Prep next screen var
      SET @cOutField01 = '' --Pick Zone

      -- Go to next screen
      SET @nScn  = 1874
      SET @nStep = 5

      SET @cFieldAttr01 = ''
      SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = ''
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = ''

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- Release lock
      SET @nTranCount = @@TRANCOUNT

      BEGIN TRAN
      SAVE TRAN Step4_Update

      DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
      SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
      AND   AddWho = @cUserName
      AND   Status IN ('1', 'X')
      OPEN CUR_DEL
      FETCH NEXT FROM CUR_DEL INTO @nRowRef
      WHILE @@FETCH_STATUS <> -1
      BEGIN
         DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE RowRef = @nRowRef

         IF @@ERROR <> 0
         BEGIN
            ROLLBACK TRAN Step4_Update
            WHILE @@TRANCOUNT > @nTranCount
               COMMIT TRAN

            CLOSE CUR_DEL
            DEALLOCATE CUR_DEL
            SET @nErrNo = 65921
            SET @cErrMsg = rdt.rdtgetmessage( 65921, @cLangCode, 'DSP') --'ReleaseMobFail'
            GOTO Quit
         END

         FETCH NEXT FROM CUR_DEL INTO @nRowRef
      END
      CLOSE CUR_DEL
      DEALLOCATE CUR_DEL

      COMMIT TRAN Step4_Update
      WHILE @@TRANCOUNT > @nTranCount
            COMMIT TRAN

      SET @cLastOrderKey = ''
      SET @nOrdCount = ''
      SET @cOrderKey = '' -- SOS# 307304

      SET @cOutField01 = CASE WHEN ISNULL(@cWaveKey, '') = '' THEN '' ELSE @cWaveKey END --WaveKey
      SET @cOutField02 = CASE WHEN ISNULL(@cLoadKey, '') = '' THEN '' ELSE @cLoadKey END --LoadKey
      SET @cOutField03 = ''
      SET @cOutField04 = ''
      SET @cOutField05 = ''

      -- Go to Prev screen
      SET @nScn  = 1872
      SET @nStep = 3

      SET @cFieldAttr01 = ''
      SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = ''
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = ''
   END

   GOTO Quit

   Step_4_Fail:
   BEGIN
      IF EXISTS ( SELECT 1 FROM dbo.CODELKUP WITH (NOLOCK) WHERE ListName = 'CLPLOCTYPE' AND ISNULL( CODE, '') <> '' AND StorerKey = @cStorerKey)
      BEGIN
         SET @cOutField01 = ''
         SET @cOutField12 = ''
         SET @cFieldAttr01 = 'O'
         SET @cFieldAttr12 = 'O'
      END
      ELSE
      BEGIN
         SET @cOutField01 = ''
         SET @cOutField12 = 'ALL'
         EXEC rdt.rdtSetFocusField @nMobile, 1
      END

      SET @cOutField02 = ''
      SET @cOutField03 = ''
      SET @cOutField04 = ''
      SET @cOutField05 = ''
      SET @cOutField06 = ''
      GOTO Quit
   END

   Get_Next5PutAwayZone:
   BEGIN
      SET @nZoneCount = 0
      SET @cLastPAZone = @cOutField15 -- SOS# 237003

      IF EXISTS ( SELECT 1 FROM dbo.CODELKUP WITH (NOLOCK) WHERE ListName = 'CLPLOCTYPE' AND ISNULL( CODE, '') <> '' AND StorerKey = @cStorerKey)
         SELECT @nZoneCount = COUNT(LOC.PutawayZone)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.OrderDetail OD WITH (NOLOCK)
            ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber) -- (james09)
         JOIN dbo.LOC LOC WITH (NOLOCK) ON PD.LOC = LOC.LOC
         JOIN dbo.CODELKUP CLK WITH (NOLOCK) ON ( LOC.LocationType = CLK.Code AND PD.StorerKey = CLK.Storerkey AND ListName = 'CLPLOCTYPE')
         WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
            AND PD.Status = '0'
            AND EXISTS ( SELECT 1 FROM RDT.rdtPickLock WITH (NOLOCK)
                                 WHERE Status = '1'
                                 AND OrderKey = PD.OrderKey
                                 AND Storerkey = PD.StorerKey
                                 AND AddWho = @cUserName)
            AND LOC.PutawayZone NOT IN (@cPutAwayZone01, @cPutAwayZone02, @cPutAwayZone03, @cPutAwayZone04, @cPutAwayZone05)
            AND LOC.PutawayZone > @cLastPAZone -- SOS# 237003
      ELSE
         SELECT @nZoneCount = COUNT(LOC.PutawayZone)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.OrderDetail OD WITH (NOLOCK)
            ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber) -- (james09)
         JOIN dbo.LOC LOC WITH (NOLOCK) ON PD.LOC = LOC.LOC
         WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
            AND PD.Status = '0'
            AND EXISTS ( SELECT 1 FROM RDT.rdtPickLock WITH (NOLOCK)
                                 WHERE Status = '1'
                                 AND OrderKey = PD.OrderKey
                                 AND Storerkey = PD.StorerKey
                                 AND AddWho = @cUserName)
            AND LOC.PutawayZone NOT IN (@cPutAwayZone01, @cPutAwayZone02, @cPutAwayZone03, @cPutAwayZone04, @cPutAwayZone05)
            AND LOC.PutawayZone > @cLastPAZone -- SOS# 237003

      -- If no task
      IF @nZoneCount = 0
      BEGIN
         SET @nErrNo = 65922
         SET @cErrMsg = rdt.rdtgetmessage( 65922, @cLangCode, 'DSP') --'No more PWZone'
         GOTO Step_4_Fail
      END

      -- Clear the variable first
      SET @nLoop = 0
      SET @cPutAwayZone = ''
      SET @cOutField07 = ''
      SET @cOutField08 = ''
      SET @cOutField09 = ''
      SET @cOutField10 = ''
      SET @cOutField11 = ''

      IF EXISTS ( SELECT 1 FROM dbo.CODELKUP WITH (NOLOCK) WHERE ListName = 'CLPLOCTYPE' AND ISNULL( CODE, '') <> '' AND StorerKey = @cStorerKey)
         DECLARE curPutAwayZone CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
         SELECT DISTINCT LOC.PutawayZone
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.OrderDetail OD WITH (NOLOCK)
            ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)    -- (james09)
         JOIN dbo.LOC LOC WITH (NOLOCK) ON PD.LOC = LOC.LOC
         JOIN dbo.CODELKUP CLK WITH (NOLOCK) ON ( LOC.LocationType = CLK.Code AND PD.StorerKey = CLK.Storerkey AND ListName = 'CLPLOCTYPE')
         WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
            AND PD.Status = '0'
            AND EXISTS ( SELECT 1 FROM RDT.rdtPickLock WITH (NOLOCK)
                                 WHERE Status = '1'
                                 AND OrderKey = PD.OrderKey
                                 AND Storerkey = PD.StorerKey--@cStorerKey
                                 AND AddWho = @cUserName)      -- tlting03
            AND LOC.PutawayZone NOT IN (@cPutAwayZone01, @cPutAwayZone02, @cPutAwayZone03, @cPutAwayZone04, @cPutAwayZone05)
            AND LOC.PutawayZone > @cLastPAZone -- SOS# 237003
         ORDER BY LOC.PutawayZone
      ELSE
         DECLARE curPutAwayZone CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
         SELECT DISTINCT LOC.PutawayZone
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.OrderDetail OD WITH (NOLOCK)
            ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)    -- (james09)
         JOIN dbo.LOC LOC WITH (NOLOCK) ON PD.LOC = LOC.LOC
         WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
            AND PD.Status = '0'
            AND EXISTS ( SELECT 1 FROM RDT.rdtPickLock WITH (NOLOCK)
                                 WHERE Status = '1'
                                 AND OrderKey = PD.OrderKey
                                 AND Storerkey = PD.StorerKey--@cStorerKey
                                 AND AddWho = @cUserName)      -- tlting03
            AND LOC.PutawayZone NOT IN (@cPutAwayZone01, @cPutAwayZone02, @cPutAwayZone03, @cPutAwayZone04, @cPutAwayZone05)
            AND LOC.PutawayZone > @cLastPAZone -- SOS# 237003
         ORDER BY LOC.PutawayZone
      OPEN curPutAwayZone
      FETCH NEXT FROM curPutAwayZone INTO @cPutAwayZone
      WHILE @@FETCH_STATUS <> -1
      BEGIN
         IF @nLoop = 0
         BEGIN
            SET @cOutField07 = @cPutAwayZone
            SET @cPutAwayZone01 = @cPutAwayZone
            SET @cOutField15 = @cPutAwayZone -- SOS# 237003
         END
         IF @nLoop = 1
         BEGIN
            SET @cOutField08 = @cPutAwayZone
            SET @cPutAwayZone02 = @cPutAwayZone
            SET @cOutField15 = @cPutAwayZone -- SOS# 237003
         END
         IF @nLoop = 2
         BEGIN
            SET @cOutField09 = @cPutAwayZone
            SET @cPutAwayZone03 = @cPutAwayZone
            SET @cOutField15 = @cPutAwayZone -- SOS# 237003
         END
         IF @nLoop = 3
         BEGIN
            SET @cOutField10 = @cPutAwayZone
            SET @cPutAwayZone04 = @cPutAwayZone
            SET @cOutField15 = @cPutAwayZone -- SOS# 237003
         END
         IF @nLoop = 4
         BEGIN
            SET @cOutField11 = @cPutAwayZone
            SET @cPutAwayZone05 = @cPutAwayZone
            SET @cOutField15 = @cPutAwayZone -- SOS# 237003
         END

         SET @nLoop = @nLoop + 1
         IF @nLoop = 5 BREAK

         FETCH NEXT FROM curPutAwayZone INTO @cPutAwayZone
      END
      CLOSE curPutAwayZone
      DEALLOCATE curPutAwayZone

      IF EXISTS ( SELECT 1 FROM dbo.CODELKUP WITH (NOLOCK) WHERE ListName = 'CLPLOCTYPE' AND ISNULL( CODE, '') <> '' AND StorerKey = @cStorerKey)
      BEGIN
         SET @cOutField01 = ''
         SET @cOutField12 = ''
         SET @cFieldAttr01 = 'O'
         SET @cFieldAttr12 = 'O'
         EXEC rdt.rdtSetFocusField @nMobile, 2
      END
      ELSE
      BEGIN
         SET @cOutField01 = ''
         SET @cOutField12 = 'ALL'
         EXEC rdt.rdtSetFocusField @nMobile, 1
      END

      SET @cOutField02 = ''
      SET @cOutField03 = ''
      SET @cOutField04 = ''
      SET @cOutField05 = ''
      SET @cOutField06 = ''

      SET @cPutAwayZone01 = CASE WHEN ISNULL(@cOutField07, '') = '' THEN '' ELSE @cPutAwayZone01 END
      SET @cPutAwayZone02 = CASE WHEN ISNULL(@cOutField08, '') = '' THEN '' ELSE @cPutAwayZone02 END
      SET @cPutAwayZone03 = CASE WHEN ISNULL(@cOutField09, '') = '' THEN '' ELSE @cPutAwayZone03 END
      SET @cPutAwayZone04 = CASE WHEN ISNULL(@cOutField10, '') = '' THEN '' ELSE @cPutAwayZone04 END
      SET @cPutAwayZone05 = CASE WHEN ISNULL(@cOutField11, '') = '' THEN '' ELSE @cPutAwayZone05 END

      -- SOS# 237003 (Start)
      IF ISNULL(RTRIM(@cPutAwayZone01),'') = ''
      BEGIN
         SET @cOutField15 = ''
      END

      IF ISNULL(RTRIM(@cPutAwayZone02),'') = ''
      BEGIN
         SET @cOutField15 = ''
      END

      IF ISNULL(RTRIM(@cPutAwayZone03),'') = ''
      BEGIN
         SET @cOutField15 = ''
      END

      IF ISNULL(RTRIM(@cPutAwayZone04),'') = ''
      BEGIN
         SET @cOutField15 = ''
      END

      IF ISNULL(RTRIM(@cPutAwayZone05),'') = ''
      BEGIN
         SET @cOutField15 = ''
      END
      -- SOS# 237003 (End)

      GOTO Quit
   END
END
GOTO Quit

/********************************************************************************
Step 5. Screen = 1874
   PICK ZONE     (field01, input)
********************************************************************************/
Step_5:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN

      SET @cPickZone = @cInField01

      --(james53)
      -- If PickZone keyed in
      IF ISNULL(@cPickZone, '') <> ''
      BEGIN
         --  Check whether PickZone exists in orders
         IF NOT EXISTS ( SELECT 1 FROM dbo.PICKDETAIL PD WITH (NOLOCK)
                         JOIN dbo.ORDERS O WITH (NOLOCK) ON ( PD.OrderKey = O.OrderKey)
                         JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                         WHERE (( @nMultiStorer = 1) OR ( O.StorerKey = @cStorerKey))
                         AND   (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                         AND   (( ISNULL( @cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                         AND   (( ISNULL( @cOrderKey, '') = '') OR ( O.OrderKey = @cOrderKey))
                         AND   (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                         AND   (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                         AND   LOC.Facility = @cFacility
                         AND   PD.Status = '0')

         BEGIN
            SET @nErrNo = 65923
            SET @cErrMsg = rdt.rdtgetmessage( 65923, @cLangCode, 'DSP') --'InvalidPKZone'
            GOTO Step_5_Fail
         END
      END

      --if input is blank, system assign a PickZone
      IF ISNULL(@cPickZone, '') = ''
      BEGIN
         -- (james58)
         EXEC rdt.rdt_Cluster_Pick_GetPickZone
            @nMobile       = @nMobile,
            @nFunc         = @nFunc,
            @cLangCode     = @cLangCode,
            @nStep         = @nStep,
            @nInputKey     = @nInputKey,
            @cStorerkey    = @cStorerkey,
            @cWaveKey      = @cWaveKey,
            @cLoadKey      = @cLoadKey,
            @cOrderKey     = @cOrderKey,
            @cPickSlipNo   = @cPickSlipNo,
            @cPutawayZone  = @cPutawayZone,
            @cFacility     = @cFacility,
            @cUserName     = @cUserName,
            @cPickZone     = @cPickZone   OUTPUT

         IF ISNULL(@cPickZone, '') = ''
         BEGIN
            -- No more pickzone in putawayzone to pick
            IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
                  AND Status = '1'
                  AND AddWho = @cUserName
                  AND PutawayZone <> '')
            BEGIN
               SET @nErrNo = 65924
               SET @cErrMsg = rdt.rdtgetmessage( 65924, @cLangCode, 'DSP') --'NoMorePKZone'
               GOTO Step_5_Fail
            END
         END
      END

      -- Check if PickZone locked by other user
      IF EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND Status = '1'
            AND AddWho <> @cUserName
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
            AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
            AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
            AND OrderKey IN (SELECT DISTINCT OrderKey FROM RDT.RDTPickLock WITH (NOLOCK) Where Status < '9' AND AddWho = @cUserName))
      BEGIN
         SET @nErrNo = 65925
         SET @cErrMsg = rdt.rdtgetmessage( 65925, @cLangCode, 'DSP') --'PKZoneLocked'
         GOTO Step_5_Fail
      END

      SET @nTranCount = @@TRANCOUNT
      BEGIN TRAN

      SAVE TRAN A
      -- (james16)
      SET @nNo_Of_Ord = 0
      SET @nNo_Of_Ord = rdt.RDTGetConfig( @nFunc, 'ClusterPickAutoInsOrd', @cStorerKey)

      IF @nNo_Of_Ord > 0
      BEGIN
         DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE AddWho = @cUserName
         AND   Status ='1'
         OPEN CUR_DEL
         FETCH NEXT FROM CUR_DEL INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            DELETE FROM RDT.RDTPICKLOCK WITH (ROWLOCK) WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               ROLLBACK TRAN A
               WHILE @@TRANCOUNT > @nTranCount
                  COMMIT TRAN

               CLOSE CUR_DEL
               DEALLOCATE CUR_DEL
               SET @nErrNo = 65921
               SET @cErrMsg = rdt.rdtgetmessage( 65921, @cLangCode, 'DSP') --'ReleaseMobFail'
               GOTO Quit
            END

            FETCH NEXT FROM CUR_DEL INTO @nRowRef
         END
         CLOSE CUR_DEL
         DEALLOCATE CUR_DEL

         DECLARE CUR_INS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT DISTINCT PD.OrderKey FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.OrderDetail OD WITH (NOLOCK) ON PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber
         JOIN dbo.Orders O WITH (NOLOCK) ON OD.OrderKey = O.OrderKey
         JOIN LOC LOC WITH (NOLOCK) ON PD.LOC = LOC.LOC
         WHERE (( @nMultiStorer = 1) OR ( O.StorerKey = @cStorerKey))
            AND O.SOStatus <> '9'         -- tlting03 - just to make use of index.
            AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
            AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
            AND PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
            AND O.Facility = @cFacility      -- tlting03

         OPEN CUR_INS
         FETCH NEXT FROM CUR_INS INTO @cTemp_OrderKey
         WHILE @@FETCH_STATUS <> -1 AND @nNo_Of_Ord > 0
         BEGIN
            SET @cPickSlipNo = ''
            SELECT @cPickSlipNo = PickHeaderKey
            FROM dbo.PickHeader PH WITH (NOLOCK)
            JOIN dbo.Orders O WITH (NOLOCK) ON PH.WaveKey = O.UserDefine09 AND PH.OrderKey = O.OrderKey
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey
            WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
               AND O.OrderKey = @cTemp_OrderKey
               AND PH.Status = '0'

            -- If not wave plan, look in loadplan
            IF ISNULL(@cPickSlipNo, '') = ''
            BEGIN
               SELECT @cPickSlipNo = PickHeaderKey
               FROM dbo.PickHeader PH WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK) ON PH.ExternOrderKey = O.LoadKey
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey
               WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
                  AND O.OrderKey = @cTemp_OrderKey
                  AND PH.Status = '0'
            END

            -- Not in wave, not in load then check 4 discrete pickslip
            IF ISNULL(@cPickSlipNo, '') = ''
            BEGIN
               SELECT @cPickSlipNo = PickHeaderKey
               FROM dbo.PickHeader PH WITH (NOLOCK)
               WHERE PH.OrderKey = @cTemp_OrderKey
                  AND PH.Status = '0'
            END

            IF ISNULL(@cPickSlipNo, '') = ''
            BEGIN
               SET @nErrNo = 69358
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'PKSLIPNOTPRINT'
               ROLLBACK TRAN A
               GOTO Step_5_Fail
            END

            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cTemp_OrderKey

            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
            , LOT, LOC, Status, AddWho, AddDate, PickSlipNo, Mobile)
            SELECT UserDefine09,
                   LoadKey,
                   OrderKey,
                   '',
                   StorerKey,
                   @cPutAwayZone AS PutAwayZone,
                   @cPickZone AS PickZone,
                   '' AS PickDetailKey,
                   '' AS LOT,
                   '' AS LOC,
                   '1' AS Status,
                   @cUserName AS AddWho,
                   GETDATE() AS AddWho,
                   @cPickSlipNo AS PickSlipNo,
                   @nMobile as Mobile
            FROM dbo.Orders WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cTemp_OrderKey

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 69357
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'LockOrdersFail'
               ROLLBACK TRAN A
               GOTO Step_5_Fail
            END

            SET @nNo_Of_Ord = @nNo_Of_Ord - 1

            FETCH NEXT FROM CUR_INS INTO @cTemp_OrderKey
         END
         CLOSE CUR_INS
         DEALLOCATE CUR_INS
      END

      -- Update PickZone to respective orders
      UPDATE RPL WITH (ROWLOCK) SET
         PickZone = @cPickZone
      FROM RDT.RDTPickLock RPL
      JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey) -- (Vicky01)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.Loc = L.Loc) -- (Vicky01)
      WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
         AND RPL.Status = '1'
         AND RPL.AddWho = @cUserName
         AND PD.Status = '0'
         AND L.Facility = @cFacility
         AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))

      IF @@ERROR <> 0
      BEGIN
         SET @nErrNo = 65926
         SET @cErrMsg = rdt.rdtgetmessage( 65926, @cLangCode, 'DSP') --'UPDPKLockFail'
         ROLLBACK TRAN A
         GOTO Step_5_Fail
      END

      WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
         COMMIT TRAN A

      SELECT @nOrderCnt      = COUNT (DISTINCT PD.OrderKey),
             @nSKUCnt        = COUNT (DISTINCT PD.SKU),
             @nTTL_Alloc_Qty = SUM(PD.Qty)
      FROM RDT.RDTPickLock RPL WITH (NOLOCK)
      JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.Loc = L.Loc)
      WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
         AND RPL.Status = '1'
         AND RPL.AddWho = @cUserName
         AND PD.Status = '0'
         AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
         AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
         AND L.Facility = @cFacility

      -- Extended info
      IF @cExtendedInfoSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
         BEGIN
            SET @cExtendedInfo = ''

            SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

            SET @cSQLParam =
               '@nMobile       INT, ' +
               '@nFunc         INT, ' +
               '@cLangCode     NVARCHAR( 3), ' +
               '@nStep         INT, ' +
               '@nInputKey     INT, ' +
               '@cWaveKey      NVARCHAR( 10), ' +
               '@cLoadKey      NVARCHAR( 10), ' +
               '@cOrderKey     NVARCHAR( 10), ' +
               '@cDropID       NVARCHAR( 20), ' +
               '@cStorerKey    NVARCHAR( 15), ' +
               '@cSKU          NVARCHAR( 20), ' +
               '@cLOC          NVARCHAR( 10), ' +
               '@cExtendedInfo NVARCHAR( 20) OUTPUT '

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
         END
      END

      SET @cDropID = ''

      -- Prep next screen var
      SET @cOutField01 = '' --Option
      SET @cOutField02 = @cWaveKey
      SET @cOutField03 = @cLoadKey
      SET @cOutField04 = @cPutAwayZone
      SET @cOutField05 = @cPickZone
      SET @cOutField06 = @nOrderCnt
      SET @cOutField07 = @nSKUCnt
      SET @cOutField08 = @nTTL_Alloc_Qty
      SET @cOutField09 = @cExtendedInfo

      -- Go to next screen
      SET @nScn  = 1875
      SET @nStep = 6

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      IF EXISTS ( SELECT 1 FROM dbo.CODELKUP WITH (NOLOCK) WHERE ListName = 'CLPLOCTYPE' AND ISNULL( CODE, '') <> '' AND StorerKey = @cStorerKey)
      BEGIN
         SET @cOutField01 = ''
         SET @cOutField12 = ''
         SET @cFieldAttr01 = 'O'
         SET @cFieldAttr12 = 'O'
         EXEC rdt.rdtSetFocusField @nMobile, 2
      END
      ELSE
      BEGIN
         SET @cOutField01 = ''
         SET @cOutField12 = 'ALL'
         EXEC rdt.rdtSetFocusField @nMobile, 1
      END

      SET @cOutField02 = ''
      SET @cOutField03 = ''
      SET @cOutField04 = ''
      SET @cOutField05 = ''
      SET @cOutField06 = ''
      SET @cOutField07 = @cPutAwayZone01
      SET @cOutField08 = @cPutAwayZone02
      SET @cOutField09 = @cPutAwayZone03
      SET @cOutField10 = @cPutAwayZone04
      SET @cOutField11 = @cPutAwayZone05

      EXEC rdt.rdtSetFocusField @nMobile, 1

      -- Go to next screen
      SET @nScn  = 1873
   SET @nStep = 4
   END

   GOTO Quit

   Step_5_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 6. Screen = 1875
   Option    (field01, input)
********************************************************************************/
Step_6:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @c_TraceName = 'rdtfnc_Cluster_Pick_Step_6'
      SET @d_StartTime = getdate()  -- (james_tune)

      SET @cOption = @cInField01

      --if input is not either '1' or '2'
      IF @cOption NOT IN ('1', '2')
      BEGIN
         SET @nErrNo = 65927
         SET @cErrMsg = rdt.rdtgetmessage( 65927, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_6_Fail
      END

      SET @d_step1 = GETDATE()   -- (james_tune)
      IF @cOption = '1'
      BEGIN

         BEGIN TRAN
         -- Scan in pickslip if not yet scan
         SET @d_step1 = GETDATE()

         IF ISNULL(@cWavekey, '') <> ''
         BEGIN
            SET @c_Col2 = 'W'+@cWavekey

            INSERT INTO dbo.PickingInfo (PickSlipNo, ScanInDate, PickerID, ScanOutDate, AddWho)
            SELECT DISTINCT PH.PickHeaderKey, GETDATE(), @cUserName, NULL, @cUserName
            FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN dbo.Orders O WITH (NOLOCK, INDEX(PKOrders) ) ON RPL.OrderKey = O.OrderKey -- (Vicky03)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (O.OrderKey = OD.OrderKey)     -- (james09)
            JOIN dbo.PickHeader PH WITH (NOLOCK) ON O.Userdefine09 = PH.WaveKey AND O.OrderKey = PH.OrderKey
            WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
               AND RPL.Status = '1'
               AND RPL.AddWho = @cUserName
               AND RPL.StorerKey = @cStorerKey
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( RPL.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( RPL.PickZone = @cPickZone))
               AND NOT EXISTS (SELECT 1 FROM dbo.PickingInfo PIF WITH (NOLOCK)
                       WHERE PIF.PickSlipNo = PH.PickHeaderKey )
         END
         ELSE
         BEGIN
            -- Check if it is Conso pickslip (james06)
            IF EXISTS (SELECT 1 FROM dbo.PickHeader WITH (NOLOCK)
               WHERE ExternOrderKey = @cLoadKey
               AND   ISNULL(RTRIM(Orderkey), '') = '' ) AND ISNULL( @cLoadKey, '') <> ''
            BEGIN
               SET @c_Col2 = 'C'+@cLoadKey
               INSERT INTO dbo.PickingInfo (PickSlipNo, ScanInDate, PickerID, ScanOutDate, AddWho)
               SELECT DISTINCT PH.PickHeaderKey, GETDATE(), @cUserName, NULL, @cUserName
               FROM RDT.RDTPickLock RPL WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK, INDEX(PKOrders) ) ON RPL.OrderKey = O.OrderKey -- (Vicky03)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (O.OrderKey = OD.OrderKey)     -- (james09)
               JOIN dbo.PickHeader PH WITH (NOLOCK) ON O.LoadKey = PH.ExternOrderKey
               WHERE (( @nMultiStorer = 1) OR ( OD.StorerKey = @cStorerKey))
                  AND RPL.Status = '1'
                  AND RPL.AddWho = @cUserName
                  AND (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( RPL.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( RPL.PickZone = @cPickZone))
                  AND NOT EXISTS (SELECT 1 FROM dbo.PickingInfo PIF WITH (NOLOCK)
                          WHERE PIF.PickSlipNo = PH.PickHeaderKey )
            END
            ELSE
            BEGIN
               SET @c_Col2 = 'O'
               INSERT INTO dbo.PickingInfo (PickSlipNo, ScanInDate, PickerID, ScanOutDate, AddWho)
               SELECT DISTINCT PH.PickHeaderKey, GETDATE(), @cUserName, NULL, @cUserName
               FROM RDT.RDTPickLock RPL WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK, INDEX(PKOrders) ) ON RPL.OrderKey = O.OrderKey -- (Vicky03)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey -- SOS# 176144
               JOIN dbo.PickHeader PH WITH (NOLOCK) ON O.LoadKey = PH.ExternOrderKey AND O.OrderKey = PH.OrderKey
               WHERE (( @nMultiStorer = 1) OR ( O.StorerKey = @cStorerKey))
                  AND RPL.Status = '1'
                  AND RPL.AddWho = @cUserName
                  AND (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))     -- tlting
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( RPL.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( RPL.PickZone = @cPickZone))
                  AND NOT EXISTS (SELECT 1 FROM dbo.PickingInfo PIF WITH (NOLOCK)
                          WHERE PIF.PickSlipNo = PH.PickHeaderKey )
            END
         END

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65928
            SET @cErrMsg = rdt.rdtgetmessage( 65928, @cLangCode, 'DSP') --'Scan In Fail'
            ROLLBACK TRAN
            GOTO Step_6_Fail
         END

         SET @d_step1 = GETDATE() - @d_step1 -- (tlting)

         COMMIT TRAN

         SET @cDropID = ''

         -- Remember current LOC (james19)
         SET @cPrevLOC = ''
         SET @cPrevLOC = @cLOC

         SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)

         IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
         BEGIN
            EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                @n_Mobile        = @nMobile
               ,@n_Func          = @nFunc
               ,@c_SPName        = @cClusterPickGetNextTask_SP
               ,@c_Storerkey     = @cStorerKey
               ,@c_UserName      = @cUserName
               ,@c_Facility      = @cFacility
               ,@c_PutawayZone   = @cPutawayZone
               ,@c_PickZone      = @cPickZone
               ,@c_LangCode      = @cLangCode
               ,@c_oFieled01     = @c_oFieled01 OUTPUT
               ,@c_oFieled02     = @c_oFieled02 OUTPUT
               ,@c_oFieled03     = @c_oFieled03 OUTPUT
               ,@c_oFieled04     = @c_oFieled04 OUTPUT
               ,@c_oFieled05     = @c_oFieled05 OUTPUT
               ,@c_oFieled06     = @c_oFieled06 OUTPUT
               ,@c_oFieled07     = @c_oFieled07 OUTPUT
               ,@c_oFieled08     = @c_oFieled08 OUTPUT
               ,@c_oFieled09     = @c_oFieled09 OUTPUT
               ,@c_oFieled10     = @c_oFieled10 OUTPUT
               ,@c_oFieled11     = @c_oFieled11 OUTPUT
               ,@c_oFieled12     = @c_oFieled12 OUTPUT
               ,@c_oFieled13     = @c_oFieled13 OUTPUT
               ,@c_oFieled14     = @c_oFieled14 OUTPUT
               ,@c_oFieled15     = @c_oFieled15 OUTPUT
               ,@b_Success       = @b_Success   OUTPUT
               ,@n_ErrNo         = @nErrNo      OUTPUT
               ,@c_ErrMsg        = @cErrMsg     OUTPUT

            SET @cLOC            = @c_oFieled01
            SET @cOrderKey       = @c_oFieled02
            SET @cSKU            = @c_oFieled03
            SET @cSKU_Descr      = @c_oFieled04
            SET @cStyle          = @c_oFieled05
            SET @cColor          = @c_oFieled06
            SET @cSize           = @c_oFieled07
            SET @cColor_Descr    = @c_oFieled08
            SET @cLot            = @c_oFieled09
            SET @cPickSlipNo     = @c_oFieled10
            SET @cExternOrderKey = @c_oFieled11
            SET @cConsigneeKey   = @c_oFieled12
            SET @cLottable02     = @c_oFieled13
            SET @dLottable04     = @c_oFieled14
         END
         ELSE
         BEGIN
            SET @nErrNo = 0
            EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cPutAwayZone,
               @cPickZone,
               @cLangCode,
               @nErrNo           OUTPUT,
               @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
               @cLOC             OUTPUT,
               @cOrderKey        OUTPUT,
               @cExternOrderKey  OUTPUT,
               @cConsigneeKey    OUTPUT,
               @cSKU             OUTPUT,
               @cSKU_Descr       OUTPUT,
               @cStyle           OUTPUT,
               @cColor           OUTPUT,
               @cSize            OUTPUT,
               @cColor_Descr     OUTPUT,
               @cLot             OUTPUT,
               @cPickSlipNo      OUTPUT,
               @nMobile,
               @nFunc,
               @cWaveKey,
               @cLoadKey,
               @cLottable02,
               @dLottable04
         END

         IF @nErrNo <> 0
            GOTO Quit

         SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
         IF ISNULL( @cLocDescr, '') = ''
            SET @cLocDescr = @cLOC

         EXEC [RDT].[rdt_ClusterPickSkuAttribute]
            @nMobile       = @nMobile,
            @nFunc         = @nFunc,
            @cLangCode     = @cLangCode,
            @nStep         = @nStep,
            @nInputKey     = @nInputKey,
            @cStorerKey    = @cStorerKey,
            @cSKU          = @cSKU,
            @cAltSKU       = @cAltSKU       OUTPUT,
            @cDescr        = @cSKU_Descr    OUTPUT,
            @cStyle        = @cStyle        OUTPUT,
            @cColor        = @cColor        OUTPUT,
            @cSize         = @cSize         OUTPUT,
            @cColor_Descr  = @cColor_Descr  OUTPUT,
            @cAttribute01  = @cAttribute01  OUTPUT,
            @cAttribute02  = @cAttribute02  OUTPUT,
            @cAttribute03  = @cAttribute03  OUTPUT,
            @cAttribute04  = @cAttribute04  OUTPUT,
            @cAttribute05  = @cAttribute05  OUTPUT,
            @cAttribute06  = @cAttribute06  OUTPUT,
            @cAttribute07  = @cAttribute07  OUTPUT,
            @cAttribute08  = @cAttribute08  OUTPUT,
            @cAttribute09  = @cAttribute09  OUTPUT,
            @cAttribute10  = @cAttribute10  OUTPUT,
            @nErrNo        = @nErrNo        OUTPUT,
            @cErrMsg       = @cErrMsg       OUTPUT

         -- If pick by conso then look for all orders
         -- and group by logicalloc, loc, sku, lot2, lot4
         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            SET @d_step3 = GETDATE()   -- (james_tune)
            SET @c_Col5 = '6.1.1'

            SELECT @cLottable02 = Lottable02,
                   @dLottable04 = Lottable04
            FROM dbo.LotAttribute WITH (NOLOCK)
            WHERE LOT = @cLot

            DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT RowRef FROM RDT.RDTPICKLOCK WITH (NOLOCK)
            WHERE  AddWho = @cUserName
            AND    Status = '1'
            OPEN CUR_DEL
            FETCH NEXT FROM CUR_DEL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               DELETE FROM RDT.RDTPICKLOCK WITH (ROWLOCK) WHERE RowRef = @nRowRef
               FETCH NEXT FROM CUR_DEL INTO @nRowRef
            END
            CLOSE CUR_DEL
            DEALLOCATE CUR_DEL

            SET @d_step3 = GETDATE() - @d_step3 -- (james_tune)
            SET @d_step4 = GETDATE()   -- (james_tune)

            IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
            BEGIN
               SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
               SET @cColor = @cColor + ' '
               SET @cSKU_Descr = ''
            END

            SET @d_step4 = GETDATE() - @d_step4 -- (james_tune)
            SET @d_step5 = GETDATE()   -- (james_tune)

            DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT PD.ORDERKEY, PD.LOT
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey and PD.OrderLineNumber = OD.OrderLineNumber)
            JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.StorerKey = @cStorerKey
               AND PD.STATUS = '0'
               AND PD.LOC = @cLOC
               AND PD.SKU = @cSKU
               AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
               AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            GROUP BY PD.ORDERKEY, PD.LOT  -- (james56)
            ORDER BY PD.ORDERKEY, PD.LOT
            OPEN CUR_LOOK4CONSO_ORDERS
            FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               BEGIN TRAN

               INSERT INTO RDT.RDTPickLock
               (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
               , LOT, LOC, SKU, DropID, Lottable02, Lottable04, Status, AddWho, AddDate, PickSlipNo, Mobile, PackKey)
               VALUES
               (ISNULL(@cWaveKey, ''), ISNULL(@cLoadKey, ''), @cConso_Orders, '', @cStorerKey, ISNULL(@cPutAwayZone, ''), ISNULL(@cPickZone, ''), @cConso_Orders,
               @cLot, @cLoc, @cSKU, @cDropID, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cPickSlipNo, @nMobile, @cCartonType)

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65976
                  SET @cErrMsg = rdt.rdtgetmessage( 65976, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN
                  GOTO Step_6_Fail
               END

               COMMIT TRAN

               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
            END
            CLOSE CUR_LOOK4CONSO_ORDERS
            DEALLOCATE CUR_LOOK4CONSO_ORDERS
            SET @d_step5 = GETDATE() - @d_step5 -- (james_tune)
         END
         ELSE
         BEGIN
            SET @d_step3 = GETDATE()   -- (james_tune)
            SET @c_Col5 = '6.1.2'

            SET @d_step3 = GETDATE() - @d_step3 -- (james_tune)
            SET @d_step4 = GETDATE()   -- (james_tune)

            -- Get the Lottables
            SELECT
               @cLottable02 = Lottable02,
               @dLottable04 = Lottable04
            FROM dbo.LotAttribute WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               AND SKU = @cSKU
               AND LOT = @cLot

            SET @d_step4 = GETDATE() - @d_step4 -- (james_tune)
            SET @d_step5 = GETDATE()   -- (james_tune)

            BEGIN TRAN

            UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
               LOT = @cLot,
               LOC = @cLoc,
               SKU = @cSKU,
               DropID = @cDropID,
               PackKey = @cCartonType,
               Lottable02 = @cLottable02,
               Lottable04 = @dLottable04,
               OrderLineNumber = LEFT( OrderLineNumber + '%%', 5)  -- SOS232145
            WHERE OrderKey = @cOrderKey
               AND Status = '1'
               AND AddWho = @cUserName
               AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65929
               SET @cErrMsg = rdt.rdtgetmessage( 65929, @cLangCode, 'DSP') --'UPDPKLockFail'
               ROLLBACK TRAN
               GOTO Step_6_Fail
            END

            SET @d_step5 = GETDATE() - @d_step5 -- (james_tune)

            COMMIT TRAN
         END

         SET @nActQty = 0
         SET @nQtyToPick = '0'

         IF @cClusterPickPrintLabel = '1'
         BEGIN
            SET @cOutField01 = ''

            -- Go to next screen
            SET @nScn  = 1885
            SET @nStep = 13
         END
         ELSE
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
            BEGIN
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = ''

               -- Go to next screen
               SET @nScn  = 1892
               SET @nStep = 19

               GOTO Quit
            END

            IF @nFunc = 1620
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cOrderKey
               SET @cOutField03 = @cExternOrderKey
               SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
               SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
               SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

               -- (james55)
               IF @cClusterPickNIKE <> ''
               BEGIN
                  IF @cClusterPickNIKE = '1'
                  BEGIN
                     SET @cTemp_String = ''
                     SET @cTemp_UOM = ''
                     SET @nTemp_PackQtyIndicator = ''

                     SELECT
                        @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                        @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                     FROM dbo.SKU SKU WITH (NOLOCK)
                     JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                     WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                        AND SKU.SKU = @cSKU

                     SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                        '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                  END
                  ELSE
                  BEGIN
                     IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo2 = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                        SET @cOutField08 = @cExtendedInfo2
                     END
                  END

               END
               ELSE
               BEGIN
                  -- Extended info
                  IF @cExtendedInfoSP <> ''
                  BEGIN
                     IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT

                        SET @cOutField08 = @cExtendedInfo
                     END
                  END
                  ELSE
                     SET @cOutField08 = @cColor_Descr
               END

               SET @cOutField09 = ''   -- DropID
               SET @cOutField10 = ''
               SET @cOutField11 = ''

               -- (james42)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
               BEGIN
                  SET @cOutField10 = 'CTN TYPE:'
                  SET @cOutField11 = ''
               END

               -- Go to next screen
               SET @nScn  = 1876
               SET @nStep = 7
            END
            ELSE
            IF @nFunc = 1621
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cOrderKey
               SET @cOutField03 = @cExternOrderKey
               SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
               SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
               SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
               SET @cOutField08 = @cLottable02
               SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField10 = ''   -- DropID
               -- SOS172041

               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

               IF RDT.RDTGetConfig( @nFunc, 'ClusterPickPromptNewDropID', @cStorerKey) = 1
               BEGIN
                  SELECT @cDropID = DropID FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                     AND LOC = @cLOC
                     AND OrderKey = @cOrderKey
                     AND AddWho = @cUserName

                  IF ISNULL(@cDropID, '') = ''
                  BEGIN
                     SET @cOutField11 = 'NEW DROP ID'
                     SET @cOutField12 = ''
                  END
                  ELSE
                  BEGIN
                     SET @cOutField11 = @cDropID
                     SET @cOutField12 = ''
                  END
               END
               ELSE
               BEGIN
                  SET @cOutField11 = 'SCAN CARTON ID'
                  SET @cOutField12 = 'DROP ID:'
               END

               -- Go to next screen
               SET @nScn  = 1882
               SET @nStep = 7
            END
            ELSE
            IF @nFunc = 1628
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cLoadKey
               SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               --SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
               --SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
               SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
               SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
               SET @cOutField08 = @cLottable02
               SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField10 = ''   -- DropID
               SET @cOutField11 = ''
               SET @cOutField12 = ''

               -- Go to next screen
               SET @nScn  = 1887
               SET @nStep = 7
            END

            -- (james30)
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
            BEGIN
               EXECUTE rdt.rdt_Cluster_Pick_DropID
                  @nMobile,
                  @nFunc,
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cLoadKey,
                  @cPickSlipNo,
                  @cOrderKey,
                  @cDropID       OUTPUT,
                  @cSKU,
                  'R',      -- R = Retrieve
                  @cLangCode,
                  @nErrNo        OUTPUT,
                  @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max

               IF @nFunc = 1620
               BEGIN
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                     SET @cOutField09 = ''         -- DropID
                  ELSE
                     SET @cOutField09 = @cDropID   -- DropID
               END
               ELSE
               BEGIN
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                     SET @cOutField10 = ''         -- DropID
                  ELSE
                     SET @cOutField10 = @cDropID   -- DropID
               END
            END

            -- (james42)
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
            BEGIN
               IF @nFunc = 1620
               BEGIN
                  SET @cOutField10 = 'CTN TYPE:'
                  SET @cFieldAttr11 = ''
                  SET @cOutField11 = ''
               END
               ELSE
               BEGIN
                  SET @cOutField11 = 'CTN TYPE:'
                  SET @cFieldAttr12 = ''
                  SET @cOutField12 = ''
               END
            END
            ELSE
            BEGIN
               IF @nFunc = 1620
                  SET @cFieldAttr11 = 'O'
               ELSE
                  SET @cFieldAttr12 = 'O'
            END
         END
      END

      IF @cOption = '2'
      BEGIN
         -- Release locked record
         SET @nTranCount = @@TRANCOUNT

         BEGIN TRAN
         SAVE TRAN Step6_Update

         SET @d_step1 = GETDATE() - @d_step1 -- (james_tune)
         SET @d_step2 = GETDATE()   -- (james_tune)
         SET @c_Col5 = '6.2'

         DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE AddWho = @cUserName
         AND   Status IN ('1', 'X')
         AND   (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
         OPEN CUR_DEL
         FETCH NEXT FROM CUR_DEL INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               ROLLBACK TRAN Step6_Update
               WHILE @@TRANCOUNT > @nTranCount
                  COMMIT TRAN

               CLOSE CUR_DEL
               DEALLOCATE CUR_DEL
               SET @nErrNo = 65930
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'ReleaseMobFail'
               GOTO Quit
            END
            FETCH NEXT FROM CUR_DEL INTO @nRowRef
         END
         CLOSE CUR_DEL
         DEALLOCATE CUR_DEL

         DECLARE CUR_UPD CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE ADDWHO = @cUserName
         AND   PickDetailKey <> ''
         OPEN CUR_UPD
         FETCH NEXT FROM CUR_UPD INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
               PickDetailKey = ''
            WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               ROLLBACK TRAN Step6_Update
               WHILE @@TRANCOUNT > @nTranCount
                  COMMIT TRAN

               CLOSE CUR_UPD
               DEALLOCATE CUR_UPD
               SET @nErrNo = 65930
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'ReleaseMobFail'
               GOTO Quit
            END
            FETCH NEXT FROM CUR_UPD INTO @nRowRef
         END
         CLOSE CUR_UPD
         DEALLOCATE CUR_UPD

         SET @d_step2 = GETDATE() - @d_step2 -- (james_tune)
         SET @d_step3 = GETDATE()   -- (james_tune)

         COMMIT TRAN Step6_Update
         WHILE @@TRANCOUNT > @nTranCount
               COMMIT TRAN

         -- Go back to first screen
         SET @nScn  = 1870
         SET @nStep = 1

         SET @cDropID = ''
         SET @cOutField01 = ''
      END

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      SET @cOutField01 = '' --Option
      SET @cOutField02 = @cWaveKey
      SET @cOutField03 = @cLoadKey
      SET @cOutField04 = @cPutAwayZone
      SET @cOutField05 = @nOrderCnt
      SET @cOutField06 = @nTTL_Alloc_Qty

      SET @nScn  = 1874
      SET @nStep = 5
   END

   GOTO Quit

   Step_6_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 7. Screen = 1876, 1882
   Drop ID     (field01, input)
********************************************************************************/
Step_7:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN

      IF @nFunc = 1620
      BEGIN
         SET @cDropID = UPPER(@cInField09) -- (Vicky01)
         SET @cCartonType = @cInField11    -- (james42)
         SET @cBarcode = @cInField09
      END
      ELSE
      BEGIN
         IF RDT.RDTGetConfig( @nFunc, 'ClusterPickPromptNewDropID', @cStorerKey) = 1
         BEGIN
            IF @cInField10 <> @cDropID
            BEGIN
               SET @cDropID = UPPER(@cInField10)

               SET @cOutField01 = '' --Option

               -- Save current screen no
               SET @nCurScn = @nScn
               SET @nCurStep = @nStep

               -- Go to STD short pick screen
               SET @nScn = 1890
               SET @nStep = 16

               GOTO Quit
            END
         END
         ELSE
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '0'
            OR ISNULL( @cInField09, '') <> ''
               SET @cDropID = UPPER(@cInField10)

            SET @cCartonType = @cInField12    -- (james42)
         END

         SET @cBarcode = @cInField10
      END

      -- (james57)
      IF @cClusterPickGenDropID = '1'
      BEGIN
         EXECUTE rdt.rdt_Cluster_Pick_DropID
            @nMobile,
            @nFunc,
            @cStorerKey,
            @cUserName,
            @cFacility,
            @cLoadKey,
            @cPickSlipNo,
            @cOrderKey,
            @cDropID       OUTPUT,
            @cSKU,
            'N',      -- N = New drop id
            @cLangCode,
            @nErrNo        OUTPUT,
            @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max

         IF @@ERROR <> 0
            GOTO Step_7_Fail
      END

      -- If config turned on, DropID field is mandatory
      IF @cClusterPickScanDropID = '1' AND ISNULL(@cDropID, '') = ''
      BEGIN
         SET @nErrNo = 65961
         SET @cErrMsg = rdt.rdtgetmessage( 65961, @cLangCode, 'DSP') --DropID needed
         GOTO Step_7_Fail
      END

      -- (james69)
      -- Decode
      IF @cDecodeDropIDSP <> ''
      BEGIN
         -- Standard decode
         IF @cDecodeDropIDSP = '1'
         BEGIN
            SET @cID = ''
            EXEC rdt.rdt_Decode @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerKey, @cFacility, @cBarcode,
               @cID           OUTPUT, @cUPC           OUTPUT, @nQTY           OUTPUT,
               @cLottable01   OUTPUT, @cLottable02    OUTPUT, @cLottable03    OUTPUT, @dLottable04    OUTPUT, @dLottable05    OUTPUT,
               @cLottable06   OUTPUT, @cLottable07    OUTPUT, @cLottable08    OUTPUT, @cLottable09    OUTPUT, @cLottable10    OUTPUT,
               @cLottable11   OUTPUT, @cLottable12    OUTPUT, @dLottable13    OUTPUT, @dLottable14    OUTPUT, @dLottable15    OUTPUT,
               @cUserDefine01 OUTPUT, @cUserDefine02  OUTPUT, @cUserDefine03  OUTPUT, @cUserDefine04  OUTPUT, @cUserDefine05  OUTPUT,
               @nErrNo        OUTPUT, @cErrMsg        OUTPUT

            SET @cDropID = @cID
         END

         -- Customize decode
         ELSE IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cDecodeDropIDSP AND type = 'P')
         BEGIN
            SET @cSQL = 'EXEC rdt.' + RTRIM( @cDecodeDropIDSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerKey, @cBarcode, ' +
               ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutawayZone, @cPickZone, ' +
               ' @cDropID        OUTPUT, @cUPC           OUTPUT, @nQTY           OUTPUT, ' +
               ' @cLottable01    OUTPUT, @cLottable02    OUTPUT, @cLottable03    OUTPUT, @dLottable04    OUTPUT, @dLottable05    OUTPUT, ' +
               ' @cLottable06    OUTPUT, @cLottable07    OUTPUT, @cLottable08    OUTPUT, @cLottable09    OUTPUT, @cLottable10    OUTPUT, ' +
               ' @cLottable11    OUTPUT, @cLottable12    OUTPUT, @dLottable13    OUTPUT, @dLottable14    OUTPUT, @dLottable15    OUTPUT, ' +
               ' @cUserDefine01  OUTPUT, @cUserDefine02  OUTPUT, @cUserDefine03  OUTPUT, @cUserDefine04  OUTPUT, @cUserDefine05  OUTPUT, ' +
               ' @nErrNo         OUTPUT, @cErrMsg        OUTPUT'
            SET @cSQLParam =
               ' @nMobile        INT,           ' +
               ' @nFunc          INT,           ' +
               ' @cLangCode      NVARCHAR( 3),  ' +
               ' @nStep          INT,           ' +
               ' @nInputKey      INT,           ' +
               ' @cStorerKey     NVARCHAR( 15), ' +
               ' @cBarcode       NVARCHAR( 60), ' +
               ' @cWaveKey       NVARCHAR( 10), ' +
               ' @cLoadKey       NVARCHAR( 10), ' +
               ' @cOrderKey      NVARCHAR( 10), ' +
               ' @cPutawayZone   NVARCHAR( 10), ' +
               ' @cPickZone      NVARCHAR( 10), ' +
               ' @cDropID        NVARCHAR( 20)  OUTPUT, ' +
               ' @cUPC           NVARCHAR( 20)  OUTPUT, ' +
               ' @nQTY           INT            OUTPUT, ' +
               ' @cLottable01    NVARCHAR( 18)  OUTPUT, ' +
               ' @cLottable02    NVARCHAR( 18)  OUTPUT, ' +
               ' @cLottable03    NVARCHAR( 18)  OUTPUT, ' +
               ' @dLottable04    DATETIME       OUTPUT, ' +
               ' @dLottable05    DATETIME       OUTPUT, ' +
               ' @cLottable06    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable07    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable08    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable09    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable10    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable11    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable12    NVARCHAR( 30)  OUTPUT, ' +
               ' @dLottable13    DATETIME       OUTPUT, ' +
               ' @dLottable14    DATETIME       OUTPUT, ' +
               ' @dLottable15    DATETIME       OUTPUT, ' +
               ' @cUserDefine01  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine02  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine03  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine04  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine05  NVARCHAR( 60)  OUTPUT, ' +
               ' @nErrNo         INT            OUTPUT, ' +
               ' @cErrMsg        NVARCHAR( 20)  OUTPUT'

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerKey, @cBarcode,
               @cWaveKey, @cLoadKey, @cOrderKey, @cPutawayZone, @cPickZone,
               @cDropID       OUTPUT, @cUPC           OUTPUT, @nQTY           OUTPUT,
               @cLottable01   OUTPUT, @cLottable02    OUTPUT, @cLottable03    OUTPUT, @dLottable04    OUTPUT, @dLottable05    OUTPUT,
               @cLottable06   OUTPUT, @cLottable07    OUTPUT, @cLottable08    OUTPUT, @cLottable09    OUTPUT, @cLottable10    OUTPUT,
               @cLottable11   OUTPUT, @cLottable12    OUTPUT, @dLottable13    OUTPUT, @dLottable14    OUTPUT, @dLottable15    OUTPUT,
               @cUserDefine01 OUTPUT, @cUserDefine02  OUTPUT, @cUserDefine03  OUTPUT, @cUserDefine04  OUTPUT, @cUserDefine05  OUTPUT,
               @nErrNo        OUTPUT, @cErrMsg        OUTPUT
         END
      END   -- End for DecodeSP

      --if DropID scanned, check whether the prefix is 'ID'
      IF ISNULL(@cDropID, '') <> ''
      BEGIN
         IF @cNot_Check_ID_Prefix <> '1'
         BEGIN
            IF SUBSTRING(@cDropID, 1, 2) <> 'ID'
            BEGIN
               SET @nErrNo = 65931
               SET @cErrMsg = rdt.rdtgetmessage( 65931, @cLangCode, 'DSP') --Invalid DropID
               GOTO Step_7_Fail
            END
         END

         --(james01)
         -- Stored Proc to validate Drop ID by storerkey
         SET @cCheckDropID_SP = rdt.RDTGetConfig( 0, 'CheckDropID_SP', @cStorerKey)

         IF ISNULL(@cCheckDropID_SP, '') NOT IN ('', '0')
         BEGIN
            SET @cSQLStatement = N'EXEC rdt.' + RTRIM(@cCheckDropID_SP) +
                                  ' @cFacility, @cStorerkey, @cOrderkey, @cDropID, @nValid OUTPUT, @nErrNo OUTPUT,  @cErrMsg OUTPUT'

            SET @cSQLParms = N'@cFacility    NVARCHAR( 5),         ' +
                              '@cStorerkey   NVARCHAR( 15),        ' +
                              '@cOrderkey    NVARCHAR( 10),        ' +
                              '@cDropID      NVARCHAR( 20),        ' +
                              '@nValid       INT      OUTPUT,  ' +
                              '@nErrNo       INT      OUTPUT,  ' +
                              '@cErrMsg      NVARCHAR(20) OUTPUT '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                                 @cFacility,
                                 @cStorerKey,
                                 @cOrderKey,
                                 @cDropID,
                                 @nValid  OUTPUT,
                                 @nErrNo  OUTPUT,
                                 @cErrMsg OUTPUT

            IF @nErrNo <> 0
            BEGIN
               GOTO Step_7_Fail
            END

            IF @nValid = 0
            BEGIN
               SET @nErrNo = 65962
               SET @cErrMsg = rdt.rdtgetmessage( 65962, @cLangCode, 'DSP') --Invalid DropID
               GOTO Step_7_Fail
            END
         END--(james01)

         -- (james16)
         -- If config AutoPromptDropID turned on then check if this dropid exists in other orders or not
         -- because 1 dropid not allow mix orders
         IF @cAutoPromptDropID = '1'
            AND rdt.RDTGetConfig( @nFunc, 'ClusterPickDropIDMixOrd', @cStorerKey) <> '1'
            BEGIN
               DECLARE @cPickH_Zone       NVARCHAR( 10)
               DECLARE @cPickH_OrderKey   NVARCHAR( 10)
               DECLARE @cPickH_LoadKey    NVARCHAR( 10)
               DECLARE @nDropIDMixOrd     INT = 0

               IF ISNULL( @cPickSlipNo, '') = ''
                  SELECT @cPickSlipNo = PickHeaderKey FROM dbo.PICKHEADER (NOLOCK) WHERE OrderKey = @cOrderKey

               IF ISNULL( @cPickSlipNo, '') = ''
                  SELECT @cPickSlipNo = PickHeaderKey FROM dbo.PICKHEADER (NOLOCK) WHERE ExternOrderKey = @cLoadKey

               IF ISNULL( @cPickSlipNo, '') = ''
                  SELECT @cPickSlipNo = PickHeaderKey FROM dbo.PICKHEADER (NOLOCK) WHERE WaveKey = @cWaveKey

               -- Get PickHeader info
               SELECT TOP 1
                  @cPickH_OrderKey = OrderKey,
                  @cPickH_LoadKey = ExternOrderKey,
                  @cPickH_Zone = Zone
               FROM dbo.PickHeader WITH (NOLOCK)
               WHERE PickHeaderKey = @cPickSlipNo

               -- Cross dock PickSlip
               IF @cPickH_Zone IN ('XD', 'LB', 'LP')
               BEGIN
                  IF EXISTS (
                     SELECT 1
                     FROM dbo.RefKeyLookup RKL WITH (NOLOCK)
                     JOIN dbo.PickDetail PD WITH (NOLOCK) ON (PD.PickDetailKey = RKL.PickDetailKey)
                     JOIN dbo.DropID D WITH (NOLOCK) ON (PD.DropID = D.DropID)
                     WHERE RKL.PickSlipNo = @cPickSlipNo
                     AND   PD.Status < '5'
                     AND   PD.QTY > 0
                     AND   (( @nMultiStorer = 1) OR ( PD.StorerKey = @cStorerKey))
                     AND   PD.DropID = @cDropID
                     AND   PD.OrderKey <> @cOrderKey
                     AND   D.Status < '9')
                     SET @nDropIDMixOrd = 1
               END
               -- Discrete PickSlip
               ELSE IF @cPickH_OrderKey <> ''
               BEGIN
                  IF EXISTS (
                     SELECT 1 FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.PickHeader PH WITH (NOLOCK) ON (PH.OrderKey = PD.OrderKey)
                     JOIN dbo.DropID D WITH (NOLOCK) ON (PD.DropID = D.DropID)
                     WHERE (( @nMultiStorer = 1) OR ( PD.StorerKey = @cStorerKey))
                     AND   PD.DropID = @cDropID
                     AND   PD.OrderKey <> @cOrderKey
                     AND   PH.PickHeaderKey = @cPickSlipNo
                     AND   D.Status < '9')
                     SET @nDropIDMixOrd = 1
               END
               -- Conso PickSlip
               ELSE IF @cPickH_LoadKey <> ''
               BEGIN
                  IF EXISTS (
                     SELECT 1
                     FROM dbo.LoadPlanDetail LPD WITH (NOLOCK)
                     JOIN dbo.PickDetail PD WITH (NOLOCK) ON (LPD.OrderKey = PD.OrderKey)
                     JOIN dbo.DropID D WITH (NOLOCK) ON (PD.DropID = D.DropID)
                     WHERE LPD.LoadKey = @cLoadKey
                     AND   PD.DropID = @cDropID
                     AND   PD.Status < '5'
                     AND   PD.QTY > 0
                     AND   PD.OrderKey <> @cOrderKey
                     AND   D.Status < '9')
                     SET @nDropIDMixOrd = 1
               END

               --v2.8 start
               -- For those storer not using DropID table (james73)
               IF @nDropIDMixOrd = 0
               BEGIN
                  SELECT TOP 1 @cTemp_OrderKey = PD.OrderKey
                  FROM dbo.PICKDETAIL PD WITH (NOLOCK)
                  WHERE PD.Storerkey = @cStorerkey
                  AND   PD.DropID = @cDropID
                  AND   PD.[Status] < '9'
                  ORDER BY 1
                  
                  IF ( @cOrderKey <> @cTemp_OrderKey) AND ISNULL( @cTemp_OrderKey, '') <> ''
                     SET @nDropIDMixOrd = 1
               END
               --v2.8 end

            --AND EXISTS (SELECT 1 FROM dbo.PickDetail PD WITH (NOLOCK)
            --            JOIN dbo.PickHeader PH WITH (NOLOCK) ON (PH.OrderKey = PD.OrderKey)  -- (Chee01)
            --            JOIN dbo.DropID D WITH (NOLOCK) ON (PD.DropID = D.DropID)            -- (Chee01)
            --            WHERE (( @nMultiStorer = 1) OR ( PD.StorerKey = @cStorerKey))
            --              AND PD.DropID = @cDropID
            --              AND PD.OrderKey <> @cOrderKey
            --              AND D.Status < '9'                     -- (Chee01)
            --              AND PH.PickHeaderKey = D.PickSlipNo)   -- (Chee01)
               IF @nDropIDMixOrd = 1
               BEGIN
                  SET @nErrNo = 69359
                  SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --CANNOT MIX ORD
                  GOTO Step_7_Fail
               END
            END

         -- Check from id format (james49)
         IF rdt.rdtIsValidFormat( @nFunc, @cStorerKey, 'DROPID', @cDropID) = 0
         BEGIN
            SET @nErrNo = 104001
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --Invalid Format
            GOTO Step_7_Fail
         END
      END

      -- (james44)
      IF @cExtendedValidateSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.objects WHERE name = @cExtendedValidateSP AND type = 'P')
         BEGIN
            SET @nErrNo = 0
            SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedValidateSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cLoc                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@nQty                      INT, '           +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                  @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

            IF @nErrNo <> 0
               GOTO Step_7_Fail
         END
      END

      -- (james42)
      -- Get config for carton type capture
      -- 0 = Off & no need capture carton type
      -- 1 = On & capture cartontype is req
      -- 2 = On but capture carton type is optional
      SET @cCaptureCtnType = RDT.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey)

      IF @cCaptureCtnType NOT IN ('', '0')
      BEGIN
         IF @cCaptureCtnType = '1'
         BEGIN
            IF ISNULL( @cCartonType, '') = ''
            BEGIN
               SET @nErrNo = 69389
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --Ctn Type Req
               GOTO Step_7_Fail
            END
         END

         IF ISNULL( @cCartonType, '') <> ''
         BEGIN
            IF NOT EXISTS ( SELECT 1
                  FROM dbo.Cartonization CZ WITH (NOLOCK)
                  JOIN Storer ST WITH (NOLOCK) ON CZ.CartonizationGroup = ST.CartonGroup
                  WHERE StorerKey = @cStorerKey
                  AND   CartonType = @cCartonType)
            BEGIN
               SET @nErrNo = 69390
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --Inv Ctn Type
               GOTO Step_7_Fail
            END
         END
      END

      SET @nTranCount = @@TRANCOUNT

      BEGIN TRAN
      SAVE TRAN Step_7_Tran

      IF @cLoadDefaultPickMethod = 'C'
      BEGIN
         UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
            DropID = @cDropID,
            PackKey = @cCartonType
         WHERE StorerKey = @cStorerKey
            AND LoadKey = @cLoadKey
            AND Status = '1'
            AND AddWho = @cUserName
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
            AND SKU = @cSKU
            AND PickQty = 0

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65977
            SET @cErrMsg = rdt.rdtgetmessage( 65977, @cLangCode, 'DSP') --'UPDPKLockFail'
            ROLLBACK TRAN Step_7_Tran
            GOTO Step_7_Fail
         END

         DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT OrderKey, LOT, SUM(PickQty) FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE StorerKey = @cStorerKey
            AND Status = '1'
            AND AddWho = @cUserName
            AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
            AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
            AND SKU = @cSKU
            AND PickQty > 0
         GROUP BY OrderKey, LOT
         OPEN CUR_LOOK4CONSO_ORDERS
         FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cRPL_LOT, @nPickQty
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            SELECT @nPD_Qty = SUM(PD.QTY)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.StorerKey = @cStorerKey
               AND PD.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND PD.OrderKey = @cConso_Orders
               AND PD.Status = '0'
               AND LOC.Facility = @cFacility
               AND PD.LOT = @cRPL_LOT
               --AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               --AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

            IF @nPickQty < @nPD_Qty
            BEGIN
               IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE OrderKey = @cConso_Orders
                     AND StorerKey = @cStorerKey      --tlting03
                     AND Status = '1'
                     AND AddWho = @cUserName
                     AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                     AND SKU = @cSKU
                     AND LOT = @cRPL_LOT
                     AND DropID = @cDropID )
               BEGIN
                  INSERT INTO RDT.RDTPickLock
                  (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                  , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
                  SELECT TOP 1 WaveKey, LoadKey, Orderkey, '**' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                       , LOT, LOC, Lottable02, Lottable04, '1', AddWho, AddDate, @cDropID AS DropID, @cPickSlipNo AS PickSlipNo, @nMobile as Mobile
                       , @cCartonType AS PackKey
                  FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE OrderKey = @cConso_Orders
                     AND StorerKey = @cStorerKey    -- tlting03
                     AND SKU = @cSKU
                     AND Status = '1'
                     AND Addwho = @cUserName
                     AND LOT = @cRPL_LOT
                     ORDER BY ROWREF DESC

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65978
                     SET @cErrMsg = rdt.rdtgetmessage( 65978, @cLangCode, 'DSP') --'UPDPKLockFail'
                     CLOSE CUR_LOOK4CONSO_ORDERS
                     DEALLOCATE CUR_LOOK4CONSO_ORDERS
                     ROLLBACK TRAN Step_7_Tran
                     GOTO Step_7_Fail
                  END
               END
            END

            FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cRPL_LOT, @nPickQty
         END
         CLOSE CUR_LOOK4CONSO_ORDERS
         DEALLOCATE CUR_LOOK4CONSO_ORDERS

         SELECT @nTTL_Qty = SUM(PD.QTY)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey
                        AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey)
            -- AND PD.OrderKey in (SELECT DISTINCT PickDetailKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName AND Status = '1')
            -- tlitng03 Duplicate check
            --AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = PD.StorerKey
            --               AND OrderKey = PD.OrderKey AND ADDWHO = @cUserName AND Status = '1') -- SOS# 176144

         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE PD.LOC = @cLOC
            AND PD.SKU = @cSKU
            AND PD.Status = '0'
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
               AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey)
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))
      END -- IF @cLoadDefaultPickMethod = 'C'
      ELSE
      BEGIN
         SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

         IF EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE OrderKey = @cOrderKey
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND Status = '1'
               AND AddWho = @cUserName
               AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
               AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND SKU = @cSKU
               AND PickQty = '0' ) -- Update by Bryan, update dropid if last carton is not pick yet
         BEGIN
            UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
               DropID  = @cDropID,
               PackKey = @cCartonType
            WHERE OrderKey = @cOrderKey
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND Status = '1'
               AND AddWho = @cUserName
               AND ISNULL(RTRIM(DropID),'') <> @cDropID
               AND PickQty = '0' -- SOS# 208635

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65932
               SET @cErrMsg = rdt.rdtgetmessage( 65932, @cLangCode, 'DSP') --'UPDPKLockFail'
               ROLLBACK TRAN Step_7_Tran
               GOTO Step_7_Fail
            END

            COMMIT TRAN
         END
         --ELSE --SOS# 173419
         IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK) --SOS# 173419
         WHERE OrderKey = @cOrderKey
            AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
            AND Status = '1'
            AND AddWho = @cUserName
            AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
            AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
            AND SKU = @cSKU
            AND ISNULL(RTRIM(DropID),'') = ISNULL(RTRIM(@cDropID),''))
         BEGIN
            -- If DropID not exists, insert new line
            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
            , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
            SELECT TOP 1 WaveKey, LoadKey, Orderkey, '##' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                 , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, @cDropID AS DropID, @cPickSlipNo AS PickSlipNo, @nMobile as Mobile
                 , @cCartonType AS PackKey
						FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE OrderKey = @cOrderKey
               AND Status = '1'
               AND AddWho = @cUserName
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
               AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND SKU = @cSKU
            SET @nRowCount = @@ROWCOUNT

            IF @nRowCount = 0
            BEGIN
               -- If DropID not exists, insert new line
               INSERT INTO RDT.RDTPickLock
               (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
               , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
               SELECT TOP 1 WaveKey, LoadKey, Orderkey, '##' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                    , LOT, LOC, Lottable02, Lottable04, '1' AS Status, AddWho, AddDate, @cDropID AS DropID, @cPickSlipNo AS PickSlipNo, @nMobile as Mobile
                    , @cCartonType AS PackKey
               FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE OrderKey = @cOrderKey
                  AND Status = '5'
                  AND AddWho = @cUserName
                  AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                  AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                  AND SKU = @cSKU

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65933
                  SET @cErrMsg = rdt.rdtgetmessage( 65933, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN Step_7_Tran
                  GOTO Step_7_Fail
               END

            END
         END

         -- Get the total oustanding qty for orderkey + putawayzone + pickzone
         SELECT @nTTL_Qty = ISNULL( SUM(PD.QTY), 0)
         FROM RDT.RDTPickLock RPL WITH (NOLOCK)
         JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND RPL.PickQty <= 0
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = RPL.StorerKey
                           AND OrderKey = PD.OrderKey
                           AND ADDWHO = @cUserName ) -- SOS# 176144
            --AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName) -- SOS# 176144


         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
         FROM dbo.PickDetail WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
            AND LOC = @cLOC
            AND SKU = @cSKU
            AND OrderKey = @cOrderKey
            AND Status = '0'
            AND Lot = @cLOT
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( UOM = @cPickUsingPrefUOM))
      END

      -- ExtendedUpdate (james45)
      IF @cExtendedUpdateSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedUpdateSP AND type = 'P')
         BEGIN
            SET @nErrNo = 0
            SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedUpdateSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cLoc                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@nQty                      INT, '           +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                 @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                 @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

            IF @nErrNo <> 0
            BEGIN
               ROLLBACK TRAN Step_7_Tran
               GOTO Step_7_Fail
            END
         END
      END

      WHILE @@TRANCOUNT > @nTranCount
         COMMIT TRAN

      SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
      IF CAST(@cDefaultPickQty AS INT) <= 0
      BEGIN
         SET @cDefaultPickQty = ''

         IF @cDefaultToAllocatedQty = '1'
         BEGIN
            SET @cDefaultPickQty = @nTotalPickQty
         END

         IF @nQtyToPick > 0
         BEGIN
            IF ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
               SET @cDefaultPickQty = ''
            ELSE
               SET @cDefaultPickQty = CAST(@cDefaultPickQty AS INT) - @nQtyToPick
         END
      END

      -- Get Total Orders left on the current sku that need to pick
      SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0) -- (james59)
      FROM dbo.PickDetail PD WITH (NOLOCK)
      JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
      JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
      WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
         AND RPL.Status < '5'
         AND RPL.AddWho = @cUserName
         AND RPL.PickQty <= 0
         AND PD.SKU = @cSKU
         AND PD.Status = '0'
         AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
         AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
         AND L.Facility = @cFacility
         AND PD.SKU = @cSKU
         AND PD.LOC = @cLOC
         AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
         AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

      -- (james14)
      IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
      BEGIN
         SET @cOS_Qty = ''

         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND LPD.LoadKey = @cLoadKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND PD.Status >= '3'
               AND LPD.LoadKey = @cLoadKey

            SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
         ELSE
         BEGIN
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey
               AND Status >= '3'

            SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
      END

      IF @cClusterPickNike <> ''
      BEGIN
         IF @cClusterPickNike = '1'
         BEGIN
            SET @cTemp_String = ''
            SET @cTemp_UOM = ''
            SET @nTemp_PackQtyIndicator = ''

            SELECT
               @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
               @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                               '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
         END
         ELSE
         BEGIN
            IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
            BEGIN
               SET @cExtendedInfo2 = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

               SET @cTemp_String = @cExtendedInfo2
            END
         END
      END

      -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
      BEGIN
         SET @cPackCfg = ''

         SELECT @fPack_Qty = PACK.QTY,
                @fPack_InnerPack = PACK.InnerPack,
                @fPack_CaseCnt = PACK.CaseCnt
         FROM dbo.SKU SKU WITH (NOLOCK)
         JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
         WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
            AND SKU.SKU = @cSKU

         SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                         RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                         RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
      END

      SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
      IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
         SET @cScanLOT02 = '0'

      IF @cPrefUOM <> '6'
      BEGIN
         SELECT TOP 1
            @nPrefUOM_Div = CAST( IsNULL(
               CASE @cPrefUOM
                  WHEN '2' THEN Pack.CaseCNT
                  WHEN '3' THEN Pack.InnerPack
                  WHEN '6' THEN Pack.QTY
                  WHEN '1' THEN Pack.Pallet
                  WHEN '4' THEN Pack.OtherUnit1
                  WHEN '5' THEN Pack.OtherUnit2
               END, 1) AS INT)
         FROM dbo.SKU SKU (NOLOCK)
            INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
         WHERE StorerKey = @cStorerKey
            AND SKU = @cSKU

         -- Convert to prefer UOM QTY to be picked
         SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

         -- Convert to prefer UOM QTY picked
         SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

			--SOS334125 Start
         SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                   '/' +
                                   RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
			--SOS334125 End

         SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
         SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
      END

      -- Extended info
      IF @cExtendedInfoSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
         BEGIN
            SET @cExtendedInfo = ''

            SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

            SET @cSQLParam =
               '@nMobile       INT, ' +
               '@nFunc         INT, ' +
               '@cLangCode     NVARCHAR( 3), ' +
               '@nStep         INT, ' +
               '@nInputKey     INT, ' +
               '@cWaveKey      NVARCHAR( 10), ' +
               '@cLoadKey      NVARCHAR( 10), ' +
               '@cOrderKey     NVARCHAR( 10), ' +
               '@cDropID       NVARCHAR( 20), ' +
               '@cStorerKey    NVARCHAR( 15), ' +
               '@cSKU          NVARCHAR( 20), ' +
               '@cLOC          NVARCHAR( 10), ' +
               '@cExtendedInfo NVARCHAR( 20) OUTPUT '

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
         END
      END

      EXEC [RDT].[rdt_ClusterPickSkuAttribute]
         @nMobile       = @nMobile,
         @nFunc         = @nFunc,
         @cLangCode     = @cLangCode,
         @nStep         = @nStep,
         @nInputKey     = @nInputKey,
         @cStorerKey    = @cStorerKey,
         @cSKU          = @cSKU,
         @cAltSKU       = @cAltSKU       OUTPUT,
         @cDescr        = @cSKU_Descr    OUTPUT,
         @cStyle        = @cStyle        OUTPUT,
         @cColor        = @cColor        OUTPUT,
         @cSize         = @cSize         OUTPUT,
         @cColor_Descr  = @cColor_Descr  OUTPUT,
         @cAttribute01  = @cAttribute01  OUTPUT,
         @cAttribute02  = @cAttribute02  OUTPUT,
         @cAttribute03  = @cAttribute03  OUTPUT,
         @cAttribute04  = @cAttribute04  OUTPUT,
         @cAttribute05  = @cAttribute05  OUTPUT,
         @cAttribute06  = @cAttribute06  OUTPUT,
         @cAttribute07  = @cAttribute07  OUTPUT,
         @cAttribute08  = @cAttribute08  OUTPUT,
         @cAttribute09  = @cAttribute09  OUTPUT,
         @cAttribute10  = @cAttribute10  OUTPUT,
         @nErrNo        = @nErrNo        OUTPUT,
         @cErrMsg       = @cErrMsg       OUTPUT

      IF @nFunc = 1620
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cDropID
         SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField04 = ''
         SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
         SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                            THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

         EXEC rdt.rdtSetFocusField @nMobile, 4

         -- Go to next screen
         SET @nScn  = 1877
         SET @nStep = 8
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cSKU
         SET @cOutField03 = ''
         SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = @nTTL_Ord

         EXEC rdt.rdtSetFocusField @nMobile, 3

         -- Go to next screen
         SET @nScn  = 1883
         SET @nStep = 8
      END
      ELSE
      IF @nFunc = 1628  -- (james07)
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField03 = ''
         SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
         SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
         SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cLoadKey
         SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField11 = @nTTL_Ord

         EXEC rdt.rdtSetFocusField @nMobile, 3

         -- Go to next screen
         SET @nScn  = 1888
         SET @nStep = 8
      END

      SET @nQtyToPick = 0
      SELECT @nQtyToPick = ISNULL( SUM(PickQty), 0)
      FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE ( ( @cLoadDefaultPickMethod <> 'C' AND OrderKey = @cOrderKey) OR
               ( @cLoadDefaultPickMethod = 'C' AND LoadKey = @cLoadKey))
         AND SKU = @cSKU
         AND LOC = @cLOC
         AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
         AND LOC = @cLOC
         AND Status = '1'
         AND AddWho = @cUserName

      IF @cPrefUOM <> '6'
         SET @cOutField12 = @cPreferQty2Display
      ELSE
         IF @nTotalPickQty > 0
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7)))

      SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                         THEN '' ELSE @cDefaultPickQty END -- Qty to pick
      SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
      SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                              CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                         ELSE 'QTY: ' END

      SET @cFieldAttr01 = ''
      SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

      IF @cScanLOT02 = '1'
      BEGIN
         SET @cFieldAttr06 =''
         EXEC rdt.rdtSetFocusField @nMobile, 3
      END
      ELSE
         SET @cFieldAttr06 ='O'

      -- If config turned on, not allow to change Qty To Pick
      IF @cClusterPickLockQtyToPick = '1'
      BEGIN
         SET @cFieldAttr13 = 'O'
         SET @cInField13 = @cDefaultPickQty
      END

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- (james36)
      SET @cPickNotFinish = ''
      IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
      BEGIN
         IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                     JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                     JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                     WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                     AND   PD.Status = '0'
                     AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                     AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                     AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                     AND   LOC.Facility = @cFacility
                     AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                           WHERE PD.OrderKey = RPL.OrderKey
                                           AND   PD.StorerKey = RPL.StorerKey
                                           AND   RPL.AddWho = @cUserName
                                           AND   RPL.Status < '9'))
         BEGIN
            SET @cPickNotFinish = 'PICKING NOT FINISH'
         END
      END

      SET @cOutField01 = ''
      SET @cOutField02 = @cWaveKey
      SET @cOutField03 = @cLoadKey
      SET @cOutField04 = @cPutAwayZone
      SET @cOutField05 = @cPickZone
      SET @cOutField06 = @nOrderCnt
      SET @cOutField07 = @nTTL_Alloc_Qty
      SET @cOutField08 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

      -- Goto exit picking screen
      SET @nScn  = 1880
      SET @nStep = 11
   END

   -- (james50)
   IF @nInputKey = @nFunctionKey -- Special event, call extended stored proc
   BEGIN
      SET @cExtendedFuncKeySP = rdt.RDTGetConfig( @nFunc, 'ExtendedFuncKeySP', @cStorerkey)
      IF @cExtendedFuncKeySP NOT IN ('0', '')
      BEGIN
         SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedFuncKeySP) +
            ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @nFunctionKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
            ' @cPutAwayZone, @cPickZone, @cDropID, @cCartonType, @cLOC, @cSKU, @nQty,' +
            ' @nOutScn OUTPUT, @nOutStep OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '

         SET @cSQLParms =
            '@nMobile         INT,           ' +
            '@nFunc           INT,           ' +
            '@cLangCode       NVARCHAR( 3),  ' +
            '@nStep           INT,           ' +
            '@nInputKey       INT,           ' +
            '@nFunctionKey    INT,           ' +
            '@cStorerkey      NVARCHAR( 15), ' +
            '@cWaveKey        NVARCHAR( 10), ' +
            '@cLoadKey        NVARCHAR( 10), ' +
            '@cOrderKey       NVARCHAR( 10), ' +
            '@cPutAwayZone    NVARCHAR( 10), ' +
            '@cPickZone       NVARCHAR( 10), ' +
            '@cDropID         NVARCHAR( 20), ' +
            '@cCartonType     NVARCHAR( 10), ' +
            '@cLOC            NVARCHAR( 10), ' +
            '@cSKU            NVARCHAR( 20), ' +
            '@nQty            INT,           ' +
            '@nOutScn         INT           OUTPUT,  ' +
            '@nOutStep        INT           OUTPUT,  ' +
            '@nErrNo          INT           OUTPUT,  ' +
            '@cErrMsg         NVARCHAR( 20) OUTPUT   '

         EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @nFunctionKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
               @cPutAwayZone,  @cPickZone, @cDropID, @cCartonType, @cLOC, @cSKU, @nQty,
               @nOutScn OUTPUT, @nOutStep OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT

         IF @nErrNo <> 0
            GOTO Step_7_Fail
      END

      SET @nCurScn = @nScn
      SET @nCurStep = @nStep

      SET @cOutField01 = rdt.RDTGetConfig( @nFunc, 'FunctionKey', @cStorerKey)
      SET @nScn = @nOutScn
      SET @nStep = @nOutStep
   END

   GOTO Quit

   Step_7_Fail:
   BEGIN
      SET @cOutField10 = ''   --DropID
   END

END
GOTO Quit

/********************************************************************************
Step 8. Screen = 1877, 1883
   SKU/UPC     (field04, input)
   QTY         (field13, input)
********************************************************************************/
Step_8:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cFieldAttr01 = ''
      SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END
      SET @c_LabelNo = ''

      -- If len of the input is > 20 characters then this is not a SKU
      -- use label decoding
      IF LEN(ISNULL(@cInField04, '')) > 20 AND @nFunc = 1620
      BEGIN
         SET @c_LabelNo = @cInField04
      END

      IF LEN(ISNULL(@cInField03, '')) > 20 AND @nFunc IN (1621, 1628)
      BEGIN
         SET @c_LabelNo = @cInField03
      END

      SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)

      SET @cDecodeSP = rdt.RDTGetConfig( @nFunc, 'DecodeSP', @cStorerKey)
      IF @cDecodeSP = '0'
         SET @cDecodeSP = ''

      -- Decode
      IF @cDecodeSP <> ''
      BEGIN
         SET @cBarcode = CASE WHEN @nFunc IN (1621, 1628) THEN @cInField03 ELSE @cInField04 END
         SET @cUPC = ''

         -- Standard decode
         IF @cDecodeSP = '1'
         BEGIN
            EXEC rdt.rdt_Decode @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerKey, @cFacility, @cBarcode,
               @cID           OUTPUT, @cUPC           OUTPUT, @nQTY           OUTPUT,
               @cLottable01   OUTPUT, @cLottable02    OUTPUT, @cLottable03    OUTPUT, @dLottable04    OUTPUT, @dLottable05    OUTPUT,
               @cLottable06   OUTPUT, @cLottable07    OUTPUT, @cLottable08    OUTPUT, @cLottable09    OUTPUT, @cLottable10    OUTPUT,
               @cLottable11   OUTPUT, @cLottable12    OUTPUT, @dLottable13    OUTPUT, @dLottable14    OUTPUT, @dLottable15    OUTPUT,
               @cUserDefine01 OUTPUT, @cUserDefine02  OUTPUT, @cUserDefine03  OUTPUT, @cUserDefine04  OUTPUT, @cUserDefine05  OUTPUT,
               @nErrNo        OUTPUT, @cErrMsg        OUTPUT

            SET @cActSKU = @cUPC
            SET @cActQty = @nQTY
         END

         -- Customize decode
         ELSE IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cDecodeSP AND type = 'P')
         BEGIN
            SET @cSQL = 'EXEC rdt.' + RTRIM( @cDecodeSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerKey, @cBarcode, ' +
               ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutawayZone, @cPickZone, ' +
               ' @cDropID        OUTPUT, @cUPC           OUTPUT, @nQTY           OUTPUT, ' +
               ' @cLottable01    OUTPUT, @cLottable02    OUTPUT, @cLottable03    OUTPUT, @dLottable04    OUTPUT, @dLottable05    OUTPUT, ' +
               ' @cLottable06    OUTPUT, @cLottable07    OUTPUT, @cLottable08    OUTPUT, @cLottable09    OUTPUT, @cLottable10    OUTPUT, ' +
               ' @cLottable11    OUTPUT, @cLottable12    OUTPUT, @dLottable13    OUTPUT, @dLottable14    OUTPUT, @dLottable15    OUTPUT, ' +
               ' @cUserDefine01  OUTPUT, @cUserDefine02  OUTPUT, @cUserDefine03  OUTPUT, @cUserDefine04  OUTPUT, @cUserDefine05  OUTPUT, ' +
               ' @nErrNo         OUTPUT, @cErrMsg        OUTPUT'
            SET @cSQLParam =
               ' @nMobile        INT,           ' +
               ' @nFunc          INT,           ' +
               ' @cLangCode      NVARCHAR( 3),  ' +
               ' @nStep          INT,           ' +
               ' @nInputKey      INT,           ' +
               ' @cStorerKey     NVARCHAR( 15), ' +
               ' @cBarcode       NVARCHAR( 60), ' +
               ' @cWaveKey       NVARCHAR( 10), ' +
               ' @cLoadKey       NVARCHAR( 10), ' +
               ' @cOrderKey      NVARCHAR( 10), ' +
               ' @cPutawayZone   NVARCHAR( 10), ' +
               ' @cPickZone      NVARCHAR( 10), ' +
               ' @cDropID        NVARCHAR( 20)  OUTPUT, ' +
               ' @cUPC           NVARCHAR( 20)  OUTPUT, ' +
               ' @nQTY           INT            OUTPUT, ' +
               ' @cLottable01    NVARCHAR( 18)  OUTPUT, ' +
               ' @cLottable02    NVARCHAR( 18)  OUTPUT, ' +
               ' @cLottable03    NVARCHAR( 18)  OUTPUT, ' +
               ' @dLottable04    DATETIME       OUTPUT, ' +
               ' @dLottable05    DATETIME       OUTPUT, ' +
               ' @cLottable06    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable07    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable08    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable09    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable10    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable11    NVARCHAR( 30)  OUTPUT, ' +
               ' @cLottable12    NVARCHAR( 30)  OUTPUT, ' +
               ' @dLottable13    DATETIME       OUTPUT, ' +
               ' @dLottable14    DATETIME       OUTPUT, ' +
               ' @dLottable15    DATETIME       OUTPUT, ' +
               ' @cUserDefine01  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine02  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine03  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine04  NVARCHAR( 60)  OUTPUT, ' +
               ' @cUserDefine05  NVARCHAR( 60)  OUTPUT, ' +
               ' @nErrNo         INT            OUTPUT, ' +
               ' @cErrMsg        NVARCHAR( 20)  OUTPUT'

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerKey, @cBarcode,
               @cWaveKey, @cLoadKey, @cOrderKey, @cPutawayZone, @cPickZone,
               @cDropID       OUTPUT, @cUPC           OUTPUT, @nQTY           OUTPUT,
               @cLottable01   OUTPUT, @cLottable02    OUTPUT, @cLottable03    OUTPUT, @dLottable04    OUTPUT, @dLottable05    OUTPUT,
               @cLottable06   OUTPUT, @cLottable07    OUTPUT, @cLottable08    OUTPUT, @cLottable09    OUTPUT, @cLottable10    OUTPUT,
               @cLottable11   OUTPUT, @cLottable12    OUTPUT, @dLottable13    OUTPUT, @dLottable14    OUTPUT, @dLottable15    OUTPUT,
               @cUserDefine01 OUTPUT, @cUserDefine02  OUTPUT, @cUserDefine03  OUTPUT, @cUserDefine04  OUTPUT, @cUserDefine05  OUTPUT,
               @nErrNo        OUTPUT, @cErrMsg        OUTPUT

            SET @cActSKU = @cUPC
            SET @cActQty = @nQTY
         END
      END   -- End for DecodeSP
      ELSE
      BEGIN
         SET @cDecodeLabelNo = rdt.RDTGetConfig( @nFunc, 'DecodeLabelNo', @cStorerKey)
         IF @cDecodeLabelNo = '0'
            SET @cDecodeLabelNo = ''

         IF ISNULL(@cDecodeLabelNo, '') <> ''
            SET @c_LabelNo = CASE WHEN @nFunc IN (1621, 1628) THEN @cInField03 ELSE @cInField04 END

         -- If len of the input is > 20 characters then this is not a SKU
         -- use label decoding
         IF ISNULL(@c_LabelNo, '') <> '' AND ISNULL(@cDecodeLabelNo, '') <> ''
         BEGIN
            EXEC dbo.ispLabelNo_Decoding_Wrapper
                @c_SPName     = @cDecodeLabelNo
               ,@c_LabelNo    = @c_LabelNo
               ,@c_Storerkey  = @cStorerKey
               ,@c_ReceiptKey = @nMobile
               ,@c_POKey      = ''
               ,@c_LangCode   = @cLangCode
               ,@c_oFieled01  = @c_oFieled01 OUTPUT   -- SKU
               ,@c_oFieled02  = @c_oFieled02 OUTPUT   -- STYLE
               ,@c_oFieled03  = @c_oFieled03 OUTPUT   -- COLOR
               ,@c_oFieled04  = @c_oFieled04 OUTPUT   -- SIZE
               ,@c_oFieled05  = @c_oFieled05 OUTPUT   -- QTY
               ,@c_oFieled06  = @c_oFieled06 OUTPUT   -- CO#
               ,@c_oFieled07  = @c_oFieled07 OUTPUT
               ,@c_oFieled08  = @c_oFieled08 OUTPUT
               ,@c_oFieled09  = @c_oFieled09 OUTPUT
               ,@c_oFieled10  = @c_oFieled10 OUTPUT
               ,@b_Success    = @b_Success   OUTPUT
               ,@n_ErrNo      = @nErrNo      OUTPUT
               ,@c_ErrMsg     = @cErrMsg     OUTPUT

            IF ISNULL(@cErrMsg, '') <> ''
            BEGIN
               SET @cErrMsg = @cErrMsg
               IF @nFunc = 1620
                  SET @cOutField04 = ''
               ELSE
                  SET @cOutField03 = ''

               IF @cClusterPickLockQtyToPick = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END

               EXEC rdt.rdtSetFocusField @nMobile, 3
               GOTO Quit
            END

            SET @cActSKU = @c_oFieled01
            SET @cActQty = @c_oFieled05
         END
      END   -- End for DecodeLabelNo

      IF @nFunc = 1620
      BEGIN
         IF LEN(ISNULL(@cInField04, '')) > 20
         BEGIN
            SET @cActSKU = ISNULL(LTRIM(RTRIM(@cActSKU)), '')
            SET @cActQty = CASE WHEN ISNULL(LTRIM(RTRIM(@cActQty)), '') IN ('', '0')
                                THEN @cInField13 ELSE @cActQty END   -- (james38)
         END
         ELSE IF ISNULL(@c_LabelNo, '') <> '' AND ISNULL(@cDecodeLabelNo, '') <> ''
         BEGIN
            SET @cActSKU = ISNULL(LTRIM(RTRIM(@cActSKU)), '')
            SET @cActQty = @cInField13
         END
         ELSE IF ISNULL(@cBarcode, '') <> '' AND ISNULL(@cDecodeSP, '') <> ''
         BEGIN
            SET @cActSKU = ISNULL(LTRIM(RTRIM(@cActSKU)), '')
            SET @cActQty = CASE WHEN ISNULL(LTRIM(RTRIM(@cActQty)), '') IN ('', '0')
                                THEN @cInField13 ELSE @cActQty END
         END
         ELSE
         BEGIN
            SET @cActSKU = @cInField04
            SET @cActQty = @cInField13
         END
      END

      IF @nFunc IN (1621, 1628)
      BEGIN
         IF LEN(ISNULL(LTRIM(RTRIM(@cActSKU)), '')) > 20
         BEGIN
            SET @cActSKU = ISNULL(LTRIM(RTRIM(@cActSKU)), '')
            SET @cActQty = CASE WHEN ISNULL(LTRIM(RTRIM(@cActQty)), '') IN ('', '0')
                                THEN @cInField13 ELSE @cActQty END   -- (james38)
         END
         ELSE IF ISNULL(@c_LabelNo, '') <> '' AND ISNULL(@cDecodeLabelNo, '') <> ''
         BEGIN
            SET @cActSKU = ISNULL(LTRIM(RTRIM(@cActSKU)), '')
            SET @cActQty = @cInField13
         END
         ELSE IF ISNULL(@cBarcode, '') <> '' AND ISNULL(@cDecodeSP, '') <> ''
         BEGIN
            SET @cActSKU = ISNULL(LTRIM(RTRIM(@cActSKU)), '')
            SET @cActQty = CASE WHEN ISNULL(LTRIM(RTRIM(@cActQty)), '') IN ('', '0')
                                THEN @cInField13 ELSE @cActQty END
         END
         ELSE
         BEGIN
            SET @cActSKU = @cInField03
            SET @cActQty = @cInField13
         END
      END

      -- If input is blank, goto Confirm Short Pick
      IF ISNULL(@cActSKU, '') = ''
      BEGIN
         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cTemp_String = @cExtendedInfo2
               END
            END
         END
         ELSE
         BEGIN
           EXEC [RDT].[rdt_ClusterPickSkuAttribute]
               @nMobile       = @nMobile,
               @nFunc         = @nFunc,
               @cLangCode     = @cLangCode,
               @nStep         = @nStep,
               @nInputKey     = @nInputKey,
               @cStorerKey    = @cStorerKey,
               @cSKU          = '',
               @cAltSKU       = @cAltSKU       OUTPUT,
               @cDescr        = @cSKU_Descr    OUTPUT,
               @cStyle        = @cStyle        OUTPUT,
               @cColor        = @cColor        OUTPUT,
               @cSize         = @cSize         OUTPUT,
               @cColor_Descr  = @cColor_Descr  OUTPUT,
               @cAttribute01  = @cAttribute01  OUTPUT,
               @cAttribute02  = @cAttribute02  OUTPUT,
               @cAttribute03  = @cAttribute03  OUTPUT,
               @cAttribute04  = @cAttribute04  OUTPUT,
               @cAttribute05  = @cAttribute05  OUTPUT,
               @cAttribute06  = @cAttribute06  OUTPUT,
               @cAttribute07  = @cAttribute07  OUTPUT,
               @cAttribute08  = @cAttribute08  OUTPUT,
               @cAttribute09  = @cAttribute09  OUTPUT,
               @cAttribute10  = @cAttribute10  OUTPUT,
               @nErrNo        = @nErrNo        OUTPUT,
               @cErrMsg       = @cErrMsg       OUTPUT

            IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
            BEGIN
               SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
               SET @cColor = @cColor + ' '
               SET @cSKU_Descr = ''
            END

            -- Extended info
            IF @cExtendedInfoSP <> ''
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
               BEGIN
                  SET @cExtendedInfo = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT

                  SET @cTemp_String = @cExtendedInfo
               END
            END
         END

         IF @nFunc = 1620
         BEGIN
            SET @cOutField01 = ''
            SET @cOutField02 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))
            SET @cOutField03 = @cOrderKey
            SET @cOutField04 = @cExternOrderkey
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = @cRetailSKU
            SET @cOutField07 = SUBSTRING(@cSKU_Descr,  1, 20)
            SET @cOutField08 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField09 = SUBSTRING(@cSKU_Descr, 41, 20)
            SET @cOutField10 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField11 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
            SET @cOutField12 = CASE WHEN @cClusterPickNike NOT IN ( '', '0') THEN @cTemp_String
                                    WHEN @cClusterPickNike = '' AND @cExtendedInfoSP <> '' THEN @cTemp_String
                                    ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END

            -- Go to next screen
            SET @nScn  = 1878
            SET @nStep = 9
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            SET @cOutField01 = ''
            SET @cOutField02 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))
            SET @cOutField03 = @cOrderKey
            SET @cOutField04 = @cExternOrderkey
            SET @cOutField05 = @cSKU
            SET @cOutField06 = @cRetailSKU
            SET @cOutField07 = SUBSTRING(@cSKU_Descr,  1, 20)
            SET @cOutField08 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField09 = SUBSTRING(@cSKU_Descr, 41, 20)
            SET @cOutField10 = @cLottable02
            SET @cOutField11 = rdt.rdtFormatDate(@dLottable04)

            -- Go to next screen
            SET @nScn  = 1884
            SET @nStep = 9
         END
         ELSE
         IF @nFunc = 1628  -- (james07)
         BEGIN
            SET @cOutField01 = ''
            SET @cOutField02 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))
            SET @cOutField03 = @cLoadKey
            SET @cOutField04 = ''
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = @cRetailSKU
            SET @cOutField07 = SUBSTRING(@cSKU_Descr,  1, 20)
            SET @cOutField08 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField09 = SUBSTRING(@cSKU_Descr, 41, 20)
            SET @cOutField10 = @cLottable02
            SET @cOutField11 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField12 = ''
            SET @cOutField13 = ''

            -- Go to next screen
            SET @nScn  = 1889
            SET @nStep = 9
         END

         -- SOS197651 If config setup allow to skip SKU (james11)
         -- Show different option when config ClusterPickConfirmSkipSKU is ON (james18)
         SET @cOutField13 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmSkipSKU', @cStorerKey) = 1 THEN
                               ( CASE WHEN rdt.RDTGetConfig( @nFunc, 'ClusterPickAllowSkipSKU', @cStorerKey) = 1
                                 THEN '1=YES 2=PKBAL 3=SKIP'
                                 ELSE '1 = YES 2 = NO'
                                 END)
                                 ELSE
                               ( CASE WHEN rdt.RDTGetConfig( @nFunc, 'ClusterPickAllowSkipSKU', @cStorerKey) = 1
                                 THEN '1=YES 2=NO 3=SKIP'
                                 ELSE '1 = YES 2 = NO'
                                 END)
                           END

         GOTO Quit
      END

      IF @nMultiStorer = '1'
         GOTO VALIDATE_QTY

      --if SKU scanned
      IF ISNULL(@cActSKU, '') <> ''
      BEGIN
         -- Get SKU/UPC
         SET @d_step1 = GETDATE() -- (Vicky02)

         EXEC [RDT].[rdt_GETSKUCNT]
          @cStorerKey  = @cStorerKey
         ,@cSKU        = @cActSKU
         ,@nSKUCnt     = @nSKUCnt       OUTPUT
         ,@bSuccess    = @b_Success     OUTPUT
         ,@nErr        = @n_Err         OUTPUT
         ,@cErrMsg     = @c_ErrMsg      OUTPUT

         SET @d_step1 = GETDATE() - @d_step1 -- (Vicky02)

         -- Validate SKU/UPC
         IF @nSKUCnt = 0
         BEGIN
            -- SOS 197651 If config setup show error message in new screen (james11)
            IF rdt.RDTGetConfig( @nFunc, 'ShowWrongSKUInNewScn', @cStorerKey) = 1
            BEGIN
               SET @nErrNo = 0
               SET @cErrMsg1 = '65934 Invalid SKU'
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg1
               IF @nErrNo = 1
               BEGIN
                  SET @cErrMsg1 = ''
               END

               IF @nFunc = 1620
               BEGIN
                  SET @cOutField04 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 4
               END
               ELSE
               BEGIN
                  SET @cOutField03 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 3
               END

               IF ISNULL(@cClusterPickLockQtyToPick, '') = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END
               GOTO Quit
            END

            SET @nErrNo = 65934
            SET @cErrMsg = rdt.rdtgetmessage( 65934, @cLangCode, 'DSP') --'Invalid SKU'
            IF @nFunc = 1620
            BEGIN
               SET @cOutField04 = ''
               EXEC rdt.rdtSetFocusField @nMobile, 4
            END
            ELSE
            BEGIN
               SET @cOutField03 = ''
               EXEC rdt.rdtSetFocusField @nMobile, 3
            END

            IF ISNULL(@cClusterPickLockQtyToPick, '') = '1'
            BEGIN
               SET @cFieldAttr13 = 'O'
               SET @cInField13 = @cDefaultPickQty
            END
            GOTO Quit
         END

         -- Validate barcode return multiple SKU
         IF @nSKUCnt > 1
         BEGIN
            IF @cMultiSKUBarcode IN ('1', '2')
            BEGIN
               SET @cUPC = @cActSKU
               SET @cOutField13 = ''   -- Clear option field
               EXEC rdt.rdt_MultiSKUBarcode @nMobile, @nFunc, @cLangCode,
                  @cInField01 OUTPUT,  @cOutField01 OUTPUT,
                  @cInField02 OUTPUT,  @cOutField02 OUTPUT,
                  @cInField03 OUTPUT,  @cOutField03 OUTPUT,
                  @cInField04 OUTPUT,  @cOutField04 OUTPUT,
                  @cInField05 OUTPUT,  @cOutField05 OUTPUT,
                  @cInField06 OUTPUT,  @cOutField06 OUTPUT,
                  @cInField07 OUTPUT,  @cOutField07 OUTPUT,
                  @cInField08 OUTPUT,  @cOutField08 OUTPUT,
                  @cInField09 OUTPUT,  @cOutField09 OUTPUT,
                  @cInField10 OUTPUT,  @cOutField10 OUTPUT,
                  @cInField11 OUTPUT,  @cOutField11 OUTPUT,
                  @cInField12 OUTPUT,  @cOutField12 OUTPUT,
                  @cInField13 OUTPUT,  @cOutField13 OUTPUT,
                  @cInField14 OUTPUT,  @cOutField14 OUTPUT,
                  @cInField15 OUTPUT,  @cOutField15 OUTPUT,
                  'POPULATE',
                  @cMultiSKUBarcode,
                  @cStorerKey,
                  @cUPC     OUTPUT,
                  @nErrNo   OUTPUT,
                  @cErrMsg  OUTPUT,
                  'LOTXLOCXID.LOC',    -- DocType
                  @cLOC

               IF @nErrNo = 0 -- Populate multi SKU screen
               BEGIN
                  -- Go to Multi SKU screen
                  SET @nCurScn = @nScn
                  SET @nCurStep = @nStep
                  SET @nScn = 3570
                  SET @nStep = @nStep + 13
                  GOTO Quit
               END
               IF @nErrNo = -1 -- Found in Doc, skip multi SKU screen
               BEGIN
                  SET @nErrNo = 0
                  SET @cActSKU = @cUPC
               END
            END
            ELSE
            BEGIN
               SET @nErrNo = 65935
               SET @cErrMsg = rdt.rdtgetmessage( 65935, @cLangCode, 'DSP') --'SameBarCodeSKU'
               IF @nFunc = 1620
               BEGIN
                  SET @cOutField04 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 4
               END
               ELSE
               BEGIN
                  SET @cOutField03 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 3
               END

               IF ISNULL(@cClusterPickLockQtyToPick, '') = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END
               GOTO Quit
            END
         END

         SET @d_step2 = GETDATE() -- (Vicky02)

         EXEC [RDT].[rdt_GETSKU]
          @cStorerKey  = @cStorerKey
         ,@cSKU        = @cActSKU       OUTPUT
         ,@bSuccess    = @b_Success     OUTPUT
         ,@nErr        = @n_Err         OUTPUT
         ,@cErrMsg     = @c_ErrMsg      OUTPUT

         SET @d_step2 = GETDATE() - @d_step2 -- (Vicky02)

         IF @cActSKU <> @cSKU
         BEGIN
            -- SOS 197651 If config setup show error message in new screen (james11)
            IF rdt.RDTGetConfig( @nFunc, 'ShowWrongSKUInNewScn', @cStorerKey) = 1
            BEGIN
               SET @nErrNo = 0
               SET @cErrMsg1 = '65936 Different SKU'
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg1
               IF @nErrNo = 1
               BEGIN
                  SET @cErrMsg1 = ''
               END

               IF @nFunc = 1620
               BEGIN
                  SET @cOutField04 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 4
               END
               ELSE
               BEGIN
                  SET @cOutField03 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 3
               END

               IF ISNULL(@cClusterPickLockQtyToPick, '') = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END
               GOTO Quit
            END

            SET @nErrNo = 65936
            SET @cErrMsg = rdt.rdtgetmessage( 65936, @cLangCode, 'DSP') --'Different SKU'
            IF @nFunc = 1620
            BEGIN
               SET @cOutField04 = ''
               EXEC rdt.rdtSetFocusField @nMobile, 4
            END
            ELSE
            BEGIN
               SET @cOutField03 = ''
               EXEC rdt.rdtSetFocusField @nMobile, 3
            END

            IF ISNULL(@cClusterPickLockQtyToPick, '') = '1'
            BEGIN
               SET @cFieldAttr13 = 'O'
               SET @cInField13 = @cDefaultPickQty
            END
            GOTO Quit
         END

         IF ISNULL( @cScanLOT02, '') = '1' AND @cFieldAttr06 = '' AND ISNULL( @cInField06, '') = ''   --(james32)
         BEGIN
            IF @nFunc = 1620
               SET @cOutField04 = @cInField04
            ELSE
               SET @cOutField03 = @cInField03
            EXEC rdt.rdtSetFocusField @nMobile, 6
            GOTO Quit
         END
      END

      -- Validate Lot02 (james32)
      IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
         SET @cScanLOT02 = '0'
      ELSE
      BEGIN
         IF ISNULL( @cInField06, '') = ''
         BEGIN
            SET @nErrNo = 69384
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'LOT02 REQ'
            SET @cOutField06 = ''
            EXEC rdt.rdtSetFocusField @nMobile, 6
            IF @nFunc = 1620
               SET @cOutField04 = @cInField04
            ELSE
               SET @cOutField03 = @cInField03

            GOTO Quit
         END

         -- Get the Lottable02
         SELECT
            @cLottable02 = Lottable02
         FROM dbo.LotAttribute WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND SKU = @cSKU
            AND LOT = @cLot

         IF @cInField06 <> @cLottable02
         BEGIN
            SET @nErrNo = 69385
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'INVALID LOT02'
            SET @cOutField06 = ''
            EXEC rdt.rdtSetFocusField @nMobile, 6
            IF @nFunc = 1620
               SET @cOutField04 = @cInField04
            ELSE
               SET @cOutField03 = @cInField03

            GOTO Quit
         END
      END --V2.8

      IF @cPrefUOM <> '6' AND @cFieldAttr15 = '' AND ISNULL( @cInField15, '') = '' AND ISNULL( @cInField13, '') = '' -- (james32) --v2.8
      BEGIN
         -- If carton field is blank then check if qty to pick is it > 1 carton
         -- If yes then quit and force them use case field to enter (james35)
         SELECT @nPrefQty = ISNULL ( CASE @cPrefUOM
                                 WHEN '2' THEN Pack.CaseCNT
                                 WHEN '3' THEN Pack.InnerPack
                                 WHEN '6' THEN Pack.QTY
                                 WHEN '1' THEN Pack.Pallet
                                 WHEN '4' THEN Pack.OtherUnit1
                                 WHEN '5' THEN Pack.OtherUnit2 END, 1)
         FROM SKU SKU (NOLOCK)
         JOIN PACK PACK (NOLOCK) ON SKU.PackKey = PACK.PackKey
         WHERE SKU = @cSKU
         AND (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))

         --v2.8 start
         SELECT @nSumPickQTY = SUM( Qty)
         FROM dbo.PICKDETAIL WITH (NOLOCK)
         WHERE Storerkey = @cStorerKey
         AND   Loc = @cLOC
         AND   Sku = @cSKU
         AND   [Status] = '0'
         --V2.8 end

         --IF @nPrefQty < CAST( @cActQty AS INT)
         IF @nPrefQty < CAST( @nSumPickQTY AS INT) --v2.8
         BEGIN
            IF @nFunc = 1620
               SET @cOutField04 = @cInField04
            ELSE
               SET @cOutField03 = @cInField03

            SET @cOutField06 = @cInField06

            EXEC rdt.rdtSetFocusField @nMobile, 15
            GOTO Quit
         END
      END
      ELSE
      BEGIN
         --v2.8 start
         SELECT @nPrefQty = ISNULL ( CASE @cPrefUOM
                                 WHEN '2' THEN Pack.CaseCNT
                                 WHEN '3' THEN Pack.InnerPack
                                 WHEN '6' THEN Pack.QTY
                                 WHEN '1' THEN Pack.Pallet
                                 WHEN '4' THEN Pack.OtherUnit1
                                 WHEN '5' THEN Pack.OtherUnit2 END, 1)
         FROM SKU SKU (NOLOCK)
         JOIN PACK PACK (NOLOCK) ON SKU.PackKey = PACK.PackKey
         WHERE SKU = @cSKU
         AND (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))

         SELECT @nSumPickQTY = SUM( Qty)
         FROM dbo.PICKDETAIL WITH (NOLOCK)
         WHERE Storerkey = @cStorerKey
         AND   OrderKey = @cOrderKey
         AND   Loc = @cLOC
         AND   Sku = @cSKU
         AND   [Status] = '0'

         --INSERT INTO TRACEINFO(TRACENAME, TIMEIN, COL1, Col2, Col3) VALUES ('1621', GETDATE(), @nPrefQty, CAST( @cInField15 AS INT), @nSumPickQTY)
         IF @nPrefQty * CAST( @cInField15 AS INT) = @nSumPickQTY
            GOTO VALIDATE_QTY
         --v2.8 end
         IF ISNULL( @cInField13, '') = ''
         BEGIN
            IF @nFunc = 1620
               SET @cOutField04 = @cInField04
            ELSE
               SET @cOutField03 = @cInField03

            SET @cOutField06 = @cInField06

            IF @cInField15 <> ''
               SET @cOutField15 = @cInField15

            EXEC rdt.rdtSetFocusField @nMobile, 13
            GOTO Quit
         END
      END

      VALIDATE_QTY:
      SET @nPrefQty = 0
      SET @cPrefQty = ''
      IF @cPrefUOM <> '6' AND @cFieldAttr15 = ''   -- (james32)
      BEGIN
         SET @cPrefQty = @cInField15

         IF RDT.rdtIsValidQTY( @cPrefQty, 1) <> 0
            SELECT @nPrefQty = CAST( @cPrefQty AS INT) * ISNULL ( CASE @cPrefUOM
                                    WHEN '2' THEN Pack.CaseCNT
                                    WHEN '3' THEN Pack.InnerPack
                                    WHEN '6' THEN Pack.QTY
                                    WHEN '1' THEN Pack.Pallet
                                    WHEN '4' THEN Pack.OtherUnit1
                                    WHEN '5' THEN Pack.OtherUnit2 END, 1)
            FROM SKU SKU (NOLOCK)
            JOIN PACK PACK (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE SKU = @cSKU
            AND (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))

         --IF @cFieldAttr13 = '' AND ISNULL( @cInField13, '') = ''  AND @cOutField15 = '' -- (james32)
         IF @cFieldAttr13 = '' AND ISNULL( @cInField13, '') = ''  AND @cInField15 = '' -- V2.8
         BEGIN
            IF @nFunc = 1620
               SET @cOutField04 = @cInField04
            ELSE
               SET @cOutField03 = @cInField03

            SET @cOutField06 = @cInField06
            SET @cOutField15 = @cInField15

            EXEC rdt.rdtSetFocusField @nMobile, 13
            GOTO Quit
         END
      END

      IF @cActQty = '0'
      BEGIN
         IF @cPrefQty = '' OR @cPrefQty = '0'
         BEGIN
            SET @cActQty = ''
            IF rdt.RDTGetConfig( @nFunc, 'ShowWrongSKUInNewScn', @cStorerKey) = 1
            BEGIN
               SET @nErrNo = 0
               SET @cErrMsg1 = '65937 QTY needed'
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg1
               IF @nErrNo = 1
               BEGIN
                  SET @cErrMsg1 = ''
               END
            END
            ELSE
            BEGIN
               SET @nErrNo = 65937
               SET @cErrMsg = rdt.rdtgetmessage( 65937, @cLangCode, 'DSP') --'QTY needed'
            END

            --V2.8 start
            IF ISNULL(@cActSKU, '') <> ''
            BEGIN
               IF @nFunc = 1620
                  SET @cOutField04 = @cActSKU
               ELSE
               	SET @cOutField03 = @cActSKU
            END

            -- If config turned on, not allow to change Qty To Pick
            IF @cClusterPickLockQtyToPick = '1'
            BEGIN
               SET @cFieldAttr13 = 'O'
               SET @cInField13 = @cDefaultPickQty
               IF @cFieldAttr15 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 15
            END
            ELSE
            BEGIN
               SET @cOutField13 = @cDefaultPickQty
               EXEC rdt.rdtSetFocusField @nMobile, 13
            END
            --V2.8 end

            GOTO Quit
         END
      END

      IF @cActQty  = ''
         SET @cActQty  = '0' --'Blank taken as zero'

      IF RDT.rdtIsValidQTY( @cActQty, 1) = 0
      BEGIN
         IF @cPrefQty = '' OR @cPrefQty = '0'
         BEGIN
            IF ISNULL(@cActSKU, '') <> ''
            BEGIN
               IF @nFunc = 1620
               BEGIN
                  SET @cOutField04 = @cActSKU
               END
               ELSE
               IF @nFunc in (1621, 1628)
               BEGIN
                  SET @cOutField03 = @cActSKU
               END
            END

            SET @cActQty = ''
            IF rdt.RDTGetConfig( @nFunc, 'ShowWrongSKUInNewScn', @cStorerKey) = 1
            BEGIN
               SET @nErrNo = 0
               SET @cErrMsg1 = '65938 Invalid QTY'
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg1
               IF @nErrNo = 1
               BEGIN
                  SET @cErrMsg1 = ''
               END
            END
            ELSE
            BEGIN
               SET @nErrNo = 65938
               SET @cErrMsg = rdt.rdtgetmessage( 65938, @cLangCode, 'DSP') --'Invalid QTY'
            END

            SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = 0
                            THEN '' ELSE @cDefaultPickQty END
            EXEC rdt.rdtSetFocusField @nMobile, 13
            GOTO Quit
         END
      END

      -- if the SKU is same then increase ActQTY by 1
      IF @cSKU = @cActSKU
      BEGIN
         IF @cClusterPickNike NOT IN ( '', '0')
         BEGIN
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

            SET @cTemp_PrePackIndicator = ''
            SET @cTemp_PrePackIndicator = 0

            SELECT
               @cTemp_PrePackIndicator = PrePackIndicator,
               @nTemp_PackQtyIndicator = PackQtyIndicator
               FROM dbo.SKU WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND @cSKU = SKU

            IF CAST(@cTemp_PrePackIndicator AS INT) = 2
            BEGIN
               SET @cActQty = (CAST(@cActQty AS INT) + @nPrefQty) * @nTemp_PackQtyIndicator
            END
         END

         SET @cActQty = CAST( @cActQty AS INT) + @nPrefQty -- (james32)
         SET @nQtyToPick = @nQtyToPick + CAST(@cActQty AS INT)
         SET @nActQty = @nActQty + CAST(@cActQty AS INT)
      END

      SET @nRDTPickLockQTY = 0

      SELECT @nRDTPickLockQTY = SUM(PickQty)
      FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE OrderKey = @cOrderKey
         AND SKU = @cSKU
         AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
         AND LOC = @cLOC
         AND Status = '1'
         AND AddWho = @cUserName

      -- Update PickQty = QtyToPick
      SET @nStartTranCnt = @@TRANCOUNT    --(james10)
      BEGIN TRAN
      SAVE TRAN A

      IF @cLoadDefaultPickMethod = 'C' AND CAST(@cActQty AS INT) > 0
      BEGIN
         -- (james17)   start
         SET @nRDTPickLockQTY = 0

         SELECT @nRDTPickLockQTY = SUM(PickQty)
         FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE StorerKey = @cStorerKey
            AND Status = '1'
            AND AddWho = @cUserName
            AND LoadKey = @cLoadKey
            AND SKU = @cSKU
            AND LOC = @cLOC
            AND (( ISNULL(@cLottable02, '') = '') OR ( Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(Lottable04, '') = @dLottable04))

         SELECT @nTotalPickQty = ISNULL( SUM(PD.QTY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
         JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE PD.StorerKey = @cStorerKey
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND PD.Status = '0'
            AND LOC.Facility = @cFacility
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND LPD.LoadKey = @cLoadKey
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

         IF (@nRDTPickLockQTY + @cActQty) >  @nTotalPickQty
         BEGIN
            -- reverse the qty if error
            SET @nActQty = @nActQty - CAST(@cActQty AS INT)
            SET @nQtyToPick = @nQtyToPick - CAST(@cActQty AS INT)
            SET @cActQty = ''
            ROLLBACK TRAN A

            IF rdt.RDTGetConfig( @nFunc, 'ShowWrongSKUInNewScn', @cStorerKey) = 1
            BEGIN
               SET @nErrNo = 0
               SET @cErrMsg1 = '69360 Over Pick'
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg1
               IF @nErrNo = 1
               BEGIN
                  SET @cErrMsg1 = ''
               END
            END
            ELSE
            BEGIN
               SET @nErrNo = 69360
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'Over Pick'
            END

            SET @cOutField13 = @cDefaultPickQty
            EXEC rdt.rdtSetFocusField @nMobile, 13
            GOTO Step_8_Fail
         END
         -- (james17)   end

         SET @nQty2Offset = CAST(@cActQty AS INT)
         IF ISNULL(@cBarcode, '') <> '' AND ISNULL(@cDecodeSP, '') <> '' AND @cBarcode = @cSKU
            SET @cBarcode = ''

         DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT RPL.ORDERKEY, O.Priority, RPL.LOT, SUM(RPL.PickQty)
         FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
         JOIN dbo.Orders O WITH (NOLOCK) ON (RPL.ORDERKEY = O.ORDERKEY)
         WHERE RPL.StorerKey = @cStorerKey
            AND RPL.status = '1'
            AND RPL.AddWho = @cUserName
            AND RPL.LoadKey = @cLoadKey
            AND RPL.SKU = @cSKU
            AND RPL.LOC = @cLOC
         GROUP BY RPL.ORDERKEY, O.Priority, RPL.LOT
         ORDER BY O.PRIORITY, RPL.ORDERKEY, RPL.LOT     -- Highest priority got the changes to be offset first
         OPEN CUR_LOOK4CONSO_ORDERS
         FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cPriority, @cLOT, @nRPL_Qty
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            SELECT @nPD_Qty = SUM(PD.QTY)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.StorerKey = @cStorerKey
               AND PD.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND PD.LOT = @cLOT
               AND PD.OrderKey = @cConso_Orders
               AND PD.Status = '0'
               AND LOC.Facility = @cFacility

            IF @nPD_Qty > @nRPL_Qty
            BEGIN
               IF (@nPD_Qty - @nRPL_Qty) >= @nQty2Offset
               BEGIN
                  IF NOT EXISTS ( SELECT 1
                                 FROM RDT.RDTPickLock WITH (NOLOCK)
                                 WHERE OrderKey = @cConso_Orders
                                 AND StorerKey = @cStorerKey
                                 AND SKU = @cSKU
                                 AND LOC = @cLOC
                                 AND LOT = @cLOT
                                 AND DropID = @cDropID
                                 AND Status = '1'
                                 AND AddWho = @cUserName
                                 AND (( ISNULL( LabelNo, '') = '') OR ( ISNULL( LabelNo, '') = @cBarcode))
                                 )
                  BEGIN
                     INSERT INTO RDT.RDTPickLock
                     (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                     , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey, PickQty, LabelNo)
                     SELECT TOP 1 WaveKey, LoadKey, Orderkey, '**' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey,
                     LOT, LOC, Lottable02, Lottable04, '1', AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey, @nQty2Offset, @cBarcode
                     FROM RDT.RDTPickLock WITH (NOLOCK)
                     WHERE OrderKey = @cConso_Orders
                     AND StorerKey = @cStorerKey     --tlting03
                     AND SKU = @cSKU
                     AND LOC = @cLOC
                     AND LOT = @cLOT
                     AND Status = '1'
                     AND AddWho = @cUserName
                  END
                  ELSE
                  BEGIN
                     IF @cBarcode = ''
                        UPDATE TOP (1) RDT.RDTPickLock WITH (ROWLOCK) SET
                           PickQty = PickQty + @nQty2Offset
                        WHERE OrderKey = @cConso_Orders
                           AND StorerKey = @cStorerKey     --tlting03
                           AND SKU = @cSKU
                           AND LOC = @cLOC
                           AND LOT = @cLOT
                           AND DropID = @cDropID
                           AND Status = '1'
                           AND AddWho = @cUserName
                           AND ISNULL( LabelNo, '') = ''
                     ELSE
                        UPDATE TOP (1) RDT.RDTPickLock WITH (ROWLOCK) SET
                           PickQty = PickQty + @nQty2Offset
                        WHERE OrderKey = @cConso_Orders
                           AND StorerKey = @cStorerKey     --tlting03
                           AND SKU = @cSKU
                           AND LOC = @cLOC
                           AND LOT = @cLOT
                           AND DropID = @cDropID
                           AND Status = '1'
                           AND AddWho = @cUserName
                           AND (( ISNULL( LabelNo, '') = '') OR ( ISNULL( LabelNo, '') = @cBarcode))
                  END

                  SET @nQty2Offset = 0
               END
               ELSE
               IF (@nPD_Qty - @nRPL_Qty) < @nQty2Offset
               BEGIN
                  SET @c_LabelNo = ''
                  SELECT @c_LabelNo = LabelNo
                  FROM RDT.RDTPickLock WITH (ROWLOCK)
                  WHERE OrderKey = @cConso_Orders
                     AND StorerKey = @cStorerKey     --tlting03
                     AND SKU = @cSKU
                     AND LOC = @cLOC
                     AND LOT = @cLOT
                     AND DropID = @cDropID
                     AND Status = '1'
                     AND AddWho = @cUserName

                  IF @c_LabelNo = @cBarcode OR ISNULL( @c_LabelNo, '') = ''
                  BEGIN
                     IF NOT EXISTS ( SELECT 1
                                     FROM RDT.RDTPickLock WITH (NOLOCK)
                                     WHERE OrderKey = @cConso_Orders
                                    AND StorerKey = @cStorerKey     --tlting03
                                    AND SKU = @cSKU
                                    AND LOC = @cLOC
                                    AND LOT = @cLOT
                                    AND DropID = @cDropID
                                    AND Status = '1'
                                    AND AddWho = @cUserName
                                    AND PickQty = 0)
                     BEGIN
                        INSERT INTO RDT.RDTPickLock
                        (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                        , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey, PickQty, LabelNo)
                        SELECT TOP 1 WaveKey, LoadKey, Orderkey, '**' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey,
                        LOT, LOC, Lottable02, Lottable04, '1', AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey, (@nPD_Qty - @nRPL_Qty), @cUCCNo
                        FROM RDT.RDTPickLock WITH (NOLOCK)
                        WHERE OrderKey = @cConso_Orders
                           AND StorerKey = @cStorerKey     --tlting03
                           AND SKU = @cSKU
                           AND LOC = @cLOC
                           AND LOT = @cLOT
                           AND DropID = @cDropID
                           AND Status = '1'
                           AND AddWho = @cUserName
                     END
                     ELSE
                     BEGIN
                        UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
                           PickQty = PickQty + (@nPD_Qty - @nRPL_Qty)
                        WHERE OrderKey = @cConso_Orders
                           AND StorerKey = @cStorerKey     --tlting03
                           AND SKU = @cSKU
                           AND LOC = @cLOC
                           AND LOT = @cLOT
                           AND DropID = @cDropID
                           AND Status = '1'
                           AND AddWho = @cUserName
                           AND (( ISNULL( LabelNo, '') = '') OR ( LabelNo = @cBarcode))
                     END
                  END
                  ELSE
                  BEGIN
                     INSERT INTO RDT.RDTPickLock
                     (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                     , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey, PickQty, LabelNo)
                     SELECT TOP 1 WaveKey, LoadKey, Orderkey, '**' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey,
                     LOT, LOC, Lottable02, Lottable04, '1', AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey, (@nPD_Qty - @nRPL_Qty), @cUCCNo
                     FROM RDT.RDTPickLock WITH (NOLOCK)
                     WHERE OrderKey = @cConso_Orders
                        AND StorerKey = @cStorerKey     --tlting03
                        AND SKU = @cSKU
                        AND LOC = @cLOC
                        AND LOT = @cLOT
                        AND DropID = @cDropID
                        AND Status = '1'
                        AND AddWho = @cUserName
                  END

                  SET @nQty2Offset = @nQty2Offset - (@nPD_Qty - @nRPL_Qty)
               END

               IF @@ERROR <> 0 OR @@ROWCOUNT = 0
               BEGIN
                  SET @nErrNo = 65979
                  SET @cErrMsg = rdt.rdtgetmessage( 65979, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN A
                  GOTO Step_8_Fail
               END
            END

            IF @nQty2Offset <= 0
               BREAK

            FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cPriority, @cLOT, @nRPL_Qty
         END
         CLOSE CUR_LOOK4CONSO_ORDERS
         DEALLOCATE CUR_LOOK4CONSO_ORDERS
      END
      ELSE
      BEGIN -- @cLoadDefaultPickMethod <> 'C'
          -- ChewKP01 (Start)
         SET @nRDTPickLockQTY = 0

         SELECT @nRDTPickLockQTY = SUM(PickQty)
         FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE OrderKey = @cOrderKey
            AND SKU = @cSKU
            AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND LOC = @cLOC
            AND Status = '1'
            AND AddWho = @cUserName

         IF (@nRDTPickLockQTY + CAST(@cActQty AS INT)) >  @nTotalPickQty
         BEGIN
            -- reverse the qty if error
            SET @nActQty = @nActQty - CAST(@cActQty AS INT)
            SET @nQtyToPick = @nQtyToPick - CAST(@cActQty AS INT)
            SET @cActQty = ''
            -- SOS 197651 If config setup show error message in new screen (james11)
            IF rdt.RDTGetConfig( @nFunc, 'ShowWrongSKUInNewScn', @cStorerKey) = 1
            BEGIN
               SET @nErrNo = 0
               SET @cErrMsg1 = '65939 Over Pick'
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg1
               IF @nErrNo = 1
               BEGIN
                  SET @cErrMsg1 = ''
               END
            END
            ELSE
            BEGIN
               SET @nErrNo = 65939
               SET @cErrMsg = rdt.rdtgetmessage( 65939, @cLangCode, 'DSP') --'Over Pick'
               ROLLBACK TRAN A -- ang01
               GOTO Step_8_Fail -- ang01
            END

            SET @cOutField13 = @cDefaultPickQty
            EXEC rdt.rdtSetFocusField @nMobile, 13
            GOTO Step_8_Fail
         END

         UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
            PickQty = PickQty + CAST(@cActQty AS INT)
         WHERE OrderKey = @cOrderKey
            AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND SKU = @cSKU
            AND LOC = @cLOC
            AND DropID = @cDropID
            AND Status = '1'
            AND AddWho = @cUserName

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65940
            SET @cErrMsg = rdt.rdtgetmessage( 65940, @cLangCode, 'DSP') --'UPDPKLockFail'
            ROLLBACK TRAN A
            GOTO Step_8_Fail
         END
      END   -- @cLoadDefaultPickMethod <> 'C'

      -- (james41)
      IF @cExtendedValidateSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.objects WHERE name = @cExtendedValidateSP AND type = 'P')
         BEGIN
            SET @nQty = CAST( @cActQty AS INT)
            SET @nErrNo = 0
            SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedValidateSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cLoc                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@nQty                      INT, '           +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                  @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

            IF @nErrNo <> 0
            BEGIN
               IF @nFunc = 1620
               BEGIN
                  SET @cOutField04 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 4
               END
               ELSE
               BEGIN
                  SET @cOutField03 = ''
                  EXEC rdt.rdtSetFocusField @nMobile, 3
               END

               IF ISNULL(@cClusterPickLockQtyToPick, '') = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END

               -- reverse the qty if error
               SET @nActQty = @nActQty - CAST(@cActQty AS INT)
               SET @nQtyToPick = @nQtyToPick - CAST(@cActQty AS INT)
               SET @cActQty = ''

               ROLLBACK TRAN A
               SET @cOutField13 = @cDefaultPickQty
               EXEC rdt.rdtSetFocusField @nMobile, 13
               GOTO Step_8_Fail
            END
         END
      END

      SET @d_step3 = GETDATE() -- (Vicky02)

      -- If scanned qty = pick qty
      -- Add in LOT as selection criteria because for conso, there might be few orders with
      -- different lot or 1 order with different lot
      IF @nTotalPickQty = @nQtyToPick
      BEGIN
         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT DISTINCT OrderKey, LOT FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
            AND Status = '1'
            AND AddWho = @cUserName
            AND LoadKey = @cLoadKey
            AND SKU = @cSKU
            OPEN CUR_LOOK4CONSO_ORDERS
            FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               SET @nErrNo = 0
               SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
               IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
               BEGIN
                  SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                     ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                     ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                  SET @cSQLParms =
                     '@nMobile                   INT,           ' +
                     '@nFunc                     INT,           ' +
                     '@cLangCode                 NVARCHAR( 3),  ' +
                     '@nStep                     INT,           ' +
                     '@nInputKey                 INT,           ' +
                     '@cFacility                 NVARCHAR( 5),  ' +
                     '@cStorerkey                NVARCHAR( 15), ' +
                     '@cWaveKey                  NVARCHAR( 10), ' +
                     '@cLoadKey                  NVARCHAR( 10), ' +
                     '@cOrderKey                 NVARCHAR( 10), ' +
                     '@cPutAwayZone              NVARCHAR( 10), ' +
                     '@cPickZone                 NVARCHAR( 10), ' +
                     '@cSKU                      NVARCHAR( 20), ' +
                     '@cPickSlipNo               NVARCHAR( 10), ' +
                     '@cLOT                      NVARCHAR( 10), ' +
                     '@cLOC                      NVARCHAR( 10), ' +
                     '@cDropID                   NVARCHAR( 20), ' +
                     '@cStatus                   NVARCHAR( 1),  ' +
                     '@cCartonType               NVARCHAR( 10), ' +
                     '@nErrNo                    INT           OUTPUT,  ' +
                     '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                     @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                     @cLOT, @cLOC, @cDropID, '5', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
               END
               ELSE
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cPutAwayZone,
                     @cPickZone,
                     @cConso_Orders,   -- Set orderkey = '' as conso pick
                     @cSKU,
                     @cPickSlipNo,
                     @cLOT,
                     @cLOC,
                     @cDropID,
                     '5',
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                     @nMobile, -- (Vicky06)
                     @nFunc    -- (Vicky06)
               END

               IF @nErrNo <> 0
               BEGIN
                  -- reverse the qty if error
                  SET @nActQty = @nActQty - CAST(@cActQty AS INT)
                  SET @nQtyToPick = @nQtyToPick - CAST(@cActQty AS INT)
                  SET @cActQty = ''

                  ROLLBACK TRAN A
                  IF @nErrNo IN (66043, 66044, 66047, 66048)
                  BEGIN
                     EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg
                     SET @nErrNo = 0
                     SET @cErrMsg = ''
                  END

                  CLOSE CUR_LOOK4CONSO_ORDERS
                  DEALLOCATE CUR_LOOK4CONSO_ORDERS
                  GOTO Step_8_Fail
               END
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
            END
            CLOSE CUR_LOOK4CONSO_ORDERS
            DEALLOCATE CUR_LOOK4CONSO_ORDERS
         END
         ELSE
         BEGIN -- @cLoadDefaultPickMethod <> 'C'
            SET @nErrNo = 0
            SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
            IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
            BEGIN
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                  ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                  ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cFacility                 NVARCHAR( 5),  ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cPutAwayZone              NVARCHAR( 10), ' +
               '@cPickZone                 NVARCHAR( 10), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@cPickSlipNo               NVARCHAR( 10), ' +
               '@cLOT                      NVARCHAR( 10), ' +
               '@cLOC                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cStatus                   NVARCHAR( 1),  ' +
               '@cCartonType               NVARCHAR( 10), ' +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
               @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
               @cLOT, @cLOC, @cDropID, '5', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
            END
            ELSE
            BEGIN
               EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cPutAwayZone,
                  @cPickZone,
                  @cOrderKey,
                  @cSKU,
                  @cPickSlipNo,
                  @cLOT,
                  @cLOC,
                  @cDropID,
                  '5',
                  @cLangCode,
                  @nErrNo        OUTPUT,
                  @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                  @nMobile, -- (Vicky06)
                  @nFunc    -- (Vicky06)
            END
         END   -- @cLoadDefaultPickMethod <> 'C'

         IF @nErrNo <> 0
         BEGIN
            ROLLBACK TRAN A
            IF @nErrNo IN (66043, 66044, 66047, 66048)
         		BEGIN
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg
               SET @nErrNo = 0
               SET @cErrMsg = ''
            END

            -- reverse the qty if error
            SET @nActQty = @nActQty - CAST(@cActQty AS INT)
            SET @nQtyToPick = @nQtyToPick - CAST(@cActQty AS INT)
            GOTO Step_8_Fail
         END

         SET @d_step3 = GETDATE() - @d_step3 -- (Vicky02)

         SET @d_step4 = GETDATE() -- (Vicky02)

         -- (james39)
         IF @cExtendedUpdateSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedUpdateSP AND type = 'P')
            BEGIN
               SET @nErrNo = 0
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedUpdateSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                  ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

               SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cLoc                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@nQty                      INT, '           +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                    @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

               IF @nErrNo <> 0
               BEGIN
                  ROLLBACK TRAN A

                  -- reverse the qty if error
                  SET @nActQty = @nActQty - CAST(@cActQty AS INT)
                  SET @nQtyToPick = @nQtyToPick - CAST(@cActQty AS INT)
                  GOTO Step_8_Fail
               END
            END
         END

         -- If pick by conso then look for all orders
         -- and group by logicalloc, loc, sku, lot2, lot4
         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            -- Remember current LOC (james19)
            SET @cPrevLOC = ''
            SET @cPrevLOC = @cLOC

            SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)

            IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
            BEGIN
               SET @c_oFieled03 = @cSKU
               EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                   @n_Mobile        = @nMobile
                  ,@n_Func          = @nFunc
                  ,@c_SPName        = @cClusterPickGetNextTask_SP
                  ,@c_Storerkey     = @cStorerKey
                  ,@c_UserName      = @cUserName
                  ,@c_Facility      = @cFacility
                  ,@c_PutawayZone   = @cPutawayZone
                  ,@c_PickZone      = @cPickZone
                  ,@c_LangCode      = @cLangCode
                  ,@c_oFieled01     = @c_oFieled01 OUTPUT
                  ,@c_oFieled02     = @c_oFieled02 OUTPUT
                  ,@c_oFieled03     = @c_oFieled03 OUTPUT
                  ,@c_oFieled04     = @c_oFieled04 OUTPUT
                  ,@c_oFieled05     = @c_oFieled05 OUTPUT
                  ,@c_oFieled06     = @c_oFieled06 OUTPUT
                  ,@c_oFieled07     = @c_oFieled07 OUTPUT
                  ,@c_oFieled08     = @c_oFieled08 OUTPUT
                  ,@c_oFieled09     = @c_oFieled09 OUTPUT
                  ,@c_oFieled10     = @c_oFieled10 OUTPUT
                  ,@c_oFieled11     = @c_oFieled11 OUTPUT
                  ,@c_oFieled12     = @c_oFieled12 OUTPUT
                  ,@c_oFieled13     = @c_oFieled13 OUTPUT
                  ,@c_oFieled14     = @c_oFieled14 OUTPUT
                  ,@c_oFieled15     = @c_oFieled15 OUTPUT
                  ,@b_Success       = @b_Success   OUTPUT
                  ,@n_ErrNo         = @nErrNo      OUTPUT
                  ,@c_ErrMsg        = @cErrMsg     OUTPUT

               SET @cLOC            = @c_oFieled01
               SET @cOrderKey       = @c_oFieled02
               SET @cSKU            = @c_oFieled03
               SET @cSKU_Descr      = @c_oFieled04
               SET @cStyle          = @c_oFieled05
               SET @cColor          = @c_oFieled06
               SET @cSize           = @c_oFieled07
               SET @cColor_Descr    = @c_oFieled08
               SET @cLot            = @c_oFieled09
               SET @cPickSlipNo     = @c_oFieled10
               SET @cExternOrderKey = @c_oFieled11
               SET @cConsigneeKey   = @c_oFieled12
               SET @cLottable02     = @c_oFieled13
               SET @dLottable04     = @c_oFieled14

               SET @cNewLOC = @cLOC
               SET @cNewSKU = @cSKU
               SET @cNewLottable02 = @cLottable02
               SET @dNewLottable04 = @dLottable04
            END
            ELSE
            BEGIN
               SET @cLogicalLoc = ''
               SELECT @cLogicalLoc = LogicalLocation
               FROM dbo.LOC WITH (NOLOCK)
               WHERE LOC = @cLOC
                  AND Facility = @cFacility

               SELECT TOP 1
                  @cLOC = PD.Loc,
                  @cSKU = PD.SKU,
                  @cLottable02 = LA.Lottable02,
                  @dLottable04 = LA.Lottable04
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK)
                  ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)    -- (james09)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
               JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE O.StorerKey = @cStorerKey        -- tlting03
                  AND PD.Status = '0'
                  AND O.LoadKey = @cLoadKey
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                  AND LOC.Facility = @cFacility
                  AND RTRIM(LOC.LogicalLocation) + RTRIM(PD.SKU) + ISNULL(RTRIM(LA.Lottable02), '') + ISNULL(CONVERT( NVARCHAR( 10), LA.Lottable04, 120), 0) >
                        RTRIM(@cLogicalLoc) + RTRIM(@cSKU) + RTRIM(@cLottable02) + ISNULL(CONVERT( NVARCHAR( 10), @dLottable04, 120), 0)--@dLottable04
                  AND NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK)
                     WHERE PD.StorerKey = RPL.StorerKey AND PD.OrderKey = RPL.OrderKey AND PD.SKU = RPL.SKU AND RPL.Status = '1')
               GROUP BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
               ORDER BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04

               -- No more task
               IF @@ROWCOUNT = 0
               BEGIN
                  SELECT TOP 1
                     @cNewLOC = PD.Loc,
                     @cNewSKU = PD.SKU,
                     @cNewLottable02 = LA.Lottable02,
                     @dNewLottable04 = LA.Lottable04
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                  JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
                  JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
                  JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
                  WHERE O.StorerKey = @cStorerKey
                     AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                     AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                     AND PD.Status = '0'
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                     AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                     AND LOC.Facility = @cFacility
                  GROUP BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
                  ORDER BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
               END
               ELSE
               BEGIN
                  SET @cNewLOC = @cLOC
                  SET @cNewSKU = @cSKU
                  SET @cNewLottable02 = @cLottable02
                  SET @dNewLottable04 = @dLottable04
               END
            END

            SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cNewLOC
            IF ISNULL( @cLocDescr, '') = ''
               SET @cLocDescr = @cLOC

            IF ISNULL( @cNewLoc, '') = ''
            BEGIN
               SET @cPromptCloseCase = ''
               SET @cPromptCloseCase = rdt.RDTGetConfig( @nFunc, 'PromptCloseCase', @cStorerKey)

               IF LEN( RTRIM( @cPromptCloseCase)) > 1
               BEGIN
                  IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cPromptCloseCase AND type = 'P')
                  BEGIN
                     SET @nErrNo = 0
                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cPromptCloseCase) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                        ' @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '
                     SET @cSQLParam =
                        '@nMobile          INT,                   ' +
                        '@nFunc            INT,                   ' +
                        '@cLangCode        NVARCHAR( 3),          ' +
                        '@nStep            INT,                   ' +
                        '@nInputKey        INT,                   ' +
                        '@cStorerkey       NVARCHAR( 15),         ' +
                        '@cWaveKey         NVARCHAR( 10),         ' +
                        '@cLoadKey         NVARCHAR( 10),         ' +
                        '@cOrderKey        NVARCHAR( 10),         ' +
                        '@cLoc             NVARCHAR( 10),         ' +
                        '@cDropID          NVARCHAR( 20),         ' +
                        '@cSKU             NVARCHAR( 20),         ' +
                        '@nQty             INT,                   ' +
                        '@cPromptCloseCase NVARCHAR( 1)  OUTPUT,  ' +
                        '@nErrNo           INT           OUTPUT,  ' +
                        '@cErrMsg          NVARCHAR( 20) OUTPUT   '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                        @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT
                  END
               END

               --If no more task then prompt Close Case screen (If turned on) (james03)
               IF @cPromptCloseCase = '1'
               BEGIN
                  IF rdt.RDTGetConfig( @nFunc, 'AutoCloseCaseIfLastCarton', @cStorerKey) = '1'
                  BEGIN
                     SET @nErrNo = 0
                     EXECUTE RDT.rdt_Cluster_Pick_PrintLabel
                        @nMobile,
                        @nFunc,
                        @nStep,
                        @nInputKey,
                        @cLangCode,
                        @cStorerKey,
                        @cWaveKey,
                        @cLoadKey,
                        @cCurrentOrderKey,
                        @cPickSlipNo,
                        @cLOC,
                        @cDropID,
                        @cSKU,
                        @nQty,
                        @nErrNo   OUTPUT,
                        @cErrMsg  OUTPUT

                     IF @nErrNo <> 0
                     BEGIN
                        ROLLBACK TRAN A
                        GOTO Step_8_Fail
                     END

                     -- Insert into DropID table   (james30)
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
                     BEGIN
                        SET @nErrNo = 0
                        EXECUTE rdt.rdt_Cluster_Pick_DropID
                           @nMobile,
                           @nFunc,
                           @cStorerKey,
                           @cUserName,
                           @cFacility,
                           @cLoadKey,
                           @cPickSlipNo,
                           @cCurrentOrderKey,
                           @cDropID       OUTPUT,
                           @cSKU,
                           'U',      -- U = Update
                           @cLangCode,
                           @nErrNo        OUTPUT,
                           @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

                        IF @nErrNo <> 0
                        BEGIN
                           ROLLBACK TRAN A
                           GOTO Step_8_Fail
                        END
                     END
                  END
                  ELSE
                  BEGIN
                     SET @cOutField01 = ''

                     -- Go to Close Case screen
                     SET @nScn  = 1886
                     SET @nStep = 15

                     -- Commit the transaction before goto picking screen
                     COMMIT TRAN

                     GOTO Quit
                  END
               END

               SELECT
                  @nOrderPicked = COUNT( DISTINCT OrderKey),
                  @nTTL_PickedQty = SUM(PickQty)
               FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE AddWho = @cUserName
                  AND Status = '5'  -- Picked
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                  AND StorerKey = @cStorerKey

               -- (james36)
               SET @cPickNotFinish = ''
               IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
               BEGIN
                  IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                              JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                              JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                              JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                              WHERE PD.StorerKey = @cStorerKey
                              AND   PD.Status = '0'
                              AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                              AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                              AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                              AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                              AND   LOC.Facility = @cFacility
                              AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                    WHERE PD.OrderKey = RPL.OrderKey
                                                    AND   PD.StorerKey = RPL.StorerKey
                                                    AND   RPL.AddWho = @cUserName
                                                    AND   RPL.Status < '9'))
                  BEGIN
                     SET @cPickNotFinish = 'PICKING NOT FINISH'
                  END
               END

               -- Prep next screen var
               SET @cOutField01 = @cWaveKey
               SET @cOutField02 = @cLoadKey
               SET @cOutField03 = @cPutawayZone
               SET @cOutField04 = @cPickZone
               SET @cOutField05 = @nOrderPicked
               SET @cOutField06 = @nTTL_PickedQty
               SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

               SET @nScn  = 1879
               SET @nStep = 10

               SET @nActQty = 0
               SET @nQtyToPick = 0

               SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
               SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND AddWho = @cUserName
                  AND Status = '5'
               OPEN @curUpdRPL
               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
                  WHERE RowRef = @nRowRef

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65942
                     SET @cErrMsg = rdt.rdtgetmessage( 65942, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN A
                     GOTO Step_8_Fail
                  END

                  FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               END
               CLOSE @curUpdRPL
               DEALLOCATE @curUpdRPL

               -- Commit the transaction before goto picking screen
               COMMIT TRAN

               GOTO Quit
            END
            ELSE
            BEGIN
               SET @cLOC = @cNewLOC
               SET @cSKU = @cNewSKU
               SET @cLottable02 = @cNewLottable02
               SET @dLottable04 = @dNewLottable04

               EXEC [RDT].[rdt_ClusterPickSkuAttribute]
                  @nMobile       = @nMobile,
                  @nFunc         = @nFunc,
                  @cLangCode     = @cLangCode,
                  @nStep         = @nStep,
                  @nInputKey     = @nInputKey,
                  @cStorerKey    = @cStorerKey,
                  @cSKU          = @cSKU,
                  @cAltSKU       = @cAltSKU       OUTPUT,
                  @cDescr        = @cSKU_Descr    OUTPUT,
                  @cStyle        = @cStyle        OUTPUT,
                  @cColor        = @cColor        OUTPUT,
                  @cSize         = @cSize         OUTPUT,
                  @cColor_Descr  = @cColor_Descr  OUTPUT,
                  @cAttribute01  = @cAttribute01  OUTPUT,
                  @cAttribute02  = @cAttribute02  OUTPUT,
                  @cAttribute03  = @cAttribute03  OUTPUT,
                  @cAttribute04  = @cAttribute04  OUTPUT,
                  @cAttribute05  = @cAttribute05  OUTPUT,
                  @cAttribute06  = @cAttribute06  OUTPUT,
                  @cAttribute07  = @cAttribute07  OUTPUT,
                  @cAttribute08  = @cAttribute08  OUTPUT,
                  @cAttribute09  = @cAttribute09  OUTPUT,
                  @cAttribute10  = @cAttribute10  OUTPUT,
                  @nErrNo        = @nErrNo        OUTPUT,
                  @cErrMsg       = @cErrMsg       OUTPUT

               IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
               BEGIN
                  SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
                  SET @cColor = @cColor + ' '
                  SET @cSKU_Descr = ''
               END

               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT PD.ORDERKEY, PD.LOT
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey and PD.OrderLineNumber = OD.OrderLineNumber)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE OD.StorerKey = @cStorerKey       --tlting03
                  AND PD.STATUS = '0'
                  AND PD.LOC = @cLOC
                  AND PD.SKU = @cSKU
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                  AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               GROUP BY PD.ORDERKEY, PD.LOT
               ORDER BY PD.ORDERKEY, PD.LOT
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  BEGIN TRAN

                  INSERT INTO RDT.RDTPickLock
                  (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
                  , LOT, LOC, SKU, DropID, Lottable02, Lottable04, Status, AddWho, AddDate, PickSlipNo, Mobile, PackKey)
                  VALUES
                  (ISNULL(@cWaveKey, ''), ISNULL(@cLoadKey, ''), @cConso_Orders, 'SKIP', @cStorerKey, ISNULL(@cPutAwayZone, ''), ISNULL(@cPickZone, ''), @cConso_Orders,
                  @cLot, @cLoc, @cSKU, @cDropID, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cPickSlipNo, @nMobile, @cCartonType)

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65976
                     SET @cErrMsg = rdt.rdtgetmessage( 65976, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN A
                     GOTO Step_8_Fail
                  END

                  COMMIT TRAN

                  FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS

               SELECT @nTTL_Qty = SUM(PD.QTY)
               FROM dbo.PickDetail PD WITH (NOLOCK) --ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND PD.SKU = @cSKU
                  AND PD.LOC = @cLOC
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)

               -- Get the total allocated qty for LOC + SKU + OrderKey
               SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.LOC = @cLOC
                  AND PD.SKU = @cSKU
                  AND PD.Status = '0'
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
                  AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

               SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
               IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

               IF @cDefaultToAllocatedQty = '1'
               BEGIN
                  SET @cDefaultPickQty = @nTotalPickQty
               END

               SET @nQtyToPick = 0
               SET @nActQty = 0

               -- Get Total Orders left on the current sku that need to pick
               SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE RPL.StorerKey = @cStorerKey
                  AND RPL.Status < '5'
                  AND RPL.AddWho = @cUserName
                  AND RPL.PickQty <= 0
                  AND LA.StorerKey = @cStorerKey
                  AND LA.SKU = @cSKU
                  AND PD.LOC = @cLOC
                  AND PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

               -- (james14)
               IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
               BEGIN
                  SET @cOS_Qty = ''

                  IF @cLoadDefaultPickMethod = 'C'
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND LPD.LoadKey = @cLoadKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND PD.Status >= '3'
                        AND LPD.LoadKey = @cLoadKey

                     SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
                  ELSE
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey
                        AND Status >= '3'

                     SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
               END

               IF @cClusterPickNike <> ''
               BEGIN
                  IF @cClusterPickNike = '1'
                  BEGIN
                     SET @cTemp_String = ''
                     SET @cTemp_UOM = ''
                     SET @nTemp_PackQtyIndicator = ''

                     SELECT
                        @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                        @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                     FROM dbo.SKU SKU WITH (NOLOCK)
                     JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                     WHERE SKU.StorerKey = @cStorerKey
                        AND SKU.SKU = @cSKU

                     SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                        '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                  END
                  ELSE
                  BEGIN
                     IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo2 = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                        SET @cTemp_String = @cExtendedInfo2
                     END
                  END
               END

               -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
               BEGIN
                  SET @cPackCfg = ''

                  SELECT @fPack_Qty = PACK.QTY,
                         @fPack_InnerPack = PACK.InnerPack,
                         @fPack_CaseCnt = PACK.CaseCnt
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE SKU.StorerKey = @cStorerKey
                     AND SKU.SKU = @cSKU

                  SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                                  RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                                  RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
               END

               SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
               IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
                  SET @cScanLOT02 = '0'

               IF @cPrefUOM <> '6'
               BEGIN
                  SELECT TOP 1
                     @nPrefUOM_Div = CAST( IsNULL(
                        CASE @cPrefUOM
                           WHEN '2' THEN Pack.CaseCNT
                           WHEN '3' THEN Pack.InnerPack
                           WHEN '6' THEN Pack.QTY
                           WHEN '1' THEN Pack.Pallet
                           WHEN '4' THEN Pack.OtherUnit1
                           WHEN '5' THEN Pack.OtherUnit2
                        END, 1) AS INT)
                  FROM dbo.SKU SKU (NOLOCK)
                     INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
                  WHERE StorerKey = @cStorerKey
                     AND SKU = @cSKU

                  -- Convert to prefer UOM QTY to be picked
                  SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

                  -- Convert to prefer UOM QTY picked
                  SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

						--SOS334125 Start
                  SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                            '/' +
                                            RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
						--SOS334125 End

                  SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
                  SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
               END

               -- Extended info
               IF @cExtendedInfoSP <> ''
               BEGIN
                  IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
                  END
               END

               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
               BEGIN
                  -- If change of LOC then need to go back to confirm LOC screen
                  IF @cPrevLOC <> @cLOC
                  BEGIN
                     -- Commit until the level we started
                     WHILE @@TRANCOUNT > @nStartTranCnt
                        COMMIT TRAN

                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = ''

                     -- Go to next screen
                     SET @nScn  = 1892
                     SET @nStep = 19

                     GOTO Quit
                  END
               END

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cDropID
                  SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField04 = ''
                  SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
                  SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                                     THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                          ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

                  EXEC rdt.rdtSetFocusField @nMobile, 4

                  SET @nScn  = 1877
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cSKU
                  SET @cOutField03 = ''
                  SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1883
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1628  -- (james07)
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField03 = ''
                  SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
                  SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cLoadKey
                  SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1888
                  SET @nStep = 8
               END

               IF @cPrefUOM <> '6'
                  SET @cOutField12 = @cPreferQty2Display
               ELSE
                  SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

               SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                                  THEN '' ELSE @cDefaultPickQty END -- Qty to pick
               SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
               SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                       CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                                  ELSE 'QTY: ' END

               -- Commit transaction
               COMMIT TRAN

               SET @cFieldAttr01 = ''
               SET @cFieldAttr02 = ''
               SET @cFieldAttr03 = ''
               SET @cFieldAttr04 = ''
               SET @cFieldAttr05 = ''
               SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
               SET @cFieldAttr07 = ''
               SET @cFieldAttr08 = ''
               SET @cFieldAttr09 = ''
               SET @cFieldAttr10 = ''
               SET @cFieldAttr11 = ''
               SET @cFieldAttr12 = ''
               SET @cFieldAttr13 = ''
               SET @cFieldAttr14 = ''
               SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

               -- If config turned on, not allow to change Qty To Pick
               IF @cClusterPickLockQtyToPick = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END

               GOTO Quit
            END
         END
         ELSE
         BEGIN
            -- SOS172041
            -- If SKU.SUSR4 setup with L'Oreal Anti-Diversion code
            -- Use codelkup to determine whether we need to capture serial no (james20)
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickInsPackDt', @cStorerKey) = '1'
            BEGIN
               SET @nCount = 0   -- (james27)
               SET @cSKUFieldName = rdt.RDTGetConfig( @nFunc, 'FieldName2CaptureSerialNo', @cStorerKey)
               IF ISNULL(@cSKUFieldName, '') NOT IN ('', '0')
               BEGIN
                  IF NOT EXISTS(SELECT 1 FROM SYS.COLUMNS
                                WHERE NAME = @cSKUFieldName
                                AND   OBJECT_ID = OBJECT_ID(N'SKU'))
                  BEGIN
                     SET @nErrNo = 69377
                     SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'Bad SKU Field'
                     ROLLBACK TRAN A
                     GOTO Step_8_Fail
                  END

                  SET @cExecStatements = ''
                  SET @cExecStatements = 'SELECT @nCount = COUNT(1) ' +
                           'FROM dbo.CODELKUP CLK WITH (NOLOCK) ' +
                           'JOIN dbo.SKU SKU WITH (NOLOCK) ON (CLK.StorerKey = SKU.StorerKey AND CLK.Code = SKU.' + RTRIM(@cSKUFieldName) + ') ' +
                           'WHERE CLK.StorerKey = ''' + RTRIM(@cStorerKey)  + ''' ' +
                           'AND CLK.ListName = ''PICKSERIAL'' ' +
                           'AND   SKU.SKU = ''' + RTRIM(@cSKU)  + ''' '
                  SET @cExecArguments = N'@nCount            INT     OUTPUT , ' +
                                         '@cSKUFieldName     NVARCHAR( 30)  , ' +
                                         '@cStorerKey        NVARCHAR( 15)  , ' +
                                         '@cSKU              NVARCHAR( 20)   '
                  EXEC sp_ExecuteSql @cExecStatements
                                   , @cExecArguments
                                   , @nCount       OUTPUT
                                   , @cSKUFieldName
                                   , @cStorerKey
                                   , @cSKU
               END

               IF @nCount > 0 OR
               -- cater for existing customer who not setup codelkup yet
               EXISTS ( SELECT 1 FROM dbo.SKU WITH (NOLOCK)
                        WHERE StorerKey = @cStorerKey
                        AND   SKU = @cSKU
                        AND   SUSR4 = 'AD' )
               BEGIN
                  SELECT @nOtherUnit2 = OtherUnit2 FROM Pack P WITH (NOLOCK)
                  JOIN SKU S WITH (NOLOCK) ON (P.PackKey = S.PackKey)
                  WHERE StorerKey = @cStorerKey
                     AND SKU = @cSKU

                  IF @nOtherUnit2 <= 0
                  BEGIN
                     SET @nErrNo = 69341
                     SET @cErrMsg = rdt.rdtgetmessage( 69341, @cLangCode, 'DSP') --'LockOrdersFail'
                     ROLLBACK TRAN A
                     GOTO Step_8_Fail
                  END

                  SELECT @nSum_PickQty = ISNULL(SUM(PickQty), 0) FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                     AND OrderKey = @cOrderKey
                     AND SKU = @cSKU
                     AND LOT = @cLOT
                     AND LOC = @cLOC
                     AND AddWho = @cUserName
                     AND Status = '5'
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                     AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))

                  SELECT @nCount_SerialNo = Count(1) FROM dbo.SerialNo WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                     AND OrderKey = @cOrderKey
                     AND SKU = @cSKU

                  -- IF @nOtherUnit2 > 0 AND (@nSum_PickQty % @nOtherUnit2 = 0) (Shong01)
                  IF @nOtherUnit2 > 0 AND (@nSum_PickQty % @nOtherUnit2 = 0 OR @nOtherUnit2=1)
                  BEGIN
                     -- Check whether still need to scan Anti-Diversion code
                     IF (@nSum_PickQty / @nOtherUnit2) > @nCount_SerialNo
                     BEGIN
                     SET @cOutField01 = @cSKU
                        SET @cOutField02 = SUBSTRING(@cSKU_Descr,  1, 20)
                        SET @cOutField03 = SUBSTRING(@cSKU_Descr, 21, 20)
                        SET @cOutField04 = SUBSTRING(@cSKU_Descr, 41, 20)
                        SET @cOutField05 = ''
                        SET @cOutField06 = CAST(@nCount_SerialNo AS NVARCHAR( 5)) + '/' + CAST((@nSum_PickQty / @nOtherUnit2) AS NVARCHAR( 5))

                        SET @nCurScn = @nScn  -- remember current screen no
                        SET @nCurStep = @nStep  -- remember current step no

                        -- Go to Anti-Diversion code screen
                        SET @nScn  = 1891
                        SET @nStep = 17

                        -- Commit the transaction before goto picking screen
                        COMMIT TRAN

                        GOTO Quit
                     END
                  END   -- @nOtherUnit2 > 0
               END   -- PICKSERIAL
            END   -- ClusterPickInsPackDt

            -- Get next available task
            SET @nErrNo = 0
            SET @cCurrentOrderKey = @cOrderKey -- to Store the current Orderkey
            SET @cOrderKey = ''

            -- Remember current LOC (james19)
            SET @cPrevLOC = ''
            SET @cPrevLOC = @cLOC

            SET @cPrevSKU = ''
            SET @cPrevSKU = @cSKU

            SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
            IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
            BEGIN
               EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                   @n_Mobile        = @nMobile
                  ,@n_Func          = @nFunc
                  ,@c_SPName        = @cClusterPickGetNextTask_SP
                  ,@c_Storerkey     = @cStorerKey
                  ,@c_UserName      = @cUserName
                  ,@c_Facility      = @cFacility
                  ,@c_PutawayZone   = @cPutawayZone
                  ,@c_PickZone      = @cPickZone
                  ,@c_LangCode      = @cLangCode
                  ,@c_oFieled01     = @c_oFieled01 OUTPUT
                  ,@c_oFieled02     = @c_oFieled02 OUTPUT
                  ,@c_oFieled03     = @c_oFieled03 OUTPUT
                  ,@c_oFieled04     = @c_oFieled04 OUTPUT
                  ,@c_oFieled05     = @c_oFieled05 OUTPUT
                  ,@c_oFieled06     = @c_oFieled06 OUTPUT
                  ,@c_oFieled07     = @c_oFieled07 OUTPUT
                  ,@c_oFieled08     = @c_oFieled08 OUTPUT
                  ,@c_oFieled09     = @c_oFieled09 OUTPUT
                  ,@c_oFieled10     = @c_oFieled10 OUTPUT
                  ,@c_oFieled11     = @c_oFieled11 OUTPUT
                  ,@c_oFieled12     = @c_oFieled12 OUTPUT
                  ,@c_oFieled13     = @c_oFieled13 OUTPUT
                  ,@c_oFieled14     = @c_oFieled14 OUTPUT
                  ,@c_oFieled15     = @c_oFieled15 OUTPUT
                  ,@b_Success       = @b_Success   OUTPUT
                  ,@n_ErrNo         = @nErrNo      OUTPUT
                  ,@c_ErrMsg        = @cErrMsg     OUTPUT

               SET @cLOC            = @c_oFieled01
               SET @cOrderKey       = @c_oFieled02
               SET @cSKU            = @c_oFieled03
               SET @cSKU_Descr      = @c_oFieled04
               SET @cStyle          = @c_oFieled05
               SET @cColor          = @c_oFieled06
               SET @cSize           = @c_oFieled07
               SET @cColor_Descr    = @c_oFieled08
               SET @cLot            = @c_oFieled09
               SET @cPickSlipNo     = @c_oFieled10
               SET @cExternOrderKey = @c_oFieled11
               SET @cConsigneeKey   = @c_oFieled12
            END
            ELSE
            BEGIN
               EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cPutAwayZone,
                  @cPickZone,
                  @cLangCode,
                  @nErrNo           OUTPUT,
                  @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
                  @cLOC             OUTPUT,
                  @cOrderKey        OUTPUT,
                  @cExternOrderKey  OUTPUT,
                  @cConsigneeKey    OUTPUT,
                  @cSKU             OUTPUT,
                  @cSKU_Descr       OUTPUT,
                  @cStyle           OUTPUT,
                  @cColor           OUTPUT,
                  @cSize            OUTPUT,
                  @cColor_Descr     OUTPUT,
                  @cLot             OUTPUT,
                  @cPickSlipNo      OUTPUT,
                  @nMobile,
                  @nFunc

               IF @nErrNo <> 0
               BEGIN
                  SET @nErrNo = 65941
                  SET @cErrMsg = rdt.rdtgetmessage( 65941, @cLangCode, 'DSP') --'GetNextTaskFail'
                  ROLLBACK TRAN A
                  GOTO Step_8_Fail
               END
            END
         END

         SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
         IF ISNULL( @cLocDescr, '') = ''
            SET @cLocDescr = @cLOC

         SET @d_step4 = GETDATE() - @d_step4 -- (Vicky02)

         -- If no more task, goto confirm picking screen
         IF ISNULL(@cOrderKey, '') = ''
         BEGIN
            SET @cPromptCloseCase = ''
            SET @cPromptCloseCase = rdt.RDTGetConfig( @nFunc, 'PromptCloseCase', @cStorerKey)

            IF LEN( RTRIM( @cPromptCloseCase)) > 1
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cPromptCloseCase AND type = 'P')
               BEGIN
                  SET @nErrNo = 0
                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cPromptCloseCase) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                     ' @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '
                  SET @cSQLParam =
                     '@nMobile          INT,                   ' +
                     '@nFunc            INT,                   ' +
                     '@cLangCode        NVARCHAR( 3),          ' +
                     '@nStep            INT,                   ' +
                     '@nInputKey        INT,                   ' +
                     '@cStorerkey       NVARCHAR( 15),         ' +
                     '@cWaveKey         NVARCHAR( 10),         ' +
                     '@cLoadKey         NVARCHAR( 10),         ' +
                     '@cOrderKey        NVARCHAR( 10),         ' +
                     '@cLoc             NVARCHAR( 10),         ' +
                     '@cDropID          NVARCHAR( 20),         ' +
                     '@cSKU             NVARCHAR( 20),         ' +
                     '@nQty             INT,                   ' +
                     '@cPromptCloseCase NVARCHAR( 1)  OUTPUT,  ' +
                     '@nErrNo           INT           OUTPUT,  ' +
                     '@cErrMsg          NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                     @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT
               END
            END

            --If no more task then prompt Close Case screen (If turned on) (james03)
            IF @cPromptCloseCase = '1'
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'AutoCloseCaseIfLastCarton', @cStorerKey) = '1'
               BEGIN
                  SET @nErrNo = 0
                  EXECUTE RDT.rdt_Cluster_Pick_PrintLabel
                     @nMobile,
                     @nFunc,
                     @nStep,
                     @nInputKey,
                     @cLangCode,
                     @cStorerKey,
                     @cWaveKey,
                     @cLoadKey,
                     @cCurrentOrderKey,
                     @cPickSlipNo,
                     @cLOC,
                     @cDropID,
                     @cSKU,
                     @nQty,
                     @nErrNo   OUTPUT,
                     @cErrMsg  OUTPUT

                  IF @nErrNo <> 0
                  BEGIN
                     ROLLBACK TRAN A
                     GOTO Step_8_Fail
                  END

                  -- Insert into DropID table   (james30)
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
                  BEGIN
                     SET @nErrNo = 0
                     EXECUTE rdt.rdt_Cluster_Pick_DropID
                        @nMobile,
                        @nFunc,
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cLoadKey,
                        @cPickSlipNo,
                        @cCurrentOrderKey,
                        @cDropID       OUTPUT,
                        @cSKU,
                        'U',      -- U = Update
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

                     IF @nErrNo <> 0
                     BEGIN
                        ROLLBACK TRAN A
                        GOTO Step_8_Fail
                     END
                  END
               END
               ELSE
               BEGIN
                  SET @cOutField01 = ''

                  -- Go to Close Case screen
                  SET @nScn  = 1886
                  SET @nStep = 15

                  -- Commit the transaction before goto picking screen
                  COMMIT TRAN

                  GOTO Quit
               END
            END

            SET @cOrderKey = @cCurrentOrderKey -- Assign back the OrderKey

            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            SELECT
               @nOrderPicked = COUNT( DISTINCT OrderKey),
               @nTTL_PickedQty = SUM(PickQty)
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE AddWho = @cUserName
               AND Status = '5'  -- Picked
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))

            -- (james36)
            SET @cPickNotFinish = ''
            IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
            BEGIN
               IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                           JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                           JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                           JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                           WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                           AND   ( PD.Status = '0' OR PD.Status = '4')
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                           AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                           AND   LOC.Facility = @cFacility
                           AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                 WHERE PD.OrderKey = RPL.OrderKey
                                                 AND   PD.StorerKey = RPL.StorerKey
                                                 AND   RPL.AddWho = @cUserName
                                                 AND   RPL.Status < '9'))
               BEGIN
                  SET @cPickNotFinish = 'PICKING NOT FINISH'
               END
            END

            -- Prep next screen var
            SET @cOutField01 = @cWaveKey
            SET @cOutField02 = @cLoadKey
            SET @cOutField03 = @cPutawayZone
            SET @cOutField04 = @cPickZone
            SET @cOutField05 = @nOrderPicked
            SET @cOutField06 = @nTTL_PickedQty
            SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

            SET @nScn  = 1879
            SET @nStep = 10

            SET @nActQty = 0
            SET @nQtyToPick = 0

            SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               AND AddWho = @cUserName
               AND Status = '5'
            OPEN @curUpdRPL
            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
               WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65942
                  SET @cErrMsg = rdt.rdtgetmessage( 65942, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN A
                  GOTO Step_8_Fail
               END

               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            END
            CLOSE @curUpdRPL
            DEALLOCATE @curUpdRPL

            -- Commit the transaction before goto picking screen
            COMMIT TRAN

            GOTO Quit
         END

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

         -- Get the Lottables
         SELECT
            @cLottable02 = Lottable02,
            @dLottable04 = Lottable04
         FROM dbo.LotAttribute WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
            AND SKU = @cSKU
            AND LOT = @cLot

         IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                        WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                        AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                        AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                        AND OrderKey = @cOrderKey
                        AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                        AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                        AND Status = '1'
                        AND SKU IS NULL
                        AND AddWho = @cUserName)
         BEGIN
            -- Insert next task to picklock
            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
             SKU, PutAwayZone, PickZone, PickDetailKey
            ,LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
            VALUES
            (@cWaveKey, @cLoadKey, @cOrderKey, '', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
             @cSKU, @cPutAwayZone, @cPickZone, ''
            ,@cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65943
               SET @cErrMsg = rdt.rdtgetmessage( 65943, @cLangCode, 'DSP') --'LockOrdersFail'
               ROLLBACK TRAN A
               GOTO Step_8_Fail
            END
         END
         ELSE
         BEGIN
            UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
               LOT = @cLot,
               LOC = @cLoc,
               SKU = @cSKU,
               DropID = @cDropID,
               PackKey = @cCartonType,
               Lottable02 = @cLottable02,
               Lottable04 = @dLottable04
            WHERE OrderKey = @cOrderKey
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND Status = '1'
               AND AddWho = @cUserName

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65929
               SET @cErrMsg = rdt.rdtgetmessage( 65929, @cLangCode, 'DSP') --'UPDPKLockFail'
               ROLLBACK TRAN A
               GOTO Step_8_Fail
            END
         END

         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
         BEGIN
            -- If change of LOC then need to go back to confirm LOC screen
            IF @cPrevLOC <> @cLOC
            BEGIN
               -- Commit until the level we started
               WHILE @@TRANCOUNT > @nStartTranCnt
                  COMMIT TRAN

               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = ''

               -- Go to next screen
               SET @nScn  = 1892
               SET @nStep = 19

               GOTO Quit
            END
         END

         IF @cPrevSKU <> @cSKU
         BEGIN
            EXEC [RDT].[rdt_ClusterPickSkuAttribute]
               @nMobile       = @nMobile,
               @nFunc         = @nFunc,
               @cLangCode     = @cLangCode,
               @nStep         = @nStep,
               @nInputKey     = @nInputKey,
               @cStorerKey    = @cStorerKey,
               @cSKU          = @cSKU,
               @cAltSKU       = @cAltSKU       OUTPUT,
               @cDescr        = @cSKU_Descr    OUTPUT,
               @cStyle        = @cStyle        OUTPUT,
               @cColor        = @cColor        OUTPUT,
               @cSize         = @cSize         OUTPUT,
               @cColor_Descr  = @cColor_Descr  OUTPUT,
               @cAttribute01  = @cAttribute01  OUTPUT,
               @cAttribute02  = @cAttribute02  OUTPUT,
               @cAttribute03  = @cAttribute03  OUTPUT,
               @cAttribute04  = @cAttribute04  OUTPUT,
               @cAttribute05  = @cAttribute05  OUTPUT,
               @cAttribute06  = @cAttribute06  OUTPUT,
               @cAttribute07  = @cAttribute07  OUTPUT,
               @cAttribute08  = @cAttribute08  OUTPUT,
               @cAttribute09  = @cAttribute09  OUTPUT,
               @cAttribute10  = @cAttribute10  OUTPUT,
               @nErrNo        = @nErrNo        OUTPUT,
               @cErrMsg       = @cErrMsg       OUTPUT

            IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
            BEGIN
               SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
               SET @cColor = @cColor + ' '
               SET @cSKU_Descr = ''
            END
         END

         -- (james39)
         IF @cAutoPromptDropID <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cAutoPromptDropID AND type = 'P')
            BEGIN
               SET @nErrNo = 0
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cAutoPromptDropID) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                  ' @cLoc, @cDropID, @cSKU, @nQty, @nPromptDropIDScn OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '

               SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cLoc                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@nQty                      INT, '           +
                  '@nPromptDropIDScn          INT           OUTPUT,  ' +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                    @cLoc, @cDropID, @cSKU, @nQty, @nPromptDropIDScn OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT

               -- If result allow auto go back to DropID screen
               IF @nPromptDropIDScn = '1'
               BEGIN
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
                  BEGIN
                     -- If change of LOC then need to go back to confirm LOC screen
                     IF @cPrevLOC <> @cLOC
                     BEGIN
                        SET @nActQty = 0
                        SET @nQtyToPick = 0

                        -- Commit until the level we started
                        WHILE @@TRANCOUNT > @nStartTranCnt
                           COMMIT TRAN

                        SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                        SET @cOutField02 = ''

                      -- Go to next screen
                      SET @nScn  = 1892
                      SET @nStep = 19

                        GOTO Quit
                     END
                  END

                  IF @nFunc = 1620
                  BEGIN
                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = @cOrderKey
                     SET @cOutField03 = @cExternOrderKey
                     SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                     SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                     SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                     SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

                     SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

                     -- (james55)
                     IF @cClusterPickNIKE <> ''
                     BEGIN
                        IF @cClusterPickNIKE = '1'
                        BEGIN
                           SET @cTemp_String = ''
                           SET @cTemp_UOM = ''
                           SET @nTemp_PackQtyIndicator = ''

                           SELECT
                              @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                              @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                           FROM dbo.SKU SKU WITH (NOLOCK)
                           JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                           WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                              AND SKU.SKU = @cSKU

                           SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                              '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                        END
                        ELSE
                        BEGIN
                           IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                           BEGIN
                              SET @cExtendedInfo2 = ''

                              SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                                 ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                              SET @cSQLParam =
                                 '@nMobile       INT, ' +
                                 '@nFunc         INT, ' +
                                 '@cLangCode     NVARCHAR( 3), ' +
                                 '@nStep         INT, ' +
                                 '@nInputKey     INT, ' +
                                 '@cWaveKey      NVARCHAR( 10), ' +
                                 '@cLoadKey      NVARCHAR( 10), ' +
                                 '@cOrderKey     NVARCHAR( 10), ' +
                                 '@cDropID       NVARCHAR( 20), ' +
                                 '@cStorerKey    NVARCHAR( 15), ' +
                                 '@cSKU          NVARCHAR( 20), ' +
                                 '@cLOC          NVARCHAR( 10), ' +
                                 '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                              EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                                 @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                              SET @cOutField08 = @cExtendedInfo2
                           END
                        END

                     END
                     ELSE
                     BEGIN
                        -- Extended info
                        IF @cExtendedInfoSP <> ''
                        BEGIN
                           IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                           BEGIN
                              SET @cExtendedInfo = ''

                              SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                                 ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                              SET @cSQLParam =
                                 '@nMobile       INT, ' +
                                 '@nFunc         INT, ' +
                                 '@cLangCode     NVARCHAR( 3), ' +
                                 '@nStep         INT, ' +
                                 '@nInputKey     INT, ' +
                                 '@cWaveKey      NVARCHAR( 10), ' +
                                 '@cLoadKey      NVARCHAR( 10), ' +
                                 '@cOrderKey     NVARCHAR( 10), ' +
                                 '@cDropID       NVARCHAR( 20), ' +
                                 '@cStorerKey    NVARCHAR( 15), ' +
                                 '@cSKU          NVARCHAR( 20), ' +
                                 '@cLOC          NVARCHAR( 10), ' +
                                 '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                              EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                                 @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT

                              SET @cOutField08 = @cExtendedInfo
                           END
                        END
                        ELSE
                           SET @cOutField08 = @cColor_Descr
                     END

                     SET @cOutField09 = ''   -- DropID
                     SET @cOutField10 = ''
                     SET @cOutField11 = ''

                     -- (james42)
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
                     BEGIN
                        SET @cOutField10 = 'CTN TYPE:'
                        SET @cOutField11 = ''
                     END

                     -- Go to next screen
                     SET @nScn  = 1876
                     SET @nStep = 7
                  END
                  ELSE
                  IF @nFunc = 1621
                  BEGIN
                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = @cOrderKey
                     SET @cOutField03 = @cExternOrderKey
                     SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                     SET @cOutField05 = @cSKU
                     SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                     SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                     SET @cOutField08 = @cLottable02
                     SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                     SET @cOutField10 = ''   -- DropID
                     -- SOS172041

                     SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

                     IF RDT.RDTGetConfig( @nFunc, 'ClusterPickPromptNewDropID', @cStorerKey) = 1
                     BEGIN
                        SELECT @cDropID = DropID FROM RDT.RDTPickLock WITH (NOLOCK)
                        WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                           AND LOC = @cLOC
                           AND OrderKey = @cOrderKey
                           AND AddWho = @cUserName

                        IF ISNULL(@cDropID, '') = ''
                        BEGIN
                           SET @cOutField11 = 'NEW DROP ID'
                           SET @cOutField12 = ''
                        END
                        ELSE
                        BEGIN
                           SET @cOutField11 = @cDropID
                           SET @cOutField12 = ''
                        END
                     END
                     ELSE
                     BEGIN
                        SET @cOutField11 = 'SCAN CARTON ID'
                        SET @cOutField12 = 'DROP ID:'
                     END

                     -- Go to next screen
                     SET @nScn  = 1882
                     SET @nStep = 7
                  END
                  ELSE
                  IF @nFunc = 1628
                  BEGIN
                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = @cLoadKey
                     SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                     SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                     SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                     SET @cOutField08 = @cLottable02
                     SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                     SET @cOutField10 = ''   -- DropID
                     SET @cOutField11 = ''
                     SET @cOutField12 = ''

                     -- Go to next screen
                     SET @nScn  = 1887
                     SET @nStep = 7
                  END

                  -- (james30)
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
                  BEGIN
                     EXECUTE rdt.rdt_Cluster_Pick_DropID
                        @nMobile,
                        @nFunc,
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cLoadKey,
                        @cPickSlipNo,
                        @cOrderKey,
                        @cDropID       OUTPUT,
                        @cSKU,
                        'R',      -- R = Retrieve
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max

                     IF @nFunc = 1620
                     BEGIN
                        IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                           SET @cOutField09 = ''         -- DropID
                        ELSE
                           SET @cOutField09 = @cDropID   -- DropID
                     END
                     ELSE
                     BEGIN
                        IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                           SET @cOutField10 = ''         -- DropID
                        ELSE
                           SET @cOutField10 = @cDropID   -- DropID
                     END
                  END

                  SET @nActQty = 0
                  SET @nQtyToPick = 0

                  -- Commit transaction before goto DropID screen
                  WHILE @@TRANCOUNT > @nStartTranCnt
                     COMMIT TRAN

                  GOTO Quit
               END
            END
         END

         -- If OrderKey changed
         IF @cOrderKey <> @cOutField09
         BEGIN
            -- If configkey 'AutoPromptDropID' turned on, auto go back to DropID screen
            IF @cAutoPromptDropID = '1'
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
               BEGIN
                  -- If change of LOC then need to go back to confirm LOC screen
                  IF @cPrevLOC <> @cLOC
                  BEGIN
                     SET @nActQty = 0
                     SET @nQtyToPick = 0

                     -- Commit until the level we started
                     WHILE @@TRANCOUNT > @nStartTranCnt
                        COMMIT TRAN

                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = ''

                   -- Go to next screen
                   SET @nScn  = 1892
                   SET @nStep = 19

                     GOTO Quit
                  END
               END

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cOrderKey
                  SET @cOutField03 = @cExternOrderKey
                  SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                  SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

                  IF @cClusterPickNike <> ''
                  BEGIN
                     IF @cClusterPickNike = '1'
                     BEGIN
                        SET @cTemp_String = ''
                        SET @cTemp_UOM = ''
                        SET @nTemp_PackQtyIndicator = ''

                        SELECT
                           @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                           @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                        FROM dbo.SKU SKU WITH (NOLOCK)
                        JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                        WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
                           AND SKU.SKU = @cSKU

                        SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                           '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                     END
                     ELSE
                     BEGIN
                        IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                        BEGIN
                           SET @cExtendedInfo2 = ''

                           SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                              ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                           SET @cSQLParam =
                              '@nMobile       INT, ' +
                              '@nFunc         INT, ' +
                              '@cLangCode     NVARCHAR( 3), ' +
                              '@nStep         INT, ' +
                              '@nInputKey     INT, ' +
                              '@cWaveKey      NVARCHAR( 10), ' +
                              '@cLoadKey      NVARCHAR( 10), ' +
                              '@cOrderKey     NVARCHAR( 10), ' +
                              '@cDropID       NVARCHAR( 20), ' +
                              '@cStorerKey    NVARCHAR( 15), ' +
                              '@cSKU          NVARCHAR( 20), ' +
                              '@cLOC          NVARCHAR( 10), ' +
                              '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                           EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                              @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                           SET @cOutField08 = @cExtendedInfo2
                        END
                     END
                  END
                  ELSE
                  BEGIN
                     SET @cOutField08 = @cColor_Descr
                  END

                  SET @cOutField09 = ''   -- DropID
                  SET @cOutField10 = ''
                  SET @cOutField11 = ''

                  SET @nScn  = 1876
                  SET @nStep = 7
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cOrderKey
                  SET @cOutField03 = @cExternOrderKey
                  SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                  SET @cOutField05 = @cSKU
                  SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField08 = @cLottable02
                  SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField10 = ''   -- DropID

                  -- Go to next screen
                  SET @nScn  = 1882
                  SET @nStep = 7
               END
               ELSE
               IF @nFunc = 1628
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cLoadKey
                  SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField08 = @cLottable02
                  SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField10 = ''   -- DropID

                  -- Go to next screen
                  SET @nScn  = 1887
                  SET @nStep = 7
               END

               -- (james30)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_DropID
                     @nMobile,
                     @nFunc,
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cLoadKey,
                     @cPickSlipNo,
                     @cOrderKey,
                     @cDropID       OUTPUT,
                     @cSKU,
                     'R',      -- R = Retrieve
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max

                  IF @nFunc = 1620
                  BEGIN
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                        SET @cOutField09 = ''         -- DropID
                     ELSE
                        SET @cOutField09 = @cDropID   -- DropID
                  END
                  ELSE
                  BEGIN
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                        SET @cOutField10 = ''         -- DropID
                     ELSE
                        SET @cOutField10 = @cDropID   -- DropID
                  END
               END

               SET @nActQty = 0
               SET @nQtyToPick = 0

               -- Commit transaction before goto DropID screen
               COMMIT TRAN

               GOTO Quit
            END
         END   -- If OrderKey changed

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

         SET @d_step5 = GETDATE() -- (Vicky02)
         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
            AND PD.LOC = @cLOC
            AND PD.SKU = @cSKU
            AND PD.OrderKey = @cOrderKey
            AND PD.Status = '0'
            AND PD.LOT = @cLOT
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

         SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
         IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

         -- If DefaultToAllocatedQty = '1' then we use DefaultToAllocatedQty as DefaultPickQty
         IF @cDefaultToAllocatedQty = '1'
         BEGIN
            SET @cDefaultPickQty = @nTotalPickQty
         END

         SET @nQtyToPick = 0
         SET @nActQty = 0

         -- Get the total oustanding qty for orderkey + putawayzone + pickzone
         SELECT @nTTL_Qty = SUM(QTY)
         FROM RDT.RDTPickLock RPL WITH (NOLOCK)
         JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE (( @nMultiStorer = 1 AND RPL.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND RPL.StorerKey = @cStorerKey))
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND PD.Status = '0'
            AND (( @nMultiStorer = 1 AND LA.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND LA.StorerKey = @cStorerKey))
            AND LA.SKU = @cSKU
            AND L.LOC = @cLOC
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND EXISTS ( SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = RPL.AddWho
                     AND StorerKey = RPL.StorerKey AND OrderKey =  PD.OrderKey )       -- tlting02

         -- Get Total Orders left on the current sku that need to pick
         SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE (( @nMultiStorer = 1 AND RPL.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND RPL.StorerKey = @cStorerKey))
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND (( @nMultiStorer = 1 AND LA.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND LA.StorerKey = @cStorerKey))
            AND LA.SKU = @cSKU      -- tlting03
            AND L.LOC = @cLOC
            AND PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

         SET @d_step5 = GETDATE() - @d_step5 -- (Vicky02)

         -- (james14)
         IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
         BEGIN
            SET @cOS_Qty = ''

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND LPD.LoadKey = @cLoadKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.Status >= '3'
                  AND LPD.LoadKey = @cLoadKey

               SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
            ELSE
            BEGIN
               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND OrderKey = @cOrderKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND OrderKey = @cOrderKey
                     AND Status >= '3'

               SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
         END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cTemp_String = @cExtendedInfo2
               END
            END
         END

         -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
         BEGIN
            SET @cPackCfg = ''

            SELECT @fPack_Qty = PACK.QTY,
                   @fPack_InnerPack = PACK.InnerPack,
                   @fPack_CaseCnt = PACK.CaseCnt
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                            RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                            RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
         END

         IF @cPrefUOM <> '6'
         BEGIN
            SELECT TOP 1
               @nPrefUOM_Div = CAST( IsNULL(
                  CASE @cPrefUOM
                     WHEN '2' THEN Pack.CaseCNT
                     WHEN '3' THEN Pack.InnerPack
                     WHEN '6' THEN Pack.QTY
                     WHEN '1' THEN Pack.Pallet
                     WHEN '4' THEN Pack.OtherUnit1
                     WHEN '5' THEN Pack.OtherUnit2
                  END, 1) AS INT)
            FROM dbo.SKU SKU (NOLOCK)
               INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU

            -- Convert to prefer UOM QTY to be picked
            SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

            -- Convert to prefer UOM QTY picked
            SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

				--SOS334125 Start
            SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                      '/' +
                                      RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
				--SOS334125 End

            SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
            SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
         END

         -- Extended info
         IF @cExtendedInfoSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
            BEGIN
               SET @cExtendedInfo = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
            END
         END

         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cDropID
            SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField04 = ''
            SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
            SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                               THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

            EXEC rdt.rdtSetFocusField @nMobile, 4
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cSKU
            SET @cOutField03 = ''
            SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                               THEN @cOS_Qty
                               WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3
         END
         ELSE
         IF @nFunc = 1628  -- (james07)
         BEGIN
           -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField03 = ''
            SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
            SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                               THEN @cOS_Qty
                               WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cLoadKey
            SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3
         END

         IF @cPrefUOM <> '6'
            SET @cOutField12 = @cPreferQty2Display
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

         SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                            THEN '' ELSE @cDefaultPickQty END -- Qty to pick
         SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
         SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                 CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                            ELSE 'QTY: ' END

         --Commit transaction before
         COMMIT TRAN

         SET @cFieldAttr01 = ''
         SET @cFieldAttr02 = ''
         SET @cFieldAttr03 = ''
         SET @cFieldAttr04 = ''
         SET @cFieldAttr05 = ''
         SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
         SET @cFieldAttr07 = ''
         SET @cFieldAttr08 = ''
         SET @cFieldAttr09 = ''
         SET @cFieldAttr10 = ''
         SET @cFieldAttr11 = ''
         SET @cFieldAttr12 = ''
         SET @cFieldAttr13 = ''
         SET @cFieldAttr14 = ''
         SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

         -- If config turned on, not allow to change Qty To Pick
         IF @cClusterPickLockQtyToPick = '1'
         BEGIN
            SET @cFieldAttr13 = 'O'
            SET @cInField13 = @cDefaultPickQty
         END

         GOTO Quit

      END   -- If scanned qty = pick qty

      WHILE @@TRANCOUNT > @nStartTranCnt
         COMMIT TRAN

         -- (james39)
         IF @cAutoPromptDropIDIfIDChanged <> ''
         BEGIN
            IF @cAutoPromptDropIDIfIDChanged = '1'
            --IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cAutoPromptDropIDIfIDChanged AND type = 'P')
            BEGIN
               SET @nErrNo = 0
               declare @nIDQty int, @nRPLIDQty int
               SELECT @cID = ID, @nRPLIDQty = SUM( PICKQTY)
               FROM RDT.RDTPICKLOCK
               WHERE STORERKEY = @cStorerKey
               AND LOC = @cLOC
               AND SKU = @cSKU
               AND WAVEKEY = @cWaveKey
               AND ADDWHO = @cUserName
               AND STATUS = '1'
               AND DropID = @cDropID
               GROUP BY ID

               SELECT @nIDQty = SUM( QTY)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
               --AND   OrderKey = @cOrderKey
               AND   Loc = @cLOC
               AND   SKU = @cSKU
               AND   ID = @cID

               -- If result allow auto go back to DropID screen
               IF @nIDQty=@nRPLIDQty
               BEGIN
                  IF @nFunc = 1620
                  BEGIN
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = @cOrderKey
                     SET @cOutField03 = @cExternOrderKey
                     SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                     SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                     SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                     SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

                     IF @nMultiStorer = 1
                        SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

                     IF @cClusterPickNike <> ''
                     BEGIN
                        IF @cClusterPickNike = '1'
                        BEGIN
                           SET @cTemp_String = ''
                           SET @cTemp_UOM = ''
                           SET @nTemp_PackQtyIndicator = ''

                           SELECT
                              @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                              @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                           FROM dbo.SKU SKU WITH (NOLOCK)
                           JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                           WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                              AND SKU.SKU = @cSKU

                           SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                              '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                        END
                        ELSE
                        BEGIN
                           IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                           BEGIN
                              SET @cExtendedInfo2 = ''

                              SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                                 ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                              SET @cSQLParam =
                                 '@nMobile       INT, ' +
                                 '@nFunc         INT, ' +
                                 '@cLangCode     NVARCHAR( 3), ' +
                                 '@nStep         INT, ' +
                                 '@nInputKey     INT, ' +
                                 '@cWaveKey      NVARCHAR( 10), ' +
                                 '@cLoadKey      NVARCHAR( 10), ' +
                                 '@cOrderKey     NVARCHAR( 10), ' +
                                 '@cDropID       NVARCHAR( 20), ' +
                                 '@cStorerKey    NVARCHAR( 15), ' +
                                 '@cSKU          NVARCHAR( 20), ' +
                                 '@cLOC          NVARCHAR( 10), ' +
                                 '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                              EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                                 @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                              SET @cOutField08 = @cExtendedInfo2
                           END
                        END
                     END

                     -- (james42)
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
                     BEGIN
                        SET @cOutField10 = 'CTN TYPE:'
                        SET @cOutField11 = ''
                     END

                     SET @cOutField09 = ''   -- DropID
                     SET @cOutField10 = ''
                     SET @cOutField11 = ''

                     UPDATE RDT.RDTPickLock WITH (ROWLOCK) -- SOS# 173419
                        SET DropID = ''
                     WHERE AddWho = @cUserName AND PickQty = 0
                     AND Status = '1' AND Mobile = @nMobile
                     AND Sku = @cSKU
                     AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                     AND WaveKey = @cWaveKey AND LoadKey = @cLoadKey
                     AND OrderKey = @cOrderKey AND LOC = @cLOC
                     AND PutawayZone = @cPutAwayZone AND PickZone = @cPickZone
                     AND ISNULL(RTRIM(DropID),'') = @cDropID

                     -- Prepare Prev Screen
                     SET @nScn  = 1876
                     SET @nStep = 7

                     GOTO Quit
                  END
               END
            END
         END

      -- Extended info
      IF @cExtendedInfoSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
         BEGIN
            SET @cExtendedInfo = ''

            SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

            SET @cSQLParam =
               '@nMobile       INT, ' +
               '@nFunc         INT, ' +
               '@cLangCode     NVARCHAR( 3), ' +
               '@nStep         INT, ' +
               '@nInputKey     INT, ' +
               '@cWaveKey      NVARCHAR( 10), ' +
               '@cLoadKey      NVARCHAR( 10), ' +
               '@cOrderKey     NVARCHAR( 10), ' +
               '@cDropID       NVARCHAR( 20), ' +
               '@cStorerKey    NVARCHAR( 15), ' +
               '@cSKU          NVARCHAR( 20), ' +
               '@cLOC          NVARCHAR( 10), ' +
               '@cExtendedInfo NVARCHAR( 20) OUTPUT '

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
         END
      END

      -- (james36)
      IF @cLoadDefaultPickMethod = 'C'
         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE PD.LOC = @cLOC
            AND PD.SKU = @cSKU
            AND PD.Status = '0'
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
               AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey)
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))
      ELSE
         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM( QTY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
            AND PD.LOC = @cLOC
            AND PD.SKU = @cSKU
            AND PD.OrderKey = @cOrderKey
            AND PD.Status = '0'
            AND PD.LOT = @cLOT
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

      IF @cDefaultToAllocatedQty = '1'
      BEGIN
         SET @cDefaultPickQty = @nTotalPickQty - @nQtyToPick --CAST(@cActQty AS INT)
      END

      -- (james14)
      IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
      BEGIN
         SET @cOS_Qty = ''

         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND LPD.LoadKey = @cLoadKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND PD.Status >= '3'
               AND LPD.LoadKey = @cLoadKey

            SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
         ELSE
         BEGIN
            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey
               AND Status >= '3'

            SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
      END

      IF @cPrefUOM <> '6'
      BEGIN
         SELECT TOP 1
            @nPrefUOM_Div = CAST( IsNULL(
               CASE @cPrefUOM
                  WHEN '2' THEN Pack.CaseCNT
                  WHEN '3' THEN Pack.InnerPack
                  WHEN '6' THEN Pack.QTY
                  WHEN '1' THEN Pack.Pallet
                  WHEN '4' THEN Pack.OtherUnit1
                  WHEN '5' THEN Pack.OtherUnit2
               END, 1) AS INT)
         FROM dbo.SKU SKU (NOLOCK)
            INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
         WHERE StorerKey = @cStorerKey
            AND SKU = @cSKU

         -- Convert to prefer UOM QTY to be picked
         SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

         -- Convert to prefer UOM QTY picked
         SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

			--SOS334125 Start
         SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                   '/' +
                                   RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
			--SOS334125 End

         SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
         SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
      END

      IF @nFunc = 1620
      BEGIN
         SET @cOutField04 = ''   -- SKU/UPC
         SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
         SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                            THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         EXEC rdt.rdtSetFocusField @nMobile, 4
      END
      ELSE
      IF @nFunc IN (1621, 1628)
      BEGIN
         SET @cOutField03 = ''   -- SKU/UPC
         SET @cOutField06 = CASE WHEN @cScanLot02 = 1 THEN '' ELSE @cLottable02 END
         EXEC rdt.rdtSetFocusField @nMobile, 3
      END
      SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                              THEN @cOS_Qty
                              WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                         ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
      IF @nFunc = 1620
         SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))
      ELSE
      BEGIN
         IF @cPrefUOM <> '6'
            SET @cOutField12 = @cPreferQty2Display
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))
      END
      SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '0') = '0' THEN '' ELSE @cDefaultPickQty END  -- Qty to pick
      SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                              CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                         ELSE 'QTY: ' END

      SET @cFieldAttr01 = ''
      SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

      -- If config turned on, not allow to change Qty To Pick
      IF @cClusterPickLockQtyToPick = '1'
      BEGIN
         SET @cFieldAttr13 = 'O'
         SET @cInField13 = @cDefaultPickQty
      END
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      SET @cPromptCloseCase = ''
      SET @cPromptCloseCase = rdt.RDTGetConfig( @nFunc, 'PromptCloseCase', @cStorerKey)

      IF LEN( RTRIM( @cPromptCloseCase)) > 1
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cPromptCloseCase AND type = 'P')
         BEGIN
            SET @nErrNo = 0
            SET @cSQL = 'EXEC rdt.' + RTRIM( @cPromptCloseCase) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '
            SET @cSQLParam =
               '@nMobile          INT,                   ' +
               '@nFunc            INT,                   ' +
               '@cLangCode        NVARCHAR( 3),          ' +
               '@nStep            INT,                   ' +
               '@nInputKey        INT,                   ' +
               '@cStorerkey       NVARCHAR( 15),         ' +
               '@cWaveKey         NVARCHAR( 10),         ' +
               '@cLoadKey         NVARCHAR( 10),         ' +
               '@cOrderKey        NVARCHAR( 10),         ' +
               '@cLoc             NVARCHAR( 10),         ' +
               '@cDropID          NVARCHAR( 20),         ' +
               '@cSKU             NVARCHAR( 20),         ' +
               '@nQty             INT,                   ' +
               '@cPromptCloseCase NVARCHAR( 1)  OUTPUT,  ' +
               '@nErrNo           INT           OUTPUT,  ' +
               '@cErrMsg          NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
               @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT
         END
      END

      --(james03)
      IF @cPromptCloseCase = '1'
      BEGIN
         SET @cOutField01 = ''

         -- Go to Close Case screen
         SET @nScn  = 1886
         SET @nStep = 15

         GOTO Quit
      END

      IF @nFunc = 1620
      BEGIN
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cOutField08 = @cExtendedInfo2
               END
            END
         END
         ELSE
         BEGIN
            -- Extended info
            IF @cExtendedInfoSP <> ''
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
               BEGIN
                  SET @cExtendedInfo = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT

                  SET @cOutField08 = @cExtendedInfo
               END
            END
            ELSE
            BEGIN
               SET @cOutField08 = @cColor_Descr
            END
         END

         -- (james42)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
         BEGIN
            SET @cOutField10 = 'CTN TYPE:'
            SET @cOutField11 = ''
         END

         SET @cOutField09 = ''   -- DropID
         SET @cOutField10 = ''
         SET @cOutField11 = ''

         UPDATE RDT.RDTPickLock WITH (ROWLOCK) -- SOS# 173419
            SET DropID = ''
         WHERE AddWho = @cUserName AND PickQty = 0
         AND Status = '1' AND Mobile = @nMobile
         AND Sku = @cSKU
         AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
         AND WaveKey = @cWaveKey AND LoadKey = @cLoadKey
         AND OrderKey = @cOrderKey AND LOC = @cLOC
         AND PutawayZone = @cPutAwayZone AND PickZone = @cPickZone
         AND ISNULL(RTRIM(DropID),'') = @cDropID

         -- Prepare Prev Screen
         SET @nScn  = 1876
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = @cSKU
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

         -- SOS172041
         IF RDT.RDTGetConfig( @nFunc, 'ClusterPickPromptNewDropID', @cStorerKey) = 1
         BEGIN
            SELECT @cDropID = DropID FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND LOC = @cLOC
               AND OrderKey = @cOrderKey
               AND AddWho = @cUserName

            IF ISNULL(@cDropID, '') = ''
            BEGIN
               SET @cOutField11 = 'NEW DROP ID'
               SET @cOutField12 = ''
            END
            ELSE
            BEGIN
               SET @cOutField11 = @cDropID
               SET @cOutField12 = ''
            END
         END
         ELSE
         BEGIN
            SET @cOutField11 = 'SCAN CARTON ID'
            SET @cOutField12 = 'DROP ID:'
         END

         -- Go to next screen
         SET @nScn  = 1882
         SET @nStep = 7
      END
      IF @nFunc = 1628  -- (james07)
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cLoadKey
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         -- Go to next screen
         SET @nScn  = 1887
         SET @nStep = 7
      END

      -- (james30)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
      BEGIN
         EXECUTE rdt.rdt_Cluster_Pick_DropID
            @nMobile,
            @nFunc,
            @cStorerKey,
            @cUserName,
            @cFacility,
            @cLoadKey,
            @cPickSlipNo,
            @cOrderKey,
            @cDropID       OUTPUT,
            @cSKU,
            'R',      -- R = Retrieve
            @cLangCode,
            @nErrNo        OUTPUT,
            @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

         IF @nFunc = 1620
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField09 = ''         -- DropID
            ELSE
               SET @cOutField09 = @cDropID   -- DropID
         END
         ELSE
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField10 = ''         -- DropID
            ELSE
               SET @cOutField10 = @cDropID   -- DropID
         END
      END

      -- (james42)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
      BEGIN
         IF @nFunc = 1620
         BEGIN
            SET @cOutField10 = 'CTN TYPE:'
            SET @cFieldAttr11 = ''
            SET @cOutField11 = ''
         END
         ELSE
         BEGIN
            SET @cOutField11 = 'CTN TYPE:'
            SET @cFieldAttr12 = ''
            SET @cOutField12 = ''
         END
      END
      ELSE
      BEGIN
         IF @nFunc = 1620
            SET @cFieldAttr11 = 'O'
         ELSE
            SET @cFieldAttr12 = 'O'
      END
   END

   GOTO Quit

   Step_8_Fail:
   BEGIN
      IF @nFunc = 1620
         SET @cOutField04 = ''   --ActSKU
      ELSE
         SET @cOutField03 = ''   --ActSKU

      SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = 0
                      THEN '' ELSE @cDefaultPickQty END
      EXEC rdt.rdtSetFocusField @nMobile, 13

      IF ISNULL(@cClusterPickLockQtyToPick, '') = '1'
      BEGIN
         SET @cFieldAttr13 = 'O'
      END

      -- rollback didn't decrease @@trancount
      -- COMMIT statements for such transaction
      -- decrease @@TRANCOUNT by 1 without making updates permanent
      WHILE @@TRANCOUNT > @nStartTranCnt
         COMMIT TRAN
   END

END
GOTO Quit

/********************************************************************************
Step 9. Screen = 1878, 1884
   Option     (field01, input)
********************************************************************************/
Step_9:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cOption = @cInField01

      --if input is not either '1' or '2' OR '3'
      --IF @cOption NOT IN ('1', '2', '3')
      IF @cOption NOT IN ('1', '2', CASE WHEN (rdt.RDTGetConfig(@nFunc, 'ClusterPickAllowSkipSKU', @cStorerKey) = 1) THEN '3' END)   --ZG02
      BEGIN
         SET @nErrNo = 65944
         SET @cErrMsg = rdt.rdtgetmessage( 65944, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_9_Fail
      END

      IF @cOption = '1'
      BEGIN
         -- (james36)
         IF rdt.RDTGetConfig( @nFunc, 'NOTALLOWSHORTPICK', @cStorerKey) = 1
         BEGIN
            SET @nErrNo = 69387
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --SHPICK X ALLOW
            GOTO Step_9_Fail
         END

         -- (james18)
         Confirm_Skip_SKU:

         SET @cSHOWSHTPICKRSN = rdt.RDTGetConfig( @nFunc, 'SHOWSHTPICKRSN', @cStorerKey)

         IF @cSHOWSHTPICKRSN = '1'
         BEGIN
            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            SELECT @nShortPickedQty = PickQty
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey
               AND SKU = @cSKU
               AND LOT = @cLOT
               AND LOC = @cLOC
               AND Status = '1'
               AND AddWho = @cUserName
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))

            SELECT
               @cPackUOM3 = P.PACKUOM3
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK P WITH (NOLOCK) ON (SKU.PackKey = P.PackKey)
            WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cOutField01 = @nShortPickedQty -- cluster picking, this is short picked qty
            SET @cOutField02 = @cPackUOM3 -- cluster picking
            SET @cOutField03 = ''
            SET @cOutField04 = ''
            SET @cOutField05 = ''

            -- Save current screen no
            SET @nCurScn = @nScn
            SET @nCurStep = @nStep

            -- Go to STD short pick screen
            SET @nScn = 2010
            SET @nStep = @nStep + 5

            GOTO Quit
         END
         ELSE
         BEGIN
            IF  @cLoadDefaultPickMethod <> 'C' -- SOS# 176144
            BEGIN
               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

               -- Insert the short picked qty   SOS131967
               IF NOT EXISTS (SELECT 1
               FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE OrderKey = @cOrderKey
                  AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND Status = '1'
                  AND AddWho = @cUserName
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                  AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                  AND SKU = @cSKU
                  AND PickQty = 0)
               BEGIN

                  BEGIN TRAN
                  INSERT INTO RDT.RDTPickLock
                  (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC,
                  Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, PickQty, Mobile, ID)
                  SELECT TOP 1 WaveKey, LoadKey, Orderkey, '****' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC,
                  Lottable02, Lottable04, Status, AddWho, AddDate, '' AS DropID, @cPickSlipNo AS PickSlipNo, 0, @nMobile, ID
                  FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE OrderKey = @cOrderKey
                     AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                     AND Status = '1'
                     AND AddWho = @cUserName
                     AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                     AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                     AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                     AND SKU = @cSKU

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65964
                     SET @cErrMsg = rdt.rdtgetmessage( 65964, @cLangCode, 'DSP') --'INSTPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_9_Fail
                  END
                  ELSE -- SOS# 176144
                  BEGIN
                     COMMIT TRAN
                  END
               END
            END

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN --SOS# 176144 (Start)
               -- Insert the short picked qty   SOS131967
               IF NOT EXISTS (SELECT 1
                              FROM RDT.RDTPickLock WITH (NOLOCK)
                              WHERE Status = '1'
                              AND StorerKey = @cStorerKey   --tlting03
                              AND AddWho = @cUserName
                              AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                              AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                              AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                              AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                              AND SKU = @cSKU
                              AND PickQty = 0)
               BEGIN
                  BEGIN TRAN
                  INSERT INTO RDT.RDTPickLock
                  (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC,
                  Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, PickQty, Mobile)
                  SELECT TOP 1 WaveKey, LoadKey, Orderkey, '****' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC,
                  Lottable02, Lottable04, Status, AddWho, AddDate, '' AS DropID, @cPickSlipNo AS PickSlipNo, 0, @nMobile
                  FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE Status = '1'
                     AND StorerKey = @cStorerKey   --tlting03
                     AND AddWho = @cUserName
                     AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                     AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                     AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                     AND SKU = @cSKU

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65964
                     SET @cErrMsg = rdt.rdtgetmessage( 65964, @cLangCode, 'DSP') --'INSTPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_9_Fail
                  END
                  ELSE
                  BEGIN
                     COMMIT TRAN
                  END
               END --SOS# 176144 (End)

               -- 1.0 Confirm pick first
               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT DISTINCT OrderKey, LOT FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
               AND Status = '1'
               AND AddWho = @cUserName
               AND LoadKey = @cLoadKey
               AND SKU = @cSKU
               AND PickQty > 0
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  BEGIN TRAN --SOS# 176144
                  SET @nErrNo = 0
                  SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
                  IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
                  BEGIN
                     SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                        ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                        ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                     SET @cSQLParms =
                        '@nMobile                   INT,           ' +
                        '@nFunc                     INT,           ' +
                        '@cLangCode                 NVARCHAR( 3),  ' +
                        '@nStep                     INT,           ' +
                        '@nInputKey                 INT,           ' +
                        '@cFacility                 NVARCHAR( 5),  ' +
                        '@cStorerkey                NVARCHAR( 15), ' +
                        '@cWaveKey                  NVARCHAR( 10), ' +
                        '@cLoadKey                  NVARCHAR( 10), ' +
                        '@cOrderKey                 NVARCHAR( 10), ' +
                        '@cPutAwayZone              NVARCHAR( 10), ' +
                        '@cPickZone                 NVARCHAR( 10), ' +
                        '@cSKU                      NVARCHAR( 20), ' +
                        '@cPickSlipNo               NVARCHAR( 10), ' +
                        '@cLOT                      NVARCHAR( 10), ' +
                        '@cLOC                      NVARCHAR( 10), ' +
                        '@cDropID                   NVARCHAR( 20), ' +
                        '@cStatus                   NVARCHAR( 1),  ' +
                        '@cCartonType               NVARCHAR( 10), ' +
                        '@nErrNo                    INT           OUTPUT,  ' +
                        '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                     EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                        @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                        @cLOT, @cLOC, @cDropID, '5', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
                  END
                  ELSE
                  BEGIN
                     EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cPutAwayZone,
                        @cPickZone,
                        @cConso_Orders,   -- Set orderkey = '' as conso pick
                        @cSKU,
                        @cPickSlipNo,
                        @cLOT,
                        @cLOC,
                        @cDropID,
                        '5',
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                        @nMobile, -- (Vicky06)
                        @nFunc    -- (Vicky06)
                  END

                  IF @nErrNo <> 0
                  BEGIN
                     ROLLBACK TRAN
                     CLOSE CUR_LOOK4CONSO_ORDERS
                     DEALLOCATE CUR_LOOK4CONSO_ORDERS
                     GOTO Step_9_Fail
                  END
                  ELSE -- SOS# 176144
                  BEGIN
                     COMMIT TRAN
                  END
                  FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS

               -- 2.0 Short pick the rest
               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT DISTINCT OrderKey, LOT FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
               AND Status = '1'
               AND AddWho = @cUserName
               AND LoadKey = @cLoadKey
               AND SKU = @cSKU
               AND PickQty = 0
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  BEGIN TRAN --SOS# 176144

                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmSkipSKU', @cStorerKey) = '1'
                  BEGIN
                     SET @nErrNo = 0
                     SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
                     IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
                     BEGIN
                        SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                           ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                           ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                        SET @cSQLParms =
                           '@nMobile                   INT,           ' +
                           '@nFunc                     INT,           ' +
                           '@cLangCode                 NVARCHAR( 3),  ' +
                           '@nStep                     INT,           ' +
                           '@nInputKey                 INT,           ' +
                           '@cFacility                 NVARCHAR( 5),  ' +
                           '@cStorerkey                NVARCHAR( 15), ' +
                           '@cWaveKey                  NVARCHAR( 10), ' +
                           '@cLoadKey                  NVARCHAR( 10), ' +
                           '@cOrderKey                 NVARCHAR( 10), ' +
                           '@cPutAwayZone              NVARCHAR( 10), ' +
                           '@cPickZone                 NVARCHAR( 10), ' +
                           '@cSKU                      NVARCHAR( 20), ' +
                           '@cPickSlipNo               NVARCHAR( 10), ' +
                           '@cLOT                      NVARCHAR( 10), ' +
                           '@cLOC                      NVARCHAR( 10), ' +
                           '@cDropID                   NVARCHAR( 20), ' +
                           '@cStatus                   NVARCHAR( 1),  ' +
                           '@cCartonType               NVARCHAR( 10), ' +
                           '@nErrNo                    INT           OUTPUT,  ' +
                           '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                        EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                           @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                           @cLOT, @cLOC, @cDropID, '0', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
                     END
                     ELSE
                     BEGIN
                        EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                           @cStorerKey,
                           @cUserName,
                           @cFacility,
                           @cPutAwayZone,
                           @cPickZone,
                           @cConso_Orders,   -- Set orderkey = '' as conso pick
                           @cSKU,
                           @cPickSlipNo,
                           @cLOT,
                           @cLOC,
                           @cDropID,
                           '0',
                           @cLangCode,
                           @nErrNo        OUTPUT,
                           @cErrMsg     OUTPUT,  -- screen limitation, 20 NVARCHAR max
                           @nMobile, -- (Vicky06)
                           @nFunc    -- (Vicky06)
                     END
                  END
                  ELSE
                  BEGIN
                     SET @nErrNo = 0
                     SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
                     IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
                     BEGIN
                        SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                           ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                           ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                        SET @cSQLParms =
                           '@nMobile                   INT,           ' +
                           '@nFunc                     INT,           ' +
                           '@cLangCode                 NVARCHAR( 3),  ' +
                           '@nStep                     INT,           ' +
                           '@nInputKey                 INT,           ' +
                           '@cFacility                 NVARCHAR( 5),  ' +
                           '@cStorerkey                NVARCHAR( 15), ' +
                           '@cWaveKey                  NVARCHAR( 10), ' +
                           '@cLoadKey                  NVARCHAR( 10), ' +
                           '@cOrderKey                 NVARCHAR( 10), ' +
                           '@cPutAwayZone              NVARCHAR( 10), ' +
                           '@cPickZone                 NVARCHAR( 10), ' +
                           '@cSKU                      NVARCHAR( 20), ' +
                           '@cPickSlipNo               NVARCHAR( 10), ' +
                           '@cLOT                      NVARCHAR( 10), ' +
                           '@cLOC                      NVARCHAR( 10), ' +
                           '@cDropID                   NVARCHAR( 20), ' +
                           '@cStatus                   NVARCHAR( 1),  ' +
                           '@cCartonType               NVARCHAR( 10), ' +
                           '@nErrNo                    INT           OUTPUT,  ' +
                           '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                        EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                           @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                           @cLOT, @cLOC, @cDropID, '4', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
                     END
                     ELSE
                     BEGIN
                        EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                           @cStorerKey,
                           @cUserName,
                           @cFacility,
                           @cPutAwayZone,
                           @cPickZone,
                           @cConso_Orders,   -- Set orderkey = '' as conso pick
                           @cSKU,
                           @cPickSlipNo,
                           @cLOT,
                           @cLOC,
                           @cDropID,
                           '4',
                           @cLangCode,
                           @nErrNo        OUTPUT,
                           @cErrMsg     OUTPUT,  -- screen limitation, 20 NVARCHAR max
                           @nMobile, -- (Vicky06)
                           @nFunc    -- (Vicky06)
                     END
                  END

                  IF @nErrNo <> 0
                  BEGIN
                     ROLLBACK TRAN
                     CLOSE CUR_LOOK4CONSO_ORDERS
                     DEALLOCATE CUR_LOOK4CONSO_ORDERS
                     GOTO Step_9_Fail
                  END
                  ELSE -- SOS# 176144
                  BEGIN
                     COMMIT TRAN
                  END

                  FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS
            END
            ELSE
            BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmSkipSKU', @cStorerKey) = '1'
            BEGIN
               IF @cOption = '1' -- (james28)
               BEGIN
                  SET @nErrNo = 0
                  SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
                  IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
                  BEGIN
                     SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                        ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                        ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                     SET @cSQLParms =
                        '@nMobile                   INT,           ' +
                        '@nFunc                     INT,           ' +
                        '@cLangCode                 NVARCHAR( 3),  ' +
                        '@nStep                     INT,           ' +
                        '@nInputKey                 INT,           ' +
                        '@cFacility                 NVARCHAR( 5),  ' +
                        '@cStorerkey                NVARCHAR( 15), ' +
                        '@cWaveKey                  NVARCHAR( 10), ' +
                        '@cLoadKey                  NVARCHAR( 10), ' +
                        '@cOrderKey                 NVARCHAR( 10), ' +
                        '@cPutAwayZone              NVARCHAR( 10), ' +
                        '@cPickZone                 NVARCHAR( 10), ' +
                        '@cSKU                      NVARCHAR( 20), ' +
                        '@cPickSlipNo               NVARCHAR( 10), ' +
                        '@cLOT                      NVARCHAR( 10), ' +
                        '@cLOC                      NVARCHAR( 10), ' +
                        '@cDropID                   NVARCHAR( 20), ' +
                        '@cStatus                   NVARCHAR( 1),  ' +
                        '@cCartonType               NVARCHAR( 10), ' +
                        '@nErrNo                    INT           OUTPUT,  ' +
                        '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                     EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                        @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                        @cLOT, @cLOC, @cDropID, '4', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
                  END
                  ELSE
                  BEGIN
                     EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cPutAwayZone,
                        @cPickZone,
                        @cOrderKey,
                        @cSKU,
                        @cPickSlipNo,
                        @cLOT,
                        @cLOC,
                        @cDropID,
                        '4',  -- Pick in progress
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                        @nMobile, -- (Vicky06)
                        @nFunc    -- (Vicky06)
                  END
               END
               ELSE
               BEGIN
                  SET @nErrNo = 0
                  SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
                  IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
                  BEGIN
                     SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                        ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                        ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                     SET @cSQLParms =
                        '@nMobile                   INT,           ' +
                        '@nFunc                     INT,           ' +
                        '@cLangCode                 NVARCHAR( 3),  ' +
                        '@nStep                     INT,           ' +
                        '@nInputKey                 INT,           ' +
                        '@cFacility                 NVARCHAR( 5),  ' +
                        '@cStorerkey                NVARCHAR( 15), ' +
                        '@cWaveKey                  NVARCHAR( 10), ' +
                        '@cLoadKey                  NVARCHAR( 10), ' +
                        '@cOrderKey                 NVARCHAR( 10), ' +
                        '@cPutAwayZone              NVARCHAR( 10), ' +
                        '@cPickZone                 NVARCHAR( 10), ' +
                        '@cSKU                      NVARCHAR( 20), ' +
                        '@cPickSlipNo               NVARCHAR( 10), ' +
                        '@cLOT                      NVARCHAR( 10), ' +
                        '@cLOC                      NVARCHAR( 10), ' +
                        '@cDropID                   NVARCHAR( 20), ' +
                        '@cStatus                   NVARCHAR( 1),  ' +
                        '@cCartonType               NVARCHAR( 10), ' +
                        '@nErrNo                    INT           OUTPUT,  ' +
                        '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                     EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                        @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                        @cLOT, @cLOC, @cDropID, '0', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
                  END
                  ELSE
                  BEGIN
                     EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cPutAwayZone,
                        @cPickZone,
                        @cOrderKey,
                        @cSKU,
                        @cPickSlipNo,
                        @cLOT,
                        @cLOC,
                        @cDropID,
                        '0',  -- Pick in progress
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                        @nMobile, -- (Vicky06)
                        @nFunc    -- (Vicky06)
                  END
               END
            END
            ELSE
            BEGIN
               SET @nErrNo = 0

               SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
               IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
               BEGIN
                  SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                     ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                     ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                  SET @cSQLParms =
                     '@nMobile                   INT,           ' +
                     '@nFunc                     INT,           ' +
                     '@cLangCode                 NVARCHAR( 3),  ' +
                     '@nStep                     INT,           ' +
                     '@nInputKey                 INT,           ' +
                     '@cFacility                 NVARCHAR( 5),  ' +
                     '@cStorerkey                NVARCHAR( 15), ' +
                     '@cWaveKey                  NVARCHAR( 10), ' +
                     '@cLoadKey                  NVARCHAR( 10), ' +
                     '@cOrderKey                 NVARCHAR( 10), ' +
                     '@cPutAwayZone              NVARCHAR( 10), ' +
                     '@cPickZone                 NVARCHAR( 10), ' +
                     '@cSKU                      NVARCHAR( 20), ' +
                     '@cPickSlipNo               NVARCHAR( 10), ' +
                     '@cLOT                      NVARCHAR( 10), ' +
                     '@cLOC                      NVARCHAR( 10), ' +
                     '@cDropID                   NVARCHAR( 20), ' +
                     '@cStatus                   NVARCHAR( 1),  ' +
                     '@cCartonType               NVARCHAR( 10), ' +
                     '@nErrNo                    INT           OUTPUT,  ' +
                     '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                     @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                     @cLOT, @cLOC, @cDropID, '4', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
               END
               ELSE
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cPutAwayZone,
                     @cPickZone,
                     @cOrderKey,
                     @cSKU,
                     @cPickSlipNo,
                     @cLOT,
                     @cLOC,
                     @cDropID,
                     '4',  -- Pick in progress
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                     @nMobile, -- (Vicky06)
                     @nFunc    -- (Vicky06)
               END
            END

            IF @nErrNo <> 0
            BEGIN
               GOTO Step_9_Fail
            END
            ELSE
            BEGIN
               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

                  -- SOS172041
                  -- If SKU.SUSR4 setup with L'Oreal Anti-Diversion code
                  -- Use codelkup to determine whether we need to capture serial no (james20)
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickInsPackDt', @cStorerKey) = '1'
                  BEGIN
                     SET @nCount = 0   -- (james27)
                     SET @cSKUFieldName = rdt.RDTGetConfig( @nFunc, 'FieldName2CaptureSerialNo', @cStorerKey)
                     IF ISNULL(@cSKUFieldName, '') NOT IN ('', '0')
                     BEGIN
                        IF NOT EXISTS(SELECT 1 FROM SYS.COLUMNS
                                      WHERE NAME = @cSKUFieldName
                                      AND   OBJECT_ID = OBJECT_ID(N'SKU'))
                        BEGIN
                           SET @nErrNo = 69378
                           SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'Bad SKU Field'
                           ROLLBACK TRAN A
                           GOTO Step_8_Fail
                        END

                        SET @cExecStatements = ''
                        SET @cExecStatements = 'SELECT @nCount = COUNT(1) ' +
                                 'FROM dbo.CODELKUP CLK WITH (NOLOCK) ' +
                                 'JOIN dbo.SKU SKU WITH (NOLOCK) ON (CLK.StorerKey = SKU.StorerKey AND CLK.Code = SKU.' + RTRIM(@cSKUFieldName) + ') ' +
                                 'WHERE CLK.StorerKey = ''' + RTRIM(@cStorerKey)  + ''' ' +
                                 'AND CLK.ListName = ''PICKSERIAL'' ' +
                                 'AND   SKU.SKU = ''' + RTRIM(@cSKU)  + ''' '
                        SET @cExecArguments = N'@nCount            INT     OUTPUT , ' +
                                               '@cSKUFieldName     NVARCHAR( 30)  , ' +
                                               '@cStorerKey        NVARCHAR( 15)  , ' +
                                               '@cSKU              NVARCHAR( 20)   '
                        EXEC sp_ExecuteSql @cExecStatements
                                         , @cExecArguments
                                         , @nCount       OUTPUT
                                         , @cSKUFieldName
                                         , @cStorerKey
                                         , @cSKU
                     END

                     IF @nCount > 0 OR
                     -- cater for existing customer who not setup codelkup yet
                     EXISTS ( SELECT 1 FROM dbo.SKU WITH (NOLOCK)
                              WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                              AND   SKU = @cSKU
                              AND   SUSR4 = 'AD' )
                     BEGIN
                        SELECT @nOtherUnit2 = OtherUnit2 FROM Pack P WITH (NOLOCK)
                        JOIN SKU S WITH (NOLOCK) ON (P.PackKey = S.PackKey)
                        WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                           AND SKU = @cSKU

                        IF @nOtherUnit2 <= 0
                        BEGIN
                           SET @nErrNo = 69349
                           SET @cErrMsg = rdt.rdtgetmessage( 69349, @cLangCode, 'DSP') --'LockOrdersFail'
                           --  ROLLBACK TRAN  -- ang02
                           GOTO Step_8_Fail
                        END

                        SELECT @nSum_PickQty = ISNULL(SUM(PickQty), 0) FROM RDT.RDTPickLock WITH (NOLOCK)
                        WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                           AND OrderKey = @cOrderKey
                           AND SKU = @cSKU
                           AND LOT = @cLOT
                           AND LOC = @cLOC
                           AND AddWho = @cUserName
                           AND Status = '5'
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))

                        SELECT @nCount_SerialNo = Count(1) FROM dbo.SerialNo WITH (NOLOCK)
                        WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                           AND OrderKey = @cOrderKey
                           AND SKU = @cSKU

                        IF @nOtherUnit2 > 0 AND (@nSum_PickQty % @nOtherUnit2 = 0)
                        BEGIN
                           -- Check whether still need to scan Anti-Diversion code
                           IF (@nSum_PickQty / @nOtherUnit2) > @nCount_SerialNo
                           BEGIN
                              SET @cOutField01 = @cSKU
                              SET @cOutField02 = SUBSTRING(@cSKU_Descr,  1, 20)
                              SET @cOutField03 = SUBSTRING(@cSKU_Descr, 21, 20)
                              SET @cOutField04 = SUBSTRING(@cSKU_Descr, 41, 20)
                              SET @cOutField05 = ''
                              SET @cOutField06 = CAST(@nCount_SerialNo AS NVARCHAR( 5)) + '/' + CAST((@nSum_PickQty / @nOtherUnit2) AS NVARCHAR( 5))

                              SET @nCurScn = @nScn  -- remember current screen no
                              SET @nCurStep = @nStep  -- remember current step no

                              -- Go to Anti-Diversion code screen
                              SET @nScn  = 1891
                              SET @nStep = 17

                              GOTO Quit
                           END
                        END   -- @nOtherUnit2 > 0
                     END   -- PICKSERIAL
                  END
               END
            END

            -- (james39)
            IF @cExtendedUpdateSP <> ''
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedUpdateSP AND type = 'P')
               BEGIN
                  SET @nErrNo = 0
                  SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedUpdateSP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                     ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                  SET @cSQLParms =
                     '@nMobile                   INT,           ' +
                     '@nFunc                     INT,           ' +
                     '@cLangCode                 NVARCHAR( 3),  ' +
                     '@nStep                     INT,           ' +
                     '@nInputKey                 INT,           ' +
                     '@cStorerkey                NVARCHAR( 15), ' +
                     '@cWaveKey                  NVARCHAR( 10), ' +
                     '@cLoadKey                  NVARCHAR( 10), ' +
                     '@cOrderKey                 NVARCHAR( 10), ' +
                     '@cLoc                      NVARCHAR( 10), ' +
                     '@cDropID                   NVARCHAR( 20), ' +
                     '@cSKU                      NVARCHAR( 20), ' +
                     '@nQty                      INT, '           +
                     '@nErrNo                    INT           OUTPUT,  ' +
                     '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                       @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                       @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

                  IF @nErrNo <> 0
                     GOTO Step_9_Fail
               END
            END

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN

            -- Remember current LOC (james19)
            SET @cPrevLOC = ''
            SET @cPrevLOC = @cLOC

            SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
            IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
            BEGIN
               SET @c_oFieled03 = @cSKU
               EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                   @n_Mobile        = @nMobile
                  ,@n_Func          = @nFunc
                  ,@c_SPName        = @cClusterPickGetNextTask_SP
                  ,@c_Storerkey     = @cStorerKey
                  ,@c_UserName      = @cUserName
                  ,@c_Facility      = @cFacility
                  ,@c_PutawayZone   = @cPutawayZone
                  ,@c_PickZone      = @cPickZone
                  ,@c_LangCode      = @cLangCode
                  ,@c_oFieled01     = @c_oFieled01 OUTPUT
                  ,@c_oFieled02     = @c_oFieled02 OUTPUT
                  ,@c_oFieled03     = @c_oFieled03 OUTPUT
                  ,@c_oFieled04     = @c_oFieled04 OUTPUT
                  ,@c_oFieled05     = @c_oFieled05 OUTPUT
                  ,@c_oFieled06     = @c_oFieled06 OUTPUT
                  ,@c_oFieled07     = @c_oFieled07 OUTPUT
                  ,@c_oFieled08     = @c_oFieled08 OUTPUT
                  ,@c_oFieled09     = @c_oFieled09 OUTPUT
                  ,@c_oFieled10     = @c_oFieled10 OUTPUT
                  ,@c_oFieled11     = @c_oFieled11 OUTPUT
                  ,@c_oFieled12     = @c_oFieled12 OUTPUT
                  ,@c_oFieled13     = @c_oFieled13 OUTPUT
                  ,@c_oFieled14     = @c_oFieled14 OUTPUT
                  ,@c_oFieled15     = @c_oFieled15 OUTPUT
                  ,@b_Success       = @b_Success   OUTPUT
                  ,@n_ErrNo         = @nErrNo      OUTPUT
                  ,@c_ErrMsg        = @cErrMsg     OUTPUT

               SET @cLOC            = @c_oFieled01
               SET @cOrderKey       = @c_oFieled02
               SET @cSKU            = @c_oFieled03
               SET @cSKU_Descr      = @c_oFieled04
               SET @cStyle          = @c_oFieled05
               SET @cColor          = @c_oFieled06
               SET @cSize           = @c_oFieled07
               SET @cColor_Descr    = @c_oFieled08
               SET @cLot            = @c_oFieled09
               SET @cPickSlipNo     = @c_oFieled10
               SET @cExternOrderKey = @c_oFieled11
               SET @cConsigneeKey   = @c_oFieled12
               SET @cLottable02     = @c_oFieled13
               SET @dLottable04     = @c_oFieled14
            END
            ELSE
            BEGIN
               SET @cLOC = ''
               SELECT TOP 1
                  @cLOC = PD.Loc,
                  @cSKU = PD.SKU,
                  @cLottable02 = LA.Lottable02,
                  @dLottable04 = LA.Lottable04
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK)
                  ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)  -- (james09)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
               JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE O.StorerKey = @cStorerKey -- tlting03
                  AND PD.Status = '0'
                  AND O.LoadKey = @cLoadKey
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                  AND LOC.Facility = @cFacility
                  AND NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK)
                     WHERE PD.StorerKey = RPL.StorerKey AND PD.OrderKey = RPL.OrderKey AND PD.SKU = RPL.SKU AND RPL.Status = '1')
               GROUP BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
               ORDER BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
            END

            SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
            IF ISNULL( @cLocDescr, '') = ''
               SET @cLocDescr = @cLOC

               -- No more task
               IF ISNULL( @cLOC, '') = ''
               BEGIN
                  SELECT
                     @nOrderPicked   = COUNT(DISTINCT OrderKey),
                     @nTTL_PickedQty = SUM(PickQty)
                  FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE AddWho = @cUserName
                     AND Status = '5'  -- Picked
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                     AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                     AND StorerKey = @cStorerKey

                  -- (james36)
                  SET @cPickNotFinish = ''
                  IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
                  BEGIN
                     IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                                 JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                                 JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                                 JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                                 WHERE PD.StorerKey = @cStorerKey
                                 AND   ( PD.Status = '0' OR PD.Status = '4')
                                 AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                                 AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                                 AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                                 AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                                 AND   LOC.Facility = @cFacility
                                 AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                       WHERE PD.OrderKey = RPL.OrderKey
                                                       AND   PD.StorerKey = RPL.StorerKey
                                                       AND   RPL.AddWho = @cUserName
                                                       AND   RPL.Status < '9'))
                     BEGIN
                        SET @cPickNotFinish = 'PICKING NOT FINISH'
                     END
                  END

                  -- Prep next screen var
                  SET @cOutField01 = @cWaveKey
                  SET @cOutField02 = @cLoadKey
                  SET @cOutField03 = @cPutawayZone
                  SET @cOutField04 = @cPickZone
                  SET @cOutField05 = @nOrderPicked
                  SET @cOutField06 = @nTTL_PickedQty
                  SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

                  SET @nScn  = 1879
                  SET @nStep = 10

                  SET @nActQty = 0
                  SET @nQtyToPick = 0

                  SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
                  SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                     AND AddWho = @cUserName
                     AND Status = '5'
                  OPEN @curUpdRPL
                  FETCH NEXT FROM @curUpdRPL INTO @nRowRef
                  WHILE @@FETCH_STATUS <> -1
                  BEGIN
                     BEGIN TRAN --SOS# 176144
                     UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                        Status = '9'   -- Confirm Picked
                     WHERE RowRef = @nRowRef

                     IF @@ERROR <> 0
                     BEGIN
                        SET @nErrNo = 65942
                        SET @cErrMsg = rdt.rdtgetmessage( 65942, @cLangCode, 'DSP') --'UPDPKLockFail'
                        ROLLBACK TRAN
                        GOTO Step_9_Fail
                     END
                     ELSE -- SOS# 176144
                     BEGIN
                        COMMIT TRAN
                     END

                     FETCH NEXT FROM @curUpdRPL INTO @nRowRef
                  END
                  CLOSE @curUpdRPL
                  DEALLOCATE @curUpdRPL

                  -- Commit the transaction before goto picking screen
                  --COMMIT TRAN --SOS# 176144

                  GOTO Quit
               END   -- IF @@ROWCOUNT = 0
               ELSE
               BEGIN
                  SELECT
                     @cSKU_Descr = SKU.DESCR,
                     @cStyle = SKU.Style,
                     @cColor = SKU.Color,
                     @cSize = SKU.Size,
                     @cColor_Descr = SKU.BUSR7
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                  AND SKU = @cSKU

                  IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
                  BEGIN
                     SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
                     SET @cColor = @cColor + ' '
                     SET @cSKU_Descr = ''
                  END

                  DECLARE CUR_LOOK4CONSOORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
                  SELECT PD.ORDERKEY, PD.LOT
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.Orders O WITH (NOLOCK) ON (PD.OrderKey = O.OrderKey) --SOS# 176144
                  JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
                  WHERE LA.StorerKey = @cStorerKey    -- tlting03
                     AND PD.STATUS = '0'
                     AND PD.LOC = @cLOC
                     AND LA.SKU = @cSKU
                     AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                     AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                     AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                     AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  GROUP BY PD.ORDERKEY, PD.LOT
                  ORDER BY PD.ORDERKEY, PD.LOT
                  OPEN CUR_LOOK4CONSOORDERS
                  FETCH NEXT FROM CUR_LOOK4CONSOORDERS INTO @cConso_Orders, @cLOT
                  WHILE @@FETCH_STATUS <> -1
                  BEGIN
                     IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                            WHERE StorerKey = @cStorerKey
                                    AND OrderKey = @cConso_Orders
                                    AND Status = '1'
                                    AND LOT = @cLOT
                                    AND AddWho = @cUserName)
                     BEGIN
                        BEGIN TRAN --SOS# 176144
                        INSERT INTO RDT.RDTPickLock
                        (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                        , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
                        VALUES
                        (@cWaveKey, @cLoadKey, @cConso_Orders, 'C', @cStorerKey, @cSKU, @cPutAwayZone, @cPickZone, @cConso_Orders
                        , @cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

                        IF @@ERROR <> 0
                        BEGIN
                           SET @nErrNo = 65980
                           SET @cErrMsg = rdt.rdtgetmessage( 65980, @cLangCode, 'DSP') --'LockOrdersFail'
                           ROLLBACK TRAN
                           GOTO Step_9_Fail
                        END
                        ELSE -- SOS# 176144
                        BEGIN
                           COMMIT TRAN
                        END
                     END
                     ELSE
                     BEGIN
                        BEGIN TRAN --SOS# 176144
                        UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
                           LOT = @cLot,
                           LOC = @cLoc,
                           SKU = @cSKU,
                           DropID = @cDropID,
                           PackKey = @cCartonType,
                           Lottable02 = @cLottable02,
                           Lottable04 = @dLottable04
                         , OrderLineNumber = OrderLineNumber + 'CC'
                        WHERE OrderKey = @cConso_Orders
                           AND StorerKey = @cStorerKey    -- tlting03
                           AND Status = '1'
                           AND AddWho = @cUserName

                        IF @@ERROR <> 0
                        BEGIN
                           SET @nErrNo = 65981
                           SET @cErrMsg = rdt.rdtgetmessage( 65981, @cLangCode, 'DSP') --'UPDPKLockFail'
                           ROLLBACK TRAN
                           GOTO Step_9_Fail
                        END
                        ELSE -- SOS# 176144
                        BEGIN
                           COMMIT TRAN
                        END
                     END

                     FETCH NEXT FROM CUR_LOOK4CONSOORDERS INTO @cConso_Orders, @cLOT
                  END
                  CLOSE CUR_LOOK4CONSOORDERS
                  DEALLOCATE CUR_LOOK4CONSOORDERS
               END

               SELECT @nTTL_Qty = SUM(PD.QTY)
               FROM dbo.PickDetail PD WITH (NOLOCK) --ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND LA.Storerkey = @cStorerKey      -- tlting03
                  AND LA.SKU = @cSKU
                  AND L.LOC = @cLOC
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
                  -- TLTING03 Duplicate check
                  --AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = PD.StorerKey
                  --               AND OrderKey = PD.OrderKey AND ADDWHO = @cUserName ) -- SOS# 176144
                  --AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName) -- SOS# 176144

               -- Get the total allocated qty for LOC + SKU + OrderKey
               SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.LOC = @cLOC
                  AND PD.SKU = @cSKU
                  AND PD.Status = '0'
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
                  AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

               SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
               IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

               IF @cDefaultToAllocatedQty = '1'
               BEGIN
                  SET @cDefaultPickQty = @nTotalPickQty
               END

               SET @nQtyToPick = 0
               SET @nActQty = 0

               -- Get Total Orders left on the current sku that need to pick
               SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE RPL.StorerKey = @cStorerKey
                  AND RPL.Status < '5'
                  AND RPL.AddWho = @cUserName
                  AND RPL.PickQty <= 0
                  AND PD.SKU = @cSKU
                  AND PD.LOC = @cLOC
                  AND PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

               -- (james14)
               IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
               BEGIN
                  SET @cOS_Qty = ''

                  IF @cLoadDefaultPickMethod = 'C'
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND LPD.LoadKey = @cLoadKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND PD.Status >= '3'
                        AND LPD.LoadKey = @cLoadKey

                     SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
                  ELSE
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey
                        AND Status >= '3'

                     SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST(@nTTL_UnPick_ORD AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
               END

               IF @cClusterPickNike <> ''
               BEGIN
                  IF @cClusterPickNike = '1'
                  BEGIN
                     SET @cTemp_String = ''
                     SET @cTemp_UOM = ''
                     SET @nTemp_PackQtyIndicator = ''

                     SELECT
                        @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                        @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                     FROM dbo.SKU SKU WITH (NOLOCK)
                     JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                     WHERE SKU.StorerKey = @cStorerKey
                        AND SKU.SKU = @cSKU

                     SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                        '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                  END
                  ELSE
                  BEGIN
                     IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo2 = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                        SET @cTemp_String = @cExtendedInfo2
                     END
                  END
               END

               -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
               BEGIN
                  SET @cPackCfg = ''

                  SELECT @fPack_Qty = PACK.QTY,
                         @fPack_InnerPack = PACK.InnerPack,
                         @fPack_CaseCnt = PACK.CaseCnt
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE SKU.StorerKey = @cStorerKey
                     AND SKU.SKU = @cSKU

                  SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                                  RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                                  RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
               END

               SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
               IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
                  SET @cScanLOT02 = '0'

               IF @cPrefUOM <> '6'
               BEGIN
                  SELECT TOP 1
                     @nPrefUOM_Div = CAST( IsNULL(
                        CASE @cPrefUOM
                           WHEN '2' THEN Pack.CaseCNT
                           WHEN '3' THEN Pack.InnerPack
                           WHEN '6' THEN Pack.QTY
                           WHEN '1' THEN Pack.Pallet
                           WHEN '4' THEN Pack.OtherUnit1
                           WHEN '5' THEN Pack.OtherUnit2
                        END, 1) AS INT)
                  FROM dbo.SKU SKU (NOLOCK)
                     INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
                  WHERE StorerKey = @cStorerKey
                     AND SKU = @cSKU

                  -- Convert to prefer UOM QTY to be picked
                  SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

                  -- Convert to prefer UOM QTY picked
                  SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

						--SOS334125 Start
                  SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                            '/' +
                                            RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
						--SOS334125 End

                  SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
                  SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
               END

               -- Extended info
               IF @cExtendedInfoSP <> ''
               BEGIN
                  IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
                  END
               END

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cDropID
                  SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField04 = ''
                  SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
                  SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                                     THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

                  EXEC rdt.rdtSetFocusField @nMobile, 4

                  -- Go to next screen
                  SET @nScn  = 1877
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cSKU
                  SET @cOutField03 = ''
                  SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1883
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1628 -- (james07)
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField03 = ''
                  SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
                  SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cLoadKey
                  SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1888
                  SET @nStep = 8
               END

               IF @cPrefUOM <> '6'
                  SET @cOutField12 = @cPreferQty2Display
               ELSE
                  SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

               SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                                  THEN '' ELSE @cDefaultPickQty END -- Qty to pick
               SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
               SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                       CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                                  ELSE 'QTY: ' END

               -- Commit transaction
               -- COMMIT TRAN   ang02

               SET @cFieldAttr01 = ''
               SET @cFieldAttr02 = ''
               SET @cFieldAttr03 = ''
               SET @cFieldAttr04 = ''
               SET @cFieldAttr05 = ''
               SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
               SET @cFieldAttr07 = ''
               SET @cFieldAttr08 = ''
               SET @cFieldAttr09 = ''
               SET @cFieldAttr10 = ''
               SET @cFieldAttr11 = ''
               SET @cFieldAttr12 = ''
               SET @cFieldAttr13 = ''
               SET @cFieldAttr14 = ''
               SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

               -- If config turned on, not allow to change Qty To Pick
               IF @cClusterPickLockQtyToPick = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END

               GOTO Quit
            END   -- IF @cLoadDefaultPickMethod = 'C'
            ELSE
            BEGIN
               -- Get next available task
               SET @nErrNo = 0

               -- Remember current LOC (james19)
               SET @cPrevLOC = ''
               SET @cPrevLOC = @cLOC

               SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
               IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
               BEGIN
                  EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                      @n_Mobile        = @nMobile
                     ,@n_Func          = @nFunc
                     ,@c_SPName        = @cClusterPickGetNextTask_SP
                     ,@c_Storerkey     = @cStorerKey
                     ,@c_UserName      = @cUserName
                     ,@c_Facility      = @cFacility
                     ,@c_PutawayZone   = @cPutawayZone
                     ,@c_PickZone      = @cPickZone
                     ,@c_LangCode      = @cLangCode
                     ,@c_oFieled01     = @c_oFieled01 OUTPUT
                     ,@c_oFieled02     = @c_oFieled02 OUTPUT
                     ,@c_oFieled03     = @c_oFieled03 OUTPUT
                     ,@c_oFieled04     = @c_oFieled04 OUTPUT
                     ,@c_oFieled05     = @c_oFieled05 OUTPUT
                     ,@c_oFieled06     = @c_oFieled06 OUTPUT
                     ,@c_oFieled07     = @c_oFieled07 OUTPUT
                     ,@c_oFieled08     = @c_oFieled08 OUTPUT
                     ,@c_oFieled09     = @c_oFieled09 OUTPUT
                     ,@c_oFieled10     = @c_oFieled10 OUTPUT
                     ,@c_oFieled11     = @c_oFieled11 OUTPUT
                     ,@c_oFieled12     = @c_oFieled12 OUTPUT
                     ,@c_oFieled13     = @c_oFieled13 OUTPUT
                     ,@c_oFieled14     = @c_oFieled14 OUTPUT
                     ,@c_oFieled15     = @c_oFieled15 OUTPUT
                     ,@b_Success       = @b_Success   OUTPUT
                     ,@n_ErrNo         = @nErrNo      OUTPUT
                     ,@c_ErrMsg        = @cErrMsg     OUTPUT

                  SET @cLOC            = @c_oFieled01
                  SET @cNewOrderKey    = @c_oFieled02
                  SET @cSKU            = @c_oFieled03
                  SET @cSKU_Descr      = @c_oFieled04
                  SET @cStyle          = @c_oFieled05
                  SET @cColor          = @c_oFieled06
                  SET @cSize           = @c_oFieled07
                  SET @cColor_Descr    = @c_oFieled08
                  SET @cLot            = @c_oFieled09
                  SET @cPickSlipNo     = @c_oFieled10
                  SET @cExternOrderKey = @c_oFieled11
                  SET @cConsigneeKey   = @c_oFieled12
               END
               ELSE
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cPutAwayZone,
                     @cPickZone,
                     @cLangCode,
                     @nErrNo           OUTPUT,
                     @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
                     @cLOC             OUTPUT,
                     @cNewOrderKey     OUTPUT,
                     @cExternOrderKey  OUTPUT,
                     @cConsigneeKey    OUTPUT,
                     @cSKU             OUTPUT,
                     @cSKU_Descr       OUTPUT,
                     @cStyle           OUTPUT,
                     @cColor           OUTPUT,
                     @cSize            OUTPUT,
                     @cColor_Descr     OUTPUT,
                     @cLot             OUTPUT,
                     @cPickSlipNo      OUTPUT,
                     @nMobile,
                     @nFunc

                  IF @nErrNo <> 0
                  BEGIN
                     SET @nErrNo = 65945
                     SET @cErrMsg = rdt.rdtgetmessage( 65945, @cLangCode, 'DSP') --'GetNextTaskFail'
                     GOTO Step_9_Fail
                  END
               END
            END

            SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
            IF ISNULL( @cLocDescr, '') = ''
               SET @cLocDescr = @cLOC

            -- If no more task, goto confirm picking screen
            IF ISNULL(@cNewOrderKey, '') = ''
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'AutoCloseCaseIfLastCarton', @cStorerKey) = '1'
               BEGIN
                  -- Insert into DropID table   (james30)
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
                  BEGIN
                     SET @nErrNo = 0
                     EXECUTE rdt.rdt_Cluster_Pick_DropID
                        @nMobile,
                        @nFunc,
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cLoadKey,
                        @cPickSlipNo,
                        @cOrderKey,
                        @cDropID       OUTPUT,
                        @cSKU,
                        'U',      -- U = Update
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

                     IF @nErrNo <> 0
                        GOTO Step_9_Fail
                  END

                  SET @nErrNo = 0
                  EXECUTE RDT.rdt_Cluster_Pick_PrintLabel
                     @nMobile,
                     @nFunc,
                     @nStep,
                     @nInputKey,
                     @cLangCode,
                     @cStorerKey,
                     @cWaveKey,
                     @cLoadKey,
                     @cOrderKey,
                     @cPickSlipNo,
                     @cLOC,
                     @cDropID,
                     @cSKU,
                     @nQty,
                     @nErrNo   OUTPUT,
                     @cErrMsg  OUTPUT

                  IF @nErrNo <> 0
                     GOTO Step_9_Fail
               END

               -- (jamesxx)
               SELECT
                  @nOrderPicked = COUNT( DISTINCT OrderKey),
                  @nTTL_PickedQty = SUM(PickQty)
               FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE AddWho = @cUserName
                  AND Status = '5'  -- Picked
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                  AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))

               -- Confirm picking in RDT.RDTPickLock
               SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
               SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
                WHERE StorerKey = @cStorerKey
                  AND AddWho = @cUserName
                  AND Status = '5'
               OPEN @curUpdRPL
               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               WHILE @@FETCH_STATUS <> -1
               BEGIN

                  BEGIN TRAN --SOS# 176144
                  UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
                  WHERE RowRef = @nRowRef

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65946
                     SET @cErrMsg = rdt.rdtgetmessage( 65946, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_9_Fail
                  END
                  ELSE -- SOS# 176144
                  BEGIN
                     COMMIT TRAN
                  END

                  FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               END
               CLOSE @curUpdRPL
               DEALLOCATE @curUpdRPL

               -- (james36)
               SET @cPickNotFinish = ''
               IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
               BEGIN
                  IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                              JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                              JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                              JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                              WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                              AND   ( PD.Status = '0' OR PD.Status = '4')
                              AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                              AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                              AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                              AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                              AND   LOC.Facility = @cFacility
                              AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                    WHERE PD.OrderKey = RPL.OrderKey
                                                    AND   PD.StorerKey = RPL.StorerKey
                                                    AND   RPL.AddWho = @cUserName
                                                    AND   RPL.Status < '9'))
                  BEGIN
                     SET @cPickNotFinish = 'PICKING NOT FINISH'
                  END
               END

               -- Prep next screen var
               SET @cOutField01 = @cWaveKey
               SET @cOutField02 = @cLoadKey
               SET @cOutField03 = @cPutawayZone
               SET @cOutField04 = @cPickZone
               SET @cOutField05 = @nOrderPicked
               SET @cOutField06 = @nTTL_PickedQty
               SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

               SET @nScn  = 1879
               SET @nStep = 10

               GOTO Quit
            END

            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cNewOrderKey

            -- Get the Lottables
            SELECT
               @cLottable02 = Lottable02,
               @dLottable04 = Lottable04
            FROM dbo.LotAttribute WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND SKU = @cSKU
               AND LOT = @cLot

            BEGIN TRAN --SOS# 176144
            -- Insert next task to picklock
            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
            SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
            VALUES
            (@cWaveKey, @cLoadKey, @cNewOrderKey, 'SHPK', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
            @cSKU, @cPutAwayZone, @cPickZone, '', @cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65947
               SET @cErrMsg = rdt.rdtgetmessage( 65947, @cLangCode, 'DSP') --'LockOrdersFail'
               ROLLBACK TRAN
               GOTO Step_9_Fail
            END
            ELSE -- SOS# 176144
            BEGIN
               COMMIT TRAN
            END

            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
            BEGIN
               -- If change of LOC then need to go back to confirm LOC screen
               IF @cPrevLOC <> @cLOC
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = ''

                  -- (jamesxxx) Assign back the orderkey to pick (james59)
                  SET @cOrderKey = @cNewOrderKey

                -- Go to next screen
                SET @nScn  = 1892
                SET @nStep = 19
                GOTO Quit
               END
            END

            -- If still have remaining task
            -- If OrderKey changed
            IF @cOrderKey <> @cNewOrderKey
            BEGIN
               SET @cOrderKey = @cNewOrderKey

               -- If configkey 'AutoPromptDropID' turned on, auto go back to DropID screen
               IF @cAutoPromptDropID = '1'
               BEGIN
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'   -- (james18)
                  BEGIN
                     -- If change of LOC then need to go back to confirm LOC screen
                     IF @cPrevLOC <> @cLOC
                     BEGIN
                        SET @nActQty = 0
                        SET @nQtyToPick = 0

                        -- Prep next screen var
                        SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                        SET @cOutField02 = ''

                      -- Go to next screen
                      SET @nScn  = 1892
                      SET @nStep = 19

                        GOTO Quit
                     END
                  END

                  IF @nFunc = 1620
                  BEGIN
                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = @cOrderKey
                     SET @cOutField03 = @cExternOrderKey
                     SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                     SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                     SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                     SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

                     IF @nMultiStorer = 1
                        SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

                     IF @cClusterPickNike <> ''
                     BEGIN
                        IF @cClusterPickNike = '1'
                        BEGIN
                           SET @cTemp_String = ''
                           SET @cTemp_UOM = ''
                           SET @nTemp_PackQtyIndicator = ''

                           SELECT
                              @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                              @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                           FROM dbo.SKU SKU WITH (NOLOCK)
                           JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                           WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                              AND SKU.SKU = @cSKU

                           SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                              '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                        END
                        ELSE
                        BEGIN
                           IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                           BEGIN
                              SET @cExtendedInfo2 = ''

                              SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                                 ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                              SET @cSQLParam =
                                 '@nMobile       INT, ' +
                                 '@nFunc         INT, ' +
                                 '@cLangCode     NVARCHAR( 3), ' +
                                 '@nStep         INT, ' +
                                 '@nInputKey     INT, ' +
                                 '@cWaveKey      NVARCHAR( 10), ' +
                                 '@cLoadKey      NVARCHAR( 10), ' +
                                 '@cOrderKey     NVARCHAR( 10), ' +
                                 '@cDropID       NVARCHAR( 20), ' +
                                 '@cStorerKey    NVARCHAR( 15), ' +
                                 '@cSKU          NVARCHAR( 20), ' +
                                 '@cLOC          NVARCHAR( 10), ' +
                                 '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                              EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                                 @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                              SET @cOutField08 = @cExtendedInfo2
                           END
                        END
                     END
                     ELSE
                     BEGIN
                        SET @cOutField08 = @cColor_Descr
                     END

                     SET @cOutField09 = ''   -- DropID
                     SET @cOutField10 = ''
                     SET @cOutField11 = ''

                     SET @nScn  = 1876
                     SET @nStep = 7
                  END
                  ELSE
                  IF @nFunc = 1621
                  BEGIN
                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = @cOrderKey
                     SET @cOutField03 = @cExternOrderKey
                     SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                     SET @cOutField05 = @cSKU
                     SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                     SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                     SET @cOutField08 = @cLottable02
                     SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                     SET @cOutField10 = ''   -- DropID

                     -- Go to next screen
                     SET @nScn  = 1882
                     SET @nStep = 7
                  END
                  ELSE
                  IF @nFunc = 1628
                  BEGIN
                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = @cLoadKey
                     SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                     SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                     SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                     SET @cOutField08 = @cLottable02
                     SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                     SET @cOutField10 = ''   -- DropID

                     -- Go to next screen
                     SET @nScn  = 1887
                     SET @nStep = 7
                  END

                  -- (james30)
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
                  BEGIN
                     EXECUTE rdt.rdt_Cluster_Pick_DropID
                        @nMobile,
                        @nFunc,
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cLoadKey,
                        @cPickSlipNo,
                        @cOrderKey,
                        @cDropID       OUTPUT,
                        @cSKU,
                        'R',      -- R = Retrieve
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max

                     IF @nFunc = 1620
                     BEGIN
                        IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                           SET @cOutField09 = ''         -- DropID
                        ELSE
                           SET @cOutField09 = @cDropID   -- DropID
                     END
                     ELSE
                     BEGIN
                        IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                           SET @cOutField10 = ''         -- DropID
                        ELSE
                           SET @cOutField10 = @cDropID   -- DropID
                     END
                  END

                  SET @nActQty = 0
                  SET @nQtyToPick = 0

                  GOTO Quit
              END

            END   -- If OrderKey changed

               IF @cAutoPromptDropIDIfIDChanged = '1'
               BEGIN
                  SET @nErrNo = 0

                  SELECT @cID = ID, @nRPLIDQty = ISNULL( SUM( PickQty), 0)
                  FROM RDT.RDTPICKLOCK
                  WHERE STORERKEY = @cStorerKey
                  AND LOC = @cLOC
                  AND SKU = @cSKU
                  AND WAVEKEY = @cWaveKey
                  AND ADDWHO = @cUserName
                  AND STATUS = '5'
                  AND DropID = @cDropID
                  GROUP BY ID

                  SELECT @nIDQty = ISNULL( SUM( QTY), 0)
                  FROM dbo.PickDetail WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                  --AND   OrderKey = @cOrderKey
                  AND   Loc = @cLOC
                  AND   SKU = @cSKU
                  AND   ID = @cID

                  -- Need exclude short pick qty
                  SELECT @nIDShortPickedQty = ISNULL( SUM( QTY), 0)
                  FROM dbo.PickDetail WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                  --AND   OrderKey = @cOrderKey
                  AND   Loc = @cLOC
                  AND   SKU = @cSKU
                  AND   ID = @cID
                  AND   Status = '4'

                  -- If result allow auto go back to DropID screen
                  IF ( @nIDQty - @nIDShortPickedQty) = @nRPLIDQty OR ( (@nIDQty - @nRPLIDQty) = 1)
                  BEGIN
                     IF @nFunc = 1620
                     BEGIN
                        SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                        SET @cOutField02 = @cOrderKey
                        SET @cOutField03 = @cExternOrderKey
                        SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                        SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                        SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                        SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

                        IF @nMultiStorer = 1
                           SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

                        IF @cClusterPickNike <> ''
                        BEGIN
                           IF @cClusterPickNike = '1'
                           BEGIN
                              SET @cTemp_String = ''
                              SET @cTemp_UOM = ''
                              SET @nTemp_PackQtyIndicator = ''

                              SELECT
                                 @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                                 @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                              FROM dbo.SKU SKU WITH (NOLOCK)
                              JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                              WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                                 AND SKU.SKU = @cSKU

                              SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                                   '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                           END
                           ELSE
                           BEGIN
                              IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                              BEGIN
                                 SET @cExtendedInfo2 = ''

                                 SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                                    ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                                 SET @cSQLParam =
                                    '@nMobile       INT, ' +
                                    '@nFunc         INT, ' +
                                    '@cLangCode     NVARCHAR( 3), ' +
                                    '@nStep         INT, ' +
                                    '@nInputKey     INT, ' +
                                    '@cWaveKey      NVARCHAR( 10), ' +
                                    '@cLoadKey      NVARCHAR( 10), ' +
                                    '@cOrderKey     NVARCHAR( 10), ' +
                                    '@cDropID       NVARCHAR( 20), ' +
                                    '@cStorerKey    NVARCHAR( 15), ' +
                                    '@cSKU          NVARCHAR( 20), ' +
                                    '@cLOC          NVARCHAR( 10), ' +
                                    '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                                 EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                                 SET @cOutField08 = @cExtendedInfo2
                              END
                           END
                        END
                        ELSE
                        BEGIN
                           -- Extended info
                           IF @cExtendedInfoSP <> ''
                           BEGIN
                              IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                              BEGIN
                                 SET @cExtendedInfo = ''

                                 SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                                    ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                                 SET @cSQLParam =
                                    '@nMobile       INT, ' +
                                    '@nFunc         INT, ' +
                                    '@cLangCode     NVARCHAR( 3), ' +
                                    '@nStep         INT, ' +
                                    '@nInputKey     INT, ' +
                                    '@cWaveKey      NVARCHAR( 10), ' +
                                    '@cLoadKey      NVARCHAR( 10), ' +
                                    '@cOrderKey     NVARCHAR( 10), ' +
                                    '@cDropID       NVARCHAR( 20), ' +
                                    '@cStorerKey    NVARCHAR( 15), ' +
                                    '@cSKU          NVARCHAR( 20), ' +
                                    '@cLOC          NVARCHAR( 10), ' +
                                    '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                                 EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT

                                 SET @cOutField08 = @cExtendedInfo
                              END
                           END
                        END

                        -- (james42)
                        IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
                        BEGIN
                           SET @cOutField10 = 'CTN TYPE:'
                           SET @cOutField11 = ''
                        END

                        SET @cOutField09 = ''   -- DropID
                        SET @cOutField10 = ''
                        SET @cOutField11 = ''

                        UPDATE RDT.RDTPickLock WITH (ROWLOCK) -- SOS# 173419
                           SET DropID = ''
                        WHERE AddWho = @cUserName AND PickQty = 0
                        AND Status = '1' AND Mobile = @nMobile
                        AND Sku = @cSKU
                        AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                        AND WaveKey = @cWaveKey AND LoadKey = @cLoadKey
                        AND OrderKey = @cOrderKey AND LOC = @cLOC
                        AND PutawayZone = @cPutAwayZone AND PickZone = @cPickZone
                        AND ISNULL(RTRIM(DropID),'') = @cDropID

                        -- Prepare Prev Screen
                        SET @nScn  = 1876
                        SET @nStep = 7

                        GOTO Quit
                     END

                     GOTO Quit
                  END
               END
            SET @cOrderKey = @cNewOrderKey

            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            -- Get the total allocated qty for LOC + SKU + OrderKey
            SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
               AND PD.LOC = @cLOC
               AND PD.SKU = @cSKU
               AND PD.OrderKey = @cOrderKey
               AND PD.Status = '0'
               AND PD.LOT = @cLOT
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

            SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
            IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

            IF @cDefaultToAllocatedQty = '1'
            BEGIN
               SET @cDefaultPickQty = @nTotalPickQty
            END

            SET @nQtyToPick = 0
            SET @nActQty = 0

            -- Get the total oustanding qty for orderkey + putawayzone + pickzone
            SELECT @nTTL_Qty = SUM(QTY)
            FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE (( @nMultiStorer = 1 AND RPL.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND RPL.StorerKey = @cStorerKey))
               AND RPL.Status < '5'
               AND RPL.AddWho = @cUserName
               AND RPL.PickQty <= 0
               AND PD.Status = '0'
               AND (( @nMultiStorer = 1 AND LA.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND LA.StorerKey = @cStorerKey))
               AND LA.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               AND EXISTS ( SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = RPL.AddWho
                                    AND StorerKey = RPL.StorerKey AND OrderKey =  PD.OrderKey )       -- tlting02
               --AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName) -- SOS# 176144

            -- Get Total Orders left on the current sku that need to pick
            SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE (( @nMultiStorer = 1 AND RPL.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND RPL.StorerKey = @cStorerKey))
               AND RPL.Status < '5'
               AND RPL.AddWho = @cUserName
               AND RPL.PickQty <= 0
               AND PD.Status = '0'
               AND PD.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

            -- (james14)
            IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
            BEGIN
               SET @cOS_Qty = ''

               IF @cLoadDefaultPickMethod = 'C'
               BEGIN
                  -- Get the total qty picked per orders
                  SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                  WHERE PD.StorerKey = @cStorerKey
                     AND LPD.LoadKey = @cLoadKey

                  -- Get the total qty unpick per orders
                  SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                  WHERE PD.StorerKey = @cStorerKey
                     AND PD.Status >= '3'
                     AND LPD.LoadKey = @cLoadKey

                  SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
               END
               ELSE
               BEGIN
                  -- Get the total qty picked per orders
                  SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
                  FROM dbo.PickDetail WITH (NOLOCK)
                  WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                     AND OrderKey = @cOrderKey

                  -- Get the total qty unpick per orders
                  SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
                  FROM dbo.PickDetail WITH (NOLOCK)
                  WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                     AND OrderKey = @cOrderKey
                     AND Status >= '3'

                  SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST(@nTTL_UnPick_ORD AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
               END
            END

            IF @cClusterPickNike <> ''
            BEGIN
               IF @cClusterPickNike = '1'
               BEGIN
                  SET @cTemp_String = ''
                  SET @cTemp_UOM = ''
                  SET @nTemp_PackQtyIndicator = ''

                  SELECT
                     @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                     @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                     AND SKU.SKU = @cSKU

                  SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                     '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
               END
               ELSE
               BEGIN
                  IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo2 = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                     SET @cTemp_String = @cExtendedInfo2
                  END
               END
            END

            -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
            BEGIN
               SET @cPackCfg = ''

               SELECT @fPack_Qty = PACK.QTY,
                      @fPack_InnerPack = PACK.InnerPack,
                      @fPack_CaseCnt = PACK.CaseCnt
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                               RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                               RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
            END

            SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
            IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
               SET @cScanLOT02 = '0'

            IF @cPrefUOM <> '6'
            BEGIN
               SELECT TOP 1
                  @nPrefUOM_Div = CAST( IsNULL(
                     CASE @cPrefUOM
                        WHEN '2' THEN Pack.CaseCNT
                        WHEN '3' THEN Pack.InnerPack
                        WHEN '6' THEN Pack.QTY
                        WHEN '1' THEN Pack.Pallet
                        WHEN '4' THEN Pack.OtherUnit1
                        WHEN '5' THEN Pack.OtherUnit2
                     END, 1) AS INT)
               FROM dbo.SKU SKU (NOLOCK)
                  INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
               WHERE StorerKey = @cStorerKey
                  AND SKU = @cSKU

               -- Convert to prefer UOM QTY to be picked
               SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
               SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

               -- Convert to prefer UOM QTY picked
               SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
               SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

					--SOS334125 Start
               SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                         RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                         '/' +
                                         RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                         RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
					--SOS334125 End

               SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
               SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
            END

            -- Extended info
            IF @cExtendedInfoSP <> ''
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
               BEGIN
                  SET @cExtendedInfo = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
               END
            END

            IF @nFunc = 1620
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cDropID
               SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField04 = ''
               SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
               SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
               SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                                  THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
               SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                       THEN @cOS_Qty
                                       WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                  ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
               SET @cOutField09 = @cOrderKey
               SET @cOutField10 = @cExternOrderKey
               SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

               EXEC rdt.rdtSetFocusField @nMobile, 4

               SET @nScn  = 1877
               SET @nStep = 8
            END
            ELSE
            IF @nFunc = 1621
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cSKU
               SET @cOutField03 = ''
               SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
               SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
               SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
               SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                       THEN @cOS_Qty
                                       WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                  ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
               SET @cOutField09 = @cOrderKey
               SET @cOutField10 = @cExternOrderKey
               SET @cOutField11 = @nTTL_Ord

               EXEC rdt.rdtSetFocusField @nMobile, 3

               -- Go to next screen
               SET @nScn  = 1883
               SET @nStep = 8
            END
            ELSE
            IF @nFunc = 1628  -- (james07)
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField03 = ''
               SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
               SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
               SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
               SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                       THEN @cOS_Qty
                                       WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                  ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
               SET @cOutField09 = @cLoadKey
               SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
               SET @cOutField11 = @nTTL_Ord

               EXEC rdt.rdtSetFocusField @nMobile, 3

               -- Go to next screen
               SET @nScn  = 1888
               SET @nStep = 8
            END

            IF @cPrefUOM <> '6'
               SET @cOutField12 = @cPreferQty2Display
            ELSE
               SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

            SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                               THEN '' ELSE @cDefaultPickQty END -- Qty to pick
            SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
            SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                    CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                               ELSE 'QTY: ' END

            SET @cFieldAttr01 = ''
            SET @cFieldAttr02 = ''
            SET @cFieldAttr03 = ''
            SET @cFieldAttr04 = ''
            SET @cFieldAttr05 = ''
            SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
            SET @cFieldAttr07 = ''
            SET @cFieldAttr08 = ''
            SET @cFieldAttr09 = ''
            SET @cFieldAttr10 = ''
            SET @cFieldAttr11 = ''
            SET @cFieldAttr12 = ''
            SET @cFieldAttr13 = ''
            SET @cFieldAttr14 = ''
            SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END
         END   -- @cSHOWSHTPICKRSN = 1

         -- If config turned on, not allow to change Qty To Pick
         IF @cClusterPickLockQtyToPick = '1'
         BEGIN
            SET @cFieldAttr13 = 'O'
            SET @cInField13 = @cDefaultPickQty
         END

         GOTO Quit
      END   -- Option = 1

      IF @cOption = '2'
      BEGIN
         -- If storerconfig turned on, confirm the skipped SKU    (james18)
         -- This is the same functionality as user choosing Option 1
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmSkipSKU', @cStorerKey) = '1'
         BEGIN
            GOTO Confirm_Skip_SKU
         END

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

         -- (james14)
         IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
         BEGIN
            SET @cOS_Qty = ''

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND LPD.LoadKey = @cLoadKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.Status >= '3'
                  AND LPD.LoadKey = @cLoadKey

               SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
            ELSE
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND OrderKey = @cOrderKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND OrderKey = @cOrderKey
                  AND Status >= '3'

               SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
         END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

               SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                    '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cTemp_String = @cExtendedInfo2
               END
            END
         END

         -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
         BEGIN
            SET @cPackCfg = ''

            SELECT @fPack_Qty = PACK.QTY,
                   @fPack_InnerPack = PACK.InnerPack,
                   @fPack_CaseCnt = PACK.CaseCnt
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                            RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                            RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
         END

         SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
         IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
            SET @cScanLOT02 = '0'

         IF @cPrefUOM <> '6'
         BEGIN
            SELECT TOP 1
               @nPrefUOM_Div = CAST( IsNULL(
                  CASE @cPrefUOM
                     WHEN '2' THEN Pack.CaseCNT
                     WHEN '3' THEN Pack.InnerPack
                     WHEN '6' THEN Pack.QTY
                     WHEN '1' THEN Pack.Pallet
                     WHEN '4' THEN Pack.OtherUnit1
                     WHEN '5' THEN Pack.OtherUnit2
                  END, 1) AS INT)
            FROM dbo.SKU SKU (NOLOCK)
               INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU

            -- Convert to prefer UOM QTY to be picked
            SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

            -- Convert to prefer UOM QTY picked
            SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

				--SOS334125 Start
            SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                      '/' +
                                      RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
				--SOS334125 End

            SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
            SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
         END

         -- Extended info
         IF @cExtendedInfoSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
            BEGIN
               SET @cExtendedInfo = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
            END
         END

         IF @nFunc = 1620
         BEGIN
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cDropID
            SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField04 = ''
            SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
            SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                               THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

            EXEC rdt.rdtSetFocusField @nMobile, 4

            -- Go to prev screen
            SET @nScn  = 1877
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cSKU
            SET @cOutField03 = ''
            SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1883
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1628  -- (james07)
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField03 = ''
            SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
            SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cLoadKey
            SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1888
            SET @nStep = 8
         END

         IF @cPrefUOM <> '6'
            SET @cOutField12 = @cPreferQty2Display
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

         SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                            THEN '' ELSE @cDefaultPickQty END -- Qty to pick
         SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
         SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                 CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                            ELSE 'QTY: ' END

         SET @cFieldAttr01 = ''
         SET @cFieldAttr02 = ''
         SET @cFieldAttr03 = ''
         SET @cFieldAttr04 = ''
         SET @cFieldAttr05 = ''
         SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
         SET @cFieldAttr07 = ''
         SET @cFieldAttr08 = ''
         SET @cFieldAttr09 = ''
         SET @cFieldAttr10 = ''
         SET @cFieldAttr11 = ''
         SET @cFieldAttr12 = ''
         SET @cFieldAttr13 = ''
         SET @cFieldAttr14 = ''
         SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END
      END
      ELSE
      -- SOS197651 If config setup allow to skip SKU (james11)
      IF @cOption = '3'
      BEGIN
         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

         SELECT @cLogicalLoc = '', @cStyle = '', @cColor = '', @cBUSR6 = ''
         SELECT @cLogicalLoc = LogicalLocation
         FROM dbo.LOC WITH (NOLOCK)
         WHERE LOC = @cLOC
            AND Facility = @cFacility

         SELECT @cStyle = Style, @cColor = Color, @cBUSR6 = BUSR6 FROM dbo.SKU WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
            AND SKU = @cSKU

         --BEGIN TRAN ang02(remove)

         IF NOT EXISTS (
            SELECT 1
            FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            JOIN dbo.SKU SKU WITH (NOLOCK) ON (PD.StorerKey = SKU.StorerKey AND PD.SKU = SKU.SKU)
            WHERE (( @nMultiStorer = 1 AND RPL.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND RPL.StorerKey = @cStorerKey))
               AND RPL.Status < '9'
               AND RPL.AddWho = @cUserName
               AND PD.Status = '0'
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND RTRIM(L.LogicalLocation) + RTRIM(PD.LOC) + RTRIM(SKU.Style) + RTRIM(SKU.Color) + RTRIM(SKU.BUSR6) +
                   CASE WHEN @cLoadDefaultPickMethod = 'C' THEN '' ELSE RTRIM(PD.OrderKey) END >
                   RTRIM(@cLogicalLoc) + RTRIM(@cLOC) + RTRIM(@cStyle) + RTRIM(@cColor) + RTRIM(@cBUSR6) +
                   CASE WHEN @cLoadDefaultPickMethod = 'C' THEN '' ELSE RTRIM(@cOrderKey) END)
         BEGIN

            -- Cancel the current task
            BEGIN TRAN --ang02 (add)
            UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
               Status = 'X', Descr = 'User Skipped Task !!!'
            WHERE LoadKey = CASE WHEN @cLoadDefaultPickMethod = 'C' THEN @cLoadKey ELSE LoadKey END
               AND OrderKey = CASE WHEN @cLoadDefaultPickMethod = 'C' THEN OrderKey ELSE @cOrderKey END
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND SKU = @cSKU
               AND AddWho = @cUserName
               AND LOC = @cLOC   -- (james13)
               AND Status = '1'


            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 69350
               SET @cErrMsg = rdt.rdtgetmessage( 69350, @cLangCode, 'DSP') --'Skip Task Fail'
               ROLLBACK TRAN
               GOTO Step_9_Fail
            END
            ELSE --(ang02) start
            BEGIN
               COMMIT TRAN
            END    --(ang02) end

            -- If pick by conso then look for all orders
            -- and group by logicalloc, loc, sku, lot2, lot4
            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Remember current LOC (james19)
               SET @cPrevLOC = ''
               SET @cPrevLOC = @cLOC

               SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
               IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
               BEGIN
                  SET @c_oFieled03 = @cSKU
                  EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                      @n_Mobile        = @nMobile
                     ,@n_Func          = @nFunc
                     ,@c_SPName        = @cClusterPickGetNextTask_SP
                     ,@c_Storerkey     = @cStorerKey
                     ,@c_UserName      = @cUserName
                     ,@c_Facility      = @cFacility
                     ,@c_PutawayZone   = @cPutawayZone
                     ,@c_PickZone      = @cPickZone
                     ,@c_LangCode      = @cLangCode
                     ,@c_oFieled01     = @c_oFieled01 OUTPUT
                     ,@c_oFieled02     = @c_oFieled02 OUTPUT
                     ,@c_oFieled03     = @c_oFieled03 OUTPUT
                     ,@c_oFieled04     = @c_oFieled04 OUTPUT
                     ,@c_oFieled05     = @c_oFieled05 OUTPUT
                     ,@c_oFieled06     = @c_oFieled06 OUTPUT
                     ,@c_oFieled07     = @c_oFieled07 OUTPUT
                     ,@c_oFieled08     = @c_oFieled08 OUTPUT
                     ,@c_oFieled09     = @c_oFieled09 OUTPUT
                     ,@c_oFieled10     = @c_oFieled10 OUTPUT
                     ,@c_oFieled11     = @c_oFieled11 OUTPUT
                     ,@c_oFieled12     = @c_oFieled12 OUTPUT
                     ,@c_oFieled13     = @c_oFieled13 OUTPUT
                     ,@c_oFieled14     = @c_oFieled14 OUTPUT
                     ,@c_oFieled15     = @c_oFieled15 OUTPUT
                     ,@b_Success       = @b_Success   OUTPUT
                     ,@n_ErrNo         = @nErrNo      OUTPUT
                     ,@c_ErrMsg        = @cErrMsg     OUTPUT

                  SET @cLOC            = @c_oFieled01
                  SET @cOrderKey       = @c_oFieled02
                  SET @cSKU            = @c_oFieled03
                  SET @cSKU_Descr      = @c_oFieled04
                  SET @cStyle          = @c_oFieled05
                  SET @cColor          = @c_oFieled06
                  SET @cSize           = @c_oFieled07
                  SET @cColor_Descr    = @c_oFieled08
                  SET @cLot            = @c_oFieled09
                  SET @cPickSlipNo     = @c_oFieled10
                  SET @cExternOrderKey = @c_oFieled11
                  SET @cConsigneeKey   = @c_oFieled12
                  SET @cLottable02     = @c_oFieled13
                  SET @dLottable04     = @c_oFieled14

                  SET @cNewLOC = @cLOC
               END
               ELSE
               BEGIN
                  SET @cLogicalLoc = ''
                  SELECT @cLogicalLoc = LogicalLocation
                  FROM dbo.LOC WITH (NOLOCK)
                  WHERE LOC = @cLOC
                     AND Facility = @cFacility

                  SELECT TOP 1
                     @cNewLOC = PD.Loc,
                     @cNewSKU = PD.SKU,
                     @cNewLottable02 = LA.Lottable02,
                     @dNewLottable04 = LA.Lottable04
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                  JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
                  JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
                  JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
                  WHERE O.StorerKey = @cStorerKey
                     AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                     AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                     AND PD.Status = '0'
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                     -- (james31) to allow get next task in diff pickzone if skip task
                     --AND LOC.PickZone = CASE WHEN ISNULL(@cPickZone, '') = '' THEN LOC.PickZone ELSE @cPickZone END
                     AND O.Facility = @cFacility      -- tlting03
                     AND RTRIM(LOC.LogicalLocation) + RTRIM(PD.Loc) + RTRIM(PD.SKU) + ISNULL(RTRIM(LA.Lottable02), '') + ISNULL(CONVERT( NVARCHAR( 10), LA.Lottable04, 120), 0) >
                         RTRIM(@cLogicalLoc) + RTRIM(@cLoc) + RTRIM(@cSKU) + RTRIM(@cLottable02) + ISNULL(CONVERT( NVARCHAR( 10), @dLottable04, 120), 0)
                     AND NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK)
                        WHERE PD.StorerKey = RPL.StorerKey AND PD.OrderKey = RPL.OrderKey AND PD.SKU = RPL.SKU AND RPL.Status = '1')  -- (james31)
                  GROUP BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
                  ORDER BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
               END

               IF ISNULL( @cNewLOC, '') = ''
               BEGIN
                  SET @nErrNo = 65975
                  SET @cErrMsg = rdt.rdtgetmessage( 65975, @cLangCode, 'DSP') --'No Record'
                  GOTO Step_9_Fail
               END

               SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cNewLOC
               IF ISNULL( @cLocDescr, '') = ''
                  SET @cLocDescr = @cNewLOC     -- ZG01

               SET @cLOC = @cNewLOC
               SET @cSKU = @cNewSKU
               SET @cLottable02 = @cNewLottable02
               SET @dLottable04 = @dNewLottable04

               EXEC [RDT].[rdt_ClusterPickSkuAttribute]
                  @nMobile       = @nMobile,
                  @nFunc         = @nFunc,
                  @cLangCode     = @cLangCode,
                  @nStep         = @nStep,
                  @nInputKey     = @nInputKey,
                  @cStorerKey    = @cStorerKey,
                  @cSKU          = @cSKU,
                  @cAltSKU       = @cAltSKU       OUTPUT,
                  @cDescr        = @cSKU_Descr    OUTPUT,
                  @cStyle        = @cStyle        OUTPUT,
                  @cColor        = @cColor        OUTPUT,
                  @cSize         = @cSize         OUTPUT,
                  @cColor_Descr  = @cColor_Descr  OUTPUT,
                  @cAttribute01  = @cAttribute01  OUTPUT,
                  @cAttribute02  = @cAttribute02  OUTPUT,
                  @cAttribute03  = @cAttribute03  OUTPUT,
                  @cAttribute04  = @cAttribute04  OUTPUT,
                  @cAttribute05  = @cAttribute05  OUTPUT,
                  @cAttribute06  = @cAttribute06  OUTPUT,
                  @cAttribute07  = @cAttribute07  OUTPUT,
                  @cAttribute08  = @cAttribute08  OUTPUT,
                  @cAttribute09  = @cAttribute09  OUTPUT,
                  @cAttribute10  = @cAttribute10  OUTPUT,
                  @nErrNo        = @nErrNo        OUTPUT,
                  @cErrMsg       = @cErrMsg       OUTPUT

               IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
               BEGIN
                  SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
                  SET @cColor = @cColor + ' '
                  SET @cSKU_Descr = ''
               END

               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT PD.ORDERKEY, PD.LOT
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey and PD.OrderLineNumber = OD.OrderLineNumber)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.STATUS = '0'
                  AND PD.LOC = @cLOC
                  AND PD.SKU = @cSKU
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                  AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               GROUP BY PD.ORDERKEY, PD.LOT
               ORDER BY PD.ORDERKEY, PD.LOT
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  BEGIN TRAN

                  INSERT INTO RDT.RDTPickLock
                  (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
                  , LOT, LOC, SKU, DropID, Lottable02, Lottable04, Status, AddWho, AddDate, PickSlipNo, Mobile, PackKey)
                  VALUES
                  (ISNULL(@cWaveKey, ''), ISNULL(@cLoadKey, ''), @cConso_Orders, '', @cStorerKey, ISNULL(@cPutAwayZone, ''), ISNULL(@cPickZone, ''), @cConso_Orders,
                  @cLot, @cLoc, @cSKU, @cDropID, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cPickSlipNo, @nMobile, @cCartonType)

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65976
                     SET @cErrMsg = rdt.rdtgetmessage( 65976, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_9_Fail
                  END
                  ELSE --ang02 start
                  BEGIN
                  COMMIT TRAN
                  END--ang02 end

                  FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS

               SELECT @nTTL_Qty = SUM(PD.QTY)
               FROM dbo.PickDetail PD WITH (NOLOCK) --ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND LA.Storerkey = @cStorerKey   -- tlting03
                  AND LA.SKU = @cSKU
                  AND L.LOC = @cLOC
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
                  -- TLTING03  Duplicate check
                  --AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = PD.StorerKey
                  --               AND OrderKey = PD.OrderKey AND ADDWHO = @cUserName ) -- SOS# 176144
--                  AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName and Status = '1') -- SOS# 176144

               -- Get the total allocated qty for LOC + SKU + OrderKey
               SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.LOC = @cLOC
                  AND PD.SKU = @cSKU
                  AND PD.Status = '0'
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
                  AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

               SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
               IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

               IF @cDefaultToAllocatedQty = '1'
               BEGIN
                  SET @cDefaultPickQty = @nTotalPickQty
               END

               SET @nQtyToPick = 0
               SET @nActQty = 0

               -- Get Total Orders left on the current sku that need to pick
               SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE RPL.StorerKey = @cStorerKey
                  AND RPL.Status < '5'
                  AND RPL.AddWho = @cUserName
                  AND RPL.PickQty <= 0
                  AND PD.SKU = @cSKU
                  AND PD.LOC = @cLOC
                  AND PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

               -- (james14)
               IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
               BEGIN
                  SET @cOS_Qty = ''

                  IF @cLoadDefaultPickMethod = 'C'
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND LPD.LoadKey = @cLoadKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                     AND PD.Status >= '3'
                        AND LPD.LoadKey = @cLoadKey

                     SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
                  ELSE
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey
                        AND Status >= '3'

                     SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
               END

               IF @cClusterPickNike <> ''
               BEGIN
                  IF @cClusterPickNike = '1'
                  BEGIN
                     SET @cTemp_String = ''
                     SET @cTemp_UOM = ''
                     SET @nTemp_PackQtyIndicator = ''

                     SELECT
                        @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                        @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                     FROM dbo.SKU SKU WITH (NOLOCK)
                     JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                     WHERE SKU.StorerKey = @cStorerKey
                        AND SKU.SKU = @cSKU

                     SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                        '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                  END
                  ELSE
                  BEGIN
                     IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo2 = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                        SET @cTemp_String = @cExtendedInfo2
                     END
                  END
               END

               -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
               BEGIN
                  SET @cPackCfg = ''

                  SELECT @fPack_Qty = PACK.QTY,
                         @fPack_InnerPack = PACK.InnerPack,
                         @fPack_CaseCnt = PACK.CaseCnt
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE SKU.StorerKey = @cStorerKey
                     AND SKU.SKU = @cSKU

                  SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                                  RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                                  RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
               END

               SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
               IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
                  SET @cScanLOT02 = '0'

               IF @cPrefUOM <> '6'
               BEGIN
                  SELECT TOP 1
                     @nPrefUOM_Div = CAST( IsNULL(
                        CASE @cPrefUOM
                           WHEN '2' THEN Pack.CaseCNT
                           WHEN '3' THEN Pack.InnerPack
                           WHEN '6' THEN Pack.QTY
                           WHEN '1' THEN Pack.Pallet
                           WHEN '4' THEN Pack.OtherUnit1
                           WHEN '5' THEN Pack.OtherUnit2
                        END, 1) AS INT)
                  FROM dbo.SKU SKU (NOLOCK)
                     INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
                  WHERE StorerKey = @cStorerKey
                     AND SKU = @cSKU

                  -- Convert to prefer UOM QTY to be picked
                  SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

                  -- Convert to prefer UOM QTY picked
                  SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

						--SOS334125 Start
                  SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                            '/' +
                                            RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
						--SOS334125 End

                  SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
                  SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
               END

               -- Extended info
               IF @cExtendedInfoSP <> ''
               BEGIN
                  IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
                  END
               END

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cDropID
                  SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField04 = ''
                  SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
                  SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                                     THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

                  EXEC rdt.rdtSetFocusField @nMobile, 4

                  SET @nScn  = 1877
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cSKU
                  SET @cOutField03 = ''
                  SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1883
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1628  -- (james07)
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField03 = ''
                  SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
                  SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cLoadKey
                  SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1888
                  SET @nStep = 8
               END

               IF @cPrefUOM <> '6'
                  SET @cOutField12 = @cPreferQty2Display
               ELSE
                  SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

               SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                                  THEN '' ELSE @cDefaultPickQty END -- Qty to pick
               SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
               SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                       CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                                  ELSE 'QTY: ' END

               -- Commit transaction
               --COMMIT TRAN    ang02 remove

               SET @cFieldAttr01 = ''
               SET @cFieldAttr02 = ''
               SET @cFieldAttr03 = ''
               SET @cFieldAttr04 = ''
               SET @cFieldAttr05 = ''
               SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
               SET @cFieldAttr07 = ''
               SET @cFieldAttr08 = ''
               SET @cFieldAttr09 = ''
               SET @cFieldAttr10 = ''
               SET @cFieldAttr11 = ''
               SET @cFieldAttr12 = ''
               SET @cFieldAttr13 = ''
               SET @cFieldAttr14 = ''
               SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

               -- If config turned on, not allow to change Qty To Pick
               IF @cClusterPickLockQtyToPick = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END

               GOTO Quit
            END
            ELSE
            BEGIN
               SELECT
                  @nOrderPicked = COUNT( DISTINCT OrderKey),
                  @nTTL_PickedQty = SUM(PickQty)
               FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE AddWho = @cUserName
                  AND Status = '5'
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                  AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                  AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))

               -- Confirm picking in RDT.RDTPickLock
               SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
               SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               AND AddWho = @cUserName
               AND Status = '5'
               OPEN @curUpdRPL
               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  BEGIN TRAN --ang02 add
                  UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
                  WHERE RowRef = @nRowRef

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65946
                     SET @cErrMsg = rdt.rdtgetmessage( 65946, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_9_Fail
                  END
                  ELSE --(ang02) start
                  BEGIN
                        COMMIT TRAN
                  END--(ang02) end

                  FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               END
               CLOSE @curUpdRPL
               DEALLOCATE @curUpdRPL

               --COMMIT TRAN ang02 remove

               -- (james36)
               SET @cPickNotFinish = ''
               IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
               BEGIN
                  IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                              JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                              JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                              JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                              WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                              AND   ( PD.Status = '0' OR PD.Status = '4')
                              AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                              AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                              AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                              AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                              AND   LOC.Facility = @cFacility
                              AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                    WHERE PD.OrderKey = RPL.OrderKey
                                                    AND   PD.StorerKey = RPL.StorerKey
                                                    AND   RPL.AddWho = @cUserName
                                                    AND   RPL.Status < '9'))
                  BEGIN
                     SET @cPickNotFinish = 'PICKING NOT FINISH'
                  END
               END

               -- Prep next screen var
               SET @cOutField01 = @cWaveKey
               SET @cOutField02 = @cLoadKey
               SET @cOutField03 = @cPutawayZone
               SET @cOutField04 = @cPickZone
               SET @cOutField05 = @nOrderPicked
               SET @cOutField06 = @nTTL_PickedQty
               SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

               SET @nScn  = 1879
               SET @nStep = 10

               GOTO Quit
            END
         END   -- not exists
         ELSE
         BEGIN
            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            SELECT @cLogicalLoc = '', @cStyle = '', @cColor = '', @cBUSR6 = ''
            SELECT @cLogicalLoc = LogicalLocation
            FROM dbo.LOC WITH (NOLOCK)
            WHERE LOC = @cLOC
               AND Facility = @cFacility

            SELECT @cStyle = Style, @cColor = Color, @cBUSR6 = BUSR6 FROM dbo.SKU WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU


            -- If pick by conso then look for all orders
            -- and group by logicalloc, loc, sku, lot2, lot4
            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Remember current LOC (james19)
               SET @cPrevLOC = ''
               SET @cPrevLOC = @cLOC

               SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
               IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
               BEGIN
                  SET @c_oFieled03 = @cSKU
                  EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                      @n_Mobile        = @nMobile
                     ,@n_Func          = @nFunc
                     ,@c_SPName        = @cClusterPickGetNextTask_SP
                     ,@c_Storerkey     = @cStorerKey
                     ,@c_UserName      = @cUserName
                     ,@c_Facility      = @cFacility
                     ,@c_PutawayZone   = @cPutawayZone
                     ,@c_PickZone      = @cPickZone
                     ,@c_LangCode      = @cLangCode
                     ,@c_oFieled01     = @c_oFieled01 OUTPUT
                     ,@c_oFieled02     = @c_oFieled02 OUTPUT
                     ,@c_oFieled03     = @c_oFieled03 OUTPUT
                     ,@c_oFieled04     = @c_oFieled04 OUTPUT
                     ,@c_oFieled05     = @c_oFieled05 OUTPUT
                     ,@c_oFieled06     = @c_oFieled06 OUTPUT
                     ,@c_oFieled07     = @c_oFieled07 OUTPUT
                     ,@c_oFieled08     = @c_oFieled08 OUTPUT
                     ,@c_oFieled09     = @c_oFieled09 OUTPUT
                     ,@c_oFieled10     = @c_oFieled10 OUTPUT
                     ,@c_oFieled11     = @c_oFieled11 OUTPUT
                     ,@c_oFieled12     = @c_oFieled12 OUTPUT
                     ,@c_oFieled13     = @c_oFieled13 OUTPUT
                     ,@c_oFieled14     = @c_oFieled14 OUTPUT
                     ,@c_oFieled15     = @c_oFieled15 OUTPUT
                     ,@b_Success       = @b_Success   OUTPUT
                     ,@n_ErrNo         = @nErrNo      OUTPUT
                     ,@c_ErrMsg        = @cErrMsg     OUTPUT

                  SET @cLOC            = @c_oFieled01
                  SET @cOrderKey       = @c_oFieled02
                  SET @cSKU            = @c_oFieled03
                  SET @cSKU_Descr      = @c_oFieled04
                  SET @cStyle          = @c_oFieled05
                  SET @cColor          = @c_oFieled06
                  SET @cSize           = @c_oFieled07
                  SET @cColor_Descr    = @c_oFieled08
                  SET @cLot            = @c_oFieled09
                  SET @cPickSlipNo     = @c_oFieled10
                  SET @cExternOrderKey = @c_oFieled11
                  SET @cConsigneeKey   = @c_oFieled12
                  SET @cLottable02 = @c_oFieled13
                  SET @dLottable04   = @c_oFieled14

                  SET @cNewLOC = @cLOC
               END
               ELSE
               BEGIN
                  SELECT TOP 1
                     @cNewLOC = PD.Loc,
                     @cNewSKU = PD.SKU,
                     @cNewLottable02 = LA.Lottable02,
                     @dNewLottable04 = LA.Lottable04
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.OrderDetail OD WITH (NOLOCK)
                     ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)    -- (james09)
                  JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
                  JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
                  JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
                  WHERE PD.StorerKey = @cStorerKey
                     AND PD.Status = '0'
                     AND O.LoadKey = @cLoadKey
                     AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                     AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                     AND O.Facility = @cFacility   -- tlting03
                     AND RTRIM(LOC.LogicalLocation) + RTRIM(PD.SKU) + ISNULL(RTRIM(LA.Lottable02), '') + ISNULL(CONVERT( NVARCHAR( 10), LA.Lottable04, 120), 0) >
                         RTRIM(@cLogicalLoc) + RTRIM(@cSKU) + RTRIM(@cLottable02) + ISNULL(CONVERT( NVARCHAR( 10), @dLottable04, 120), 0)--@dLottable04
                     AND NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK)
                        WHERE PD.StorerKey = RPL.StorerKey AND PD.OrderKey = RPL.OrderKey AND PD.SKU = RPL.SKU AND RPL.Status = '1')
                  GROUP BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
                  ORDER BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
               END

               IF ISNULL( @cNewLOC, '') = ''
               BEGIN
                  SET @nErrNo = 65975
                  SET @cErrMsg = rdt.rdtgetmessage( 65975, @cLangCode, 'DSP') --'No Record'
                  GOTO Step_9_Fail
               END

               SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cNewLOC
               IF ISNULL( @cLocDescr, '') = ''
                  SET @cLocDescr = @cNewLOC     -- ZG01

               BEGIN TRAN   --ang02 add
               -- Cancel the current task
               UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
                  Status = 'X', Descr = 'User Skipped Task !!!'
               WHERE LoadKey = @cLoadKey
                  AND StorerKey = @cStorerKey    -- tlting03
                  AND SKU = @cSKU
                  AND AddWho = @cUserName
                  AND LOC = @cLOC   -- (james13)
                  AND Status = '1'

               IF @@ERROR <> 0
               BEGIN
                  ROLLBACK TRAN
                  GOTO Step_9_Fail
               END
               ELSE --(ang02) start
               BEGIN
                     COMMIT TRAN
               END--(ang02) end

               SET @cLOC = @cNewLOC
               SET @cSKU = @cNewSKU
               SET @cLottable02 = @cNewLottable02
               SET @dLottable04 = @dNewLottable04

               EXEC [RDT].[rdt_ClusterPickSkuAttribute]
                  @nMobile       = @nMobile,
                  @nFunc         = @nFunc,
                  @cLangCode     = @cLangCode,
                  @nStep         = @nStep,
                  @nInputKey     = @nInputKey,
                  @cStorerKey    = @cStorerKey,
                  @cSKU          = @cSKU,
                  @cAltSKU       = @cAltSKU       OUTPUT,
                  @cDescr        = @cSKU_Descr    OUTPUT,
                  @cStyle        = @cStyle        OUTPUT,
                  @cColor        = @cColor        OUTPUT,
                  @cSize         = @cSize         OUTPUT,
                  @cColor_Descr  = @cColor_Descr  OUTPUT,
                  @cAttribute01  = @cAttribute01  OUTPUT,
                  @cAttribute02  = @cAttribute02  OUTPUT,
                  @cAttribute03  = @cAttribute03  OUTPUT,
                  @cAttribute04  = @cAttribute04  OUTPUT,
                  @cAttribute05  = @cAttribute05  OUTPUT,
                  @cAttribute06  = @cAttribute06  OUTPUT,
                  @cAttribute07  = @cAttribute07  OUTPUT,
                  @cAttribute08  = @cAttribute08  OUTPUT,
                  @cAttribute09  = @cAttribute09  OUTPUT,
                  @cAttribute10  = @cAttribute10  OUTPUT,
                  @nErrNo        = @nErrNo        OUTPUT,
                  @cErrMsg       = @cErrMsg       OUTPUT

               IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
               BEGIN
                  SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
                  SET @cColor = @cColor + ' '
                  SET @cSKU_Descr = ''
               END

               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT PD.ORDERKEY, PD.LOT
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey and PD.OrderLineNumber = OD.OrderLineNumber)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.STATUS = '0'
                  AND PD.LOC = @cLOC
                  AND PD.SKU = @cSKU
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                  AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               GROUP BY PD.ORDERKEY, PD.LOT
               ORDER BY PD.ORDERKEY, PD.LOT
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  BEGIN TRAN

                  INSERT INTO RDT.RDTPickLock
                  (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
                  , LOT, LOC, SKU, DropID, Lottable02, Lottable04, Status, AddWho, AddDate, PickSlipNo, Mobile, PackKey)
                  VALUES
                  (ISNULL(@cWaveKey, ''), ISNULL(@cLoadKey, ''), @cConso_Orders, 'SKIP', @cStorerKey, ISNULL(@cPutAwayZone, ''), ISNULL(@cPickZone, ''), @cConso_Orders,
                  @cLot, @cLoc, @cSKU, @cDropID, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cPickSlipNo, @nMobile, @cCartonType)

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65976
                     SET @cErrMsg = rdt.rdtgetmessage( 65976, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN
                GOTO Step_9_Fail
                  END
                  ELSE --ang02 start
                  BEGIN
                     COMMIT TRAN
                  END --ang02 end

                  FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS

               SELECT @nTTL_Qty = SUM(PD.QTY)
               FROM dbo.PickDetail PD WITH (NOLOCK) --ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND PD.SKU = @cSKU
                  AND PD.LOC = @cLOC
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
                  -- TLTING03 Duplicate check
                  --AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = PD.StorerKey
                  --               AND OrderKey = PD.OrderKey
                  --               AND ADDWHO = @cUserName ) -- SOS# 176144
                  --AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName and Status = '1') -- SOS# 176144

               -- Get the total allocated qty for LOC + SKU + OrderKey
               SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.LOC = @cLOC
                  AND PD.StorerKey = @cStorerKey   -- tlting03
                  AND PD.SKU = @cSKU
                  AND PD.Status = '0'
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
                     AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
                  AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

               SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
               IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

               IF @cDefaultToAllocatedQty = '1'
               BEGIN
                  SET @cDefaultPickQty = @nTotalPickQty
               END

               SET @nQtyToPick = 0
               SET @nActQty = 0

               -- Get Total Orders left on the current sku that need to pick
               SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE RPL.StorerKey = @cStorerKey
                  AND RPL.Status < '5'
                  AND RPL.AddWho = @cUserName
                  AND RPL.PickQty <= 0
                  AND LA.StorerKey = @cStorerKey      -- tlting03
                  AND LA.SKU = @cSKU
                  AND L.LOC = @cLOC
                  AND PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

               -- (james14)
               IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
               BEGIN
                  SET @cOS_Qty = ''

                  IF @cLoadDefaultPickMethod = 'C'
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND LPD.LoadKey = @cLoadKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND PD.Status >= '3'
                        AND LPD.LoadKey = @cLoadKey

                     SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
                  ELSE
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND OrderKey = @cOrderKey
                        AND Status >= '3'

                     SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
               END

               IF @cClusterPickNike <> ''
               BEGIN
                  IF @cClusterPickNike = '1'
                  BEGIN
                     SET @cTemp_String = ''
                     SET @cTemp_UOM = ''
                     SET @nTemp_PackQtyIndicator = ''

                     SELECT
                        @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                        @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                     FROM dbo.SKU SKU WITH (NOLOCK)
                     JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                     WHERE SKU.StorerKey = @cStorerKey
                        AND SKU.SKU = @cSKU

                     SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                        '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                  END
                  ELSE
                  BEGIN
                     IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo2 = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                        SET @cTemp_String = @cExtendedInfo2
                     END
                  END
               END

               -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
               BEGIN
                  SET @cPackCfg = ''

                  SELECT @fPack_Qty = PACK.QTY,
                         @fPack_InnerPack = PACK.InnerPack,
                         @fPack_CaseCnt = PACK.CaseCnt
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE SKU.StorerKey = @cStorerKey
                     AND SKU.SKU = @cSKU

                  SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                                  RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                                  RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
               END

               SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
               IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
                  SET @cScanLOT02 = '0'

               IF @cPrefUOM <> '6'
               BEGIN
                  SELECT TOP 1
                     @nPrefUOM_Div = CAST( IsNULL(
                        CASE @cPrefUOM
                           WHEN '2' THEN Pack.CaseCNT
                           WHEN '3' THEN Pack.InnerPack
                           WHEN '6' THEN Pack.QTY
                           WHEN '1' THEN Pack.Pallet
                           WHEN '4' THEN Pack.OtherUnit1
                           WHEN '5' THEN Pack.OtherUnit2
                        END, 1) AS INT)
                  FROM dbo.SKU SKU (NOLOCK)
                     INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
                  WHERE StorerKey = @cStorerKey
                     AND SKU = @cSKU

                  -- Convert to prefer UOM QTY to be picked
                  SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

                  -- Convert to prefer UOM QTY picked
                  SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

						--SOS334125 Start
                  SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                            '/' +
                                            RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
						--SOS334125 End

                  SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
                  SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
               END

               -- Extended info
               IF @cExtendedInfoSP <> ''
               BEGIN
                  IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
                  END
               END

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cDropID
                  SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField04 = ''
                  SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
                  SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                                     THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

                  EXEC rdt.rdtSetFocusField @nMobile, 4

                  SET @nScn  = 1877
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cSKU
                  SET @cOutField03 = ''
                  SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1883
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1628  -- (james07)
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField03 = ''
                  SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
                  SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cLoadKey
                  SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1888
                  SET @nStep = 8
               END

               IF @cPrefUOM <> '6'
                  SET @cOutField12 = @cPreferQty2Display
               ELSE
                  SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

               SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                                  THEN '' ELSE @cDefaultPickQty END -- Qty to pick
               SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
               SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                       CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                                  ELSE 'QTY: ' END

               -- Commit transaction
               --  COMMIT TRAN   -- ang02

               SET @cFieldAttr01 = ''
               SET @cFieldAttr02 = ''
               SET @cFieldAttr03 = ''
               SET @cFieldAttr04 = ''
               SET @cFieldAttr05 = ''
               SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
               SET @cFieldAttr07 = ''
               SET @cFieldAttr08 = ''
               SET @cFieldAttr09 = ''
               SET @cFieldAttr10 = ''
               SET @cFieldAttr11 = ''
               SET @cFieldAttr12 = ''
               SET @cFieldAttr13 = ''
               SET @cFieldAttr14 = ''
               SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

               -- If config turned on, not allow to change Qty To Pick
               IF @cClusterPickLockQtyToPick = '1'
               BEGIN
                  SET @cFieldAttr13 = 'O'
                  SET @cInField13 = @cDefaultPickQty
               END

               GOTO Quit
            END
            ELSE
            BEGIN
               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

               SELECT @cLogicalLoc = '', @cStyle = '', @cColor = '', @cBUSR6 = ''
               SELECT @cLogicalLoc = LogicalLocation
               FROM dbo.LOC WITH (NOLOCK)
               WHERE LOC = @cLOC
                  AND Facility = @cFacility

               SELECT @cStyle = Style, @cColor = Color, @cBUSR6 = BUSR6 FROM dbo.SKU WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND SKU = @cSKU

               -- (james19)
               SET @cPrevLOC = ''
               SET @cPrevLOC = @cLOC
               -- Skip current SKU
               SET @c_ExecStatements = N'SELECT TOP 1 ' +
                                        '@cNewLOC = PD.Loc, ' +
                                        '@cNewOrderKey = PD.OrderKey,  ' +
                                        '@cNewSKU = PD.SKU,  ' +
                                        '@cLot = PD.LOT,  ' +
                                        '@cPickSlipNo = PD.PickSlipNo  ' +
                                        'FROM RDT.RDTPickLock RPL WITH (NOLOCK)  ' +
                                        'JOIN dbo.PickDetail PD WITH (NOLOCK) ' +
                                        'ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)  ' +
                                        'JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)  ' +
                                        'JOIN dbo.SKU SKU WITH (NOLOCK) ON (PD.StorerKey = SKU.StorerKey AND PD.SKU = SKU.SKU)  ' +
                                        'WHERE (( @nMultiStorer = 1 AND RPL.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND RPL.StorerKey = @cStorerKey))' +
                                        'AND RPL.Status < ''9''  ' +
                                        'AND RPL.AddWho = @cUserName  ' +
                                        'AND PD.Status = ''0''  ' +
                                        'AND (( ISNULL( @cPutAwayZone, '''') = ''ALL'') OR ( L.PutAwayZone = @cPutAwayZone)) ' +
                                        'AND (( ISNULL( @cPickZone, '''') = '''') OR ( L.PickZone = @cPickZone)) ' +
                                        'AND L.Facility = @cFacility  '

               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickNike', @cStorerKey) = '1'
               BEGIN
                  SET @c_ExecStatements = RTRIM(@c_ExecStatements) +
                                          ' AND RTRIM(L.LogicalLocation) + RTRIM(PD.LOC) + RTRIM(SKU.Style) + RTRIM(SKU.Color) + RTRIM(SKU.BUSR6) + RTRIM(PD.OrderKey) > ' +
                                          ' RTRIM(@cLogicalLoc) + RTRIM(@cLOC) + RTRIM(@cStyle) + RTRIM(@cColor) + RTRIM(@cBUSR6) + RTRIM(@cOrderKey) '
                  SET @c_ExecStatements = RTRIM(@c_ExecStatements) + ' ORDER BY L.LogicalLocation, PD.LOC, SKU.Style, SKU.Color, SKU.BUSR6, PD.OrderKey '
               END
               ELSE
               BEGIN
                  SET @c_ExecStatements = RTRIM(@c_ExecStatements) + ' AND RTRIM(L.LogicalLocation) + RTRIM(PD.SKU) > RTRIM(@cLogicalLoc) + RTRIM(@cSKU) '
                  SET @c_ExecStatements = RTRIM(@c_ExecStatements) + ' ORDER BY L.LogicalLocation, PD.LOC, PD.SKU, PD.OrderKey '
               END

               SET @c_ExecArguments = N'@cStorerKey            NVARCHAR(15), ' +
                                       '@cUserName             NVARCHAR(15), ' +
                                       '@cPutAwayZone          NVARCHAR(10), ' +
                                       '@cPickZone             NVARCHAR(10), ' +
                                       '@cFacility             NVARCHAR(5),  ' +
                                       '@cLogicalLoc           NVARCHAR(18), ' +
                                       '@cSKU                  NVARCHAR(20), ' +
                                       '@cStyle                NVARCHAR(20), ' +
                                       '@cColor                NVARCHAR(10), ' +
                                       '@cBUSR6                NVARCHAR(30), ' +
                                       '@cOrderKey             NVARCHAR(10), ' +
                                       '@cLOC                  NVARCHAR(10), ' +
                                       '@cORD_StorerKey        NVARCHAR(15), ' +
                                       '@nMultiStorer          INT,          ' +
                                       '@cNewLOC               NVARCHAR(10) OUTPUT, ' +
                                       '@cNewOrderKey          NVARCHAR(10) OUTPUT, ' +
                                       '@cNewSKU               NVARCHAR(20) OUTPUT, ' +
                                       '@cLot                  NVARCHAR(10) OUTPUT, ' +
                                       '@cPickSlipNo           NVARCHAR(10) OUTPUT '

               EXEC sp_ExecuteSql @c_ExecStatements
                                 ,@c_ExecArguments
                                 ,@cStorerKey
                                 ,@cUserName
                                 ,@cPutAwayZone
                                 ,@cPickZone
                                 ,@cFacility
                                 ,@cLogicalLoc
                                 ,@cSKU
                                 ,@cStyle
                                 ,@cColor
                                 ,@cBUSR6
                                 ,@cOrderKey
                                 ,@cLOC
                                 ,@cORD_StorerKey
                                 ,@nMultiStorer
                                 ,@cNewLOC      OUTPUT
                                 ,@cNewOrderKey OUTPUT
                                 ,@cNewSKU      OUTPUT
                                 ,@cLot         OUTPUT
                                 ,@cPickSlipNo  OUTPUT

               -- (james31)
               IF ISNULL(@cNewOrderKey, '') = ''
               BEGIN
                  SET @nErrNo = 69383
                  SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'NO MORE TASK'
                  GOTO Step_9_Fail
               END

               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cNewOrderKey

               SELECT
                  @cLottable02 = Lottable02,
                  @dLottable04 = Lottable04
               FROM dbo.LotAttribute WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND SKU = @cNewSKU
                  AND LOT = @cLot

               SELECT @cSKU_Descr = SKU.DESCR,
                  @cStyle = SKU.Style,
                  @cColor = SKU.Color,
                  @cSize = SKU.Size,
                  @cColor_Descr = SKU.BUSR7
               FROM dbo.SKU SKU WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cNewSKU

               IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
               BEGIN
                  SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
                  SET @cColor = @cColor + ' '
                  SET @cSKU_Descr = ''
               END

               SELECT
                  @cExternOrderKey = ExternOrderKey,
                  @cConsigneeKey = ConsigneeKey
               FROM dbo.Orders WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND OrderKey = @cNewOrderKey

               BEGIN TRAN

               -- Insert next task to picklock
               INSERT INTO RDT.RDTPickLock
               (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
               , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
               VALUES
               (@cWaveKey, @cLoadKey, @cNewOrderKey, 'SKIP', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
               @cNewSKU, @cPutAwayZone, @cPickZone, ''
               , @cLOT, @cNewLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 69352
                  SET @cErrMsg = rdt.rdtgetmessage( 69352, @cLangCode, 'DSP') --'LockOrdersFail'
                  ROLLBACK TRAN
                  GOTO Step_9_Fail
               END
               ELSE
               BEGIN
                  COMMIT TRAN
               END

               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

               -- Cancel the current task
               BEGIN TRAN --ang02
               UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
                  Status = 'X', Descr = 'User Skipped Task !!!'
               WHERE OrderKey = @cOrderKey
                  AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                  AND SKU = @cSKU
                  AND AddWho = @cUserName
                  AND LOC = @cLOC   -- (james13)
                  AND Status = '1'

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 69353
                  SET @cErrMsg = rdt.rdtgetmessage( 69353, @cLangCode, 'DSP') --'Skip Task Fail'
                  ROLLBACK TRAN
                  GOTO Step_9_Fail
               END
               ELSE --ang02 start
               BEGIN
                     COMMIT TRAN
               END -- ang02 end

               SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cNewLOC -- ZG01
               IF ISNULL( @cLocDescr, '') = ''
                  SET @cLocDescr = @cNewLOC     -- ZG01

               -- (james26)
               SET @cLOC = @cNewLOC
               SET @cSKU = @cNewSKU
               SET @cOrderKey = @cNewOrderKey

               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
               BEGIN
                  -- If change of LOC then need to go back to confirm LOC screen
                  IF @cPrevLOC <> @cLOC
                  BEGIN
                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = ''

                     -- Go to next screen
                     SET @nScn  = 1892
                     SET @nStep = 19

                     GOTO Quit
                  END
               END

               -- If still have remaining task
               -- If OrderKey changed
               IF @cOrderKey <> @cNewOrderKey
               BEGIN
                  SET @cOrderKey = @cNewOrderKey
                  SET @cSKU = @cNewSKU

                  -- If configkey 'AutoPromptDropID' turned on, auto go back to DropID screen
                  IF @cAutoPromptDropID = '1'
                  BEGIN
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'   -- (james18)
                     BEGIN
                        -- If change of LOC then need to go back to confirm LOC screen
                        IF @cPrevLOC <> @cLOC
                        BEGIN
                           SET @nActQty = 0
                           SET @nQtyToPick = 0

                           -- Prep next screen var
                           SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                           SET @cOutField02 = ''

                           -- Go to next screen
                           SET @nScn  = 1892
                           SET @nStep = 19

                           GOTO Quit
                        END
                     END

                     IF @nFunc = 1620
                     BEGIN
                        -- Prep next screen var
                        SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                        SET @cOutField02 = @cOrderKey
                        SET @cOutField03 = @cExternOrderKey
                        SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                        SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                        SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                        SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

                        IF @nMultiStorer = 1
                           SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

                        IF @cClusterPickNike <> ''
                        BEGIN
                           IF @cClusterPickNike = '1'
                           BEGIN
                              SET @cTemp_String = ''
                              SET @cTemp_UOM = ''
                              SET @nTemp_PackQtyIndicator = ''

                              SELECT
                                 @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                                 @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                              FROM dbo.SKU SKU WITH (NOLOCK)
                              JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                              WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                                 AND SKU.SKU = @cSKU

                              SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                                 '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                           END
                           ELSE
                           BEGIN
                              IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                              BEGIN
                                 SET @cExtendedInfo2 = ''

                                 SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                                    ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                                 SET @cSQLParam =
                                    '@nMobile       INT, ' +
                                    '@nFunc         INT, ' +
                                    '@cLangCode     NVARCHAR( 3), ' +
                                    '@nStep         INT, ' +
                                    '@nInputKey     INT, ' +
                                    '@cWaveKey      NVARCHAR( 10), ' +
                                    '@cLoadKey      NVARCHAR( 10), ' +
                                    '@cOrderKey     NVARCHAR( 10), ' +
                                    '@cDropID       NVARCHAR( 20), ' +
                                    '@cStorerKey    NVARCHAR( 15), ' +
                                    '@cSKU          NVARCHAR( 20), ' +
                                    '@cLOC          NVARCHAR( 10), ' +
                                    '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                                 EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                                 SET @cOutField08 = @cExtendedInfo2
                              END
                           END
                        END
                        ELSE
                        BEGIN
                           SET @cOutField08 = @cColor_Descr
                        END

                        SET @cOutField09 = ''   -- DropID
                        SET @cOutField10 = ''
                        SET @cOutField11 = ''

                        SET @nScn  = 1876
                        SET @nStep = 7
                     END
                     ELSE
                     IF @nFunc = 1621
                     BEGIN
                        -- Prep next screen var
                        SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                        SET @cOutField02 = @cOrderKey
                        SET @cOutField03 = @cExternOrderKey
                        SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                        SET @cOutField05 = @cSKU
                        SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                        SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                        SET @cOutField08 = @cLottable02
                        SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                        SET @cOutField10 = ''   -- DropID

                        -- Go to next screen
                        SET @nScn  = 1882
                        SET @nStep = 7
                     END
                     ELSE
                     IF @nFunc = 1628
                     BEGIN
                        -- Prep next screen var
                        SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                        SET @cOutField02 = @cLoadKey
                        SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                        SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                        SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                        SET @cOutField08 = @cLottable02
                        SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                        SET @cOutField10 = ''   -- DropID

                        -- Go to next screen
                        SET @nScn  = 1887
                        SET @nStep = 7
                     END

                     -- (james30)
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
                     BEGIN
                        EXECUTE rdt.rdt_Cluster_Pick_DropID
                           @nMobile,
                           @nFunc,
                           @cStorerKey,
                           @cUserName,
                           @cFacility,
                           @cLoadKey,
                           @cPickSlipNo,
                           @cOrderKey,
                           @cDropID       OUTPUT,
                           @cSKU,
                           'R',      -- R = Retrieve
                           @cLangCode,
                           @nErrNo        OUTPUT,
                           @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

                        IF @nFunc = 1620
                        BEGIN
                           IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                              SET @cOutField09 = ''         -- DropID
                           ELSE
                              SET @cOutField09 = @cDropID   -- DropID
                        END
                        ELSE
                        BEGIN
                           IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                              SET @cOutField10 = ''         -- DropID
                           ELSE
                              SET @cOutField10 = @cDropID   -- DropID
                        END
                     END

                     SET @nActQty = 0
                     SET @nQtyToPick = 0

                     GOTO Quit
                 END
               END   -- If OrderKey changed

               SET @cOrderKey = @cNewOrderKey
               SET @cSKU = @cNewSKU

               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

               -- Get the total allocated qty for LOC + SKU + OrderKey
               SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                  AND PD.LOC = @cLOC
                  AND PD.SKU = @cSKU
                  AND PD.OrderKey = @cOrderKey
                  AND PD.Status = '0'
                  AND PD.LOT = @cLOT
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

               SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
               IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

               IF @cDefaultToAllocatedQty = '1'
               BEGIN
                  SET @cDefaultPickQty = @nTotalPickQty
               END

               SET @nQtyToPick = 0
               SET @nActQty = 0

               -- Get the total oustanding qty for orderkey + putawayzone + pickzone
               SELECT @nTTL_Qty = SUM(QTY)
               FROM RDT.RDTPickLock RPL WITH (NOLOCK)
               JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
                  AND RPL.Status < '5'
                  AND RPL.AddWho = @cUserName
                  AND RPL.PickQty <= 0
                  AND PD.Status = '0'
                  AND (( @nMultiStorer = 1 AND LA.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND LA.StorerKey = @cStorerKey))
                  AND LA.SKU = @cSKU
                  AND L.LOC = @cLOC
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
                  AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName) -- SOS# 176144

               -- Get Total Orders left on the current sku that need to pick
               SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
                  AND RPL.Status < '5'
                  AND RPL.AddWho = @cUserName
                  AND RPL.PickQty <= 0
                  AND PD.Status = '0'
                  AND (( @nMultiStorer = 1) OR ( LA.StorerKey = @cStorerKey))
                  AND LA.SKU = @cSKU
                  AND L.LOC = @cLOC
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

               -- (james14)
               IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
               BEGIN
                  SET @cOS_Qty = ''

                  IF @cLoadDefaultPickMethod = 'C'
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND LPD.LoadKey = @cLoadKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
                     FROM dbo.PickDetail PD WITH (NOLOCK)
                     JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                     WHERE PD.StorerKey = @cStorerKey
                        AND PD.Status >= '3'
                        AND LPD.LoadKey = @cLoadKey

                     SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
                  ELSE
                  BEGIN
                     -- Get the total qty picked per orders
                     SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                        AND OrderKey = @cOrderKey

                     -- Get the total qty unpick per orders
                     SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
                     FROM dbo.PickDetail WITH (NOLOCK)
                     WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
                        AND OrderKey = @cOrderKey
                        AND Status >= '3'

                     SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
                  END
               END

               IF @cClusterPickNike <> ''
               BEGIN
                  IF @cClusterPickNike = '1'
                  BEGIN
                     SET @cTemp_String = ''
                     SET @cTemp_UOM = ''
                     SET @nTemp_PackQtyIndicator = ''

                     SELECT
                        @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                        @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                     FROM dbo.SKU SKU WITH (NOLOCK)
                     JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                     WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                        AND SKU.SKU = @cSKU

                     SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                        '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                  END
                  ELSE
                  BEGIN
                     IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo2 = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                        SET @cTemp_String = @cExtendedInfo2
                     END
                  END
               END
               -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
               BEGIN
                  SET @cPackCfg = ''

                  SELECT @fPack_Qty = PACK.QTY,
                         @fPack_InnerPack = PACK.InnerPack,
                         @fPack_CaseCnt = PACK.CaseCnt
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                     AND SKU.SKU = @cSKU

                  SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                                  RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                                  RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
               END

               SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
               IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
                  SET @cScanLOT02 = '0'

               IF @cPrefUOM <> '6'
               BEGIN
                  SELECT TOP 1
                     @nPrefUOM_Div = CAST( IsNULL(
                        CASE @cPrefUOM
                           WHEN '2' THEN Pack.CaseCNT
                           WHEN '3' THEN Pack.InnerPack
                           WHEN '6' THEN Pack.QTY
                           WHEN '1' THEN Pack.Pallet
                           WHEN '4' THEN Pack.OtherUnit1
                           WHEN '5' THEN Pack.OtherUnit2
                        END, 1) AS INT)
                  FROM dbo.SKU SKU (NOLOCK)
                     INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
                  WHERE StorerKey = @cStorerKey
                     AND SKU = @cSKU

                  -- Convert to prefer UOM QTY to be picked
                  SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

                  -- Convert to prefer UOM QTY picked
                  SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
                  SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

						--SOS334125 Start
                  SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                            '/' +
                                            RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                            RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
						--SOS334125 End


                  SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
                  SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
               END

               -- Extended info
               IF @cExtendedInfoSP <> ''
               BEGIN
                  IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
                  END
               END

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cDropID
                  SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField04 = ''
                  SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
                  SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                                     THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

                  EXEC rdt.rdtSetFocusField @nMobile, 4

                  SET @nScn  = 1877
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cSKU
                  SET @cOutField03 = ''
                  SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cOrderKey
                  SET @cOutField10 = @cExternOrderKey
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1883
                  SET @nStep = 8
               END
               ELSE
               IF @nFunc = 1628  -- (james07)
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField03 = ''
                  SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
                  SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
                  SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
                  SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                          THEN @cOS_Qty
                                          WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                     ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
                  SET @cOutField09 = @cLoadKey
                  SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
                  SET @cOutField11 = @nTTL_Ord

                  EXEC rdt.rdtSetFocusField @nMobile, 3

                  -- Go to next screen
                  SET @nScn  = 1888
                  SET @nStep = 8
               END

               IF @cPrefUOM <> '6'
                  SET @cOutField12 = @cPreferQty2Display
               ELSE
                  SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

               SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                                  THEN '' ELSE @cDefaultPickQty END -- Qty to pick
               SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
               SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                       CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                                  ELSE 'QTY: ' END

               SET @cFieldAttr01 = ''
               SET @cFieldAttr02 = ''
               SET @cFieldAttr03 = ''
               SET @cFieldAttr04 = ''
               SET @cFieldAttr05 = ''
               SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
               SET @cFieldAttr07 = ''
               SET @cFieldAttr08 = ''
               SET @cFieldAttr09 = ''
               SET @cFieldAttr10 = ''
               SET @cFieldAttr11 = ''
               SET @cFieldAttr12 = ''
               SET @cFieldAttr13 = ''
               SET @cFieldAttr14 = ''
               SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END
            END
         END
      END      -- IF @cOption = '3'

      SET @cFieldAttr01 = ''
      SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

      -- If config turned on, not allow to change Qty To Pick
      IF @cClusterPickLockQtyToPick = '1'
      BEGIN
         SET @cFieldAttr13 = 'O'
         SET @cInField13 = @cDefaultPickQty
      END

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- (james14)
      IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
      BEGIN
         SET @cOS_Qty = ''

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND LPD.LoadKey = @cLoadKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND PD.Status >= '3'
               AND LPD.LoadKey = @cLoadKey

            SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
         ELSE
         BEGIN
            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey
               AND Status >= '3'

            SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
      END

      IF @cClusterPickNike <> ''
      BEGIN
         IF @cClusterPickNike = '1'
         BEGIN
            SET @cTemp_String = ''
            SET @cTemp_UOM = ''
            SET @nTemp_PackQtyIndicator = ''

            SELECT
               @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
               @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                               '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
         END
         ELSE
         BEGIN
            IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
            BEGIN
               SET @cExtendedInfo2 = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

               SET @cTemp_String = @cExtendedInfo2
            END
         END
      END
      -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
      BEGIN
         SET @cPackCfg = ''

         SELECT @fPack_Qty = PACK.QTY,
                @fPack_InnerPack = PACK.InnerPack,
                @fPack_CaseCnt = PACK.CaseCnt
         FROM dbo.SKU SKU WITH (NOLOCK)
         JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
         WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
            AND SKU.SKU = @cSKU

         SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                         RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                         RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
      END

      SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
      IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
         SET @cScanLOT02 = '0'

      IF @cPrefUOM <> '6'
      BEGIN
         SELECT TOP 1
            @nPrefUOM_Div = CAST( IsNULL(
               CASE @cPrefUOM
                  WHEN '2' THEN Pack.CaseCNT
                  WHEN '3' THEN Pack.InnerPack
                  WHEN '6' THEN Pack.QTY
                  WHEN '1' THEN Pack.Pallet
                  WHEN '4' THEN Pack.OtherUnit1
                  WHEN '5' THEN Pack.OtherUnit2
               END, 1) AS INT)
         FROM dbo.SKU SKU (NOLOCK)
            INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
         WHERE StorerKey = @cStorerKey
            AND SKU = @cSKU

         -- Convert to prefer UOM QTY to be picked
         SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

         -- Convert to prefer UOM QTY picked
         SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

			--SOS334125 Start
         SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                   '/' +
                                   RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
			--SOS334125 End

         SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
         SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
      END

      -- Extended info
      IF @cExtendedInfoSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
         BEGIN
            SET @cExtendedInfo = ''

            SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

            SET @cSQLParam =
               '@nMobile       INT, ' +
               '@nFunc         INT, ' +
               '@cLangCode     NVARCHAR( 3), ' +
               '@nStep         INT, ' +
               '@nInputKey     INT, ' +
               '@cWaveKey      NVARCHAR( 10), ' +
               '@cLoadKey      NVARCHAR( 10), ' +
               '@cOrderKey     NVARCHAR( 10), ' +
               '@cDropID       NVARCHAR( 20), ' +
               '@cStorerKey    NVARCHAR( 15), ' +
               '@cSKU          NVARCHAR( 20), ' +
               '@cLOC          NVARCHAR( 10), ' +
               '@cExtendedInfo NVARCHAR( 20) OUTPUT '

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
         END
      END

      IF @nFunc = 1620
      BEGIN
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cDropID
         SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField04 = ''
         SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
         SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                            THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

         EXEC rdt.rdtSetFocusField @nMobile, 4

         -- Go to next screen
         SET @nScn  = 1877
         SET @nStep = 8
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cSKU
         SET @cOutField03 = ''
         SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END  -- (james32)
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = @nTTL_Ord

         EXEC rdt.rdtSetFocusField @nMobile, 3

         -- Go to next screen
         SET @nScn  = 1883
         SET @nStep = 8
      END
      ELSE
      IF @nFunc = 1628  -- (james07)
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField03 = ''
         SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
         SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
         SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cLoadKey
         SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField11 = @nTTL_Ord

         EXEC rdt.rdtSetFocusField @nMobile, 3

         -- Go to next screen
         SET @nScn  = 1888
         SET @nStep = 8
      END

      IF @cPrefUOM <> '6'
         SET @cOutField12 = @cPreferQty2Display
      ELSE
         SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

      SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                         THEN '' ELSE @cDefaultPickQty END -- Qty to pick
      SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
      SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                              CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                         ELSE 'QTY: ' END
   END
   SET @cFieldAttr01 = ''
   SET @cFieldAttr02 = ''
   SET @cFieldAttr03 = ''
   SET @cFieldAttr04 = ''
   SET @cFieldAttr05 = ''
   SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
   SET @cFieldAttr07 = ''
   SET @cFieldAttr08 = ''
   SET @cFieldAttr09 = ''
   SET @cFieldAttr10 = ''
   SET @cFieldAttr11 = ''
   SET @cFieldAttr12 = ''
   SET @cFieldAttr13 = ''
   SET @cFieldAttr14 = ''
   SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

   -- If config turned on, not allow to change Qty To Pick
   IF @cClusterPickLockQtyToPick = '1'
   BEGIN
      SET @cFieldAttr13 = 'O'
      SET @cInField13 = @cDefaultPickQty
   END

   GOTO Quit

   Step_9_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 10. Screen = 1879
   Picking Completed
********************************************************************************/
Step_10:
BEGIN
   IF @nInputKey IN (0, 1)-- ESC/ENTER
   BEGIN
      BEGIN TRAN

      SET @c_TraceName = 'rdtfnc_Cluster_Pick_Step_10'
      SET @d_StartTime = getdate()  -- (james_tune)
      SET @d_step1 = GETDATE()   -- (james_tune)

      -- Scan Out pickslip
      IF ISNULL(@cWaveKey, '') <> ''
      BEGIN
         DECLARE curPickingInfo CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
         SELECT DISTINCT PH.PickHeaderKey, 'W' -- Wave PS (Vicky07)
         FROM RDT.RDTPickLock RPL WITH (NOLOCK)
         JOIN dbo.Orders O WITH (NOLOCK, INDEX(PKOrders) ) ON (RPL.OrderKey = O.OrderKey) -- (Vicky03)
         JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey) -- SOS# 176144
         JOIN dbo.PickHeader PH WITH (NOLOCK) ON (O.UserDefine09 = PH.WaveKey AND O.OrderKey = PH.OrderKey)
         WHERE O.UserDefine09 = @cWaveKey
            AND RPL.Status = '9'
            AND RPL.StorerKey = @cStorerKey    -- tlting03
            AND RPL.AddWho = @cUserName
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( RPL.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( RPL.PickZone = @cPickZone))
            AND RPL.Mobile = @nMobile -- (Vicky07)
         --ORDER BY PH.PickHeaderKey
      END
      ELSE
      BEGIN
         -- Check if it is Conso pickslip (james06)
         IF ISNULL(@cLoadKey, '') <> ''												--IN00416131
         --IF EXISTS ( SELECT 1 FROM dbo.PickHeader WITH (NOLOCK)
         --            WHERE ExternOrderKey = @cLoadKey
         --            AND ISNULL(RTRIM(Orderkey), '') = '') -- SOS# 176144, IN00416131
         BEGIN
            DECLARE curPickingInfo CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT DISTINCT PH.PickHeaderKey, 'C' -- Conso PS (Vicky07)
            FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN dbo.Orders O WITH (NOLOCK, INDEX(PKOrders) ) ON (RPL.OrderKey = O.OrderKey) -- (Vicky03)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey) -- SOS# 176144
            JOIN dbo.LoadPlanDetail lpd WITH (NOLOCK) ON (lpd.OrderKey = O.OrderKey)
            JOIN dbo.PickHeader PH WITH (NOLOCK) ON (lpd.LoadKey = PH.ExternOrderKey)
            WHERE (( @nMultiStorer = 1) OR ( O.StorerKey = @cStorerKey))
               AND lpd.LoadKey = @cLoadKey         --tlting03
               AND RPL.Status = '9'
               AND RPL.StorerKey = @cStorerKey     -- tlting03
               AND RPL.AddWho = @cUserName
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( RPL.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( RPL.PickZone = @cPickZone))
               AND RPL.Mobile = @nMobile -- (Vicky07)
            --ORDER BY PH.PickHeaderKey
         END
         ELSE
         BEGIN
            DECLARE curPickingInfo CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT DISTINCT PH.PickHeaderKey, 'D' -- Discrete PS (Vicky07)
            FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN dbo.Orders O WITH (NOLOCK, INDEX(PKOrders) ) ON (RPL.OrderKey = O.OrderKey) -- (Vicky03)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey) -- SOS# 176144
            JOIN dbo.LoadPlanDetail lpd WITH (NOLOCK) ON (lpd.OrderKey = O.OrderKey)
            JOIN dbo.PickHeader PH WITH (NOLOCK) ON (lpd.LoadKey = PH.ExternOrderKey AND lpd.OrderKey = PH.OrderKey)
            WHERE (( @nMultiStorer = 1) OR ( O.StorerKey = @cStorerKey))
               AND (( ISNULL(@cLoadKey, '') = '') OR ( lpd.LoadKey = @cLoadKey))
               AND RPL.Status = '9'
               AND RPL.StorerKey = @cStorerKey   -- tlting03
               AND RPL.AddWho = @cUserName
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( RPL.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( RPL.PickZone = @cPickZone))
               AND RPL.Mobile = @nMobile -- (Vicky07)
            --ORDER BY PH.PickHeaderKey
         END
      END

      SET @d_step1 = GETDATE() - @d_step1 -- (james_tune)
      SET @d_step2 = GETDATE()   -- (james_tune)

      OPEN curPickingInfo
      FETCH NEXT FROM curPickingInfo INTO @cPickSlipNo, @cPSFlag -- (Vicky07)
      WHILE @@FETCH_STATUS <> -1
      BEGIN
         -- (Vicky07) - Start
         IF @cPSFlag = 'W'
         BEGIN
            IF NOT EXISTS (SELECT 1 From dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.ORDERDETAIL ORDDET WITH (NOLOCK) ON (PD.Orderkey = ORDDET.Orderkey AND PD.OrderLineNumber = ORDDET.OrderLineNumber)
            JOIN dbo.ORDERS ORD WITH (NOLOCK) ON (ORD.Orderkey = ORDDET.Orderkey)
            JOIN dbo.PickHeader PH WITH (NOLOCK) ON (ORD.UserDefine09 = PH.WaveKey AND ORD.OrderKey = PH.OrderKey)
            WHERE PH.PickHeaderkey = @cPickSlipNo
            AND   PD.Status < '5')
            BEGIN
               IF EXISTS (SELECT 1 FROM dbo.PickingInfo WITH (NOLOCK)
                  WHERE PickSlipNo = @cPickSlipNo AND ScanOutDate IS NULL)
               BEGIN
                  UPDATE dbo.PickingInfo WITH (ROWLOCK)
                     SET SCANOUTDATE = GETDATE(),
                         EditWho = @cUserName--,
                         --TrafficCop = 'X'
                  WHERE PickSlipNo = @cPickSlipNo
                  AND   SCANOUTDATE IS NULL
               END
            END
         END
         ELSE IF @cPSFlag = 'C'
         BEGIN
            IF NOT EXISTS (SELECT 1 From dbo.PickDetail PD WITH (NOLOCK)
                            JOIN dbo.ORDERDETAIL ORDDET WITH (NOLOCK) ON (PD.Orderkey = ORDDET.Orderkey AND PD.OrderLineNumber = ORDDET.OrderLineNumber)
                            JOIN dbo.ORDERS ORD WITH (NOLOCK) ON (ORD.Orderkey = ORDDET.Orderkey)
                            JOIN dbo.LOADPLANDETAIL LPD WITH (NOLOCK) ON (LPD.Orderkey = ORD.Orderkey)
                            JOIN dbo.PickHeader PH WITH (NOLOCK) ON (LPD.Loadkey = PH.ExternOrderKey)
                           WHERE PH.PickHeaderkey = @cPickSlipNo
                           AND   PD.Status < '5')
            BEGIN
               IF EXISTS (SELECT 1 FROM dbo.PickingInfo WITH (NOLOCK)
                  WHERE PickSlipNo = @cPickSlipNo AND ScanOutDate IS NULL)
               BEGIN
                  UPDATE dbo.PickingInfo WITH (ROWLOCK)
                     SET SCANOUTDATE = GETDATE(),
                         EditWho = @cUserName--,
                         --TrafficCop = 'X'
                  WHERE PickSlipNo = @cPickSlipNo
                  AND   SCANOUTDATE IS NULL
               END
            END
         END
         ELSE IF @cPSFlag = 'D'
         BEGIN
            IF NOT EXISTS (SELECT 1 From dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.ORDERDETAIL ORDDET WITH (NOLOCK) ON (PD.Orderkey = ORDDET.Orderkey AND PD.OrderLineNumber = ORDDET.OrderLineNumber)
               JOIN dbo.ORDERS ORD WITH (NOLOCK) ON (ORD.Orderkey = ORDDET.Orderkey)
               JOIN dbo.LOADPLANDETAIL LPD WITH (NOLOCK) ON (LPD.Orderkey = ORD.Orderkey)
               JOIN dbo.PickHeader PH WITH (NOLOCK) ON (LPD.Loadkey = PH.ExternOrderKey AND LPD.Orderkey = PH.Orderkey)
               WHERE PH.PickHeaderkey = @cPickSlipNo
               AND   PD.Status < '5')
            BEGIN
               IF EXISTS (SELECT 1 FROM dbo.PickingInfo WITH (NOLOCK)
                  WHERE PickSlipNo = @cPickSlipNo AND ScanOutDate IS NULL)
               BEGIN
                  UPDATE dbo.PickingInfo WITH (ROWLOCK)
                     SET SCANOUTDATE = GETDATE(),
                         EditWho = @cUserName--,
                         --TrafficCop = 'X'
                  WHERE PickSlipNo = @cPickSlipNo
                  AND   SCANOUTDATE IS NULL
               END
            END
         END
         -- (Vicky07) - End

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65948
            SET @cErrMsg = rdt.rdtgetmessage( 65948, @cLangCode, 'DSP') --'Scan Out Fail'
            ROLLBACK TRAN
            GOTO Step_10_Fail
         END

         SET @d_step2 = GETDATE() - @d_step2 -- (james_tune)
         SET @d_step3 = GETDATE()   -- (james_tune)

         -- (james10)
         -- Check picked qty = packed qty then can confirm
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickInsPackDt', @cStorerKey) = '1'
         BEGIN
            SELECT @cPOrderKey = OrderKey
            FROM dbo.PackHeader WITH (NOLOCK)
            WHERE PickSlipNo = @cPickSlipNo

            SELECT @nSumPackQTY = ISNULL(SUM(QTY)  , 0)
            FROM dbo.PackDetail WITH (NOLOCK)
            WHERE PickSlipNo = @cPickSlipNo

            -- Start (james37)
            IF @cPSFlag = 'D'
            BEGIN
               SELECT @nSumPickQTY = ISNULL(SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE Orderkey = @cPOrderKey
               AND   [Status] = '5'
            END

            IF @cPSFlag = 'C'
            BEGIN
               -- (james68)
               SELECT @cPOrderKey = OrderKey
               FROM dbo.PickHeader WITH (NOLOCK)
               WHERE PickHeaderKey = @cPickSlipNo

               IF ISNULL( @cPOrderKey, '') = ''
                  SELECT @nSumPickQTY = ISNULL( SUM( PD.QTY), 0)
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON (PD.OrderKey = LPD.OrderKey)
                  JOIN dbo.PickHeader PH WITH (NOLOCK) ON (LPD.LoadKey = PH.ExternOrderKey)
                  WHERE PH.PickHeaderKey = @cPickSlipNo
                  AND   PD.Status = '5'
               ELSE
                  SELECT @nSumPickQTY = ISNULL(SUM(QTY), 0)
                  FROM dbo.PickDetail WITH (NOLOCK)
                  WHERE Orderkey = @cPOrderKey
                  AND   [Status] = '5'
            END

            IF @cPSFlag = 'W'
            BEGIN
               SELECT @nSumPickQTY = ISNULL( SUM( QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.Orderkey = O.Orderkey)
               JOIN dbo.PickHeader PH WITH (NOLOCK) ON (O.UserDefine09 = PH.WaveKey AND O.OrderKey = PH.OrderKey)
               WHERE PH.PickHeaderKey = @cPickSlipNo
               AND   PD.Status = '5'
            END
            -- End(james37)

            SET @d_step4 = GETDATE()   -- (james_tune)

            -- Only when config 'AUTOPACKCONFIRM' is turned on and pick and pack match then scan out
            IF (@nSumPackQTY = @nSumPickQTY)
            BEGIN
               SET @cAutoPackConfirm = rdt.RDTGetConfig( @nFunc, 'AutoPackConfirm', @cStorerKey)

               IF EXISTS( SELECT 1 FROM dbo.sysobjects WHERE name = @cAutoPackConfirm AND type = 'P')
               BEGIN
                  INSERT INTO @tAutoPackCfm (Variable, Value) VALUES
                  ('@cWaveKey',       @cWaveKey),
                  ('@cLoadKey',       @cLoadKey),
                  ('@cOrderKey',      @cOrderKey)

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cAutoPackConfirm) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerKey, @cPickSlipNo, @tAutoPackCfm, ' +
                     ' @nErrNo OUTPUT, @cErrMsg OUTPUT '

                  SET @cSQLParam =
                     ' @nMobile        INT,           ' +
                     ' @nFunc          INT,           ' +
                     ' @cLangCode      NVARCHAR( 3),  ' +
                     ' @nStep          INT,           ' +
                     ' @nInputKey      INT,           ' +
                     ' @cFacility      NVARCHAR( 5),  ' +
                     ' @cStorerKey     NVARCHAR( 15), ' +
                     ' @cPickSlipNo    NVARCHAR( 10), ' +
                     ' @tAutoPackCfm   VariableTable READONLY, ' +
                     ' @nErrNo         INT           OUTPUT, ' +
                     ' @cErrMsg        NVARCHAR( 20) OUTPUT  '
                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerKey, @cPickSlipNo, @tAutoPackCfm,
                     @nErrNo OUTPUT, @cErrMsg OUTPUT

                  IF @nErrNo <> 0
                  BEGIN
                     ROLLBACK TRAN
                     GOTO Step_10_Fail
                  END
               END
               ELSE
               BEGIN
                  IF @cAutoPackConfirm = '1'
                  BEGIN
                     -- Start (james37)
                     IF @cPSFlag = 'D'
                     BEGIN
                        IF NOT EXISTS (SELECT 1 FROM dbo.PickDetail WITH (NOLOCK)
                                   WHERE Orderkey = @cPOrderKey
                                   AND   [Status] < '5')
                        BEGIN
                           UPDATE dbo.PackHeader WITH (ROWLOCK) SET
                              STATUS = '9'
                           WHERE PickSlipNo = @cPickSlipNo
                              AND STATUS = '0'

                           IF @@ERROR <> 0
                           BEGIN
                              SET @nErrNo = 69348
                              SET @cErrMsg = rdt.rdtgetmessage( 69348, @cLangCode, 'DSP') --'ConfPackFail'
                              ROLLBACK TRAN
                              GOTO Step_10_Fail
                           END
                        END
                     END

                     IF @cPSFlag = 'C'
                     BEGIN
                        IF NOT EXISTS ( SELECT 1 FROM dbo.PickDetail PD WITH (NOLOCK)
                                        JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON (PD.OrderKey = LPD.OrderKey)
                                        JOIN dbo.PickHeader PH WITH (NOLOCK) ON (LPD.LoadKey = PH.ExternOrderKey)
                                        WHERE PH.PickHeaderKey = @cPickSlipNo
                                        AND PD.Status < '5')
                        BEGIN
                           UPDATE dbo.PackHeader WITH (ROWLOCK) SET
                              STATUS = '9'
                           WHERE PickSlipNo = @cPickSlipNo
                              AND STATUS = '0'

                           IF @@ERROR <> 0
                           BEGIN
                              SET @nErrNo = 69348
                              SET @cErrMsg = rdt.rdtgetmessage( 69348, @cLangCode, 'DSP') --'ConfPackFail'
                              ROLLBACK TRAN
                              GOTO Step_10_Fail
                           END
                        END
                     END

                     IF @cPSFlag = 'W'
                     BEGIN
                        IF NOT EXISTS ( SELECT 1 FROM dbo.PickDetail PD WITH (NOLOCK)
                                        JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                                        JOIN dbo.Orders O WITH (NOLOCK) ON (OD.Orderkey = O.Orderkey)
                                        JOIN dbo.PickHeader PH WITH (NOLOCK) ON (O.UserDefine09 = PH.WaveKey AND O.OrderKey = PH.OrderKey)
                                        WHERE PH.PickHeaderKey = @cPickSlipNo
                                        AND   PD.Status < '5')
                        BEGIN
                           UPDATE dbo.PackHeader WITH (ROWLOCK) SET
                              STATUS = '9'
                           WHERE PickSlipNo = @cPickSlipNo
                              AND STATUS = '0'

                           IF @@ERROR <> 0
                           BEGIN
                              SET @nErrNo = 69348
                              SET @cErrMsg = rdt.rdtgetmessage( 69348, @cLangCode, 'DSP') --'ConfPackFail'
                              ROLLBACK TRAN
                              GOTO Step_10_Fail
                           END
                        END
                     END                -- Start (james37)
                  END
               END

               -- (james71)
               IF EXISTS ( SELECT 1 FROM dbo.PackHeader WITH (NOLOCK) WHERE PickSlipNo = @cPickSlipNo AND [Status] = '9')
                  AND @cAssignPackLabelToOrdCfg = '1'
               BEGIN
                  -- Get storer config
                  DECLARE @c_authority NVARCHAR(30)

                  EXECUTE nspGetRight
                     NULL,        -- facility
                     @cStorerKey, -- Storerkey
                     NULL,        -- Sku
                     'AssignPackLabelToOrdCfg',
                     @b_success     OUTPUT,
                     @c_authority   OUTPUT,
                     @n_err         OUTPUT,
                     @c_errmsg      OUTPUT
                  IF @b_success <> 1
                  BEGIN
                     SET @nErrNo = 104004
                     SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode,'DSP') -- GetRight Fail
                     ROLLBACK TRAN
                     GOTO Step_10_Fail
                  END
                  ELSE IF @c_authority = '1'
                  BEGIN
                     -- Copy PackDetail.LabelNo to PackDetail.DropID
                     EXEC isp_AssignPackLabelToOrderByLoad
                        @cPickSlipNo,
                        @b_success  OUTPUT,
                        @n_err      OUTPUT,
                        @c_errmsg   OUTPUT
                     IF @b_success <> 1 OR @n_err <> 0
                     BEGIN
                        SET @nErrNo = 104005
                        SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode,'DSP') -- Lbl2DropIDFail
                        ROLLBACK TRAN
                        GOTO Step_10_Fail
                     END
                  END
               END
            END

            -- Close the dropid if picked = packed (james30)
            IF (@nSumPackQTY = @nSumPickQTY) AND rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
            BEGIN
               SET @cTDropID = ''
               SELECT TOP 1 @cTDropID = D.DropID
               FROM dbo.DROPID D (NOLOCK)
               JOIN dbo.DROPIDDETAIL DD (NOLOCK) ON D.DROPID = DD.DROPID
               JOIN dbo.PickDetail PD WITH (NOLOCK) ON DD.ChildID = PD.OrderKey
               WHERE PD.OrderKey = @cPOrderKey
               AND   D.Status = '0'

               EXECUTE rdt.rdt_Cluster_Pick_DropID
                  @nMobile,
                  @nFunc,
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cLoadKey,
                  @cPickSlipNo,
                  @cOrderKey,
                  @cTDropID      OUTPUT,
                  @cSKU,
                  'U',      -- U = Update
                  @cLangCode,
                  @nErrNo        OUTPUT,
                  @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max
            END
            set @nErrNo = 0
            set @cErrMsg = ''
            SET @d_step4 = GETDATE() - @d_step4 -- (james_tune)
         END
         ELSE  -- Not auto packing
         BEGIN
            -- Close the dropid if picked = packed (james30)
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
            BEGIN
               --UWP-15502 - Invalid Drop ID Error (jackc)
               SELECT @cPOrderKey = OrderKey
               FROM dbo.PICKHEADER WITH (NOLOCK)
               WHERE PickHeaderKey = @cPickSlipNo

               DECLARE @cTDropStatus NVARCHAR( 10) = ''
               SET @cTDropID = ''
               SET @cTDropStatus = ''

               SELECT TOP 1 @cTDropID = D.DropID, @cTDropStatus = D.[Status]
               FROM dbo.DROPID D (NOLOCK)
               JOIN dbo.DROPIDDETAIL DD (NOLOCK) ON D.DROPID = DD.DROPID
               JOIN dbo.PickDetail PD WITH (NOLOCK) ON DD.ChildID = PD.OrderKey
               WHERE PD.OrderKey = @cPOrderKey
               ORDER BY 2 DESC

               IF @cTDropID <> ''   --UWP-15502 mulitple orders in one dropid (jackc)
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_DropID
                     @nMobile,
                     @nFunc,
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cLoadKey,
                     @cPickSlipNo,
                     @cOrderKey,
                     @cTDropID      OUTPUT,
                     @cSKU,
                     'U',      -- U = Update
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max
               END
            END
         END
         FETCH NEXT FROM curPickingInfo INTO @cPickSlipNo, @cPSFlag -- (Vicky07)
      END
      CLOSE curPickingInfo
      DEALLOCATE curPickingInfo

      SET @d_step3 = GETDATE() - @d_step3 -- (james_tune)
      --SET @d_step5 = GETDATE()   -- (james_tune)

      -- (james72)
      IF @cExtendedUpdateSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedUpdateSP AND type = 'P')
         BEGIN
            SET @nErrNo = 0
            SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedUpdateSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
               ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

            SET @cSQLParms =
               '@nMobile                   INT,           ' +
               '@nFunc                     INT,           ' +
               '@cLangCode                 NVARCHAR( 3),  ' +
               '@nStep                     INT,           ' +
               '@nInputKey                 INT,           ' +
               '@cStorerkey                NVARCHAR( 15), ' +
               '@cWaveKey                  NVARCHAR( 10), ' +
               '@cLoadKey                  NVARCHAR( 10), ' +
               '@cOrderKey                 NVARCHAR( 10), ' +
               '@cLoc                      NVARCHAR( 10), ' +
               '@cDropID                   NVARCHAR( 20), ' +
               '@cSKU                      NVARCHAR( 20), ' +
               '@nQty                      INT, '           +
               '@nErrNo                    INT           OUTPUT,  ' +
               '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

            EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                  @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

            IF @nErrNo <> 0
               GOTO Step_10_Fail
         END
      END

      COMMIT TRAN

      SET @d_StartTime = getdate()  -- (james_tune)

      SET @d_step1 = GETDATE()   -- (james_tune)

      IF @nMultiStorer = 1 AND ISNULL(@cPOrderKey, '') <> ''
         SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

      -- Decide where to go
      --1. Check if exists other pickzone within the same orders
      IF EXISTS (SELECT 1 FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         WHERE  PD.Status = '0'
            AND PD.OrderKey = @cOrderKey
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND L.Facility = @cFacility
            AND RPL.AddWho = @cUserName
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM)))
      BEGIN
         SET @c_Col4 = '10.2.1'
         SET @d_step1 = GETDATE() - @d_step1 -- (james_tune)

         SET @d_step2 = GETDATE()   -- (james_tune)

         -- check discrete first    (james23)
         SELECT TOP 1 @cPickSlipNo = PickHeaderKey
         FROM dbo.PickHeader PH WITH (NOLOCK)
         WHERE PH.OrderKey = @cOrderKey
            AND PH.Status = '0'

         -- not discrete pick, look in wave
         IF ISNULL(@cPickSlipNo, '') = ''
         BEGIN
            IF ISNULL(@cWaveKey, '') <> ''
               SELECT TOP 1 @cPickSlipNo = PickHeaderKey
               FROM dbo.PickHeader PH WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK) ON (PH.WaveKey = O.UserDefine09 AND PH.OrderKey = O.OrderKey)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey    -- (james09)
               WHERE  O.OrderKey = @cOrderKey
                  AND PH.Status = '0'
                  AND O.UserDefine09 = @cWaveKey
            ELSE
               SELECT TOP 1 @cPickSlipNo = PickHeaderKey
               FROM dbo.PickHeader PH WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK) ON (PH.WaveKey = O.UserDefine09 AND PH.OrderKey = O.OrderKey)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey    -- (james09)
               WHERE  O.OrderKey = @cOrderKey
                  AND PH.Status = '0'
         END

         -- If not wave plan, look in loadplan
         IF ISNULL(@cPickSlipNo, '') = ''
         BEGIN
            IF ISNULL(@cLoadKey, '') <> ''
               SELECT TOP 1 @cPickSlipNo = PickHeaderKey
               FROM dbo.PickHeader PH WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK) ON (PH.ExternOrderKey = O.LoadKey  AND PH.ExternOrderKey <> '')
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey     -- (james09)
               WHERE  O.OrderKey = @cOrderKey
                  AND PH.Status = '0'
                  AND O.LoadKey = @cLoadKey
            ELSE
               SELECT TOP 1 @cPickSlipNo = PickHeaderKey
               FROM dbo.PickHeader PH WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK) ON (PH.ExternOrderKey = O.LoadKey  AND PH.ExternOrderKey <> '')
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON O.OrderKey = OD.OrderKey     -- (james09)
               WHERE  O.OrderKey = @cOrderKey
                  AND PH.Status = '0'
         END

         SET @d_step2 = GETDATE() - @d_step2 -- (james_tune)

         SET @d_step3 = GETDATE() - @d_step3 -- (james_tune)

         SET @d_step4 = GETDATE()   -- (james_tune)

         INSERT INTO RDT.RDTPickLock
         (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
         PutAwayZone, PickZone, PickDetailKey
         , LOT, LOC, Status, AddWho, AddDate, PickSlipNo, PickQty, Mobile)
         VALUES
         (@cWaveKey, @cLoadKey, @cOrderKey, '***', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
         @cPutawayzone, '', ''
         , '', '', '1', @cUserName, GETDATE(), @cPickSlipNo, 0, @nMobile)

         SET @d_step4 = GETDATE() - @d_step4 -- (james_tune)

         -- Go to PickZone screen, if there still have other pickzone to pick
         SET @nScn  = 1874
         SET @nStep = 5

         SET @cOutField01 = '' --PickZone

--         GOTO Quit
      END
      ELSE
      BEGIN
         SET @c_Col4 = '10.2.2'

         SET @d_step1 = GETDATE() - @d_step1 -- (james_tune)

         SET @d_step2 = GETDATE()   -- (james_tune)
         --2. Check if others orders got the task to do or not within same putawayzone
         IF EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            WHERE RPL.Status = '1'
               AND RPL.AddWho = @cUserName
               AND PD.Status = '0'
               AND PD.StorerKey = @cStorerKey
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND L.Facility = @cFacility
               AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM)))
         BEGIN
            SET @d_step2 = GETDATE() - @d_step2 -- (james_tune)

            -- Go to PickZone screen, if there still have other pickzone to pick
            SET @nScn  = 1874
            SET @nStep = 5

            SET @cOutField01 = '' --PickZone

            --GOTO Quit
         END
         ELSE
         BEGIN
            -- tlting  deadlock tune
            UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
               PickDetailKey = ''
            WHERE ADDWHO = @cUserName
            AND   ISNULL( PickDetailKey, '') <> ''
            AND   Status < '9'

            -- (james34)
            IF rdt.RDTGetConfig( @nFunc, 'ShowPickCfmInNewScn', @cStorerKey) = 1
            BEGIN
               SET @nErrNo = 0
               SET @cErrMsg1 = 'PICKING COMPLETED.'
               EXEC rdt.rdtInsertMsgQueue @nMobile, @nErrNo OUTPUT, @cErrMsg OUTPUT, @cErrMsg1
               IF @nErrNo = 1
               BEGIN
                  SET @cErrMsg1 = ''
               END
            END

            -- Go to WaveKey screen, if no other pickzone to pick
            SET @nScn  = 1870
            SET @nStep = 1

            SET @cOutField01 = '' --WaveKey

            --GOTO Quit
         END
      END
   END

   DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
   SELECT ROWREF
   FROM RDT.RDTPickLock WITH (NOLOCK)
   WHERE StorerKey = @cStorerKey
      AND ADDWho = @cUserName
      AND Status = 'X'
   OPEN CUR_DEL
   FETCH NEXT FROM CUR_DEL INTO @nRowRef
   WHILE @@FETCH_STATUS <> -1
   BEGIN
      DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE ROWREF = @nRowRef
      FETCH NEXT FROM CUR_DEL INTO @nRowRef
   END
   CLOSE CUR_DEL
   DEALLOCATE CUR_DEL

   GOTO Quit

   Step_10_Fail:
   BEGIN
      GOTO Quit
   END

END
GOTO Quit

/********************************************************************************
Step 11. Screen = 1880
   Exit Picking     (display)
********************************************************************************/
Step_11:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cOption = @cInField01

      --if input is not either '1' or '2'
      IF @cOption NOT IN ('1', '2')
      BEGIN
         SET @nErrNo = 65949
         SET @cErrMsg = rdt.rdtgetmessage( 65949, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_11_Fail
      END

      IF @cOption = '1'
      BEGIN
      -- If there is scanned but not yet confirmed qty, goto screen 12
      IF EXISTS ( SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
                  AND AddWho = @cUserName
                  AND Status = '1'
                  AND PickQty > 0
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone)))
      BEGIN
         -- (jame18)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmSkipSKU', @cStorerKey) = 1
         BEGIN
            SET @cOutField02 = '3 - KEEP SCANNED SKU'
         END

         SET @nScn  = 1881
         SET @nStep = 12

         SET @cOutField01 = '' -- Option
         GOTO Quit
      END
      ELSE
      BEGIN
         -- No scanned qty
         SET @nTranCount = @@TRANCOUNT

         BEGIN TRAN
         SAVE TRAN Step11_Update

         -- Update Picked to Confirm Picked
         SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND AddWho = @cUserName
            AND Status = '5'
         OPEN @curUpdRPL
         FETCH NEXT FROM @curUpdRPL INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            UPDATE RDT.RDTPickLock with (ROWLOCK) SET
               Status = '9'   -- Confirm Picked
            WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               ROLLBACK TRAN Step11_Update
               WHILE @@TRANCOUNT > @nTranCount
                  COMMIT TRAN

               SET @nErrNo = 65950
               SET @cErrMsg = rdt.rdtgetmessage( 65950, @cLangCode, 'DSP') --'UPDPKLockFail'
               GOTO Step_11_Fail
            END

            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
         END
         CLOSE @curUpdRPL
         DEALLOCATE @curUpdRPL

         -- Release lock
         DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE AddWho = @cUserName
         AND   Status IN ('1', 'X')
         AND   (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
         OPEN CUR_DEL
         FETCH NEXT FROM CUR_DEL INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               ROLLBACK TRAN Step11_Update
               WHILE @@TRANCOUNT > @nTranCount
                  COMMIT TRAN

               CLOSE CUR_DEL
               DEALLOCATE CUR_DEL
               SET @nErrNo = 65951
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'ReleaseMobFail'
               GOTO Step_11_Fail
            END
            FETCH NEXT FROM CUR_DEL INTO @nRowRef
         END
         CLOSE CUR_DEL
         DEALLOCATE CUR_DEL

         DECLARE CUR_UPD CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE ADDWHO = @cUserName
         AND   PickDetailKey <> ''
         OPEN CUR_UPD
         FETCH NEXT FROM CUR_UPD INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
               PickDetailKey = ''
            WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               ROLLBACK TRAN Step11_Update
               WHILE @@TRANCOUNT > @nTranCount
                  COMMIT TRAN

          CLOSE CUR_UPD
               DEALLOCATE CUR_UPD
               SET @nErrNo = 65951
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'ReleaseMobFail'
               GOTO Step_11_Fail
            END
            FETCH NEXT FROM CUR_UPD INTO @nRowRef
         END
         CLOSE CUR_UPD
         DEALLOCATE CUR_UPD

         COMMIT TRAN Step11_Update
         WHILE @@TRANCOUNT > @nTranCount
               COMMIT TRAN

         SET @cOutField01 = '' -- WaveKey

         -- Prev next screen variable
         SET @nScn  = 1870
         SET @nStep = 1

         GOTO Quit
      END
   END

   IF @cOption = '2'
   BEGIN
      IF @nFunc = 1620
      BEGIN
         -- Go to scan DropID screen
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cOutField08 = @cExtendedInfo2
               END
            END
         END
         ELSE
         BEGIN
            -- Extended info
            IF @cExtendedInfoSP <> ''
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
               BEGIN
                  SET @cExtendedInfo = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT

                  SET @cOutField08 = @cExtendedInfo
               END
            END
            ELSE
               SET @cOutField08 = @cColor_Descr
         END

         SET @cOutField09 = ''   -- DropID
         SET @cOutField10 = ''
         SET @cOutField11 = ''

         -- (james42)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
         BEGIN
            SET @cOutField10 = 'CTN TYPE:'
            SET @cOutField11 = ''
         END

         SET @nScn  = 1876
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = @cSKU
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         -- Go to next screen
         SET @nScn  = 1882
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1628
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cLoadKey
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         -- Go to next screen
         SET @nScn  = 1887
         SET @nStep = 7
      END

      -- (james30)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
      BEGIN
         EXECUTE rdt.rdt_Cluster_Pick_DropID
            @nMobile,
            @nFunc,
            @cStorerKey,
            @cUserName,
            @cFacility,
            @cLoadKey,
            @cPickSlipNo,
            @cOrderKey,
            @cDropID       OUTPUT,
            @cSKU,
            'R',      -- R = Retrieve
            @cLangCode,
            @nErrNo        OUTPUT,
            @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max

         IF @nFunc = 1620
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField09 = ''         -- DropID
            ELSE
               SET @cOutField09 = @cDropID   -- DropID
         END
         ELSE
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField10 = ''         -- DropID
            ELSE
               SET @cOutField10 = @cDropID   -- DropID
         END
      END

      GOTO Quit
      END
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      IF @nFunc = 1620
      BEGIN
         -- Go to scan DropID screen
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END


         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                            '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cOutField08 = @cExtendedInfo2
               END
            END
         END
         ELSE
         BEGIN
            SET @cOutField08 = @cColor_Descr
         END

         SET @cOutField09 = ''   -- DropID
         SET @cOutField10 = ''
         SET @cOutField11 = ''

         SET @nScn  = 1876
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = @cSKU
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         -- Go to next screen
         SET @nScn  = 1882
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1628
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cLoadKey
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         -- Go to next screen
         SET @nScn  = 1887
         SET @nStep = 7
      END

      -- (james30)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
      BEGIN
         EXECUTE rdt.rdt_Cluster_Pick_DropID
            @nMobile,
            @nFunc,
            @cStorerKey,
            @cUserName,
            @cFacility,
            @cLoadKey,
            @cPickSlipNo,
            @cOrderKey,
            @cDropID       OUTPUT,
            @cSKU,
            'R',      -- R = Retrieve
            @cLangCode,
            @nErrNo        OUTPUT,
            @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

         IF @nFunc = 1620
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField09 = ''         -- DropID
            ELSE
               SET @cOutField09 = @cDropID   -- DropID
         END
         ELSE
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField10 = ''         -- DropID
            ELSE
               SET @cOutField10 = @cDropID   -- DropID
         END
      END
   END

   GOTO Quit

   Step_11_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 12. Screen = 1881
   Please Input     (field01, input)
********************************************************************************/
Step_12:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cOption = @cInField01

      --if input is not either '1' or '2'
      IF @cOption NOT IN ('1', '2', '3')
      BEGIN
         SET @nErrNo = 65952
         SET @cErrMsg = rdt.rdtgetmessage( 65952, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_12_Fail
      END

      IF @nMultiStorer = 1
         SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

      IF @cOption IN ('1', '3')
      BEGIN
         -- (james36)
         IF rdt.RDTGetConfig( @nFunc, 'NOTALLOWSHORTPICK', @cStorerKey) = 1
         BEGIN
            SET @nErrNo = 69388
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --SHPICK X ALLOW
            GOTO Step_12_Fail
         END

         SET @cSHOWSHTPICKRSN = rdt.RDTGetConfig( @nFunc, 'SHOWSHTPICKRSN', @cStorerKey)

         IF @cSHOWSHTPICKRSN = '1'
         BEGIN
            SELECT @nShortPickedQty = PickQty
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey
               AND SKU = @cSKU
               AND LOT = @cLOT
               AND LOC = @cLOC
               AND Status = '1'
               AND AddWho = @cUserName
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))

            SELECT
                 @cPackUOM3 = P.PACKUOM3
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK P WITH (NOLOCK) ON (SKU.PackKey = P.PackKey)
            WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cOutField01 = @nShortPickedQty -- cluster picking, this is short picked qty
            SET @cOutField02 = @cPackUOM3 -- cluster picking
            SET @cOutField03 = ''
            SET @cOutField04 = ''
            SET @cOutField05 = ''

            -- Save current screen no
            SET @nCurScn = @nScn
            SET @nCurStep = @nStep

            -- Go to STD short pick screen
            SET @nScn = 2010
            SET @nStep = @nStep + 2
            GOTO Quit
         END
         ELSE
         BEGIN
            -- Insert the short picked qty   SOS131967
            IF NOT EXISTS (SELECT 1
                           FROM RDT.RDTPickLock WITH (NOLOCK)
                           WHERE OrderKey = @cOrderKey
                           AND Status = '1'
                           AND AddWho = @cUserName
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                           AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                           AND SKU = @cSKU
                           AND PickQty = 0)
            BEGIN
               BEGIN TRAN

               INSERT INTO RDT.RDTPickLock
               (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
               , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, PickQty, Mobile)
               SELECT TOP 1 WaveKey, LoadKey, Orderkey, '*****' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
               , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, '' AS DropID, @cPickSlipNo AS PickSlipNo, 0, @nMobile
               FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE OrderKey = @cOrderKey
                  AND Status = '1'
                  AND AddWho = @cUserName
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                  AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                  AND SKU = @cSKU

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65963
                  SET @cErrMsg = rdt.rdtgetmessage( 65963, @cLangCode, 'DSP') --'INSTPKLockFail'
                  ROLLBACK TRAN
                  GOTO Step_12_Fail
               END
            END

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT DISTINCT OrderKey FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
               AND Status = '1'
               AND AddWho = @cUserName
               AND LoadKey = @cLoadKey
               AND SKU = @cSKU
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  SET @nErrNo = 0

                  SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
                  IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
                  BEGIN
                     SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                        ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                        ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                     SET @cSQLParms =
                        '@nMobile                   INT,           ' +
                        '@nFunc                     INT,           ' +
                        '@cLangCode                 NVARCHAR( 3),  ' +
                        '@nStep                     INT,           ' +
                        '@nInputKey                 INT,           ' +
                        '@cFacility                 NVARCHAR( 5),  ' +
                        '@cStorerkey                NVARCHAR( 15), ' +
                        '@cWaveKey                  NVARCHAR( 10), ' +
                        '@cLoadKey                  NVARCHAR( 10), ' +
                        '@cOrderKey                 NVARCHAR( 10), ' +
                        '@cPutAwayZone              NVARCHAR( 10), ' +
                        '@cPickZone                 NVARCHAR( 10), ' +
                        '@cSKU                      NVARCHAR( 20), ' +
                        '@cPickSlipNo               NVARCHAR( 10), ' +
                        '@cLOT                      NVARCHAR( 10), ' +
                        '@cLOC                      NVARCHAR( 10), ' +
                        '@cDropID                   NVARCHAR( 20), ' +
                        '@cStatus                   NVARCHAR( 1),  ' +
                        '@cCartonType               NVARCHAR( 10), ' +
                        '@nErrNo                    INT           OUTPUT,  ' +
                        '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                     EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                        @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                        @cLOT, @cLOC, @cDropID, '5', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
                  END
                  ELSE
                  BEGIN
                     EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                        @cStorerKey,
                        @cUserName,
                        @cFacility,
                        @cPutAwayZone,
                        @cPickZone,
                        @cConso_Orders,   -- Set orderkey = '' as conso pick
                        @cSKU,
                        @cPickSlipNo,
                        @cLOT,
                        @cLOC,
                        @cDropID,
                        '5',
                        @cLangCode,
                        @nErrNo        OUTPUT,
                        @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                        @nMobile, -- (Vicky06)
                        @nFunc    -- (Vicky06)
                  END

                  IF @nErrNo <> 0
                  BEGIN
                     ROLLBACK TRAN
                     CLOSE CUR_LOOK4CONSO_ORDERS
                     DEALLOCATE CUR_LOOK4CONSO_ORDERS
                     GOTO Step_12_Fail
                  END
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS
            END
            ELSE
            BEGIN
               SET @nErrNo = 0
               SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
               IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
               BEGIN
                  SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                     ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                     ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                  SET @cSQLParms =
                     '@nMobile                   INT,           ' +
                     '@nFunc                     INT,           ' +
                     '@cLangCode                 NVARCHAR( 3),  ' +
                     '@nStep                     INT,           ' +
                     '@nInputKey                 INT,           ' +
                     '@cFacility                 NVARCHAR( 5),  ' +
                     '@cStorerkey                NVARCHAR( 15), ' +
                     '@cWaveKey                  NVARCHAR( 10), ' +
                     '@cLoadKey                  NVARCHAR( 10), ' +
                     '@cOrderKey                 NVARCHAR( 10), ' +
                     '@cPutAwayZone              NVARCHAR( 10), ' +
                     '@cPickZone                 NVARCHAR( 10), ' +
                     '@cSKU                      NVARCHAR( 20), ' +
                     '@cPickSlipNo               NVARCHAR( 10), ' +
                     '@cLOT                      NVARCHAR( 10), ' +
                     '@cLOC                      NVARCHAR( 10), ' +
                     '@cDropID                   NVARCHAR( 20), ' +
                     '@cStatus                   NVARCHAR( 1),  ' +
                     '@cCartonType               NVARCHAR( 10), ' +
                     '@nErrNo                    INT           OUTPUT,  ' +
                     '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                     @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                     @cLOT, @cLOC, @cDropID, '4', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
               END
               ELSE
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cPutAwayZone,
                     @cPickZone,
                     @cOrderKey,
                     @cSKU,
                     @cPickSlipNo,
                     @cLOT,
                     @cLOC,
                     @cDropID,
                     '4',  -- Pick in progress
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                     @nMobile, -- (Vicky06)
                     @nFunc    -- (Vicky06)
               END

               IF @nErrNo <> 0
               BEGIN
                  GOTO Step_12_Fail
               END
            END

            -- BEGIN TRAN

            -- Update Picked to Confirm Picked
            SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               AND AddWho = @cUserName
               AND Status = '5'
            OPEN @curUpdRPL
            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
               WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65953
                  SET @cErrMsg = rdt.rdtgetmessage( 65953, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN
                  GOTO Step_12_Fail
               END

               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            END
            CLOSE @curUpdRPL
            DEALLOCATE @curUpdRPL

            -- Release lock
            DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE AddWho = @cUserName
            AND   Status IN ('1', 'X')
            AND   (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            OPEN CUR_DEL
            FETCH NEXT FROM CUR_DEL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  CLOSE CUR_DEL
                  DEALLOCATE CUR_DEL
                  SET @nErrNo = 65954
                  SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN
                  GOTO Step_12_Fail
               END
               FETCH NEXT FROM CUR_DEL INTO @nRowRef
            END
            CLOSE CUR_DEL
            DEALLOCATE CUR_DEL

            COMMIT TRAN
         END   -- @cSHOWSHTPICKRSN = '1'
      END   -- IF @cOption = '1'

      IF @cOption = '2'
      BEGIN
         --cancel pick, rollback any partial scanned qty and return to screen 1
         IF EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND AddWho = @cUserName
            AND Status = '1'
            AND PickQty > 0
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone)))
            BEGIN
               BEGIN TRAN

               DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE AddWho = @cUserName
               AND   Status IN ('1', 'X')
               AND   (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               OPEN CUR_DEL
               FETCH NEXT FROM CUR_DEL INTO @nRowRef
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  DELETE FROM RDT.RDTPickLock WITH (ROWLOCK) WHERE RowRef = @nRowRef

                  IF @@ERROR <> 0
                  BEGIN
                     CLOSE CUR_DEL
                     DEALLOCATE CUR_DEL
                     SET @nErrNo = 65955
                     SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_12_Fail
                  END
                  FETCH NEXT FROM CUR_DEL INTO @nRowRef
               END
               CLOSE CUR_DEL
               DEALLOCATE CUR_DEL

               COMMIT TRAN
         END

         --         -- (ChewKP01)
         SET @nQtyToPick = 0
         SET @nTotalPickQty = 0
      END   -- IF @cOption = '2'

      SET @nTranCount = @@TRANCOUNT

      BEGIN TRAN
      SAVE TRAN Step12_Update

      DECLARE CUR_UPD CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
      SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE ADDWHO = @cUserName
      AND   PickDetailKey <> ''
      OPEN CUR_UPD
      FETCH NEXT FROM CUR_UPD INTO @nRowRef
      WHILE @@FETCH_STATUS <> -1
      BEGIN
         UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
            PickDetailKey = ''
         WHERE RowRef = @nRowRef

         IF @@ERROR <> 0
         BEGIN
            ROLLBACK TRAN Step12_Update
            WHILE @@TRANCOUNT > @nTranCount
               COMMIT TRAN

            CLOSE CUR_UPD
            DEALLOCATE CUR_UPD
            GOTO Quit
         END
         FETCH NEXT FROM CUR_UPD INTO @nRowRef
      END
      CLOSE CUR_UPD
      DEALLOCATE CUR_UPD

      COMMIT TRAN Step12_Update
      WHILE @@TRANCOUNT > @nTranCount
            COMMIT TRAN

      SET @cOutField01 = '' -- WaveKey

      -- Prev next screen variable
      SET @nScn  = 1870
      SET @nStep = 1

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- Back to menu
      SET @nFunc = @nMenu
      SET @nScn  = @nMenu
      SET @nStep = 0
      SET @cOutField01 = '' -- WaveKey
   END

   GOTO Quit

   Step_12_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 13. Screen = 1885
   Print Label     (field01, input)
********************************************************************************/
Step_13:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cOption = @cInField01

      IF @cOption NOT IN ('1', '2')
      BEGIN
         SET @nErrNo = 65956
         SET @cErrMsg = rdt.rdtgetmessage( 65956, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_13_Fail
      END

      -- user wannt to print label
      IF @cOption = '1'
      BEGIN
         IF ISNULL(@cPrinter, '') = ''
         BEGIN
            SET @nErrNo = 65957
            SET @cErrMsg = rdt.rdtgetmessage( 65957, @cLangCode, 'DSP') --NoLoginPrinter
            GOTO Step_13_Fail
         END

         SELECT @cDataWindow = ISNULL(RTRIM(DataWindow), ''),
                @cTargetDB = ISNULL(RTRIM(TargetDB), '')
         FROM RDT.RDTReport WITH (NOLOCK)
         WHERE StorerKey = @cStorerKey
            AND ReportType = 'ORDERLBL'

         IF ISNULL(@cDataWindow, '') = ''
         BEGIN
            SET @nErrNo = 65958
            SET @cErrMsg = rdt.rdtgetmessage( 65958, @cLangCode, 'DSP') --DWNOTSetup
            GOTO Step_13_Fail
         END

         IF ISNULL(@cTargetDB, '') = ''
         BEGIN
            SET @nErrNo = 65959
            SET @cErrMsg = rdt.rdtgetmessage( 65959, @cLangCode, 'DSP') --TgetDB Not Set
            GOTO Step_13_Fail
         END

         BEGIN TRAN

         DECLARE CUR_PRINTLBL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT DISTINCT RPL.OrderKey
         FROM RDT.RDTPickLock RPL WITH (NOLOCK)
         JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
            AND (( ISNULL( @cWaveKey, '') = '') OR ( RPL.WaveKey = @cWaveKey))
            AND (( ISNULL( @cLoadKey, '') = '') OR ( RPL.LoadKey = @cLoadKey))
            AND RPL.Status = '1'
            AND RPL.AddWho = @cUserName
            AND PD.Status = '0'
            AND L.Facility = @cFacility
         ORDER BY RPL.OrderKey
         OPEN CUR_PRINTLBL
         FETCH NEXT FROM CUR_PRINTLBL INTO @cPrint_OrderKey
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            -- Call printing spooler
            --INSERT INTO RDT.RDTPrintJob(JobName, ReportID, JobStatus, Datawindow, NoOfParms, Parm1, Printer, NoOfCopy, Mobile, TargetDB)
            --VALUES('PRINTORDERLBL', 'ORDERLBL', '0', @cDataWindow, 1, @cPrint_OrderKey, @cPrinter, 1, @nMobile, @cTargetDB)

            EXEC RDT.rdt_BuiltPrintJob
                  @nMobile,
                  @cStorerKey,
                  'ORDERLBL',
                  'PRINTORDERLBL',
                  @cDataWindow,
                  @cPrinter,
                  @cTargetDB,
                  @cLangCode,
                  @nErrNo  OUTPUT,
                  @cErrMsg OUTPUT,
                  @cPrint_OrderKey

            IF @nErrNo <> 0
            BEGIN
               ROLLBACK TRAN

               CLOSE CUR_PRINTLBL
               DEALLOCATE CUR_PRINTLBL
               SET @nErrNo = 65960
               SET @cErrMsg = rdt.rdtgetmessage( 65960, @cLangCode, 'DSP') --'InsertPRTFail'
               GOTO Step_13_Fail
            END

            FETCH NEXT FROM CUR_PRINTLBL INTO @cPrint_OrderKey
         END
         CLOSE CUR_PRINTLBL
         DEALLOCATE CUR_PRINTLBL

         COMMIT TRAN

         -- Proceed to Drop ID scren after print finish
         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

            IF @cClusterPickNike <> ''
            BEGIN
               IF @cClusterPickNike = '1'
               BEGIN
                  SET @cTemp_String = ''
                  SET @cTemp_UOM = ''
                  SET @nTemp_PackQtyIndicator = ''

                  SELECT
                     @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                     @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                     AND SKU.SKU = @cSKU

                  SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                     '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
               END
               ELSE
               BEGIN
                  IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo2 = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                     SET @cOutField08 = @cExtendedInfo2
                  END
               END
            END
            ELSE
            BEGIN
               SET @cOutField08 = @cColor_Descr
            END

            SET @cOutField09 = ''   -- DropID
            SET @cOutField10 = ''
            SET @cOutField11 = ''

            -- Go to next screen
            SET @nScn  = 1876
            SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = @cSKU
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID

            -- Go to next screen
            SET @nScn  = 1882
            SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1628
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cLoadKey
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID

            -- Go to next screen
            SET @nScn  = 1887
            SET @nStep = 7
         END

         -- (james30)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
         BEGIN
            EXECUTE rdt.rdt_Cluster_Pick_DropID
               @nMobile,
               @nFunc,
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cLoadKey,
               @cPickSlipNo,
               @cOrderKey,
               @cDropID       OUTPUT,
               @cSKU,
               'R',      -- R = Retrieve
               @cLangCode,
               @nErrNo        OUTPUT,
               @cErrMsg       OUTPUT   -- screen limitation, 20 NVARCHAR max

            IF @nFunc = 1620
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField09 = ''         -- DropID
               ELSE
                  SET @cOutField09 = @cDropID   -- DropID
            END
            ELSE
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField10 = ''         -- DropID
               ELSE
                  SET @cOutField10 = @cDropID   -- DropID
            END
         END
      END

      -- user don't want to print label, proceed to Drop ID screen
      IF @cOption = '2'
      BEGIN
         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

            IF @cClusterPickNike <> ''
            BEGIN
               IF @cClusterPickNike = '1'
               BEGIN
                  SET @cTemp_String = ''
                  SET @cTemp_UOM = ''
                  SET @nTemp_PackQtyIndicator = ''

                  SELECT
                     @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                     @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                     AND SKU.SKU = @cSKU

                  SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                     '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
               END
               ELSE
               BEGIN
                  IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo2 = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                     SET @cOutField08 = @cExtendedInfo2
                  END
               END
            END
            ELSE
            BEGIN
               SET @cOutField08 = @cColor_Descr
            END

            SET @cOutField09 = ''   -- DropID
            SET @cOutField10 = ''
            SET @cOutField11 = ''

            -- Go to next screen
            SET @nScn  = 1876
            SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = @cSKU
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID

            -- Go to next screen
            SET @nScn  = 1882
            SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1628
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cLoadKey
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID

            -- Go to next screen
            SET @nScn  = 1887
            SET @nStep = 7
         END

         -- (james30)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
         BEGIN
            EXECUTE rdt.rdt_Cluster_Pick_DropID
               @nMobile,
               @nFunc,
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cLoadKey,
               @cPickSlipNo,
               @cOrderKey,
               @cDropID       OUTPUT,
               @cSKU,
               'R',      -- R = Retrieve
               @cLangCode,
               @nErrNo        OUTPUT,
               @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

            IF @nFunc = 1620
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField09 = ''         -- DropID
               ELSE
                  SET @cOutField09 = @cDropID   -- DropID
            END
            ELSE
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField10 = ''         -- DropID
               ELSE
                  SET @cOutField10 = @cDropID   -- DropID
            END
         END
      END

      GOTO Quit
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- Prep prev screen var
      SET @cOutField01 = '' --Option
      SET @cOutField02 = @cWaveKey
      SET @cOutField03 = @cLoadKey
      SET @cOutField04 = @cPutAwayZone
      SET @cOutField05 = @cPickZone
      SET @cOutField06 = @nOrderCnt
      SET @cOutField07 = @nSKUCnt
      SET @cOutField08 = @nTTL_Alloc_Qty

      SET @nScn  = 1875
      SET @nStep = 6
   END

   GOTO Quit

   Step_13_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 14. Scn = 2010.
   RSN        (field01, input)
********************************************************************************/
Step_14:
BEGIN
   IF @nInputKey = 1 --ENTER
   BEGIN
         --screen mapping
      SET @cReasonCode = @cInField05

      IF ISNULL(@cReasonCode, '') = ''
      BEGIN
         SET @nErrNo = 65982
         SET @cErrMsg = rdt.rdtgetmessage( 65982, @cLangCode, 'DSP') --'BAD Reason'
         GOTO Step_14_Fail
      END

      SELECT @cModuleName = StoredProcName FROM RDT.RDTMsg WITH (NOLOCK) WHERE Message_id = @nFunc

      EXEC rdt.rdt_STD_Short_Pick
         @nFunc,
         @nMobile,
         @cLangCode,
         @nErrNo        OUTPUT,
         @cErrMsg       OUTPUT, -- screen limitation, 20 NVARCHAR max
         @cStorerKey,
         @cFacility,
         @cPickSlipNo,
         @cLoadKey,
         @cWaveKey,
         @cOrderKey,
         @cLOC,
         @cID,
         @cSKU,
         @cPackUOM3,
         @nShortPickedQTY,       -- In master unit
         @cLottable01,
         @cLottable02,
         @cLottable03,
         @dLottable04,
         @dLottable05,
         @cReasonCode,
         @cUserName,
         @cModuleName

      IF @nErrNo <> 0
      BEGIN
         GOTO Step_14_Fail
      END

      -- Short Pick handling start
      IF @nCurStep = 9
      BEGIN
         -- Insert the short picked qty   SOS131967
         IF NOT EXISTS (SELECT 1
                        FROM RDT.RDTPickLock WITH (NOLOCK)
                        WHERE OrderKey = @cOrderKey
                           AND Status = '1'
                           AND AddWho = @cUserName
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                           AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                           AND SKU = @cSKU
                           AND PickQty = 0)
         BEGIN
            BEGIN TRAN

            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
            , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, PickQty, Mobile)
            SELECT TOP 1 WaveKey, LoadKey, Orderkey, '****' as OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
            , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, '' AS DropID, @cPickSlipNo AS PickSlipNo, 0, @nMobile
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE OrderKey = @cOrderKey
               AND Status = '1'
               AND AddWho = @cUserName
               AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
               AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND SKU = @cSKU

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65963
               SET @cErrMsg = rdt.rdtgetmessage( 65963, @cLangCode, 'DSP') --'INSTPKLockFail'
               ROLLBACK TRAN
               GOTO Step_14_Fail
            END
         END

         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT DISTINCT OrderKey FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
            AND Status = '1'
            AND AddWho = @cUserName
            AND LoadKey = @cLoadKey
            AND SKU = @cSKU
            OPEN CUR_LOOK4CONSO_ORDERS
            FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               SET @nErrNo = 0
               SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
               IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
               BEGIN
                  SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                     ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                     ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

                  SET @cSQLParms =
                     '@nMobile                   INT,           ' +
                     '@nFunc                     INT,           ' +
                     '@cLangCode                 NVARCHAR( 3),  ' +
                     '@nStep                     INT,           ' +
                     '@nInputKey                 INT,           ' +
                     '@cFacility                 NVARCHAR( 5),  ' +
                     '@cStorerkey                NVARCHAR( 15), ' +
                     '@cWaveKey                  NVARCHAR( 10), ' +
                     '@cLoadKey                  NVARCHAR( 10), ' +
                     '@cOrderKey                 NVARCHAR( 10), ' +
                     '@cPutAwayZone              NVARCHAR( 10), ' +
                     '@cPickZone                 NVARCHAR( 10), ' +
                     '@cSKU                      NVARCHAR( 20), ' +
                     '@cPickSlipNo               NVARCHAR( 10), ' +
                     '@cLOT                      NVARCHAR( 10), ' +
                     '@cLOC                      NVARCHAR( 10), ' +
                     '@cDropID                   NVARCHAR( 20), ' +
                     '@cStatus                   NVARCHAR( 1),  ' +
                     '@cCartonType               NVARCHAR( 10), ' +
                     '@nErrNo                    INT           OUTPUT,  ' +
                     '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                     @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                     @cLOT, @cLOC, @cDropID, '5', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
               END
               ELSE
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cPutAwayZone,
                     @cPickZone,
                     @cConso_Orders,   -- Set orderkey = '' as conso pick
                     @cSKU,
                     @cPickSlipNo,
                     @cLOT,
                     @cLOC,
                     @cDropID,
                     '5',
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                     @nMobile, -- (Vicky06)
                     @nFunc    -- (Vicky06)
               END

               IF @nErrNo <> 0
               BEGIN
                  ROLLBACK TRAN
                  CLOSE CUR_LOOK4CONSO_ORDERS
                  DEALLOCATE CUR_LOOK4CONSO_ORDERS
                  GOTO Step_14_Fail
               END
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders
            END
            CLOSE CUR_LOOK4CONSO_ORDERS
            DEALLOCATE CUR_LOOK4CONSO_ORDERS
         END
         ELSE
         BEGIN
            SET @nErrNo = 0
            SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
            IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
            BEGIN
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                  ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                  ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

               SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cFacility                 NVARCHAR( 5),  ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cPutAwayZone              NVARCHAR( 10), ' +
                  '@cPickZone                 NVARCHAR( 10), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@cPickSlipNo               NVARCHAR( 10), ' +
                  '@cLOT                      NVARCHAR( 10), ' +
                  '@cLOC                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cStatus                   NVARCHAR( 1),  ' +
                  '@cCartonType               NVARCHAR( 10), ' +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                  @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                  @cLOT, @cLOC, @cDropID, '4', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
            END
            ELSE
            BEGIN
               EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cPutAwayZone,
                  @cPickZone,
                  @cOrderKey,
                  @cSKU,
                  @cPickSlipNo,
                  @cLOT,
                  @cLOC,
                  @cDropID,
                  '4',  -- Pick in progress
                  @cLangCode,
                  @nErrNo        OUTPUT,
                  @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                  @nMobile, -- (Vicky06)
                  @nFunc    -- (Vicky06)
            END

            IF @nErrNo <> 0
            BEGIN
               GOTO Step_14_Fail
            END
         END

         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            -- Remember current LOC (james19)
            SET @cPrevLOC = ''
            SET @cPrevLOC = @cLOC

            SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
            IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
            BEGIN
               SET @c_oFieled03 = @cSKU
               EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                     @n_Mobile        = @nMobile
                  ,@n_Func          = @nFunc
                  ,@c_SPName        = @cClusterPickGetNextTask_SP
                  ,@c_Storerkey     = @cStorerKey
                  ,@c_UserName      = @cUserName
                  ,@c_Facility      = @cFacility
                  ,@c_PutawayZone   = @cPutawayZone
                  ,@c_PickZone      = @cPickZone
                  ,@c_LangCode      = @cLangCode
                  ,@c_oFieled01     = @c_oFieled01 OUTPUT
                  ,@c_oFieled02     = @c_oFieled02 OUTPUT
                  ,@c_oFieled03     = @c_oFieled03 OUTPUT
                  ,@c_oFieled04     = @c_oFieled04 OUTPUT
                  ,@c_oFieled05     = @c_oFieled05 OUTPUT
                  ,@c_oFieled06     = @c_oFieled06 OUTPUT
                  ,@c_oFieled07     = @c_oFieled07 OUTPUT
                  ,@c_oFieled08     = @c_oFieled08 OUTPUT
                  ,@c_oFieled09     = @c_oFieled09 OUTPUT
                  ,@c_oFieled10     = @c_oFieled10 OUTPUT
                  ,@c_oFieled11     = @c_oFieled11 OUTPUT
                  ,@c_oFieled12     = @c_oFieled12 OUTPUT
                  ,@c_oFieled13     = @c_oFieled13 OUTPUT
                  ,@c_oFieled14     = @c_oFieled14 OUTPUT
                  ,@c_oFieled15     = @c_oFieled15 OUTPUT
                  ,@b_Success       = @b_Success   OUTPUT
                  ,@n_ErrNo         = @nErrNo      OUTPUT
                  ,@c_ErrMsg        = @cErrMsg     OUTPUT

               SET @cLOC            = @c_oFieled01
               SET @cOrderKey       = @c_oFieled02
               SET @cSKU            = @c_oFieled03
               SET @cSKU_Descr      = @c_oFieled04
               SET @cStyle          = @c_oFieled05
               SET @cColor          = @c_oFieled06
               SET @cSize           = @c_oFieled07
               SET @cColor_Descr    = @c_oFieled08
               SET @cLot            = @c_oFieled09
               SET @cPickSlipNo     = @c_oFieled10
               SET @cExternOrderKey = @c_oFieled11
               SET @cConsigneeKey   = @c_oFieled12
               SET @cLottable02 = @c_oFieled13
               SET @dLottable04   = @c_oFieled14
            END
            ELSE
            BEGIN
               SELECT TOP 1
                  @cLOC = PD.Loc,
                  @cSKU = PD.SKU,
                  @cLottable02 = LA.Lottable02,
                  @dLottable04 = LA.Lottable04
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK)
                  ON (PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)  -- (james09)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
               JOIN dbo.LOC LOC WITH (NOLOCK) ON (PD.LOC = LOC.LOC)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.Status = '0'
                  AND O.LoadKey = @cLoadKey
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                  AND LOC.Facility = @cFacility
                  AND NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK)
                     WHERE PD.StorerKey = RPL.StorerKey AND PD.OrderKey = RPL.OrderKey AND PD.SKU = RPL.SKU AND RPL.Status = '1')
               GROUP BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
               ORDER BY LOC.LogicalLocation, PD.Loc, PD.SKU, LA.Lottable02, LA.Lottable04
            END

            -- No more task
            IF ISNULL( @cLOC, '') = ''
            BEGIN
               SELECT
                  @nOrderPicked = COUNT( DISTINCT OrderKey),
                  @nTTL_PickedQty = SUM(PickQty)
               FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE AddWho = @cUserName
                  AND Status = '5'  -- Picked
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                  AND StorerKey = @cStorerKey

               -- (james36)
               SET @cPickNotFinish = ''
               IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
               BEGIN
                  IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                              JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                              JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                              JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                              WHERE PD.StorerKey = @cStorerKey
                              AND   ( PD.Status = '0' OR PD.Status = '4')
                              AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                              AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                              AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                              AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                              AND   LOC.Facility = @cFacility
                              AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                    WHERE PD.OrderKey = RPL.OrderKey
                                                    AND   PD.StorerKey = RPL.StorerKey
                                                    AND   RPL.AddWho = @cUserName
                                                    AND   RPL.Status < '9'))
                  BEGIN
                     SET @cPickNotFinish = 'PICKING NOT FINISH'
                  END
               END

               -- Prep next screen var
               SET @cOutField01 = @cWaveKey
               SET @cOutField02 = @cLoadKey
               SET @cOutField03 = @cPutawayZone
               SET @cOutField04 = @cPickZone
               SET @cOutField05 = @nOrderPicked
               SET @cOutField06 = @nTTL_PickedQty
               SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

               SET @nScn  = 1879
               SET @nStep = 10

               SET @nActQty = 0
               SET @nQtyToPick = 0

               SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
               SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND AddWho = @cUserName
                  AND Status = '5'
               OPEN @curUpdRPL
               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                     Status = '9'   -- Confirm Picked
                  WHERE RowRef = @nRowRef

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65942
                     SET @cErrMsg = rdt.rdtgetmessage( 65942, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_14_Fail
                  END

                  FETCH NEXT FROM @curUpdRPL INTO @nRowRef
               END
               CLOSE @curUpdRPL
               DEALLOCATE @curUpdRPL

               -- Commit the transaction before goto picking screen
               COMMIT TRAN
               GOTO Quit
            END
            ELSE
            BEGIN
               SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
               IF ISNULL( @cLocDescr, '') = ''
                  SET @cLocDescr = @cLOC

               SELECT
                  @cSKU_Descr = SKU.DESCR,
                  @cStyle = SKU.Style,
                  @cColor = SKU.Color,
                  @cSize = SKU.Size,
                  @cColor_Descr = SKU.BUSR7
               FROM dbo.SKU SKU WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND SKU = @cSKU

               IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
               BEGIN
                  SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
                  SET @cColor = @cColor + ' '
                  SET @cSKU_Descr = ''
               END

               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT PD.ORDERKEY, PD.LOT
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.Orders O WITH (NOLOCK) ON (PD.OrderKey = O.OrderKey)  -- (james09)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE  O.StorerKey = @cStorerKey
                  AND PD.STATUS = '0'
                  AND PD.LOC = @cLOC
                  AND LA.StorerKey = @cStorerKey    -- tlting03
                  AND LA.SKU = @cSKU
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                  AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                  AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
                  AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               GROUP BY PD.ORDERKEY, PD.LOT
               ORDER BY PD.ORDERKEY, PD.LOT
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                     AND OrderKey = @cConso_Orders
                     AND Status = '1'
                     AND LOT = @cLOT
                     AND AddWho = @cUserName)
                  BEGIN
                     INSERT INTO RDT.RDTPickLock
                     (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, SKU, PutAwayZone, PickZone, PickDetailKey
                     , LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
                     VALUES
                     (@cWaveKey, @cLoadKey, @cConso_Orders, '', @cStorerKey, @cSKU, @cPutAwayZone, @cPickZone, @cConso_Orders
                     , @cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

                     IF @@ERROR <> 0
                     BEGIN
                        SET @nErrNo = 65980
                        SET @cErrMsg = rdt.rdtgetmessage( 65980, @cLangCode, 'DSP') --'LockOrdersFail'
                        ROLLBACK TRAN
                        GOTO Step_14_Fail
                     END
                  END
                  ELSE
                  BEGIN
                  UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
                        LOT = @cLot,
                        LOC = @cLoc,
                        SKU = @cSKU,
                        DropID = @cDropID,
                        PackKey = @cCartonType,
                        Lottable02 = @cLottable02,
                        Lottable04 = @dLottable04
                     WHERE OrderKey = @cConso_Orders
                        AND Status = '1'
                        AND AddWho = @cUserName

                     IF @@ERROR <> 0
                     BEGIN
                        SET @nErrNo = 65981
                        SET @cErrMsg = rdt.rdtgetmessage( 65981, @cLangCode, 'DSP') --'UPDPKLockFail'
                        ROLLBACK TRAN
                        GOTO Step_14_Fail
                     END
                  END

                  FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS
            END

            SELECT @nTTL_Qty = SUM(PD.QTY)
            FROM dbo.PickDetail PD WITH (NOLOCK) --ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.Status = '0'
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND LA.StorerKey = @cStorerKey   -- tling03
               AND LA.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey
                  AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
               -- Duplicate check
   --AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = PD.StorerKey
               --               AND OrderKey = PD.OrderKey AND ADDWHO = @cUserName ) -- SOS# 176144
--               AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName)-- SOS# 176144

            -- Get the total allocated qty for LOC + SKU + OrderKey
            SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.LOC = @cLOC
               AND PD.StorerKey = @cStorerKey   -- tling03
               AND PD.SKU = @cSKU
               AND PD.Status = '0'
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey
                           AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
                           AND RPL.Status = '1' AND RPL.AddWho = @cUserName
                           AND RPL.StorerKey = @cStorerKey AND RPL.PickQty = 0)
               AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

            SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
            IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

            IF @cDefaultToAllocatedQty = '1'
            BEGIN
               SET @cDefaultPickQty = @nTotalPickQty
            END

            SET @nQtyToPick = 0
            SET @nActQty = 0

            -- Get Total Orders left on the current sku that need to pick
            SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE RPL.StorerKey = @cStorerKey
               AND RPL.Status < '5'
               AND RPL.AddWho = @cUserName
               AND RPL.PickQty <= 0
               AND PD.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND PD.Status = '0'
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

            -- (james14)
            IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
            BEGIN
               SET @cOS_Qty = ''

               IF @cLoadDefaultPickMethod = 'C'
               BEGIN
                  -- Get the total qty picked per orders
                  SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                  WHERE PD.StorerKey = @cStorerKey
                     AND LPD.LoadKey = @cLoadKey

                  -- Get the total qty unpick per orders
                  SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
                  FROM dbo.PickDetail PD WITH (NOLOCK)
                  JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
                  WHERE PD.StorerKey = @cStorerKey
                     AND PD.Status >= '3'
                     AND LPD.LoadKey = @cLoadKey

                  SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
               END
               ELSE
               BEGIN
                  -- Get the total qty picked per orders
                  SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
                  FROM dbo.PickDetail WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                     AND OrderKey = @cOrderKey

                  -- Get the total qty unpick per orders
                  SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
                  FROM dbo.PickDetail WITH (NOLOCK)
                  WHERE StorerKey = @cStorerKey
                     AND OrderKey = @cOrderKey
                     AND Status >= '3'

                  SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
               END
            END

            IF @cClusterPickNike <> ''
            BEGIN
               IF @cClusterPickNike = '1'
               BEGIN
                  SET @cTemp_String = ''
                  SET @cTemp_UOM = ''
                  SET @nTemp_PackQtyIndicator = ''

                  SELECT
                     @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                     @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE SKU.StorerKey = @cStorerKey
                     AND SKU.SKU = @cSKU

                  SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                     '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
               END
               ELSE
               BEGIN
                  IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo2 = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                     SET @cTemp_String = @cExtendedInfo2
                  END
               END
            END

            -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
            BEGIN
               SET @cPackCfg = ''

               SELECT @fPack_Qty = PACK.QTY,
                      @fPack_InnerPack = PACK.InnerPack,
                      @fPack_CaseCnt = PACK.CaseCnt
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE SKU.StorerKey = @cStorerKey
                  AND SKU.SKU = @cSKU

               SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                               RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                               RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
            END

            SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
            IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
               SET @cScanLOT02 = '0'

            IF @cPrefUOM <> '6'
            BEGIN
               SELECT TOP 1
                  @nPrefUOM_Div = CAST( IsNULL(
                     CASE @cPrefUOM
                        WHEN '2' THEN Pack.CaseCNT
                        WHEN '3' THEN Pack.InnerPack
                        WHEN '6' THEN Pack.QTY
                        WHEN '1' THEN Pack.Pallet
                        WHEN '4' THEN Pack.OtherUnit1
                        WHEN '5' THEN Pack.OtherUnit2
                     END, 1) AS INT)
               FROM dbo.SKU SKU (NOLOCK)
                  INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
               WHERE StorerKey = @cStorerKey
                  AND SKU = @cSKU

               -- Convert to prefer UOM QTY to be picked
               SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
               SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

               -- Convert to prefer UOM QTY picked
               SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
               SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

					--SOS334125 Start
               SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                         RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                         '/' +
                                         RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                         RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
					--SOS334125 End

               SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
               SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
            END

            -- Extended info
            IF @cExtendedInfoSP <> ''
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
               BEGIN
                  SET @cExtendedInfo = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
               END
            END

            IF @nFunc = 1620
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cDropID
               SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField04 = ''
               SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
               SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
               SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                                  THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
               SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                       THEN @cOS_Qty
                                       WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                  ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
               SET @cOutField09 = @cOrderKey
               SET @cOutField10 = @cExternOrderKey
               SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

               EXEC rdt.rdtSetFocusField @nMobile, 4

               -- Go to next screen
               SET @nScn  = 1877
               SET @nStep = 8
            END
            ELSE
            IF @nFunc = 1621
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cSKU
               SET @cOutField03 = ''
               SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
               SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
               SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
               SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                       THEN @cOS_Qty
                                       WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                  ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
               SET @cOutField09 = @cOrderKey
               SET @cOutField10 = @cExternOrderKey
               SET @cOutField11 = @nTTL_Ord

               EXEC rdt.rdtSetFocusField @nMobile, 3

               -- Go to next screen
               SET @nScn  = 1883
               SET @nStep = 8
            END
            ELSE
            IF @nFunc = 1628  -- (james07)
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField03 = ''
               SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
               SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
               SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
               SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                       THEN @cOS_Qty
                                       WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                                  ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
               SET @cOutField09 = @cLoadKey
               SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
               SET @cOutField11 = @nTTL_Ord

               EXEC rdt.rdtSetFocusField @nMobile, 3

               -- Go to next screen
               SET @nScn  = 1888
               SET @nStep = 8
            END

            IF @cPrefUOM <> '6'
               SET @cOutField12 = @cPreferQty2Display
            ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

            SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                           THEN '' ELSE @cDefaultPickQty END -- Qty to pick
            SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
            SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                              CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                           ELSE 'QTY: ' END

            -- Commit transaction
            COMMIT TRAN

            SET @cFieldAttr01 = ''
            SET @cFieldAttr02 = ''
            SET @cFieldAttr03 = ''
            SET @cFieldAttr04 = ''
            SET @cFieldAttr05 = ''
            SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
            SET @cFieldAttr07 = ''
            SET @cFieldAttr08 = ''
            SET @cFieldAttr09 = ''
            SET @cFieldAttr10 = ''
            SET @cFieldAttr11 = ''
            SET @cFieldAttr12 = ''
            SET @cFieldAttr13 = ''
            SET @cFieldAttr14 = ''
            SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

            -- If config turned on, not allow to change Qty To Pick
            IF @cClusterPickLockQtyToPick = '1'
            BEGIN
               SET @cFieldAttr13 = 'O'
               SET @cInField13 = @cDefaultPickQty
            END

            GOTO Quit
         END
         ELSE
         BEGIN
            -- Get next available task
            SET @nErrNo = 0

            -- Remember current LOC (james19)
            SET @cPrevLOC = ''
            SET @cPrevLOC = @cLOC

            SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
            IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
            BEGIN
               EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                   @n_Mobile        = @nMobile
                  ,@n_Func          = @nFunc
                  ,@c_SPName        = @cClusterPickGetNextTask_SP
                  ,@c_Storerkey     = @cStorerKey
                  ,@c_UserName      = @cUserName
                  ,@c_Facility      = @cFacility
                  ,@c_PutawayZone   = @cPutawayZone
                  ,@c_PickZone      = @cPickZone
                  ,@c_LangCode      = @cLangCode
                  ,@c_oFieled01     = @c_oFieled01 OUTPUT
                  ,@c_oFieled02     = @c_oFieled02 OUTPUT
                  ,@c_oFieled03     = @c_oFieled03 OUTPUT
                  ,@c_oFieled04     = @c_oFieled04 OUTPUT
                  ,@c_oFieled05     = @c_oFieled05 OUTPUT
                  ,@c_oFieled06     = @c_oFieled06 OUTPUT
                  ,@c_oFieled07     = @c_oFieled07 OUTPUT
                  ,@c_oFieled08     = @c_oFieled08 OUTPUT
                  ,@c_oFieled09     = @c_oFieled09 OUTPUT
                  ,@c_oFieled10     = @c_oFieled10 OUTPUT
                  ,@c_oFieled11     = @c_oFieled11 OUTPUT
                  ,@c_oFieled12     = @c_oFieled12 OUTPUT
                  ,@c_oFieled13     = @c_oFieled13 OUTPUT
                  ,@c_oFieled14     = @c_oFieled14 OUTPUT
                  ,@c_oFieled15     = @c_oFieled15 OUTPUT
                  ,@b_Success       = @b_Success   OUTPUT
                  ,@n_ErrNo         = @nErrNo      OUTPUT
                  ,@c_ErrMsg        = @cErrMsg     OUTPUT

               SET @cLOC            = @c_oFieled01
               SET @cNewOrderKey    = @c_oFieled02
               SET @cSKU            = @c_oFieled03
               SET @cSKU_Descr      = @c_oFieled04
               SET @cStyle          = @c_oFieled05
               SET @cColor          = @c_oFieled06
               SET @cSize           = @c_oFieled07
               SET @cColor_Descr    = @c_oFieled08
               SET @cLot            = @c_oFieled09
               SET @cPickSlipNo     = @c_oFieled10
               SET @cExternOrderKey = @c_oFieled11
               SET @cConsigneeKey   = @c_oFieled12
            END
            ELSE
            BEGIN
               EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cPutAwayZone,
                  @cPickZone,
                  @cLangCode,
                  @nErrNo           OUTPUT,
                  @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
                  @cLOC             OUTPUT,
                  @cNewOrderKey     OUTPUT,
                  @cExternOrderKey  OUTPUT,
                  @cConsigneeKey    OUTPUT,
                  @cSKU             OUTPUT,
                  @cSKU_Descr       OUTPUT,
                  @cStyle           OUTPUT,
                  @cColor           OUTPUT,
                  @cSize            OUTPUT,
                  @cColor_Descr     OUTPUT,
                  @cLot             OUTPUT,
                  @cPickSlipNo      OUTPUT,
                  @nMobile,
                  @nFunc

               IF @nErrNo <> 0
               BEGIN
                  SET @nErrNo = 65945
                  SET @cErrMsg = rdt.rdtgetmessage( 65945, @cLangCode, 'DSP') --'GetNextTaskFail'
                  GOTO Step_14_Fail
               END
            END

            SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
            IF ISNULL( @cLocDescr, '') = ''
               SET @cLocDescr = @cLOC

            -- Get the Lottables
            SELECT
               @cLottable02 = Lottable02,
               @dLottable04 = Lottable04
            FROM dbo.LotAttribute WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU
               AND LOT = @cLot
         END

         -- If no more task, goto confirm picking screen
         IF ISNULL(@cNewOrderKey, '') = ''
         BEGIN
            -- Confirm picking in RDT.RDTPickLock
            SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND AddWho = @cUserName
               AND Status = '5'
            OPEN @curUpdRPL
            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
              UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'  -- Confirm Picked
               WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65946
                  SET @cErrMsg = rdt.rdtgetmessage( 65946, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN
                  GOTO Step_14_Fail
               END

               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            END
            CLOSE @curUpdRPL
            DEALLOCATE @curUpdRPL

            SELECT
               @nOrderPicked = COUNT( DISTINCT OrderKey),
               @nTTL_PickedQty = SUM(PickQty)
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE AddWho = @cUserName
               AND Status = '5'
               AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
               AND (( ISNULL( @cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))

            -- (james36)
            SET @cPickNotFinish = ''
            IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
            BEGIN
               IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                           JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                           JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                           JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                           WHERE PD.StorerKey = @cStorerKey
                           AND   ( PD.Status = '0' OR PD.Status = '4')
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                           AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                           AND   LOC.Facility = @cFacility
                           AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                 WHERE PD.OrderKey = RPL.OrderKey
                                                 AND   PD.StorerKey = RPL.StorerKey
                                                 AND   RPL.AddWho = @cUserName
                                                 AND   RPL.Status < '9'))
               BEGIN
                  SET @cPickNotFinish = 'PICKING NOT FINISH'
               END
            END

            -- Prep next screen var
            SET @cOutField01 = @cWaveKey
            SET @cOutField02 = @cLoadKey
            SET @cOutField03 = @cPutawayZone
            SET @cOutField04 = @cPickZone
            SET @cOutField05 = @nOrderPicked
            SET @cOutField06 = @nTTL_PickedQty
            SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

            SET @nScn  = 1879
            SET @nStep = 10

            GOTO Quit
         END

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = Storerkey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cNewOrderKey

         -- Insert next task to picklock
         INSERT INTO RDT.RDTPickLock
         (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
         SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
         VALUES
         (@cWaveKey, @cLoadKey, @cNewOrderKey, '', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
         @cSKU, @cPutAwayZone, @cPickZone, '', @cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65947
            SET @cErrMsg = rdt.rdtgetmessage( 65947, @cLangCode, 'DSP') --'LockOrdersFail'
            ROLLBACK TRAN
            GOTO Step_14_Fail
         END

         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
         BEGIN
            -- If change of LOC then need to go back to confirm LOC screen
            IF @cPrevLOC <> @cLOC
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = ''

                -- Go to next screen
               SET @nScn  = 1892
               SET @nStep = 19

               GOTO Quit
            END
         END

         -- If still have remaining task
         -- If OrderKey changed
         IF @cOrderKey <> @cNewOrderKey
         BEGIN
            SET @cOrderKey = @cNewOrderKey

            -- If configkey 'AutoPromptDropID' turned on, auto go back to DropID screen
            IF @cAutoPromptDropID = '1'
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
               BEGIN
                  -- If change of LOC then need to go back to confirm LOC screen
                  IF @cPrevLOC <> @cLOC
                  BEGIN
                     SET @nActQty = 0
                     SET @nQtyToPick = 0

                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = ''

                     -- Go to next screen
                     SET @nScn  = 1892
                     SET @nStep = 19

                     GOTO Quit
                  END
               END

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cOrderKey
                  SET @cOutField03 = @cExternOrderKey
                  SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                  SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END


                  IF @cClusterPickNike <> ''
                  BEGIN
                     IF @cClusterPickNike = '1'
                     BEGIN
                        SET @cTemp_String = ''
                        SET @cTemp_UOM = ''
                        SET @nTemp_PackQtyIndicator = ''

                        SELECT
                           @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                           @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                        FROM dbo.SKU SKU WITH (NOLOCK)
                        JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                        WHERE SKU.StorerKey = @cStorerKey
                        AND SKU.SKU = @cSKU

                        SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                           '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                     END
                     ELSE
                     BEGIN
                        IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                        BEGIN
                           SET @cExtendedInfo2 = ''

                           SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                              ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                           SET @cSQLParam =
                              '@nMobile       INT, ' +
                              '@nFunc         INT, ' +
                              '@cLangCode     NVARCHAR( 3), ' +
                              '@nStep         INT, ' +
                              '@nInputKey     INT, ' +
                              '@cWaveKey      NVARCHAR( 10), ' +
                              '@cLoadKey      NVARCHAR( 10), ' +
                              '@cOrderKey     NVARCHAR( 10), ' +
                              '@cDropID       NVARCHAR( 20), ' +
                              '@cStorerKey    NVARCHAR( 15), ' +
                              '@cSKU          NVARCHAR( 20), ' +
                              '@cLOC          NVARCHAR( 10), ' +
                              '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                           EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                              @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                           SET @cOutField08 = @cExtendedInfo2
                        END
                     END
                  END
                  ELSE
                  BEGIN
                     SET @cOutField08 = @cColor_Descr
                  END

                  SET @cOutField09 = ''   -- DropID
                  SET @cOutField10 = ''
                  SET @cOutField11 = ''

                  SET @nScn  = 1876
                  SET @nStep = 7
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cOrderKey
                  SET @cOutField03 = @cExternOrderKey
                  SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                  SET @cOutField05 = @cSKU
                  SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField08 = @cLottable02
                  SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField10 = ''   -- DropID

                  -- Go to next screen
                  SET @nScn  = 1882
                  SET @nStep = 7
               END
               ELSE
               IF @nFunc = 1628
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cLoadKey
                  SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField08 = @cLottable02
                  SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField10 = ''   -- DropID

                  -- Go to next screen
                  SET @nScn  = 1887
                  SET @nStep = 7
               END

               -- (james30)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_DropID
                     @nMobile,
                     @nFunc,
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cLoadKey,
                     @cPickSlipNo,
                     @cOrderKey,
                     @cDropID       OUTPUT,
                     @cSKU,
                     'R',      -- R = Retrieve
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

                  IF @nFunc = 1620
                  BEGIN
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                        SET @cOutField09 = ''         -- DropID
                     ELSE
                        SET @cOutField09 = @cDropID   -- DropID
                  END
                  ELSE
                  BEGIN
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                        SET @cOutField10 = ''         -- DropID
                     ELSE
                        SET @cOutField10 = @cDropID   -- DropID
                  END
               END

               SET @nActQty = 0
               SET @nQtyToPick = 0

               GOTO Quit
            END
         END   -- If OrderKey changed

         SET @cOrderKey = @cNewOrderKey

         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         WHERE PD.StorerKey = @cStorerKey
            AND PD.LOC = @cLOC
            AND PD.SKU = @cSKU
            AND PD.OrderKey = @cOrderKey
            AND PD.Status = '0'
            AND PD.LOT = @cLOT
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

         SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
         IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

         -- If DefaultToAllocatedQty = '1' then we use DefaultToAllocatedQty as DefaultPickQty
--         SET @cDefaultToAllocatedQty = rdt.RDTGetConfig( @nFunc, 'DefaultToAllocatedQty', @cStorerKey)
         IF @cDefaultToAllocatedQty = '1'
         BEGIN
            SET @cDefaultPickQty = @nTotalPickQty
         END

         SET @nQtyToPick = 0
         SET @nActQty = 0

         -- Get the total oustanding qty for orderkey + putawayzone + pickzone
         SELECT @nTTL_Qty = SUM(QTY)
         FROM RDT.RDTPickLock RPL WITH (NOLOCK)
         JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE RPL.StorerKey = @cStorerKey
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND PD.Status = '0'
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

         -- Get Total Orders left on the current sku that need to pick
         SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE RPL.StorerKey = @cStorerKey
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND PD.Status = '0'
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

         -- (james14)
         IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
         BEGIN
            SET @cOS_Qty = ''

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND LPD.LoadKey = @cLoadKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.Status >= '3'
                  AND LPD.LoadKey = @cLoadKey

               SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
            ELSE
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND OrderKey = @cOrderKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND OrderKey = @cOrderKey
                  AND Status >= '3'

               SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
         END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE SKU.StorerKey = @cStorerKey
                  AND SKU.SKU = @cSKU

               SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cTemp_String = @cExtendedInfo2
               END
            END
         END

         -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
         BEGIN
            SET @cPackCfg = ''

            SELECT @fPack_Qty = PACK.QTY,
                   @fPack_InnerPack = PACK.InnerPack,
                   @fPack_CaseCnt = PACK.CaseCnt
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE SKU.StorerKey = @cStorerKey
               AND SKU.SKU = @cSKU

            SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                            RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                            RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
         END

         SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
         IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
            SET @cScanLOT02 = '0'

         IF @cPrefUOM <> '6'
         BEGIN
            SELECT TOP 1
               @nPrefUOM_Div = CAST( IsNULL(
                  CASE @cPrefUOM
                     WHEN '2' THEN Pack.CaseCNT
                     WHEN '3' THEN Pack.InnerPack
                     WHEN '6' THEN Pack.QTY
                     WHEN '1' THEN Pack.Pallet
                     WHEN '4' THEN Pack.OtherUnit1
                     WHEN '5' THEN Pack.OtherUnit2
                  END, 1) AS INT)
            FROM dbo.SKU SKU (NOLOCK)
               INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU

            -- Convert to prefer UOM QTY to be picked
            SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

            -- Convert to prefer UOM QTY picked
            SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

				--SOS334125 Start
            SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                      '/' +
                                      RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
				--SOS334125 End

            SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
            SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
         END

         -- Extended info
         IF @cExtendedInfoSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
            BEGIN
               SET @cExtendedInfo = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
            END
         END

         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cDropID
            SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField04 = ''
            SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
            SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                               THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

            EXEC rdt.rdtSetFocusField @nMobile, 4

            SET @nScn  = 1877
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cSKU
            SET @cOutField03 = ''
            SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1883
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1628  -- (james07)
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField03 = ''
            SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
            SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cLoadKey
            SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1888
            SET @nStep = 8
         END

         IF @cPrefUOM <> '6'
            SET @cOutField12 = @cPreferQty2Display
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

         SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                            THEN '' ELSE @cDefaultPickQty END -- Qty to pick
         SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
         SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                 CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                            ELSE 'QTY: ' END

         SET @cFieldAttr01 = ''
         SET @cFieldAttr02 = ''
         SET @cFieldAttr03 = ''
         SET @cFieldAttr04 = ''
         SET @cFieldAttr05 = ''
         SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
         SET @cFieldAttr07 = ''
         SET @cFieldAttr08 = ''
         SET @cFieldAttr09 = ''
         SET @cFieldAttr10 = ''
         SET @cFieldAttr11 = ''
         SET @cFieldAttr12 = ''
         SET @cFieldAttr13 = ''
         SET @cFieldAttr14 = ''
         SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END
      END
   END

   IF @nInputKey = 0 --ESC
   BEGIN
      IF @nCurStep = 9
      BEGIN
         SET @nScn = @nCurScn - 5
         SET @nStep = @nCurStep - 5

         GOTO Quit
      END
      ELSE
      BEGIN
         SET @nScn = @nCurScn - 2
         SET @nStep = @nCurStep - 2

         GOTO Quit
      END
   END
   GOTO Quit

   Step_14_Fail:
   BEGIN
      SET @cReasonCode = ''
      SET @cOutField05 = '' -- RSN
   END

END
GOTO Quit

/********************************************************************************
Step 15. Screen = 1886
   Close Case     (field01, input)
********************************************************************************/
Step_15:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cOption = @cInField01

      IF @cOption NOT IN ('1', '2')
      BEGIN
         SET @nErrNo = 65965
         SET @cErrMsg = rdt.rdtgetmessage( 65965, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_15_Fail
      END

      -- (james41)
      IF @cExtendedValidateSP <> ''
      BEGIN
         SET @nErrNo = 0
         SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedValidateSP) +
            ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
            ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

         SET @cSQLParms =
            '@nMobile                   INT,           ' +
            '@nFunc                     INT,           ' +
            '@cLangCode                 NVARCHAR( 3),  ' +
            '@nStep                     INT,           ' +
            '@nInputKey                 INT,           ' +
            '@cStorerkey                NVARCHAR( 15), ' +
            '@cWaveKey                  NVARCHAR( 10), ' +
            '@cLoadKey                  NVARCHAR( 10), ' +
            '@cOrderKey                 NVARCHAR( 10), ' +
            '@cLoc                      NVARCHAR( 10), ' +
            '@cDropID                   NVARCHAR( 20), ' +
            '@cSKU                      NVARCHAR( 20), ' +
            '@nQty                      INT, '           +
            '@nErrNo                    INT           OUTPUT,  ' +
            '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

         EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
               @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

         IF @nErrNo <> 0
            GOTO Step_15_Fail
      END

      -- user wannt to print label
      IF @cOption = '1'
      BEGIN
         SET @nTranCount = @@TRANCOUNT
         BEGIN TRAN
         SAVE TRAN STEP_15_Option1

         -- Confirm pick first
         DECLARE CUR_CFMPICKS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
         SELECT DISTINCT OrderKey, LOT FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE StorerKey = @cStorerKey
         AND Status = '1'
         AND AddWho = @cUserName
         AND LoadKey = @cLoadKey
         AND SKU = @cSKU
         AND PickQty > 0
         OPEN CUR_CFMPICKS
         FETCH NEXT FROM CUR_CFMPICKS INTO @cConso_Orders, @cLOT
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            SET @nErrNo = 0
            SET @cPickConfirm_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirm_SP', @cStorerKey)
            IF ISNULL(@cPickConfirm_SP, '') NOT IN ('', '0')
            BEGIN
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cPickConfirm_SP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                  ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                  ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

               SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cFacility                 NVARCHAR( 5),  ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cPutAwayZone              NVARCHAR( 10), ' +
                  '@cPickZone                 NVARCHAR( 10), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@cPickSlipNo               NVARCHAR( 10), ' +
                  '@cLOT                      NVARCHAR( 10), ' +
                  '@cLOC                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cStatus                   NVARCHAR( 1),  ' +
                  '@cCartonType               NVARCHAR( 10), ' +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                  @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                  @cLOT, @cLOC, @cDropID, '5', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
            END
            ELSE
            BEGIN
               EXECUTE rdt.rdt_Cluster_Pick_ConfirmTask
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cPutAwayZone,
                  @cPickZone,
                  @cConso_Orders,   -- Set orderkey = '' as conso pick
                  @cSKU,
                  @cPickSlipNo,
                  @cLOT,
                  @cLOC,
                  @cDropID,
                  '5',
                  @cLangCode,
                  @nErrNo        OUTPUT,
                  @cErrMsg       OUTPUT,  -- screen limitation, 20 NVARCHAR max
                  @nMobile, -- (Vicky06)
                  @nFunc    -- (Vicky06)
            END

            IF @nErrNo <> 0
            BEGIN
               CLOSE CUR_CFMPICKS
               DEALLOCATE CUR_CFMPICKS
               ROLLBACK TRAN STEP_15_Option1
               WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                  COMMIT TRAN

               GOTO Step_15_Fail
            END

            FETCH NEXT FROM CUR_CFMPICKS INTO @cConso_Orders, @cLOT
         END
         CLOSE CUR_CFMPICKS
         DEALLOCATE CUR_CFMPICKS

         -- (james66)
         IF @cExtendedUpdateSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedUpdateSP AND type = 'P')
            BEGIN
               SET @nErrNo = 0
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedUpdateSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                  ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

               SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cLoc                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@nQty                      INT, '           +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                    @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

               IF @nErrNo <> 0
               BEGIN
                  ROLLBACK TRAN STEP_15_Option1
                  WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                     COMMIT TRAN

                  GOTO Step_15_Fail
               END
            END
         END

         SET @nActQty = 0
         SET @nQtyToPick = 0

         IF ISNULL( @cOrderKey, '') = ''
            SET @cOrderKey = @cCurrentOrderKey

         SET @cTDropID = @cDropID
         -- Insert into DropID table   (james30)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
         BEGIN
            SET @nErrNo = 0
            EXECUTE rdt.rdt_Cluster_Pick_DropID
               @nMobile,
               @nFunc,
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cLoadKey,
               @cPickSlipNo,
               @cOrderKey,
               @cDropID       OUTPUT,
               @cSKU,
               'U',      -- U = Update
               @cLangCode,
               @nErrNo        OUTPUT,
               @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

            IF @nErrNo <> 0
            BEGIN
               --SET @nErrNo = 69381
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --CLOSE DID FAIL
               ROLLBACK TRAN STEP_15_Option1
               WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                  COMMIT TRAN

               GOTO Step_15_Fail
            END
         END

         WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
            COMMIT TRAN

			-- Insert WCS ( conveyor info). Due to WSC db could be different server (linked server)
			-- the wcs stored proc cannot put within transaction block (no rollback allowed)
			-- Extended wcs
			IF @cExtendedWCSSP <> ''
			BEGIN
				IF EXISTS( SELECT 1 FROM dbo.sysobjects WHERE name = @cExtendedWCSSP AND type = 'P')
				BEGIN
					SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedWCSSP) +
						' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey, ' +
                  ' @cWaveKey, @cLoadKey, @cOrderKey, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo, ' +
                  ' @cLOT, @cLOC, @cDropID, @cStatus, @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT '

					SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cFacility                 NVARCHAR( 5),  ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cPutAwayZone              NVARCHAR( 10), ' +
                  '@cPickZone                 NVARCHAR( 10), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@cPickSlipNo               NVARCHAR( 10), ' +
                  '@cLOT                      NVARCHAR( 10), ' +
                  '@cLOC                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cStatus                   NVARCHAR( 1),  ' +
                  '@cCartonType               NVARCHAR( 10), ' +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cFacility, @cStorerkey,
                  @cWaveKey, @cLoadKey, @cConso_Orders, @cPutAwayZone, @cPickZone, @cSKU, @cPickSlipNo,
                  @cLOT, @cLOC, @cDropID, '5', @cCartonType, @nErrNo OUTPUT, @cErrMsg OUTPUT
				END
			END


         SET @nErrNo = 0
         EXECUTE RDT.rdt_Cluster_Pick_PrintLabel
            @nMobile,
            @nFunc,
            @nStep,
            @nInputKey,
            @cLangCode,
            @cStorerKey,
            @cWaveKey,
            @cLoadKey,
            @cOrderKey,
            @cPickSlipNo,
            @cLOC,
            @cTDropID,
            @cSKU,
            @nQty,
            @nErrNo   OUTPUT,
            @cErrMsg  OUTPUT

         IF @nErrNo <> 0
            GOTO Step_15_Fail

         -- Get next available task
         SET @nErrNo = 0
         SET @cCurrentOrderKey = @cOrderKey -- to Store the current Orderkey
         SET @cOrderKey = ''

         -- Remember current LOC (james19)
         SET @cPrevLOC = ''
         SET @cPrevLOC = @cLOC

         SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
         IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
         BEGIN
            EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                @n_Mobile        = @nMobile
               ,@n_Func          = @nFunc
               ,@c_SPName        = @cClusterPickGetNextTask_SP
               ,@c_Storerkey     = @cStorerKey
               ,@c_UserName      = @cUserName
               ,@c_Facility      = @cFacility
               ,@c_PutawayZone   = @cPutawayZone
               ,@c_PickZone      = @cPickZone
               ,@c_LangCode      = @cLangCode
               ,@c_oFieled01     = @c_oFieled01 OUTPUT
               ,@c_oFieled02     = @c_oFieled02 OUTPUT
               ,@c_oFieled03     = @c_oFieled03 OUTPUT
               ,@c_oFieled04     = @c_oFieled04 OUTPUT
               ,@c_oFieled05     = @c_oFieled05 OUTPUT
               ,@c_oFieled06     = @c_oFieled06 OUTPUT
               ,@c_oFieled07     = @c_oFieled07 OUTPUT
               ,@c_oFieled08     = @c_oFieled08 OUTPUT
               ,@c_oFieled09     = @c_oFieled09 OUTPUT
               ,@c_oFieled10     = @c_oFieled10 OUTPUT
               ,@c_oFieled11     = @c_oFieled11 OUTPUT
               ,@c_oFieled12     = @c_oFieled12 OUTPUT
               ,@c_oFieled13     = @c_oFieled13 OUTPUT
               ,@c_oFieled14     = @c_oFieled14 OUTPUT
               ,@c_oFieled15     = @c_oFieled15 OUTPUT
               ,@b_Success       = @b_Success   OUTPUT
               ,@n_ErrNo         = @nErrNo      OUTPUT
               ,@c_ErrMsg        = @cErrMsg     OUTPUT

            SET @cLOC            = @c_oFieled01
            SET @cOrderKey       = @c_oFieled02
            SET @cSKU            = @c_oFieled03
            SET @cSKU_Descr      = @c_oFieled04
            SET @cStyle          = @c_oFieled05
            SET @cColor          = @c_oFieled06
            SET @cSize           = @c_oFieled07
            SET @cColor_Descr    = @c_oFieled08
            SET @cLot            = @c_oFieled09
            SET @cPickSlipNo     = @c_oFieled10
            SET @cExternOrderKey = @c_oFieled11
            SET @cConsigneeKey   = @c_oFieled12
         END
         ELSE
         BEGIN
            EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cPutAwayZone,
               @cPickZone,
               @cLangCode,
               @nErrNo           OUTPUT,
               @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
               @cLOC             OUTPUT,
               @cOrderKey        OUTPUT,
               @cExternOrderKey  OUTPUT,
               @cConsigneeKey    OUTPUT,
               @cSKU             OUTPUT,
               @cSKU_Descr       OUTPUT,
               @cStyle           OUTPUT,
               @cColor           OUTPUT,
               @cSize            OUTPUT,
               @cColor_Descr     OUTPUT,
               @cLot             OUTPUT,
               @cPickSlipNo      OUTPUT,
               @nMobile,
               @nFunc

            IF @nErrNo <> 0
            BEGIN
               SET @nErrNo = 65970
               SET @cErrMsg = rdt.rdtgetmessage( 65970, @cLangCode, 'DSP') --'GetNextTaskFail'
               GOTO Step_15_Fail
            END
         END

         SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
         IF ISNULL( @cLocDescr, '') = ''
            SET @cLocDescr = @cLOC

         -- Get the Lottables
         SELECT
            @cLottable02 = Lottable02,
            @dLottable04 = Lottable04
         FROM dbo.LotAttribute WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND SKU = @cSKU
            AND LOT = @cLot

         --If it is last record of the whole picking process, prompt picking completed screen
         IF ISNULL(@cOrderKey, '') = ''
         BEGIN
            SET @cOrderKey = @cCurrentOrderKey -- Assign back the OrderKey
            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            SELECT
               @nOrderPicked = COUNT( DISTINCT OrderKey),
               @nTTL_PickedQty = SUM(PickQty)
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE AddWho = @cUserName
               AND Status = '5'  -- Picked
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))

            -- (james36)
            SET @cPickNotFinish = ''
            IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
            BEGIN
               IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                           JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                           JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                           JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                           WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                           AND   ( PD.Status = '0' OR PD.Status = '4')
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                           AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                           AND   LOC.Facility = @cFacility
                           AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                 WHERE PD.OrderKey = RPL.OrderKey
                                                 AND   PD.StorerKey = RPL.StorerKey
                                                 AND   RPL.AddWho = @cUserName
                                                 AND   RPL.Status < '9'))
               BEGIN
                  SET @cPickNotFinish = 'PICKING NOT FINISH'
               END
            END

            -- Prep next screen var
            SET @cOutField01 = @cWaveKey
            SET @cOutField02 = @cLoadKey
            SET @cOutField03 = @cPutawayZone
            SET @cOutField04 = @cPickZone
            SET @cOutField05 = @nOrderPicked
            SET @cOutField06 = @nTTL_PickedQty
            SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

            SET @nScn  = 1879
            SET @nStep = 10

            SET @nActQty = 0
            SET @nQtyToPick = 0

            SET @nTranCount = @@TRANCOUNT
            BEGIN TRAN
            SAVE TRAN STEP_15_Option1

            SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               AND AddWho = @cUserName
               AND Status = '5'
            OPEN @curUpdRPL
            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
               WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65971
                  SET @cErrMsg = rdt.rdtgetmessage( 65971, @cLangCode, 'DSP') --'UPDPKLockFail'
                  CLOSE @curUpdRPL
                  DEALLOCATE @curUpdRPL
                  ROLLBACK TRAN STEP_15_Option1
                  WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                     COMMIT TRAN

                  GOTO Step_15_Fail
               END

               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            END
            CLOSE @curUpdRPL
            DEALLOCATE @curUpdRPL

            WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
               COMMIT TRAN

            GOTO Quit
         END


         SET @d_step4 = GETDATE() - @d_step4 -- (Vicky02)

         -- If no more task, goto confirm picking screen
         IF ISNULL(@cOrderKey, '') = ''
         BEGIN
            SET @cPromptCloseCase = ''
            SET @cPromptCloseCase = rdt.RDTGetConfig( @nFunc, 'PromptCloseCase', @cStorerKey)

            IF LEN( RTRIM( @cPromptCloseCase)) > 1
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cPromptCloseCase AND type = 'P')
               BEGIN
                  SET @nErrNo = 0
                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cPromptCloseCase) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                     ' @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '
                  SET @cSQLParam =
                     '@nMobile          INT,                   ' +
                     '@nFunc            INT,                   ' +
                     '@cLangCode        NVARCHAR( 3),          ' +
                     '@nStep            INT,                   ' +
                     '@nInputKey        INT,                   ' +
                     '@cStorerkey       NVARCHAR( 15),         ' +
                     '@cWaveKey         NVARCHAR( 10),         ' +
                     '@cLoadKey         NVARCHAR( 10),         ' +
                     '@cOrderKey        NVARCHAR( 10),         ' +
                     '@cLoc             NVARCHAR( 10),         ' +
                     '@cDropID          NVARCHAR( 20),         ' +
                     '@cSKU             NVARCHAR( 20),         ' +
                     '@nQty             INT,                   ' +
                     '@cPromptCloseCase NVARCHAR( 1)  OUTPUT,  ' +
                     '@nErrNo           INT           OUTPUT,  ' +
                     '@cErrMsg          NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                     @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT
               END
            END

            --If no more task then prompt Close Case screen (If turned on) (james03)
            IF @cPromptCloseCase = '1'
            BEGIN
               SET @cOutField01 = ''

               -- Go to Close Case screen
               SET @nScn  = 1886
               SET @nStep = 15

               GOTO Quit
            END

            SET @cOrderKey = @cCurrentOrderKey -- Assign back the OrderKey

            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            SELECT
               @nOrderPicked = COUNT( DISTINCT OrderKey),
               @nTTL_PickedQty = SUM(PickQty)
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE AddWho = @cUserName
               AND Status = '5'  -- Picked
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))

            -- Prep next screen var
            SET @cOutField01 = @cWaveKey
            SET @cOutField02 = @cLoadKey
            SET @cOutField03 = @cPutawayZone
            SET @cOutField04 = @cPickZone
            SET @cOutField05 = @nOrderPicked
            SET @cOutField06 = @nTTL_PickedQty

            SET @nScn  = 1879
            SET @nStep = 10

            SET @nActQty = 0
            SET @nQtyToPick = 0

            SET @nTranCount = @@TRANCOUNT
            BEGIN TRAN
            SAVE TRAN STEP_15_Option1

            SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               AND AddWho = @cUserName
               AND Status = '5'
            OPEN @curUpdRPL
            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
               WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65942
                  SET @cErrMsg = rdt.rdtgetmessage( 65942, @cLangCode, 'DSP') --'UPDPKLockFail'
                  CLOSE @curUpdRPL
                  DEALLOCATE @curUpdRPL
                  ROLLBACK TRAN STEP_15_Option1
                  WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                     COMMIT TRAN

                  GOTO Step_15_Fail
               END

               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            END
            CLOSE @curUpdRPL
            DEALLOCATE @curUpdRPL

            -- Commit the transaction before goto picking screen
            WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
               COMMIT TRAN

            GOTO Quit
         END
      END

      -- user don't want to print label, proceed to Drop ID screen
      IF @cOption = '2'
      BEGIN
         IF @cExtendedUpdateSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedUpdateSP AND type = 'P')
            BEGIN
               SET @nErrNo = 0
               SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedUpdateSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                  ' @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT '

               SET @cSQLParms =
                  '@nMobile                   INT,           ' +
                  '@nFunc                     INT,           ' +
                  '@cLangCode                 NVARCHAR( 3),  ' +
                  '@nStep                     INT,           ' +
                  '@nInputKey                 INT,           ' +
                  '@cStorerkey                NVARCHAR( 15), ' +
                  '@cWaveKey                  NVARCHAR( 10), ' +
                  '@cLoadKey                  NVARCHAR( 10), ' +
                  '@cOrderKey                 NVARCHAR( 10), ' +
                  '@cLoc                      NVARCHAR( 10), ' +
                  '@cDropID                   NVARCHAR( 20), ' +
                  '@cSKU                      NVARCHAR( 20), ' +
                  '@nQty                      INT, '           +
                  '@nErrNo                    INT           OUTPUT,  ' +
                  '@cErrMsg                   NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
                    @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                    @cLoc, @cDropID, @cSKU, @nQty, @nErrNo OUTPUT, @cErrMsg OUTPUT

               IF @nErrNo <> 0
                  GOTO Step_15_Fail
            END
         END

         -- Get next available task
         SET @nErrNo = 0
         SET @cCurrentOrderKey = @cOrderKey -- to Store the current Orderkey
         SET @cOrderKey = ''

         -- Remember current LOC (james18)
         SET @cPrevLOC = ''
         SET @cPrevLOC = @cLOC

         SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
         IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
         BEGIN
            EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                @n_Mobile        = @nMobile
               ,@n_Func          = @nFunc
               ,@c_SPName        = @cClusterPickGetNextTask_SP
               ,@c_Storerkey     = @cStorerKey
               ,@c_UserName      = @cUserName
               ,@c_Facility      = @cFacility
               ,@c_PutawayZone   = @cPutawayZone
               ,@c_PickZone      = @cPickZone
               ,@c_LangCode      = @cLangCode
               ,@c_oFieled01     = @c_oFieled01 OUTPUT
               ,@c_oFieled02     = @c_oFieled02 OUTPUT
               ,@c_oFieled03     = @c_oFieled03 OUTPUT
               ,@c_oFieled04     = @c_oFieled04 OUTPUT
               ,@c_oFieled05     = @c_oFieled05 OUTPUT
               ,@c_oFieled06     = @c_oFieled06 OUTPUT
               ,@c_oFieled07     = @c_oFieled07 OUTPUT
               ,@c_oFieled08     = @c_oFieled08 OUTPUT
               ,@c_oFieled09     = @c_oFieled09 OUTPUT
               ,@c_oFieled10     = @c_oFieled10 OUTPUT
               ,@c_oFieled11     = @c_oFieled11 OUTPUT
               ,@c_oFieled12     = @c_oFieled12 OUTPUT
               ,@c_oFieled13     = @c_oFieled13 OUTPUT
               ,@c_oFieled14     = @c_oFieled14 OUTPUT
               ,@c_oFieled15     = @c_oFieled15 OUTPUT
               ,@b_Success       = @b_Success   OUTPUT
               ,@n_ErrNo         = @nErrNo      OUTPUT
               ,@c_ErrMsg        = @cErrMsg     OUTPUT

            SET @cLOC            = @c_oFieled01
            SET @cOrderKey       = @c_oFieled02
            SET @cSKU            = @c_oFieled03
            SET @cSKU_Descr      = @c_oFieled04
            SET @cStyle          = @c_oFieled05
            SET @cColor          = @c_oFieled06
            SET @cSize           = @c_oFieled07
            SET @cColor_Descr    = @c_oFieled08
            SET @cLot            = @c_oFieled09
            SET @cPickSlipNo     = @c_oFieled10
            SET @cExternOrderKey = @c_oFieled11
            SET @cConsigneeKey   = @c_oFieled12
         END
         ELSE
         BEGIN
            EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cPutAwayZone,
               @cPickZone,
               @cLangCode,
               @nErrNo           OUTPUT,
               @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
               @cLOC             OUTPUT,
               @cOrderKey        OUTPUT,
               @cExternOrderKey  OUTPUT,
               @cConsigneeKey    OUTPUT,
               @cSKU             OUTPUT,
               @cSKU_Descr       OUTPUT,
               @cStyle           OUTPUT,
               @cColor           OUTPUT,
               @cSize            OUTPUT,
               @cColor_Descr     OUTPUT,
               @cLot             OUTPUT,
               @cPickSlipNo      OUTPUT,
               @nMobile,
               @nFunc

            IF @nErrNo <> 0
            BEGIN
               SET @nErrNo = 65972
               SET @cErrMsg = rdt.rdtgetmessage( 65972, @cLangCode, 'DSP') --'GetNextTaskFail'
               GOTO Step_15_Fail
            END
         END

         SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
         IF ISNULL( @cLocDescr, '') = ''
            SET @cLocDescr = @cLOC

         -- Get the Lottables
         SELECT
            @cLottable02 = Lottable02,
            @dLottable04 = Lottable04
         FROM dbo.LotAttribute WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND SKU = @cSKU
            AND LOT = @cLot

         --If it is last record of the whole picking process, prompt picking completed screen
         IF ISNULL( @cOrderKey, '') = ''
         BEGIN
            SET @cOrderKey = @cCurrentOrderKey -- Assign back the OrderKey
            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            SELECT
               @nOrderPicked = COUNT( DISTINCT OrderKey),
               @nTTL_PickedQty = SUM(PickQty)
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE AddWho = @cUserName
               AND Status = '5'  -- Picked
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))

            -- (james36)
            SET @cPickNotFinish = ''
            IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
            BEGIN
               IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                           JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                           JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                           JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                           WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                           AND   ( PD.Status = '0' OR PD.Status = '4')
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                           AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                           AND   LOC.Facility = @cFacility
                           AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                 WHERE PD.OrderKey = RPL.OrderKey
                                                 AND   PD.StorerKey = RPL.StorerKey
                                                 AND   RPL.AddWho = @cUserName
                                                 AND   RPL.Status < '9'))
               BEGIN
                  SET @cPickNotFinish = 'PICKING NOT FINISH'
               END
            END

            -- Prep next screen var
            SET @cOutField01 = @cWaveKey
            SET @cOutField02 = @cLoadKey
            SET @cOutField03 = @cPutawayZone
            SET @cOutField04 = @cPickZone
            SET @cOutField05 = @nOrderPicked
            SET @cOutField06 = @nTTL_PickedQty
            SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

            SET @nScn  = 1879
            SET @nStep = 10

            SET @nActQty = 0
            SET @nQtyToPick = 0

            BEGIN TRAN

            SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND AddWho = @cUserName
               AND Status = '5'
            OPEN @curUpdRPL
            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
               WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65973
                  SET @cErrMsg = rdt.rdtgetmessage( 65973, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN
                  GOTO Step_15_Fail
               END

               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            END
            CLOSE @curUpdRPL
            DEALLOCATE @curUpdRPL

            COMMIT TRAN
            GOTO Quit
         END
      END

      SET @nTranCount = @@TRANCOUNT
      BEGIN TRAN
      SAVE TRAN STEP_15_Option1

      IF @nMultiStorer = 1
         SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

         -- If pick by conso then look for all orders
         -- and group by logicalloc, loc, sku, lot2, lot4
         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            SELECT @cLottable02 = Lottable02,
                   @dLottable04 = Lottable04
            FROM dbo.LotAttribute WITH (NOLOCK)
            WHERE LOT = @cLot

            DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT RowRef FROM RDT.RDTPICKLOCK WITH (NOLOCK)
            WHERE  AddWho = @cUserName
            AND    Status = '1'
            OPEN CUR_DEL
            FETCH NEXT FROM CUR_DEL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               DELETE FROM RDT.RDTPICKLOCK WITH (ROWLOCK) WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  ROLLBACK TRAN STEP_15_Option1
                  WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                     COMMIT TRAN

                  CLOSE CUR_DEL
                  DEALLOCATE CUR_DEL

                  GOTO Step_15_Fail
               END

               FETCH NEXT FROM CUR_DEL INTO @nRowRef
            END
            CLOSE CUR_DEL
            DEALLOCATE CUR_DEL

            EXEC [RDT].[rdt_ClusterPickSkuAttribute]
               @nMobile       = @nMobile,
               @nFunc         = @nFunc,
               @cLangCode     = @cLangCode,
               @nStep         = @nStep,
               @nInputKey     = @nInputKey,
               @cStorerKey    = @cStorerKey,
               @cSKU          = @cSKU,
               @cAltSKU       = @cAltSKU       OUTPUT,
               @cDescr        = @cSKU_Descr    OUTPUT,
               @cStyle        = @cStyle        OUTPUT,
               @cColor        = @cColor        OUTPUT,
               @cSize         = @cSize         OUTPUT,
               @cColor_Descr  = @cColor_Descr  OUTPUT,
               @cAttribute01  = @cAttribute01  OUTPUT,
               @cAttribute02  = @cAttribute02  OUTPUT,
               @cAttribute03  = @cAttribute03  OUTPUT,
               @cAttribute04  = @cAttribute04  OUTPUT,
               @cAttribute05  = @cAttribute05  OUTPUT,
               @cAttribute06  = @cAttribute06  OUTPUT,
               @cAttribute07  = @cAttribute07  OUTPUT,
               @cAttribute08  = @cAttribute08  OUTPUT,
               @cAttribute09  = @cAttribute09  OUTPUT,
               @cAttribute10  = @cAttribute10  OUTPUT,
               @nErrNo        = @nErrNo        OUTPUT,
               @cErrMsg       = @cErrMsg       OUTPUT

            IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
            BEGIN
               SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
               SET @cColor = @cColor + ' '
               SET @cSKU_Descr = ''
            END

            DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
            SELECT PD.ORDERKEY, PD.LOT
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey and PD.OrderLineNumber = OD.OrderLineNumber)
            JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.StorerKey = @cStorerKey
               AND PD.STATUS = '0'
               AND PD.LOC = @cLOC
               AND PD.SKU = @cSKU
               AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
               AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            GROUP BY PD.ORDERKEY, PD.LOT  -- (james56)
            ORDER BY PD.ORDERKEY, PD.LOT
            OPEN CUR_LOOK4CONSO_ORDERS
            FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               INSERT INTO RDT.RDTPickLock
               (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
               , LOT, LOC, SKU, DropID, Lottable02, Lottable04, Status, AddWho, AddDate, PickSlipNo, Mobile, PackKey)
               VALUES
               (ISNULL(@cWaveKey, ''), ISNULL(@cLoadKey, ''), @cConso_Orders, '', @cStorerKey, ISNULL(@cPutAwayZone, ''), ISNULL(@cPickZone, ''), @cConso_Orders,
               @cLot, @cLoc, @cSKU, @cDropID, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cPickSlipNo, @nMobile, @cCartonType)

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65976
                  SET @cErrMsg = rdt.rdtgetmessage( 65976, @cLangCode, 'DSP') --'UPDPKLockFail'

                  ROLLBACK TRAN STEP_15_Option1
                  WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                     COMMIT TRAN

                  GOTO Step_15_Fail
               END

               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT
            END
            CLOSE CUR_LOOK4CONSO_ORDERS
            DEALLOCATE CUR_LOOK4CONSO_ORDERS
         END
         ELSE
         BEGIN
            -- Get the Lottables
            SELECT
               @cLottable02 = Lottable02,
               @dLottable04 = Lottable04
            FROM dbo.LotAttribute WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
               AND SKU = @cSKU
               AND LOT = @cLot

            UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
               LOT = @cLot,
               LOC = @cLoc,
               SKU = @cSKU,
               DropID = @cDropID,
               PackKey = @cCartonType,
               Lottable02 = @cLottable02,
               Lottable04 = @dLottable04,
               OrderLineNumber = LEFT( OrderLineNumber + '%%', 5)  -- SOS232145
            WHERE OrderKey = @cOrderKey
               AND Status = '1'
               AND AddWho = @cUserName
               AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65929
               SET @cErrMsg = rdt.rdtgetmessage( 65929, @cLangCode, 'DSP') --'UPDPKLockFail'
               ROLLBACK TRAN STEP_15_Option1
               WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
                  COMMIT TRAN

                  GOTO Step_15_Fail
            END
         END

      --IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
      --               WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
      --               AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
      --               AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
      --               AND OrderKey = @cOrderKey
      --               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
      --               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
      --               AND Status = '1'
      --               AND AddWho = @cUserName)
      --BEGIN
      --   -- Insert next task to picklock
      --   INSERT INTO RDT.RDTPickLock
      --   (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
      --      SKU, PutAwayZone, PickZone, PickDetailKey
      --   ,LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
      --   VALUES
      --   (@cWaveKey, @cLoadKey, @cOrderKey, '', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
      --      @cSKU, @cPutAwayZone, @cPickZone, ''
      --   ,@cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

      --   IF @@ERROR <> 0
      --   BEGIN
      --      SET @nErrNo = 65943
      --      SET @cErrMsg = rdt.rdtgetmessage( 65943, @cLangCode, 'DSP') --'LockOrdersFail'
      --      ROLLBACK TRAN STEP_15_Option1
      --      WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
      --         COMMIT TRAN

      --      GOTO Step_15_Fail
      --   END
      --END
      --ELSE
      --BEGIN
      --   UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
      --      LOT = @cLot,
      --      LOC = @cLoc,
      --      SKU = @cSKU,
      --      DropID = @cDropID,
      --      PackKey = @cCartonType,
      --      Lottable02 = @cLottable02,
      --      Lottable04 = @dLottable04
      --   WHERE OrderKey = @cOrderKey
      --      AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
      --      AND Status = '1'
      --      AND AddWho = @cUserName

      --   IF @@ERROR <> 0
      --   BEGIN
      --      SET @nErrNo = 65929
      --      SET @cErrMsg = rdt.rdtgetmessage( 65929, @cLangCode, 'DSP') --'UPDPKLockFail'
      --      ROLLBACK TRAN STEP_15_Option1
      --      WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
      --         COMMIT TRAN

      --      GOTO Step_15_Fail
      --   END
      --END

      WHILE @@TRANCOUNT > @nTranCount -- Commit until the level we started
         COMMIT TRAN

      -- Proceed to Drop ID scren after print finish
      IF @nFunc = 1620
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                    '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cOutField08 = @cExtendedInfo2
               END
            END
         END
         ELSE
         BEGIN
            SET @cOutField08 = @cColor_Descr
         END

         SET @cOutField09 = ''   -- DropID
         SET @cOutField10 = ''
         SET @cOutField11 = ''

         -- Go to next screen
         SET @nScn  = 1876
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = @cSKU
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         -- Go to next screen
         SET @nScn  = 1882
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1628
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cLoadKey
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID

         -- Go to next screen
         SET @nScn  = 1887
         SET @nStep = 7
      END

      -- (james30)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
      BEGIN
         EXECUTE rdt.rdt_Cluster_Pick_DropID
            @nMobile,
            @nFunc,
            @cStorerKey,
            @cUserName,
            @cFacility,
            @cLoadKey,
            @cPickSlipNo,
            @cOrderKey,
            @cDropID       OUTPUT,
            @cSKU,
            'R',      -- R = Retrieve
            @cLangCode,
            @nErrNo        OUTPUT,
            @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

         IF @nFunc = 1620
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField09 = ''         -- DropID
            ELSE
               SET @cOutField09 = @cDropID   -- DropID
         END
         ELSE
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField10 = ''         -- DropID
            ELSE
               SET @cOutField10 = @cDropID   -- DropID
         END

         -- (james42)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
         BEGIN
            IF @nFunc = 1620
            BEGIN
               SET @cOutField10 = 'CTN TYPE:'
               SET @cFieldAttr11 = ''
               SET @cOutField11 = ''
            END
            ELSE
            BEGIN
               SET @cOutField11 = 'CTN TYPE:'
               SET @cFieldAttr12 = ''
               SET @cOutField12 = ''
            END
         END
         ELSE
         BEGIN
            IF @nFunc = 1620
               SET @cFieldAttr11 = 'O'
            ELSE
               SET @cFieldAttr12 = 'O'
         END
      END

      SET @nQtyToPick = 0

      GOTO Quit
   END

   GOTO Quit

   Step_15_Fail:
   BEGIN
      SET @cOutField01 = ''
   END

END
GOTO Quit

/********************************************************************************
Step 16. Screen = 1890
   Option     (field01, input)
********************************************************************************/
Step_16:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      SET @cOption = @cInField01

      --if input is not either '1' or '2'
      IF @cOption NOT IN ('1', '2')
      BEGIN
         SET @nErrNo = 65927
         SET @cErrMsg = rdt.rdtgetmessage( 65927, @cLangCode, 'DSP') --Invalid Option
         GOTO Step_16_Fail
      END

      -- Proceed to Qty screen
      IF @cOption = '1'
      BEGIN
         SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
         IF CAST(@cDefaultPickQty AS INT) <= 0
         BEGIN
            SET @cDefaultPickQty = ''

            IF @cDefaultToAllocatedQty = '1'
            BEGIN
               SET @cDefaultPickQty = @nTotalPickQty
            END

            IF @nQtyToPick > 0
            BEGIN
               IF ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                  SET @cDefaultPickQty = ''
               ELSE
                  SET @cDefaultPickQty = CAST(@cDefaultPickQty AS INT) - @nQtyToPick
            END
         END

         -- update dropid
         IF ISNULL(@cDropID, '') <> ''
         BEGIN
            UPDATE RDT.RDTPICKLOCK WITH (ROWLOCK) SET
               DropID = @cDropID,
               PackKey = @cCartonType
            WHERE AddWho = @cUserName
               AND StorerKey = @cStorerKey   --tlting03
               AND Status = '1'
         END

         -- Get the total oustanding qty for orderkey + putawayzone + pickzone
         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            SELECT @nTTL_Qty = SUM(PD.QTY)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.Status = '0'
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND PD.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey
                           AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey)
               -- tlting03 Duplicate check
               --AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = PD.StorerKey
               --               AND OrderKey = PD.OrderKey
              --               AND ADDWHO = @cUserName AND Status = '1') -- SOS# 176144
               --AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName AND Status = '1') -- SOS# 176144

            SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE PD.LOC = @cLOC
               AND PD.SKU = @cSKU
               AND PD.Status = '0'
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               AND EXISTS (SELECT 1 FROM RDT.RDTPickLock RPL WITH (NOLOCK) WHERE RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey
                  AND RPL.Status = '1' AND RPL.AddWho = @cUserName AND RPL.StorerKey = @cStorerKey)
               AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))
         END
         ELSE
         BEGIN
            SELECT @nTTL_Qty = SUM(PD.QTY)
            FROM RDT.RDTPickLock RPL WITH (NOLOCK)
            JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
            JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
            JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
            WHERE RPL.StorerKey = @cStorerKey
               AND RPL.Status < '5'
               AND RPL.AddWho = @cUserName
               AND PD.Status = '0'
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
               AND L.Facility = @cFacility
               AND RPL.PickQty <= 0
               AND PD.SKU = @cSKU
               AND PD.LOC = @cLOC
               AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
               AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
               AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = RPL.StorerKey
                              AND OrderKey = PD.OrderKey
                              AND ADDWHO = @cUserName ) -- SOS# 176144
               --AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName) -- SOS# 176144

            SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND LOC = @cLOC
               AND SKU = @cSKU
               AND OrderKey = @cOrderKey
               AND Status = '0'
               AND Lot = @cLOT
               AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( UOM = @cPickUsingPrefUOM))
         END

         -- Get Total Orders left on the current sku that need to pick
         SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE RPL.StorerKey = @cStorerKey
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND PD.SKU = @cSKU
            AND PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

         -- (james14)
         IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
         BEGIN
            SET @cOS_Qty = ''

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND LPD.LoadKey = @cLoadKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.Status >= '3'
                  AND LPD.LoadKey = @cLoadKey

               SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
            ELSE
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND OrderKey = @cOrderKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND OrderKey = @cOrderKey
                  AND Status >= '3'

               SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
         END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE SKU.StorerKey = @cStorerKey
                  AND SKU.SKU = @cSKU

               SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cTemp_String = @cExtendedInfo2
               END
            END
         END

         -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
         BEGIN
            SET @cPackCfg = ''

            SELECT @fPack_Qty = PACK.QTY,
                   @fPack_InnerPack = PACK.InnerPack,
                   @fPack_CaseCnt = PACK.CaseCnt
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE SKU.StorerKey = @cStorerKey
               AND SKU.SKU = @cSKU

            SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                            RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                            RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
         END

         SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
         IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
            SET @cScanLOT02 = '0'

         IF @cPrefUOM <> '6'
         BEGIN
            SELECT TOP 1
               @nPrefUOM_Div = CAST( IsNULL(
                  CASE @cPrefUOM
                     WHEN '2' THEN Pack.CaseCNT
                     WHEN '3' THEN Pack.InnerPack
                     WHEN '6' THEN Pack.QTY
                     WHEN '1' THEN Pack.Pallet
                     WHEN '4' THEN Pack.OtherUnit1
                     WHEN '5' THEN Pack.OtherUnit2
                  END, 1) AS INT)
            FROM dbo.SKU SKU (NOLOCK)
               INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU

            -- Convert to prefer UOM QTY to be picked
            SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

            -- Convert to prefer UOM QTY picked
            SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

				--SOS334125 Start
            SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                      '/' +
                                      RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
				--SOS334125 End

            SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
            SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
         END

         -- Extended info
         IF @cExtendedInfoSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
            BEGIN
               SET @cExtendedInfo = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
            END
         END

         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cDropID
            SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField04 = ''
            SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
            SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                               THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

            EXEC rdt.rdtSetFocusField @nMobile, 4

            -- Go to next screen
            SET @nScn  = 1877
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cSKU
            SET @cOutField03 = ''
            SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1883
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1628  -- (james07)
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField03 = ''
            SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
            SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cLoadKey
            SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1888
            SET @nStep = 8
         END

         IF @cPrefUOM <> '6'
            SET @cOutField12 = @cPreferQty2Display
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

         SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                            THEN '' ELSE @cDefaultPickQty END -- Qty to pick
         SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
         SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                 CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                            ELSE 'QTY: ' END

         SET @cFieldAttr01 = ''
         SET @cFieldAttr02 = ''
         SET @cFieldAttr03 = ''
         SET @cFieldAttr04 = ''
         SET @cFieldAttr05 = ''
         SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
         SET @cFieldAttr07 = ''
         SET @cFieldAttr08 = ''
         SET @cFieldAttr09 = ''
         SET @cFieldAttr10 = ''
         SET @cFieldAttr11 = ''
         SET @cFieldAttr12 = ''
         SET @cFieldAttr13 = ''
         SET @cFieldAttr14 = ''
         SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END
         -- If config turned on, not allow to change Qty To Pick
         IF @cClusterPickLockQtyToPick = '1'
         BEGIN
            SET @cFieldAttr13 = 'O'
            SET @cInField13 = @cDefaultPickQty
         END

         GOTO Quit
      END

      -- Go back to Drop ID screen
      IF @cOption = '2'
      BEGIN
         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

            IF @cClusterPickNike <> ''
            BEGIN
               IF @cClusterPickNike = '1'
               BEGIN
                  SET @cTemp_String = ''
                  SET @cTemp_UOM = ''
                  SET @nTemp_PackQtyIndicator = ''

                  SELECT
                     @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                     @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE SKU.StorerKey = @cStorerKey
                     AND SKU.SKU = @cSKU

                  SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                     '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
               END
               ELSE
               BEGIN
                  IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo2 = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                     SET @cOutField08 = @cExtendedInfo2
                  END
               END
            END
            ELSE
            BEGIN
               SET @cOutField08 = @cColor_Descr
            END

            SET @cOutField09 = ''   -- DropID
            SET @cOutField10 = ''
            SET @cOutField11 = ''

            -- Go to next screen
            SET @nScn  = 1876
          SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            SET @cDropID = ''

            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = @cSKU
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID
            -- SOS172041
            IF RDT.RDTGetConfig( @nFunc, 'ClusterPickPromptNewDropID', @cStorerKey) = 1
            BEGIN
               SELECT @cDropID = DropID FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND LOC = @cLOC
                  AND OrderKey = @cOrderKey
                  AND AddWho = @cUserName

               IF ISNULL(@cDropID, '') = ''
               BEGIN
                  SET @cOutField11 = 'NEW DROP ID'
                  SET @cOutField12 = ''
               END
               ELSE
               BEGIN
                  SET @cOutField11 = @cDropID
                  SET @cOutField12 = ''
               END
            END
            ELSE
            BEGIN
               SET @cOutField11 = 'SCAN CARTON ID'
               SET @cOutField12 = 'DROP ID:'
            END

           -- Go to next screen
            SET @nScn  = 1882
            SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1628
         BEGIN
            set @cDropID = ''

            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cLoadKey
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID

            -- Go to next screen
            SET @nScn  = 1887
            SET @nStep = 7
         END

         -- (james30)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
         BEGIN
            EXECUTE rdt.rdt_Cluster_Pick_DropID
               @nMobile,
               @nFunc,
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cLoadKey,
               @cPickSlipNo,
               @cOrderKey,
               @cDropID       OUTPUT,
               @cSKU,
               'R',      -- R = Retrieve
               @cLangCode,
               @nErrNo        OUTPUT,
               @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

            IF @nFunc = 1620
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField09 = ''         -- DropID
               ELSE
                  SET @cOutField09 = @cDropID   -- DropID
            END
            ELSE
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField10 = ''         -- DropID
               ELSE
                  SET @cOutField10 = @cDropID   -- DropID
            END
         END

         -- (james42)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
         BEGIN
            IF @nFunc = 1620
            BEGIN
               SET @cOutField10 = 'CTN TYPE:'
               SET @cFieldAttr11 = ''
               SET @cOutField11 = ''
            END
            ELSE
            BEGIN
               SET @cOutField11 = 'CTN TYPE:'
               SET @cFieldAttr12 = ''
               SET @cOutField12 = ''
            END
         END
         ELSE
         BEGIN
            IF @nFunc = 1620
               SET @cFieldAttr11 = 'O'
            ELSE
               SET @cFieldAttr12 = 'O'
         END

         GOTO Quit
      END
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      IF @nFunc = 1620
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE SKU.StorerKey = @cStorerKey
                  AND SKU.SKU = @cSKU

               SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cOutField08 = @cExtendedInfo2
               END
            END
         END
         ELSE
         BEGIN
            SET @cOutField08 = @cColor_Descr
         END

         SET @cOutField09 = ''   -- DropID
         SET @cOutField10 = ''
         SET @cOutField11 = ''

         -- Go to next screen
         SET @nScn  = 1876
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cOrderKey
         SET @cOutField03 = @cExternOrderKey
         SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
         SET @cOutField05 = @cSKU
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID
         -- SOS172041
         IF RDT.RDTGetConfig( @nFunc, 'ClusterPickPromptNewDropID', @cStorerKey) = 1
         BEGIN
            SELECT @cDropID = DropID FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND LOC = @cLOC
               AND OrderKey = @cOrderKey
               AND AddWho = @cUserName

           IF ISNULL(@cDropID, '') = ''
            BEGIN
               SET @cOutField11 = 'NEW DROP ID'
               SET @cOutField12 = ''
            END
            ELSE
            BEGIN
               SET @cOutField11 = @cDropID
               SET @cOutField12 = ''
            END
         END
         ELSE
         BEGIN
            SET @cOutField11 = 'SCAN CARTON ID'
            SET @cOutField12 = 'DROP ID:'
         END

         -- Go to next screen
         SET @nScn  = 1882
         SET @nStep = 7
      END
      ELSE
      IF @nFunc = 1628
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cLoadKey
         SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField08 = @cLottable02
         SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField10 = ''   -- DropID
           -- Go to next screen
         SET @nScn  = 1887
         SET @nStep = 7
      END

      -- (james30)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
      BEGIN
         EXECUTE rdt.rdt_Cluster_Pick_DropID
            @nMobile,
            @nFunc,
            @cStorerKey,
            @cUserName,
            @cFacility,
            @cLoadKey,
            @cPickSlipNo,
            @cOrderKey,
            @cDropID       OUTPUT,
            @cSKU,
            'R',      -- R = Retrieve
            @cLangCode,
            @nErrNo        OUTPUT,
            @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

         IF @nFunc = 1620
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField09 = ''         -- DropID
            ELSE
               SET @cOutField09 = @cDropID   -- DropID
         END
         ELSE
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
               SET @cOutField10 = ''         -- DropID
            ELSE
               SET @cOutField10 = @cDropID   -- DropID
         END
      END

      -- (james42)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
      BEGIN
         IF @nFunc = 1620
         BEGIN
            SET @cOutField10 = 'CTN TYPE:'
            SET @cFieldAttr11 = ''
            SET @cOutField11 = ''
         END
         ELSE
         BEGIN
            SET @cOutField11 = 'CTN TYPE:'
            SET @cFieldAttr12 = ''
            SET @cOutField12 = ''
         END
      END
      ELSE
      BEGIN
         IF @nFunc = 1620
            SET @cFieldAttr11 = 'O'
         ELSE
            SET @cFieldAttr12 = 'O'
      END

      GOTO Quit
   END

   GOTO Quit

   Step_16_Fail:
   BEGIN
      SET @cOutField01 = ''
   END
END
GOTO Quit

/********************************************************************************
Step 17. Screen = 1891
   SKU        (field01)
   DESCR      (field01)
   ADCODE     (field01, input)
********************************************************************************/
Step_17:
BEGIN
   IF @nInputKey = 1 -- ENTER
  BEGIN
      SET @cADCode = @cInField05

      IF ISNULL(@cADCode, '') = ''
      BEGIN
         SET @nErrNo = 69342
         SET @cErrMsg = rdt.rdtgetmessage( 69342, @cLangCode, 'DSP') --'ADCode req'
         GOTO Step_17_Fail
      END

      IF EXISTS (SELECT 1 FROM dbo.SerialNo WITH (NOLOCK)
         WHERE StorerKey = @cStorerKey
            AND SerialNo = @cADCode)
      BEGIN
         SET @nErrNo = 69343
         SET @cErrMsg = rdt.rdtgetmessage( 69343, @cLangCode, 'DSP') --'ADCode exists'
         GOTO Step_17_Fail
      END

      -- Start insert ADCode
      EXECUTE dbo.nspg_GetKey
         'SerialNo',
         10 ,
         @cSerialNoKey      OUTPUT,
         @b_success         OUTPUT,
         @n_err             OUTPUT,
         @c_errmsg          OUTPUT

      IF @b_success <> 1
      BEGIN
         SET @nErrNo = 69344
         SET @cErrMsg = rdt.rdtgetmessage( 69344, @cLangCode, 'DSP') --'Upd Fail'
         GOTO Step_17_Fail
      END

      SELECT @cPickSlipNo = PickHeaderKey FROM dbo.PickHeader WITH (NOLOCK) WHERE OrderKey = @cOrderKey

      SELECT @nCartonNo = MIN(CartonNo) FROM dbo.PackDetail PD WITH (NOLOCK)
      WHERE StorerKey = @cStorerKey
         AND PickSlipNo = @cPickSlipNo
         AND SKU = @cSKU

      BEGIN TRAN   --(ang01)

      INSERT INTO dbo.SERIALNO (SerialNoKey, OrderKey, OrderLineNumber, StorerKey, SKU, SerialNo)
      VALUES (@cSerialNoKey, @cOrderKey, @nCartonNo, @cStorerKey, @cSKU, @cADCode)

      IF @@ERROR <> 0
      BEGIN
         SET @nErrNo = 69345
         SET @cErrMsg = rdt.rdtgetmessage( 69345, @cLangCode, 'DSP') --'Upd Fail'
         ROLLBACK TRAN --(ang01)
         GOTO Step_17_Fail
      END
      ELSE
      BEGIN
         COMMIT TRAN --(ang01)
      END

      SELECT @nOtherUnit2 = OtherUnit2 FROM Pack P WITH (NOLOCK)
      JOIN SKU S WITH (NOLOCK) ON (P.PackKey = S.PackKey)
      WHERE StorerKey = @cStorerKey
         AND SKU = @cSKU

      SELECT @nSum_PickQty = ISNULL(SUM(PickQty), 0) FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE StorerKey = @cStorerKey
         AND OrderKey = @cOrderKey
         AND SKU = @cSKU
         AND AddWho = @cUserName
         AND Status = '5'

      SELECT @nCount_SerialNo = Count(1) FROM dbo.SerialNo WITH (NOLOCK)
      WHERE StorerKey = @cStorerKey
         AND OrderKey = @cOrderKey
         AND SKU = @cSKU

      -- No more scanning required
      IF (@nSum_PickQty / @nOtherUnit2) <= @nCount_SerialNo
      BEGIN
         -- Get next available task
         SET @nErrNo = 0
         SET @cCurrentOrderKey = @cOrderKey -- to Store the current Orderkey
         SET @cOrderKey = ''

         -- Remember current LOC (james19)
         SET @cPrevLOC = ''
         SET @cPrevLOC = @cLOC

         SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
         IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
         BEGIN
            EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
                @n_Mobile        = @nMobile
               ,@n_Func          = @nFunc
               ,@c_SPName        = @cClusterPickGetNextTask_SP
               ,@c_Storerkey     = @cStorerKey
               ,@c_UserName      = @cUserName
               ,@c_Facility      = @cFacility
               ,@c_PutawayZone   = @cPutawayZone
               ,@c_PickZone      = @cPickZone
               ,@c_LangCode      = @cLangCode
               ,@c_oFieled01     = @c_oFieled01 OUTPUT
               ,@c_oFieled02     = @c_oFieled02 OUTPUT
               ,@c_oFieled03     = @c_oFieled03 OUTPUT
               ,@c_oFieled04     = @c_oFieled04 OUTPUT
               ,@c_oFieled05     = @c_oFieled05 OUTPUT
               ,@c_oFieled06     = @c_oFieled06 OUTPUT
               ,@c_oFieled07     = @c_oFieled07 OUTPUT
               ,@c_oFieled08     = @c_oFieled08 OUTPUT
               ,@c_oFieled09     = @c_oFieled09 OUTPUT
               ,@c_oFieled10     = @c_oFieled10 OUTPUT
               ,@c_oFieled11     = @c_oFieled11 OUTPUT
               ,@c_oFieled12     = @c_oFieled12 OUTPUT
               ,@c_oFieled13     = @c_oFieled13 OUTPUT
               ,@c_oFieled14     = @c_oFieled14 OUTPUT
               ,@c_oFieled15     = @c_oFieled15 OUTPUT
               ,@b_Success       = @b_Success   OUTPUT
               ,@n_ErrNo         = @nErrNo      OUTPUT
               ,@c_ErrMsg        = @cErrMsg     OUTPUT

            SET @cLOC            = @c_oFieled01
            SET @cOrderKey       = @c_oFieled02
            SET @cSKU            = @c_oFieled03
            SET @cSKU_Descr      = @c_oFieled04
            SET @cStyle          = @c_oFieled05
            SET @cColor          = @c_oFieled06
            SET @cSize           = @c_oFieled07
            SET @cColor_Descr    = @c_oFieled08
            SET @cLot            = @c_oFieled09
            SET @cPickSlipNo     = @c_oFieled10
            SET @cExternOrderKey = @c_oFieled11
            SET @cConsigneeKey   = @c_oFieled12
         END
         ELSE
         BEGIN
            EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cPutAwayZone,
               @cPickZone,
               @cLangCode,
               @nErrNo           OUTPUT,
               @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
               @cLOC             OUTPUT,
               @cOrderKey        OUTPUT,
               @cExternOrderKey  OUTPUT,
               @cConsigneeKey    OUTPUT,
               @cSKU             OUTPUT,
               @cSKU_Descr       OUTPUT,
               @cStyle           OUTPUT,
               @cColor           OUTPUT,
               @cSize            OUTPUT,
               @cColor_Descr     OUTPUT,
               @cLot             OUTPUT,
               @cPickSlipNo      OUTPUT,
               @nMobile,
              @nFunc

            IF @nErrNo <> 0
            BEGIN
               SET @nErrNo = 65941
               SET @cErrMsg = rdt.rdtgetmessage( 65941, @cLangCode, 'DSP') --'GetNextTaskFail'
--               ROLLBACK TRAN
               GOTO Step_17_Fail
            END
         END

         SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
         IF ISNULL( @cLocDescr, '') = ''
            SET @cLocDescr = @cLOC

         -- Get the Lottables
         SELECT
            @cLottable02 = Lottable02,
            @dLottable04 = Lottable04
         FROM dbo.LotAttribute WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND SKU = @cSKU
            AND LOT = @cLot

         -- If no more task, goto confirm picking screen
         IF ISNULL(@cOrderKey, '') = ''
         BEGIN
            SET @cPromptCloseCase = ''
            SET @cPromptCloseCase = rdt.RDTGetConfig( @nFunc, 'PromptCloseCase', @cStorerKey)

            IF LEN( RTRIM( @cPromptCloseCase)) > 1
            BEGIN
               IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cPromptCloseCase AND type = 'P')
               BEGIN
                  SET @nErrNo = 0
                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cPromptCloseCase) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                     ' @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '
                  SET @cSQLParam =
                     '@nMobile          INT,                   ' +
                     '@nFunc            INT,                   ' +
                     '@cLangCode        NVARCHAR( 3),          ' +
                     '@nStep            INT,                   ' +
                     '@nInputKey        INT,                   ' +
                     '@cStorerkey       NVARCHAR( 15),         ' +
                     '@cWaveKey         NVARCHAR( 10),         ' +
                     '@cLoadKey         NVARCHAR( 10),         ' +
                     '@cOrderKey        NVARCHAR( 10),         ' +
                     '@cLoc             NVARCHAR( 10),         ' +
                     '@cDropID          NVARCHAR( 20),         ' +
                     '@cSKU             NVARCHAR( 20),         ' +
                     '@nQty             INT,                   ' +
                     '@cPromptCloseCase NVARCHAR( 1)  OUTPUT,  ' +
                     '@nErrNo           INT           OUTPUT,  ' +
                     '@cErrMsg          NVARCHAR( 20) OUTPUT   '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                     @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT
               END
            END

            --If no more task then prompt Close Case screen (If turned on) (james03)
            IF @cPromptCloseCase = '1'
            BEGIN
               SET @cOutField01 = ''

               -- Go to Close Case screen
               SET @nScn  = 1886
               SET @nStep = 15

               GOTO Quit
            END

            SET @cOrderKey = @cCurrentOrderKey -- Assign back the OrderKey
            IF @nMultiStorer = 1
               SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

            SELECT
               @nOrderPicked = COUNT( DISTINCT OrderKey),
               @nTTL_PickedQty = SUM(PickQty)
            FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE AddWho = @cUserName
               AND Status = '5'  -- Picked
               AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
               AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))

            -- (james36)
            SET @cPickNotFinish = ''
            IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
            BEGIN
               IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                           JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                           JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                           JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                           WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                           AND   ( PD.Status = '0' OR PD.Status = '4')
                           AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                           AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                           AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                           AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                           AND   LOC.Facility = @cFacility
                           AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                                 WHERE PD.OrderKey = RPL.OrderKey
                                                 AND   PD.StorerKey = RPL.StorerKey
                                                 AND   RPL.AddWho = @cUserName
                                                 AND   RPL.Status < '9'))
               BEGIN
                  SET @cPickNotFinish = 'PICKING NOT FINISH'
               END
            END

            -- Prep next screen var
            SET @cOutField01 = @cWaveKey
            SET @cOutField02 = @cLoadKey
            SET @cOutField03 = @cPutawayZone
            SET @cOutField04 = @cPickZone
            SET @cOutField05 = @nOrderPicked
            SET @cOutField06 = @nTTL_PickedQty
            SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

            SET @nScn  = 1879
            SET @nStep = 10

            SET @nActQty = 0
            SET @nQtyToPick = 0

            SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
            SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND AddWho = @cUserName
               AND Status = '5'
            OPEN @curUpdRPL
            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            WHILE @@FETCH_STATUS <> -1
            BEGIN
               BEGIN TRAN --(ang01)
               UPDATE RDT.RDTPickLock with (ROWLOCK) SET
                  Status = '9'   -- Confirm Picked
               WHERE RowRef = @nRowRef

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65942
                  SET @cErrMsg = rdt.rdtgetmessage( 65942, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN   --(ang01)
                  GOTO Step_17_Fail
               END
               ELSE
               BEGIN
                  COMMIT TRAN --(ang01)
               END

               FETCH NEXT FROM @curUpdRPL INTO @nRowRef
            END
            CLOSE @curUpdRPL
            DEALLOCATE @curUpdRPL

            GOTO Quit
         END

         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

         IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                        WHERE StorerKey = @cStorerKey
                        AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                        AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                        AND OrderKey = @cOrderKey
                        AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                        AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                        AND Status = '1'
                        AND SKU IS NULL
                        AND AddWho = @cUserName)
         BEGIN              -- Insert next task to picklock
            BEGIN TRAN --(ang01)
            INSERT INTO RDT.RDTPickLock
            (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
            SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
            VALUES
            (@cWaveKey, @cLoadKey, @cOrderKey, '', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
            @cSKU, @cPutAwayZone, @cPickZone, '', @cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65943
               SET @cErrMsg = rdt.rdtgetmessage( 65943, @cLangCode, 'DSP') --'LockOrdersFail'
               ROLLBACK TRAN
               GOTO Step_17_Fail
            END
            ELSE
            BEGIN
               COMMIT TRAN --(ang01)
            END
         END
         ELSE
         BEGIN
            -- Get the lottables
            SELECT
               @cLottable02 = Lottable02,
               @dLottable04 = Lottable04
            FROM dbo.LotAttribute WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
            AND SKU = @cSKU
               AND LOT = @cLot

            BEGIN TRAN --(ang01)
            UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
               LOT = @cLot,
               LOC = @cLoc,
               SKU = @cSKU,
               DropID = @cDropID,
               PackKey = @cCartonType,
               Lottable02 = @cLottable02,
               Lottable04 = @dLottable04
            WHERE OrderKey = @cOrderKey
               AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND Status = '1'
               AND AddWho = @cUserName

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65929
               SET @cErrMsg = rdt.rdtgetmessage( 65929, @cLangCode, 'DSP') --'UPDPKLockFail'
               ROLLBACK TRAN  --(ang01)
               GOTO Step_17_Fail
            END
            ELSE
            BEGIN
               COMMIT TRAN --(ang01)
            END
         END

         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'
         BEGIN
            -- If change of LOC then need to go back to confirm LOC screen
            IF @cPrevLOC <> @cLOC
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = ''

               -- Go to next screen
               SET @nScn  = 1892
               SET @nStep = 19

               GOTO Quit
            END
         END

         -- If OrderKey changed
         IF @cOrderKey <> @cOutField09
         BEGIN
            -- If configkey 'AutoPromptDropID' turned on, auto go back to DropID screen
            IF @cAutoPromptDropID = '1'
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'   -- (james18)
               BEGIN
                  -- If change of LOC then need to go back to confirm LOC screen
                  IF @cPrevLOC <> @cLOC
                  BEGIN
                     SET @nActQty = 0
                     SET @nQtyToPick = 0

                     -- Prep next screen var
                     SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                     SET @cOutField02 = ''

                     -- Go to next screen
                     SET @nScn  = 1892
                     SET @nStep = 19

                     -- Commit transaction before goto DropID screen
                     COMMIT TRAN

                     GOTO Quit
                  END
               END

               IF @nMultiStorer = 1
                  SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

               IF @nFunc = 1620
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cOrderKey
                  SET @cOutField03 = @cExternOrderKey
                  SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                  SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
                  SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

                  IF @cClusterPickNike <> ''
                  BEGIN
                     IF @cClusterPickNike = '1'
                     BEGIN
                        SET @cTemp_String = ''
                        SET @cTemp_UOM = ''
                        SET @nTemp_PackQtyIndicator = ''

                        SELECT
                           @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                           @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                        FROM dbo.SKU SKU WITH (NOLOCK)
                        JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                        WHERE (( @nMultiStorer = 1 AND SKU.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND SKU.StorerKey = @cStorerKey))
                           AND SKU.SKU = @cSKU

                        SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                           '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                     END
                     ELSE
                     BEGIN
                        IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                        BEGIN
                           SET @cExtendedInfo2 = ''

                           SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                              ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                           SET @cSQLParam =
                              '@nMobile       INT, ' +
                              '@nFunc         INT, ' +
                              '@cLangCode     NVARCHAR( 3), ' +
                              '@nStep         INT, ' +
                              '@nInputKey     INT, ' +
                              '@cWaveKey      NVARCHAR( 10), ' +
                              '@cLoadKey      NVARCHAR( 10), ' +
                              '@cOrderKey     NVARCHAR( 10), ' +
                              '@cDropID       NVARCHAR( 20), ' +
                              '@cStorerKey    NVARCHAR( 15), ' +
                              '@cSKU          NVARCHAR( 20), ' +
                              '@cLOC          NVARCHAR( 10), ' +
                              '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                           EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                              @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                           SET @cOutField08 = @cExtendedInfo2
                        END
                     END
                  END
                  ELSE
                  BEGIN
                     SET @cOutField08 = @cColor_Descr
                  END

                  SET @cOutField09 = ''   -- DropID
                  SET @cOutField10 = ''
                  SET @cOutField11 = ''

                  SET @nScn  = 1876
                  SET @nStep = 7
               END
               ELSE
               IF @nFunc = 1621
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cOrderKey
                  SET @cOutField03 = @cExternOrderKey
                  SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
                  SET @cOutField05 = @cSKU
                  SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField08 = @cLottable02
                  SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField10 = ''   -- DropID

                  -- Go to next screen
                  SET @nScn  = 1882
                  SET @nStep = 7
               END
               ELSE
               IF @nFunc = 1628
               BEGIN
                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = @cLoadKey
                  SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
                  SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
                  SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
                  SET @cOutField08 = @cLottable02
                  SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
                  SET @cOutField10 = ''   -- DropID

                  -- Go to next screen
                  SET @nScn  = 1887
                  SET @nStep = 7
               END

               -- (james30)
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
               BEGIN
                  EXECUTE rdt.rdt_Cluster_Pick_DropID
                     @nMobile,
                     @nFunc,
                     @cStorerKey,
                     @cUserName,
                     @cFacility,
                     @cLoadKey,
                     @cPickSlipNo,
                     @cOrderKey,
                     @cDropID       OUTPUT,
                     @cSKU,
                     'R',      -- R = Retrieve
                     @cLangCode,
                     @nErrNo        OUTPUT,
                     @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

                  IF @nFunc = 1620
                  BEGIN
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                        SET @cOutField09 = ''         -- DropID
                     ELSE
                        SET @cOutField09 = @cDropID   -- DropID
                  END
                  ELSE
                  BEGIN
                     IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                        SET @cOutField10 = ''         -- DropID
                     ELSE
                        SET @cOutField10 = @cDropID   -- DropID
                  END
               END

               SET @nActQty = 0
               SET @nQtyToPick = 0

               -- Commit transaction before goto DropID screen
               --COMMIT TRAN

               GOTO Quit
            END
         END   -- If OrderKey changed

         SET @d_step5 = GETDATE() -- (Vicky02)
         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         WHERE PD.StorerKey = @cStorerKey
            AND PD.LOC = @cLOC
            AND PD.SKU = @cSKU
            AND PD.OrderKey = @cOrderKey
            AND PD.Status = '0'
            AND PD.LOT = @cLOT
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

         SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
         IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

         IF @cDefaultToAllocatedQty = '1'
         BEGIN
            SET @cDefaultPickQty = @nTotalPickQty
         END

         SET @nQtyToPick = 0
         SET @nActQty = 0

         -- Get the total oustanding qty for orderkey + putawayzone + pickzone
         SELECT @nTTL_Qty = SUM(QTY)
         FROM RDT.RDTPickLock RPL WITH (NOLOCK)
         JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE RPL.StorerKey = @cStorerKey
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND PD.Status = '0'
            AND LA.StorerKey = @cStorerKey    -- tlting03
            AND LA.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND EXISTS ( SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = RPL.AddWho
                        AND StorerKey = RPL.StorerKey AND OrderKey =  PD.OrderKey )       --tlting02
            --AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName) --SOS# 176144

         -- Get Total Orders left on the current sku that need to pick
         SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE RPL.StorerKey = @cStorerKey
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

         -- (james14)
         IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
         BEGIN
            SET @cOS_Qty = ''

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND LPD.LoadKey = @cLoadKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.Status >= '3'
                  AND LPD.LoadKey = @cLoadKey

               SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
            ELSE
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND OrderKey = @cOrderKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND OrderKey = @cOrderKey
                  AND Status >= '3'

               SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
         END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE SKU.StorerKey = @cStorerKey
                  AND SKU.SKU = @cSKU

               SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                  '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cTemp_String = @cExtendedInfo2
               END
            END
         END

         -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
         BEGIN
            SET @cPackCfg = ''

            SELECT @fPack_Qty = PACK.QTY,
                   @fPack_InnerPack = PACK.InnerPack,
                   @fPack_CaseCnt = PACK.CaseCnt
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE SKU.StorerKey = @cStorerKey
               AND SKU.SKU = @cSKU

            SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                            RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                            RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
         END

         SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
         IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
            SET @cScanLOT02 = '0'

         IF @cPrefUOM <> '6'
         BEGIN
            SELECT TOP 1
               @nPrefUOM_Div = CAST( IsNULL(
                  CASE @cPrefUOM
                     WHEN '2' THEN Pack.CaseCNT
                     WHEN '3' THEN Pack.InnerPack
                     WHEN '6' THEN Pack.QTY
                     WHEN '1' THEN Pack.Pallet
                     WHEN '4' THEN Pack.OtherUnit1
                     WHEN '5' THEN Pack.OtherUnit2
                  END, 1) AS INT)
            FROM dbo.SKU SKU (NOLOCK)
               INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU

            -- Convert to prefer UOM QTY to be picked
            SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

            -- Convert to prefer UOM QTY picked
            SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

				--SOS334125 Start
            SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                      '/' +
                                      RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
				--SOS334125 End

            SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
            SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
         END

         -- Extended info
         IF @cExtendedInfoSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
            BEGIN
               SET @cExtendedInfo = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
            END
         END

         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cDropID
            SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField04 = ''
            SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
            SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                               THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

            -- Go to next screen
            SET @nScn  = 1877
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cSKU
            SET @cOutField03 = ''
            SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = @nTTL_Ord

            -- Go to next screen
            SET @nScn  = 1883
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1628  -- (james07)
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField03 = ''
            SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
            SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cLoadKey
            SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField11 = @nTTL_Ord

            -- Go to next screen
            SET @nScn  = 1888
            SET @nStep = 8
         END

         IF @cPrefUOM <> '6'
            SET @cOutField12 = @cPreferQty2Display
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

         SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                            THEN '' ELSE @cDefaultPickQty END -- Qty to pick
         SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
         SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                 CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                            ELSE 'QTY: ' END

         SET @cFieldAttr01 = ''
         SET @cFieldAttr02 = ''
         SET @cFieldAttr03 = ''
         SET @cFieldAttr04 = ''
         SET @cFieldAttr05 = ''
         SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
         SET @cFieldAttr07 = ''
         SET @cFieldAttr08 = ''
         SET @cFieldAttr09 = ''
         SET @cFieldAttr10 = ''
         SET @cFieldAttr11 = ''
         SET @cFieldAttr12 = ''
         SET @cFieldAttr13 = ''
         SET @cFieldAttr14 = ''
         SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

         -- If config turned on, not allow to change Qty To Pick
         IF @cClusterPickLockQtyToPick = '1'
         BEGIN
            SET @cFieldAttr13 = 'O'
            SET @cInField13 = @cDefaultPickQty
         END
      END
      ELSE
      BEGIN
         SET @cOutField05 = ''
         SET @cOutField06 =  RTRIM(CAST(@nCount_SerialNo AS NVARCHAR( 5))) + '/' + CAST((@nSum_PickQty / @nOtherUnit2) AS NVARCHAR( 5))
      END
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      IF @nCount_SerialNo < (@nSum_PickQty / @nOtherUnit2)
      BEGIN
         -- Save current screen no
         SET @nCurScn = @nScn
         SET @nCurStep = @nStep

         SET @cOutField01 = ''

         -- Go to Close Case screen
         SET @nScn  = 2011
         SET @nStep = 18

         GOTO Quit
      END


   END
   GOTO Quit

   Step_17_Fail:
   BEGIN
      SET @cOutField05 = ''
   END
END
GOTO Quit

/********************************************************************************
Step 18. Screen = 2011
   SKU        (field01)
   DESCR      (field01)
   ADCODE     (field01, input)
********************************************************************************/
Step_18:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
         --screen mapping
      SET @cReasonCode = @cInField01

      IF ISNULL(@cReasonCode, '') = ''
      BEGIN
         SET @nErrNo = 69346
         SET @cErrMsg = rdt.rdtgetmessage( 69346, @cLangCode, 'DSP') --'BAD Reason'
         GOTO Step_18_Fail
      END

      SELECT @cModuleName = StoredProcName FROM RDT.RDTMsg WITH (NOLOCK) WHERE Message_id = @nFunc
      SET @cNotes = 'Anti-Diversion code short scan'

      EXEC rdt.rdt_STD_Reason
         @nFunc,
         @nMobile,
         @cLangCode,
         @nErrNo        OUTPUT,
         @cErrMsg       OUTPUT, -- screen limitation, 20 NVARCHAR max
         @cStorerKey,
         @cFacility,
         @cPickSlipNo,
         @cLoadKey,
         @cWaveKey,
         @cOrderKey,
         @cLOC,
         @cID,
         @cSKU,
         @cPackUOM3,
         @nShortPickedQTY,       -- In master unit
         @cLottable01,
         @cLottable02,
         @cLottable03,
         @dLottable04,
         @dLottable05,
         @cReasonCode,
         @cUserName,
         @cModuleName,
         @cNotes

      IF @nErrNo <> 0
      BEGIN
         GOTO Step_18_Fail
      END

      -- Get next available task
      SET @nErrNo = 0
      SET @cCurrentOrderKey = @cOrderKey -- to Store the current Orderkey
      SET @cOrderKey = ''

      -- Remember current LOC (james19)
      SET @cPrevLOC = ''
      SET @cPrevLOC = @cLOC

      SET @cClusterPickGetNextTask_SP = rdt.RDTGetConfig( @nFunc, 'ClusterPickGetNextTask_SP', @cStorerKey)
      IF ISNULL(@cClusterPickGetNextTask_SP, '') NOT IN ('', '0')
      BEGIN
         EXEC RDT.RDT_ClusterPickGetNextTask_Wrapper
             @n_Mobile        = @nMobile
            ,@n_Func          = @nFunc
            ,@c_SPName        = @cClusterPickGetNextTask_SP
            ,@c_Storerkey     = @cStorerKey
            ,@c_UserName      = @cUserName
            ,@c_Facility      = @cFacility
            ,@c_PutawayZone   = @cPutawayZone
            ,@c_PickZone      = @cPickZone
            ,@c_LangCode      = @cLangCode
            ,@c_oFieled01     = @c_oFieled01 OUTPUT
            ,@c_oFieled02     = @c_oFieled02 OUTPUT
            ,@c_oFieled03     = @c_oFieled03 OUTPUT
            ,@c_oFieled04     = @c_oFieled04 OUTPUT
            ,@c_oFieled05     = @c_oFieled05 OUTPUT
            ,@c_oFieled06     = @c_oFieled06 OUTPUT
            ,@c_oFieled07     = @c_oFieled07 OUTPUT
            ,@c_oFieled08     = @c_oFieled08 OUTPUT
            ,@c_oFieled09     = @c_oFieled09 OUTPUT
            ,@c_oFieled10     = @c_oFieled10 OUTPUT
            ,@c_oFieled11     = @c_oFieled11 OUTPUT
            ,@c_oFieled12     = @c_oFieled12 OUTPUT
            ,@c_oFieled13     = @c_oFieled13 OUTPUT
            ,@c_oFieled14     = @c_oFieled14 OUTPUT
            ,@c_oFieled15     = @c_oFieled15 OUTPUT
            ,@b_Success       = @b_Success   OUTPUT
            ,@n_ErrNo         = @nErrNo      OUTPUT
            ,@c_ErrMsg        = @cErrMsg     OUTPUT

         SET @cLOC            = @c_oFieled01
         SET @cOrderKey       = @c_oFieled02
         SET @cSKU            = @c_oFieled03
         SET @cSKU_Descr      = @c_oFieled04
         SET @cStyle          = @c_oFieled05
         SET @cColor          = @c_oFieled06
         SET @cSize           = @c_oFieled07
         SET @cColor_Descr    = @c_oFieled08
         SET @cLot            = @c_oFieled09
         SET @cPickSlipNo     = @c_oFieled10
         SET @cExternOrderKey = @c_oFieled11
         SET @cConsigneeKey   = @c_oFieled12
      END
      ELSE
      BEGIN
         EXECUTE rdt.rdt_Cluster_Pick_GetNextTask
            @cStorerKey,
            @cUserName,
            @cFacility,
            @cPutAwayZone,
            @cPickZone,
            @cLangCode,
            @nErrNo           OUTPUT,
            @cErrMsg          OUTPUT,  -- screen limitation, 20 NVARCHAR max
            @cLOC             OUTPUT,
            @cOrderKey        OUTPUT,
            @cExternOrderKey  OUTPUT,
            @cConsigneeKey    OUTPUT,
            @cSKU             OUTPUT,
            @cSKU_Descr       OUTPUT,
            @cStyle           OUTPUT,
            @cColor           OUTPUT,
            @cSize            OUTPUT,
            @cColor_Descr     OUTPUT,
            @cLot             OUTPUT,
            @cPickSlipNo      OUTPUT,
            @nMobile,
            @nFunc

         IF @nErrNo <> 0
         BEGIN
            SET @nErrNo = 65941
            SET @cErrMsg = rdt.rdtgetmessage( 65941, @cLangCode, 'DSP') --'GetNextTaskFail'
            ROLLBACK TRAN
            GOTO Step_18_Fail
         END
      END

      SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
      IF ISNULL( @cLocDescr, '') = ''
         SET @cLocDescr = @cLOC

      -- Get the Lottables
      SELECT
         @cLottable02 = Lottable02,
         @dLottable04 = Lottable04
      FROM dbo.LotAttribute WITH (NOLOCK)
      WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
         AND SKU = @cSKU
         AND LOT = @cLot

      -- If no more task, goto confirm picking screen
      IF ISNULL(@cOrderKey, '') = ''
      BEGIN
         SET @cPromptCloseCase = ''
         SET @cPromptCloseCase = rdt.RDTGetConfig( @nFunc, 'PromptCloseCase', @cStorerKey)

         IF LEN( RTRIM( @cPromptCloseCase)) > 1
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cPromptCloseCase AND type = 'P')
            BEGIN
               SET @nErrNo = 0
               SET @cSQL = 'EXEC rdt.' + RTRIM( @cPromptCloseCase) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
                  ' @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '
               SET @cSQLParam =
                  '@nMobile          INT,                   ' +
                  '@nFunc            INT,                   ' +
                  '@cLangCode        NVARCHAR( 3),          ' +
                  '@nStep            INT,                   ' +
                  '@nInputKey        INT,                   ' +
                  '@cStorerkey       NVARCHAR( 15),         ' +
                  '@cWaveKey         NVARCHAR( 10),         ' +
                  '@cLoadKey         NVARCHAR( 10),         ' +
                  '@cOrderKey        NVARCHAR( 10),         ' +
                  '@cLoc             NVARCHAR( 10),         ' +
                  '@cDropID          NVARCHAR( 20),         ' +
                  '@cSKU             NVARCHAR( 20),         ' +
                  '@nQty             INT,                   ' +
                  '@cPromptCloseCase NVARCHAR( 1)  OUTPUT,  ' +
                  '@nErrNo           INT           OUTPUT,  ' +
                  '@cErrMsg          NVARCHAR( 20) OUTPUT   '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
                  @cLoc, @cDropID, @cSKU, @nQty, @cPromptCloseCase OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT
            END
         END

         --If no more task then prompt Close Case screen (If turned on) (james03)
         IF @cPromptCloseCase = '1'
         BEGIN
            SET @cOutField01 = ''

            -- Go to Close Case screen
            SET @nScn  = 1886
            SET @nStep = 15

            GOTO Quit
         END

         SET @cOrderKey = @cCurrentOrderKey -- Assign back the OrderKey
         IF @nMultiStorer = 1
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

         SELECT
            @nOrderPicked = COUNT( DISTINCT OrderKey),
            @nTTL_PickedQty = SUM(PickQty)
         FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE AddWho = @cUserName
            AND Status = '5'  -- Picked
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
            AND (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))

         -- (james36)
         SET @cPickNotFinish = ''
         IF rdt.RDTGetConfig( @nFunc, 'DISPLAYPICKNOTFINISH', @cStorerKey) = 1
         BEGIN
            IF EXISTS ( SELECT 1 from dbo.PickDetail PD WITH (NOLOCK)
                        JOIN dbo.OrderDetail OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
                        JOIN dbo.Orders O WITH (NOLOCK) ON ( OD.OrderKey = O.OrderKey)
                        JOIN dbo.LOC LOC WITH (NOLOCK) ON ( PD.LOC = LOC.LOC)
                        WHERE (( @nMultiStorer = 1 AND PD.StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND PD.StorerKey = @cStorerKey))
                        AND   ( PD.Status = '0' OR PD.Status = '4')
                        AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                        AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
                        AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( LOC.PutAwayZone = @cPutAwayZone))
                        AND (( ISNULL( @cPickZone, '') = '') OR ( LOC.PickZone = @cPickZone))
                        AND   LOC.Facility = @cFacility
                        AND   PD.OrderKey IN (SELECT DISTINCT RPL.OrderKey FROM RDT.RDTPICKLOCK RPL WITH (NOLOCK)
                                              WHERE PD.OrderKey = RPL.OrderKey
                                              AND   PD.StorerKey = RPL.StorerKey
                                              AND   RPL.AddWho = @cUserName
                                              AND   RPL.Status < '9'))
            BEGIN
               SET @cPickNotFinish = 'PICKING NOT FINISH'
            END
         END

         -- Prep next screen var
         SET @cOutField01 = @cWaveKey
         SET @cOutField02 = @cLoadKey
         SET @cOutField03 = @cPutawayZone
         SET @cOutField04 = @cPickZone
         SET @cOutField05 = @nOrderPicked
         SET @cOutField06 = @nTTL_PickedQty
         SET @cOutField07 = CASE WHEN ISNULL( @cPickNotFinish, '') <> '' THEN @cPickNotFinish ELSE '' END

         SET @nScn  = 1879
         SET @nStep = 10

         SET @nActQty = 0
         SET @nQtyToPick = 0

         SET @curUpdRPL = CURSOR LOCAL FAST_FORWARD READ_ONLY FOR
         SELECT RowRef FROM RDT.RDTPickLock WITH (NOLOCK)
         WHERE StorerKey = @cStorerKey
            AND AddWho = @cUserName
            AND Status = '5'
         OPEN @curUpdRPL
         FETCH NEXT FROM @curUpdRPL INTO @nRowRef
         WHILE @@FETCH_STATUS <> -1
         BEGIN
            UPDATE RDT.RDTPickLock with (ROWLOCK) SET
               Status = '9'   -- Confirm Picked
            WHERE RowRef = @nRowRef

            IF @@ERROR <> 0
            BEGIN
               SET @nErrNo = 65942
               SET @cErrMsg = rdt.rdtgetmessage( 65942, @cLangCode, 'DSP') --'UPDPKLockFail'
               ROLLBACK TRAN
               GOTO Step_8_Fail
            END

            FETCH NEXT FROM @curUpdRPL INTO @nRowRef
         END
         CLOSE @curUpdRPL
         DEALLOCATE @curUpdRPL

         GOTO Quit
      END

      IF @nMultiStorer = 1
         SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE Orderkey = @cOrderKey

      IF NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock WITH (NOLOCK)
                     WHERE StorerKey = @cStorerKey
                        AND (( ISNULL( @cWaveKey, '') = '') OR ( WaveKey = @cWaveKey))
                        AND (( ISNULL(@cLoadKey, '') = '') OR ( LoadKey = @cLoadKey))
                        AND OrderKey = @cOrderKey
                        AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( PutAwayZone = @cPutAwayZone))
                        AND (( ISNULL( @cPickZone, '') = '') OR ( PickZone = @cPickZone))
                        AND Status = '1'
                        AND SKU IS NULL
                        AND AddWho = @cUserName)
      BEGIN
         -- Insert next task to picklock
         INSERT INTO RDT.RDTPickLock
         (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey,
         SKU, PutAwayZone, PickZone, PickDetailKey, LOT, LOC, Lottable02, Lottable04, Status, AddWho, AddDate, DropID, PickSlipNo, Mobile, PackKey)
         VALUES
         (@cWaveKey, @cLoadKey, @cOrderKey, '', CASE WHEN @nMultiStorer = 1 THEN @cORD_StorerKey ELSE @cStorerKey END,
         @cSKU, @cPutAwayZone, @cPickZone, '', @cLOT, @cLOC, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cDropID, @cPickSlipNo, @nMobile, @cCartonType)

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65943
            SET @cErrMsg = rdt.rdtgetmessage( 65943, @cLangCode, 'DSP') --'LockOrdersFail'
            ROLLBACK TRAN
            GOTO Step_18_Fail
         END
      END
      ELSE
      BEGIN
         -- Get the lottables
         SELECT
            @cLottable02 = Lottable02,
            @dLottable04 = Lottable04
         FROM dbo.LotAttribute WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND SKU = @cSKU
            AND LOT = @cLot

         UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
            LOT = @cLot,
            LOC = @cLoc,
            SKU = @cSKU,
            DropID = @cDropID,
            PackKey = @cCartonType,
            Lottable02 = @cLottable02,
            Lottable04 = @dLottable04
         WHERE OrderKey = @cOrderKey
            AND Status = '1'
            AND AddWho = @cUserName

         IF @@ERROR <> 0
         BEGIN
            SET @nErrNo = 65929
            SET @cErrMsg = rdt.rdtgetmessage( 65929, @cLangCode, 'DSP') --'UPDPKLockFail'
            ROLLBACK TRAN
            GOTO Step_18_Fail
         END
      END

      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'   -- (james18)
      BEGIN
         -- If change of LOC then need to go back to confirm LOC screen
         IF @cPrevLOC <> @cLOC
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = ''

            -- Go to next screen
            SET @nScn  = 1892
            SET @nStep = 19

            GOTO Quit
         END
      END

      -- If OrderKey changed
      IF @cOrderKey <> @cOutField09
      BEGIN
         -- If configkey 'AutoPromptDropID' turned on, auto go back to DropID screen
         IF @cAutoPromptDropID = '1'
         BEGIN
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickConfirmLOC', @cStorerKey) = '1'   -- (james18)
            BEGIN
               -- If change of LOC then need to go back to confirm LOC screen
               IF @cPrevLOC <> @cLOC
               BEGIN
                  SET @nActQty = 0
                  SET @nQtyToPick = 0

                  -- Commit transaction before goto DropID screen
                  COMMIT TRAN

                  -- Prep next screen var
                  SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
                  SET @cOutField02 = ''

                  -- Go to next screen
                  SET @nScn  = 1892
                  SET @nStep = 19

                  GOTO Quit
               END
            END

            IF @nFunc = 1620
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cOrderKey
               SET @cOutField03 = @cExternOrderKey
               SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
               SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
               SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

               IF @cClusterPickNike <> ''
               BEGIN
                  IF @cClusterPickNike = '1'
                  BEGIN
                     SET @cTemp_String = ''
                     SET @cTemp_UOM = ''
                     SET @nTemp_PackQtyIndicator = ''

                     SELECT
                        @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                        @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                     FROM dbo.SKU SKU WITH (NOLOCK)
                     JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                     WHERE SKU.StorerKey = @cStorerKey
                        AND SKU.SKU = @cSKU

                     SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                     '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
                  END
                  ELSE
                  BEGIN
                     IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                     BEGIN
                        SET @cExtendedInfo2 = ''

                        SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                           ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                        SET @cSQLParam =
                           '@nMobile       INT, ' +
                           '@nFunc         INT, ' +
                           '@cLangCode     NVARCHAR( 3), ' +
                           '@nStep         INT, ' +
                           '@nInputKey     INT, ' +
                           '@cWaveKey      NVARCHAR( 10), ' +
                           '@cLoadKey      NVARCHAR( 10), ' +
                           '@cOrderKey     NVARCHAR( 10), ' +
                           '@cDropID       NVARCHAR( 20), ' +
                           '@cStorerKey    NVARCHAR( 15), ' +
                           '@cSKU          NVARCHAR( 20), ' +
                           '@cLOC          NVARCHAR( 10), ' +
                           '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                        EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                           @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                        SET @cOutField08 = @cExtendedInfo2
                     END
                  END
               END
               ELSE
               BEGIN
                  SET @cOutField08 = @cColor_Descr
               END

               SET @cOutField09 = ''   -- DropID
               SET @cOutField10 = ''
               SET @cOutField11 = ''

               SET @nScn  = 1876
               SET @nStep = 7
            END
            ELSE
            IF @nFunc = 1621
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cOrderKey
               SET @cOutField03 = @cExternOrderKey
               SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
               SET @cOutField05 = @cSKU
               SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
               SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
               SET @cOutField08 = @cLottable02
               SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField10 = ''   -- DropID

               -- Go to next screen
               SET @nScn  = 1882
               SET @nStep = 7
            END
            ELSE
            IF @nFunc = 1628
            BEGIN
               -- Prep next screen var
               SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
               SET @cOutField02 = @cLoadKey
               SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
               SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
               SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
               SET @cOutField08 = @cLottable02
               SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
               SET @cOutField10 = ''   -- DropID

               -- Go to next screen
               SET @nScn  = 1887
               SET @nStep = 7
            END

            -- (james30)
            IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
            BEGIN
               EXECUTE rdt.rdt_Cluster_Pick_DropID
                  @nMobile,
                  @nFunc,
                  @cStorerKey,
                  @cUserName,
                  @cFacility,
                  @cLoadKey,
                  @cPickSlipNo,
                  @cOrderKey,
                  @cDropID       OUTPUT,
                  @cSKU,
                  'R',      -- R = Retrieve
                  @cLangCode,
                  @nErrNo        OUTPUT,
                  @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

               IF @nFunc = 1620
               BEGIN
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                     SET @cOutField09 = ''         -- DropID
                  ELSE
                     SET @cOutField09 = @cDropID   -- DropID
               END
               ELSE
               BEGIN
                  IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                     SET @cOutField10 = ''         -- DropID
                  ELSE
                     SET @cOutField10 = @cDropID   -- DropID
               END
            END

            SET @nActQty = 0
            SET @nQtyToPick = 0

            -- Commit transaction before goto DropID screen
            COMMIT TRAN

            GOTO Quit
         END
      END   -- If OrderKey changed

      -- Get the total allocated qty for LOC + SKU + OrderKey
      SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
      FROM dbo.PickDetail PD WITH (NOLOCK)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
      WHERE PD.StorerKey = @cStorerKey
         AND PD.LOC = @cLOC
         AND PD.SKU = @cSKU
         AND PD.OrderKey = @cOrderKey
         AND PD.Status = '0'
         AND PD.LOT = @cLOT
         AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
         AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
         AND L.Facility = @cFacility
         AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( PD.UOM = @cPickUsingPrefUOM))

      SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
      IF CAST(@cDefaultPickQty AS INT) <= 0 SET @cDefaultPickQty = ''

      IF @cDefaultToAllocatedQty = '1'
      BEGIN
         SET @cDefaultPickQty = @nTotalPickQty
      END

      SET @nQtyToPick = 0
      SET @nActQty = 0

      -- Get the total oustanding qty for orderkey + putawayzone + pickzone
      SELECT @nTTL_Qty = SUM(QTY)
      FROM RDT.RDTPickLock RPL WITH (NOLOCK)
      JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
      JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
      WHERE RPL.StorerKey = @cStorerKey
         AND RPL.Status < '5'
         AND RPL.AddWho = @cUserName
         AND RPL.PickQty <= 0
         AND PD.Status = '0'
         AND LA.StorerKey = @cStorerKey    -- tlting03
         AND LA.SKU = @cSKU
         AND PD.LOC = @cLOC
         AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
         AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
         AND L.Facility = @cFacility
         AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
         AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
         AND EXISTS ( SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = RPL.AddWho
                  AND StorerKey = RPL.StorerKey AND OrderKey =  PD.OrderKey )       -- tlting02
--         AND PD.OrderKey in (SELECT DISTINCT OrderKey FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE ADDWHO = @cUserName) -- SOS# 176144

         -- Get Total Orders left on the current sku that need to pick
      SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
      FROM dbo.PickDetail PD WITH (NOLOCK)
      JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
      JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
      WHERE RPL.StorerKey = @cStorerKey
         AND RPL.Status < '5'
         AND RPL.AddWho = @cUserName
         AND RPL.PickQty <= 0
         AND PD.SKU = @cSKU
         AND PD.LOC = @cLOC
         AND PD.Status = '0'
         AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
         AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
         AND L.Facility = @cFacility
         AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
         AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

      -- (james14)
      IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
      BEGIN
         SET @cOS_Qty = ''

         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND LPD.LoadKey = @cLoadKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND PD.Status >= '3'
               AND LPD.LoadKey = @cLoadKey

            SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
         ELSE
         BEGIN
            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND OrderKey = @cOrderKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE StorerKey = @cStorerKey
               AND OrderKey = @cOrderKey
               AND Status >= '3'

            SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST(@nTTL_UnPick_ORD AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
      END

      IF @cClusterPickNike <> ''
      BEGIN
         IF @cClusterPickNike = '1'
         BEGIN
            SET @cTemp_String = ''
            SET @cTemp_UOM = ''
            SET @nTemp_PackQtyIndicator = ''

            SELECT
               @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
               @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE SKU.StorerKey = @cStorerKey
               AND SKU.SKU = @cSKU

            SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                               '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
         END
         ELSE
         BEGIN
            IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
            BEGIN
               SET @cExtendedInfo2 = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

               SET @cTemp_String = @cExtendedInfo2
            END
         END
      END

      -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
      BEGIN
         SET @cPackCfg = ''

         SELECT @fPack_Qty = PACK.QTY,
             @fPack_InnerPack = PACK.InnerPack,
             @fPack_CaseCnt = PACK.CaseCnt
         FROM dbo.SKU SKU WITH (NOLOCK)
         JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
         WHERE SKU.StorerKey = @cStorerKey
            AND SKU.SKU = @cSKU

         SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                         RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                         RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
      END

      IF @cPrefUOM <> '6'
      BEGIN
         SELECT TOP 1
            @nPrefUOM_Div = CAST( IsNULL(
               CASE @cPrefUOM
                  WHEN '2' THEN Pack.CaseCNT
                  WHEN '3' THEN Pack.InnerPack
                  WHEN '6' THEN Pack.QTY
                  WHEN '1' THEN Pack.Pallet
                  WHEN '4' THEN Pack.OtherUnit1
                  WHEN '5' THEN Pack.OtherUnit2
               END, 1) AS INT)
         FROM dbo.SKU SKU (NOLOCK)
            INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
         WHERE StorerKey = @cStorerKey
            AND SKU = @cSKU

         -- Convert to prefer UOM QTY to be picked
         SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

         -- Convert to prefer UOM QTY picked
         SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

			--SOS334125 Start
         SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                   '/' +
                                   RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
			--SOS334125 End

         SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
         SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
      END

      -- Extended info
      IF @cExtendedInfoSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
         BEGIN
            SET @cExtendedInfo = ''

            SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

            SET @cSQLParam =
               '@nMobile       INT, ' +
               '@nFunc         INT, ' +
               '@cLangCode     NVARCHAR( 3), ' +
               '@nStep         INT, ' +
               '@nInputKey     INT, ' +
               '@cWaveKey      NVARCHAR( 10), ' +
               '@cLoadKey      NVARCHAR( 10), ' +
               '@cOrderKey     NVARCHAR( 10), ' +
               '@cDropID       NVARCHAR( 20), ' +
               '@cStorerKey    NVARCHAR( 15), ' +
               '@cSKU          NVARCHAR( 20), ' +
               '@cLOC          NVARCHAR( 10), ' +
               '@cExtendedInfo NVARCHAR( 20) OUTPUT '

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
         END
      END

      IF @nFunc = 1620
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cDropID
         SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField04 = ''
         SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
         SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                            THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cSKU
         SET @cOutField03 = ''
         SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField06 = @cLottable02
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = @nTTL_Ord
      END
      ELSE
      IF @nFunc = 1628  -- (james07)
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField03 = ''
         SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
         SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
         SET @cOutField06 = @cLottable02
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cLoadKey
         SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField11 = @nTTL_Ord
      END
      IF @cPrefUOM <> '6'
         SET @cOutField12 = @cPreferQty2Display
      ELSE
         SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

      SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                         THEN '' ELSE @cDefaultPickQty END -- Qty to pick
      SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
      SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                              CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                         ELSE 'QTY: ' END

      SET @cFieldAttr01 = ''
      SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

      -- If config turned on, not allow to change Qty To Pick
      IF @cClusterPickLockQtyToPick = '1'
      BEGIN
         SET @cFieldAttr13 = 'O'
         SET @cInField13 = @cDefaultPickQty
      END
   END

   Step_18_Fail:
END
GOTO Quit

/********************************************************************************
Step 19. Screen = 1892
   LOC      (field03, input)
********************************************************************************/
Step_19:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      -- Check if blank
      IF ISNULL(@cInField02, '') = ''
      BEGIN
         SET @nErrNo = 69362
         SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'BAD LOC'
         GOTO Step_19_Fail
      END

      -- Check the LOC scanned match with suggested LOC
      IF @cLOC <> @cInField02
      BEGIN
         IF @cClusterPickAllowSkipLoc <> '1'
         BEGIN
            SET @nErrNo = 69363
            SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'LOC NOT MATCH'
            GOTO Step_19_Fail
         END
         ELSE  -- (james67)
         BEGIN

            SET @cLoc = @cInField02

            DECLARE @cPD_Status  NVARCHAR( 10)
            SELECT @cPD_Status = MIN( PD.[Status])
            FROM dbo.PICKDETAIL PD WITH (NOLOCK)
            JOIN dbo.ORDERDETAIL OD WITH (NOLOCK) ON ( PD.OrderKey = OD.OrderKey AND PD.OrderLineNumber = OD.OrderLineNumber)
            JOIN dbo.ORDERS O WITH (NOLOCK) ON OD.OrderKey = PD.OrderKey
            WHERE PD.Loc = @cLOC
            AND   PD.Status = '0'
            AND   (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
            AND   (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
            AND   (( ISNULL(@cOrderKey, '') = '') OR ( O.OrderKey = @cOrderKey))

            -- Wrong Loc
            IF ISNULL( @cPD_Status, '') = ''
            BEGIN
               SET @nErrNo = 104002
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'Invalid LOC'
               GOTO Step_19_Fail
            END

            -- Check if loc picked
            IF @cPD_Status > '0'
            BEGIN
               SET @nErrNo = 104003
               SET @cErrMsg = rdt.rdtgetmessage( @nErrNo, @cLangCode, 'DSP') --'No PickTask'
               GOTO Step_19_Fail
            END

            -- If pick by conso then look for all orders
            -- and group by logicalloc, loc, sku, lot2, lot4
            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               DECLARE CUR_DEL CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT RowRef FROM RDT.RDTPICKLOCK WITH (NOLOCK)
               WHERE  AddWho = @cUserName
               AND    Status = '1'
               OPEN CUR_DEL
               FETCH NEXT FROM CUR_DEL INTO @nRowRef
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  DELETE FROM RDT.RDTPICKLOCK WITH (ROWLOCK) WHERE RowRef = @nRowRef
                  FETCH NEXT FROM CUR_DEL INTO @nRowRef
               END
               CLOSE CUR_DEL
               DEALLOCATE CUR_DEL

               IF rdt.RDTGetConfig( @nFunc, 'ReplaceDescrWithColorSize', @cStorerKey) = 1
               BEGIN
                  SET @cColor_Descr = SUBSTRING( @cSKU_Descr, 1, 20)
                  SET @cColor = @cColor + ' '
                  SET @cSKU_Descr = ''
               END

               SET @d_step4 = GETDATE() - @d_step4 -- (james_tune)
               SET @d_step5 = GETDATE()   -- (james_tune)

               DECLARE CUR_LOOK4CONSO_ORDERS CURSOR LOCAL READ_ONLY FAST_FORWARD FOR
               SELECT PD.ORDERKEY, PD.LOT, PD.Sku, LA.Lottable02, LA.Lottable04
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.OrderDetail OD WITH (NOLOCK) ON (PD.OrderKey = OD.OrderKey and PD.OrderLineNumber = OD.OrderLineNumber)
               JOIN dbo.Orders O WITH (NOLOCK) ON (OD.OrderKey = O.OrderKey)
               JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
               WHERE PD.StorerKey = @cStorerKey
                  AND PD.STATUS = '0'
                  AND PD.LOC = @cLOC
                  AND (( ISNULL( @cWaveKey, '') = '') OR ( O.UserDefine09 = @cWaveKey))
                  AND (( ISNULL(@cLoadKey, '') = '') OR ( O.LoadKey = @cLoadKey))
               GROUP BY PD.ORDERKEY, PD.LOT, PD.Sku, LA.Lottable02, LA.Lottable04  -- (james56)
               ORDER BY PD.ORDERKEY, PD.LOT, PD.Sku, LA.Lottable02, LA.Lottable04
               OPEN CUR_LOOK4CONSO_ORDERS
               FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT, @cSKU, @cLottable02, @dLottable04
               WHILE @@FETCH_STATUS <> -1
               BEGIN
                  BEGIN TRAN

                  -- Get the Lottables
                  SELECT
                     @cLottable02 = Lottable02,
                     @dLottable04 = Lottable04
                  FROM dbo.LotAttribute WITH (NOLOCK)
                  WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
                     AND SKU = @cSKU
                     AND LOT = @cLot

                  INSERT INTO RDT.RDTPickLock
                  (WaveKey, LoadKey, Orderkey, OrderLineNumber, StorerKey, PutAwayZone, PickZone, PickDetailKey
                  , LOT, LOC, SKU, DropID, Lottable02, Lottable04, Status, AddWho, AddDate, PickSlipNo, Mobile, PackKey)
                  VALUES
                  (ISNULL(@cWaveKey, ''), ISNULL(@cLoadKey, ''), @cConso_Orders, '', @cStorerKey, ISNULL(@cPutAwayZone, ''), ISNULL(@cPickZone, ''), @cConso_Orders,
                  @cLot, @cLoc, @cSKU, @cDropID, @cLottable02, @dLottable04, '1', @cUserName, GETDATE(), @cPickSlipNo, @nMobile, @cCartonType)

                  IF @@ERROR <> 0
                  BEGIN
                     SET @nErrNo = 65976
                     SET @cErrMsg = rdt.rdtgetmessage( 65976, @cLangCode, 'DSP') --'UPDPKLockFail'
                     ROLLBACK TRAN
                     GOTO Step_6_Fail
                  END

                  COMMIT TRAN

                  FETCH NEXT FROM CUR_LOOK4CONSO_ORDERS INTO @cConso_Orders, @cLOT, @cSKU, @cLottable02, @dLottable04
               END
               CLOSE CUR_LOOK4CONSO_ORDERS
               DEALLOCATE CUR_LOOK4CONSO_ORDERS
            END
            ELSE
            BEGIN
               SELECT TOP 1
                  @cOrderKey = PD.OrderKey,
                  @cSKU = PD.SKU,
                  @cLot = PD.LOT,
                  @cPickSlipNo = PD.PickSlipNo
               FROM RDT.RDTPickLock RPL WITH (NOLOCK)
               JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
               JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
               WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
                  AND RPL.Status < '9'
                  AND RPL.AddWho = @cUserName
                  AND PD.Status = '0'
                  AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
                  AND (( ISNULL(@cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
                  AND L.Facility = @cFacility
                  AND PD.Loc = @cLOC
                  AND NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock SKIP_RPL WITH (NOLOCK)
                                  WHERE SKIP_RPL.OrderKey = PD.OrderKey
                                  AND SKIP_RPL.StorerKey = RPL.StorerKey
                                  AND SKIP_RPL.SKU = PD.SKU
                                  AND SKIP_RPL.AddWho = @cUserName
                                  AND SKIP_RPL.Status = 'X')
                  -- Not to get the same loc within the same orders
                  AND NOT EXISTS (SELECT 1 FROM RDT.RDTPickLock SKIP_RPL2 WITH (NOLOCK)
                                  WHERE SKIP_RPL2.OrderKey = PD.OrderKey
                                  AND SKIP_RPL2.StorerKey = RPL.StorerKey  -- TLTING02
                                  AND SKIP_RPL2.AddWho <> @cUserName
                                  AND SKIP_RPL2.Status = '1'
                                  AND SKIP_RPL2.LOC = pd.LOC )  -- james02
               ORDER BY L.LogicalLocation, PD.LOC, PD.SKU, RPL.OrderKey

               -- Get the Lottables
               SELECT
                  @cLottable02 = Lottable02,
                  @dLottable04 = Lottable04
               FROM dbo.LotAttribute WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
                  AND SKU = @cSKU
                  AND LOT = @cLot

               BEGIN TRAN

               UPDATE RDT.RDTPickLock WITH (ROWLOCK) SET
                  LOT = @cLot,
                  LOC = @cLoc,
                  SKU = @cSKU,
                  DropID = @cDropID,
                  PackKey = @cCartonType,
                  Lottable02 = @cLottable02,
                  Lottable04 = @dLottable04,
                  OrderLineNumber = LEFT( OrderLineNumber + '%%', 5)  -- SOS232145
               WHERE OrderKey = @cOrderKey
                  AND Status = '1'
                  AND AddWho = @cUserName
                  AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))

               IF @@ERROR <> 0
               BEGIN
                  SET @nErrNo = 65929
                  SET @cErrMsg = rdt.rdtgetmessage( 65929, @cLangCode, 'DSP') --'UPDPKLockFail'
                  ROLLBACK TRAN
                  GOTO Step_6_Fail
               END

               COMMIT TRAN
            END

         END
      END

      SELECT @cLocDescr = SUBSTRING( Descr, 1, 20) FROM dbo.LOC WITH (NOLOCK) WHERE Facility = @cFacility AND LOC = @cLOC
      IF ISNULL( @cLocDescr, '') = ''
         SET @cLocDescr = @cLOC

      SELECT @cLottable02 = Lottable02,
             @dLottable04 = Lottable04
      FROM dbo.LotAttribute WITH (NOLOCK)
      WHERE LOT = @cLot

      EXEC [RDT].[rdt_ClusterPickSkuAttribute]
         @nMobile       = @nMobile,
         @nFunc         = @nFunc,
         @cLangCode     = @cLangCode,
         @nStep         = @nStep,
         @nInputKey     = @nInputKey,
         @cStorerKey    = @cStorerKey,
         @cSKU          = @cSKU,
         @cAltSKU       = @cAltSKU       OUTPUT,
         @cDescr        = @cSKU_Descr    OUTPUT,
         @cStyle        = @cStyle        OUTPUT,
         @cColor        = @cColor        OUTPUT,
         @cSize         = @cSize         OUTPUT,
         @cColor_Descr  = @cColor_Descr  OUTPUT,
         @cAttribute01  = @cAttribute01  OUTPUT,
         @cAttribute02  = @cAttribute02  OUTPUT,
         @cAttribute03  = @cAttribute03  OUTPUT,
         @cAttribute04  = @cAttribute04  OUTPUT,
         @cAttribute05  = @cAttribute05  OUTPUT,
         @cAttribute06  = @cAttribute06  OUTPUT,
         @cAttribute07  = @cAttribute07  OUTPUT,
         @cAttribute08  = @cAttribute08  OUTPUT,
         @cAttribute09  = @cAttribute09  OUTPUT,
         @cAttribute10  = @cAttribute10  OUTPUT,
         @nErrNo        = @nErrNo        OUTPUT,
         @cErrMsg       = @cErrMsg       OUTPUT

      IF @nErrNo <> 0
         GOTO Quit

      SET @nActQty = 0
      SET @nQtyToPick = '0'

      -- Skip Drop ID screen if it is exists (james21)
      IF rdt.RDTGetConfig( @nFunc, 'SKIPDROPIDSCNIFEXISTS', @cStorerKey) = '1' AND EXISTS
      ( SELECT 1 FROM rdt.rdtPickLock WITH (NOLOCK)
        WHERE AddWho = @cUserName
        AND   Status < '5'    -- (james22)
        AND   ISNULL(DropID, '') <> '' )
      BEGIN
         -- Get the total oustanding qty for orderkey + putawayzone + pickzone
         SELECT @nTTL_Qty = SUM(PD.QTY)
         FROM RDT.RDTPickLock RPL WITH (NOLOCK)
         JOIN dbo.PickDetail PD WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.SKU = PD.SKU AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND RPL.PickQty <= 0
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL( @cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))
            AND EXISTS (SELECT 1 FROM RDT.RDTPICKLOCK WITH (NOLOCK) WHERE storerkey = RPL.StorerKey
                           AND OrderKey = PD.OrderKey
                           AND ADDWHO = @cUserName ) -- SOS# 176144

         -- Get the total allocated qty for LOC + SKU + OrderKey
         SELECT @nTotalPickQty = ISNULL( SUM(QTY), 0)
         FROM dbo.PickDetail WITH (NOLOCK)
         WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
            AND LOC = @cLOC
            AND SKU = @cSKU
            AND OrderKey = @cOrderKey
            AND Status = '0'
            AND Lot = @cLOT
            AND (( ISNULL(@cPickUsingPrefUOM, '') = '') OR ( UOM = @cPickUsingPrefUOM))

         SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
         IF CAST(@cDefaultPickQty AS INT) <= 0
         BEGIN
            SET @cDefaultPickQty = ''

            IF @cDefaultToAllocatedQty = '1'
            BEGIN
               SET @cDefaultPickQty = @nTotalPickQty
            END

            IF @nQtyToPick > 0
            BEGIN
               IF ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                  SET @cDefaultPickQty = ''
               ELSE
                  SET @cDefaultPickQty = CAST(@cDefaultPickQty AS INT) - @nQtyToPick
            END
         END

         -- Get Total Orders left on the current sku that need to pick
         SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0)
         FROM dbo.PickDetail PD WITH (NOLOCK)
         JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
         JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
         JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
         WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
            AND RPL.Status < '5'
            AND RPL.AddWho = @cUserName
            AND RPL.PickQty <= 0
            AND PD.SKU = @cSKU
            AND PD.Status = '0'
            AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
            AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
            AND L.Facility = @cFacility
            AND PD.SKU = @cSKU
            AND PD.LOC = @cLOC
            AND (( ISNULL( @cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
            AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

         -- (james14)
         IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
         BEGIN
            SET @cOS_Qty = ''

            IF @cLoadDefaultPickMethod = 'C'
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE (( @nMultiStorer = 1) OR ( PD.StorerKey = @cStorerKey))
                  AND LPD.LoadKey = @cLoadKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
               FROM dbo.PickDetail PD WITH (NOLOCK)
               JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
               WHERE (( @nMultiStorer = 1) OR ( PD.StorerKey = @cStorerKey))
                  AND PD.Status >= '3'
                  AND LPD.LoadKey = @cLoadKey

               SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
            ELSE
            BEGIN
               -- Get the total qty picked per orders
               SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
                  AND OrderKey = @cOrderKey

               -- Get the total qty unpick per orders
               SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
               FROM dbo.PickDetail WITH (NOLOCK)
               WHERE (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
                  AND OrderKey = @cOrderKey
                  AND Status >= '3'

               SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
            END
         END

         IF @cClusterPickNike <> ''
         BEGIN
            IF @cClusterPickNike = '1'
            BEGIN
               SET @cTemp_String = ''
               SET @cTemp_UOM = ''
               SET @nTemp_PackQtyIndicator = ''

               SELECT
                  @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
                  @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
               FROM dbo.SKU SKU WITH (NOLOCK)
               JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
               WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
                  AND SKU.SKU = @cSKU

               SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                              '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
            END
            ELSE
            BEGIN
               IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
               BEGIN
                  SET @cExtendedInfo2 = ''

                  SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                     ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                  SET @cSQLParam =
                     '@nMobile       INT, ' +
                     '@nFunc         INT, ' +
                     '@cLangCode     NVARCHAR( 3), ' +
                     '@nStep         INT, ' +
                     '@nInputKey     INT, ' +
                     '@cWaveKey      NVARCHAR( 10), ' +
                     '@cLoadKey      NVARCHAR( 10), ' +
                     '@cOrderKey     NVARCHAR( 10), ' +
                     '@cDropID       NVARCHAR( 20), ' +
                     '@cStorerKey    NVARCHAR( 15), ' +
                     '@cSKU          NVARCHAR( 20), ' +
                     '@cLOC          NVARCHAR( 10), ' +
                     '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                  EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                     @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                  SET @cTemp_String = @cExtendedInfo2
               END
            END
         END

         -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
         BEGIN
            SET @cPackCfg = ''

            SELECT @fPack_Qty = PACK.QTY,
                   @fPack_InnerPack = PACK.InnerPack,
                   @fPack_CaseCnt = PACK.CaseCnt
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                            RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                            RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)		--INC0139851
         END

         SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
         IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
            SET @cScanLOT02 = '0'

         IF @cPrefUOM <> '6'
         BEGIN
            SELECT TOP 1
               @nPrefUOM_Div = CAST( IsNULL(
                  CASE @cPrefUOM
                     WHEN '2' THEN Pack.CaseCNT
                     WHEN '3' THEN Pack.InnerPack
                     WHEN '6' THEN Pack.QTY
                     WHEN '1' THEN Pack.Pallet
                     WHEN '4' THEN Pack.OtherUnit1
                     WHEN '5' THEN Pack.OtherUnit2
                  END, 1) AS INT)
            FROM dbo.SKU SKU (NOLOCK)
               INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
            WHERE StorerKey = @cStorerKey
               AND SKU = @cSKU

            -- Convert to prefer UOM QTY to be picked
            SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

            -- Convert to prefer UOM QTY picked
            SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
            SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

				--SOS334125 Start
            SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                      '/' +
                                      RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                      RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
				--SOS334125 End

            SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
            SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
         END

         -- Extended info
         IF @cExtendedInfoSP <> ''
         BEGIN
            IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
            BEGIN
               SET @cExtendedInfo = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
            END
         END

         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cDropID
            SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField04 = ''
            SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
            SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                               THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

            EXEC rdt.rdtSetFocusField @nMobile, 4

            -- Go to next screen
            SET @nScn  = 1877
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cSKU
            SET @cOutField03 = ''
            SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cOrderKey
            SET @cOutField10 = @cExternOrderKey
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1883
            SET @nStep = 8
         END
         ELSE
         IF @nFunc = 1628  -- (james07)
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField03 = ''
            SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
            SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
            SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
            SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                    THEN @cOS_Qty
                                    WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                               ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
            SET @cOutField09 = @cLoadKey
            SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
            SET @cOutField11 = @nTTL_Ord

            EXEC rdt.rdtSetFocusField @nMobile, 3

            -- Go to next screen
            SET @nScn  = 1888
            SET @nStep = 8
         END

         IF @cPrefUOM <> '6'
            SET @cOutField12 = @cPreferQty2Display
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))

         SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                            THEN '' ELSE @cDefaultPickQty END -- Qty to pick
         SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
         SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                                 CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                            ELSE 'QTY: ' END

         SET @cFieldAttr01 = ''
         SET @cFieldAttr02 = ''
         SET @cFieldAttr03 = ''
         SET @cFieldAttr04 = ''
         SET @cFieldAttr05 = ''
         SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
         SET @cFieldAttr07 = ''
         SET @cFieldAttr08 = ''
         SET @cFieldAttr09 = ''
         SET @cFieldAttr10 = ''
         SET @cFieldAttr11 = ''
         SET @cFieldAttr12 = ''
         SET @cFieldAttr13 = ''
         SET @cFieldAttr14 = ''
         SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END
      END   -- end of (james21)
      ELSE
      BEGIN
     -- Goto Drop ID screen
         IF @nFunc = 1620
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
            SET @cOutField07 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END

            IF @cClusterPickNike <> ''
            BEGIN
               IF @cClusterPickNike = '1'
               BEGIN
                  SET @cTemp_String = ''
                  SET @cTemp_UOM = ''
                  SET @nTemp_PackQtyIndicator = ''

                  SELECT
                     @cTemp_UOM = SUBSTRING(PACK.PackUOM3, 1, 2),
                     @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
                  FROM dbo.SKU SKU WITH (NOLOCK)
                  JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
                  WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
                     AND SKU.SKU = @cSKU

                  SET @cOutField08 = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                                     '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
               END
               ELSE
               BEGIN
                  IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo2 = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

                     SET @cOutField08 = @cExtendedInfo2
                  END
               END
            END
            ELSE
            BEGIN
               -- Extended info
               IF @cExtendedInfoSP <> ''
               BEGIN
                  IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
                  BEGIN
                     SET @cExtendedInfo = ''

                     SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
                        ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

                     SET @cSQLParam =
                        '@nMobile       INT, ' +
                        '@nFunc         INT, ' +
                        '@cLangCode     NVARCHAR( 3), ' +
                        '@nStep         INT, ' +
                        '@nInputKey     INT, ' +
                        '@cWaveKey      NVARCHAR( 10), ' +
                        '@cLoadKey      NVARCHAR( 10), ' +
                        '@cOrderKey     NVARCHAR( 10), ' +
                        '@cDropID       NVARCHAR( 20), ' +
                        '@cStorerKey    NVARCHAR( 15), ' +
                        '@cSKU          NVARCHAR( 20), ' +
                        '@cLOC          NVARCHAR( 10), ' +
                        '@cExtendedInfo NVARCHAR( 20) OUTPUT '

                     EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                        @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT

                     SET @cOutField08 = @cExtendedInfo
                  END
               END
               ELSE
                  SET @cOutField08 = @cColor_Descr
            END

            SET @cOutField09 = ''   -- DropID
            SET @cOutField10 = ''
            SET @cOutField11 = ''

            -- Go to next screen
            SET @nScn  = 1876
            SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1621
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cOrderKey
            SET @cOutField03 = @cExternOrderKey
            SET @cOutField04 = SUBSTRING(@cConsigneeKey, 1, 14)
            SET @cOutField05 = @cSKU
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID
            -- SOS172041
            IF RDT.RDTGetConfig( @nFunc, 'ClusterPickPromptNewDropID', @cStorerKey) = 1
            BEGIN
               SELECT @cDropID = DropID FROM RDT.RDTPickLock WITH (NOLOCK)
               WHERE StorerKey = @cStorerKey
                  AND LOC = @cLOC
                  AND OrderKey = @cOrderKey
                  AND AddWho = @cUserName

               IF ISNULL(@cDropID, '') = ''
               BEGIN
                  SET @cOutField11 = 'NEW DROP ID'
                  SET @cOutField12 = ''
               END
               ELSE
               BEGIN
                  SET @cOutField11 = @cDropID
                  SET @cOutField12 = ''
               END
            END
            ELSE
            BEGIN
               SET @cOutField11 = 'SCAN CARTON ID'
               SET @cOutField12 = 'DROP ID:'
            END

            -- Go to next screen
            SET @nScn  = 1882
            SET @nStep = 7
         END
         ELSE
         IF @nFunc = 1628
         BEGIN
            -- Prep next screen var
            SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
            SET @cOutField02 = @cLoadKey
            SET @cOutField05 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
            SET @cOutField06 = SUBSTRING(@cSKU_Descr, 1, 20)
            SET @cOutField07 = SUBSTRING(@cSKU_Descr, 21, 20)
            SET @cOutField08 = @cLottable02
            SET @cOutField09 = rdt.rdtFormatDate(@dLottable04)
            SET @cOutField10 = ''   -- DropID
            SET @cOutField11 = ''
            SET @cOutField12 = ''

            -- Go to next screen
            SET @nScn  = 1887
            SET @nStep = 7
         END

         -- (james30)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtOpenDropID', @cStorerKey) = '1'
         BEGIN
            EXECUTE rdt.rdt_Cluster_Pick_DropID
               @nMobile,
               @nFunc,
               @cStorerKey,
               @cUserName,
               @cFacility,
               @cLoadKey,
               @cPickSlipNo,
               @cOrderKey,
               @cDropID       OUTPUT,
               @cSKU,
               'R',      -- R = Retrieve
               @cLangCode,
               @nErrNo        OUTPUT,
               @cErrMsg       OUTPUT  -- screen limitation, 20 NVARCHAR max

            IF @nFunc = 1620
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField09 = ''         -- DropID
               ELSE
                  SET @cOutField09 = @cDropID   -- DropID
            END
            ELSE
            BEGIN
               IF rdt.RDTGetConfig( @nFunc, 'ClusterPickPromtBlankDropID', @cStorerKey) = '1'
                  SET @cOutField10 = ''         -- DropID
               ELSE
                  SET @cOutField10 = @cDropID   -- DropID
            END
         END

         -- (james42)
         IF rdt.RDTGetConfig( @nFunc, 'ClusterPickCaptureCtnType', @cStorerKey) NOT IN ('', '0')
         BEGIN
            IF @nFunc = 1620
            BEGIN
               SET @cOutField10 = 'CTN TYPE:'
               SET @cFieldAttr11 = ''
               SET @cOutField11 = ''
            END
            ELSE
            BEGIN
               SET @cOutField11 = 'CTN TYPE:'
               SET @cFieldAttr12 = ''
               SET @cOutField12 = ''
            END
         END
         ELSE
         BEGIN
            IF @nFunc = 1620
               SET @cFieldAttr11 = 'O'
            ELSE
               SET @cFieldAttr12 = 'O'
         END
      END
   END

   IF @nInputKey = 0 -- ESC
   BEGIN
      -- Prepare next screen variable
      SET @cOutField01 = ''

      -- Go back prev screen
      SET @nScn = 1874
      SET @nStep = 5
 END

   Step_19_Fail:
END
GOTO Quit

/********************************************************************************
Step 20. Screen = 4790
   PICKING ON HOLD      (Press F4 to unhold)
********************************************************************************/
Step_20:
BEGIN
   -- (james50)
   IF @nInputKey = @nFunctionKey -- Special event, call extended stored proc
   BEGIN
      SET @cExtendedFuncKeySP = rdt.RDTGetConfig( @nFunc, 'ExtendedFuncKeySP', @cStorerkey)
      IF @cExtendedFuncKeySP NOT IN ('0', '')
      BEGIN
         SET @cSQLStatement = 'EXEC rdt.' + RTRIM( @cExtendedFuncKeySP) +
            ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @nFunctionKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey, ' +
            ' @cPutAwayZone, @cPickZone, @cDropID, @cCartonType, @cLOC, @cSKU, @nQty,' +
            ' @nOutScn OUTPUT, @nOutStep OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT '

         SET @cSQLParms =
            '@nMobile         INT,           ' +
            '@nFunc           INT,           ' +
            '@cLangCode       NVARCHAR( 3),  ' +
            '@nStep           INT,           ' +
            '@nInputKey       INT,           ' +
            '@nFunctionKey    INT,           ' +
            '@cStorerkey      NVARCHAR( 15), ' +
            '@cWaveKey        NVARCHAR( 10), ' +
            '@cLoadKey        NVARCHAR( 10), ' +
            '@cOrderKey       NVARCHAR( 10), ' +
            '@cPutAwayZone    NVARCHAR( 10), ' +
            '@cPickZone       NVARCHAR( 10), ' +
            '@cDropID         NVARCHAR( 20), ' +
            '@cCartonType     NVARCHAR( 10), ' +
            '@cLOC            NVARCHAR( 10), ' +
            '@cSKU            NVARCHAR( 20), ' +
            '@nQty            INT,           ' +
            '@nOutScn         INT           OUTPUT,  ' +
            '@nOutStep        INT           OUTPUT,  ' +
            '@nErrNo          INT           OUTPUT,  ' +
            '@cErrMsg         NVARCHAR( 20) OUTPUT   '

         EXEC sp_ExecuteSQL @cSQLStatement, @cSQLParms,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @nFunctionKey, @cStorerkey, @cWaveKey, @cLoadKey, @cOrderKey,
               @cPutAwayZone,  @cPickZone, @cDropID, @cCartonType, @cLOC, @cSKU, @nQty,
               @nOutScn OUTPUT, @nOutStep OUTPUT, @nErrNo OUTPUT, @cErrMsg OUTPUT

         IF @nErrNo <> 0
            GOTO Step_20_Fail
      END

      SET @nScn = @nCurScn
      SET @nStep = @nCurStep

      IF @nStep = 7
      BEGIN
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
      END

      IF @nScn = 1870 AND @nStep = 1
      BEGIN
         -- EventLog - Sign In Function
         EXEC RDT.rdt_STD_EventLog
            @cActionType = '1', -- Sign in function
            @cUserID     = @cUserName,
            @nMobileNo   = @nMobile,
            @nFunctionID = @nFunc,
            @cFacility   = @cFacility,
            @cStorerKey  = @cStorerKey

         SET @cOutField01 = ''
      END
   END

   Step_20_Fail:
END

GOTO Quit

/********************************************************************************
Step 21. Screen = 3570. Multi SKU
   SKU         (Field01)
   SKUDesc1    (Field02)
   SKUDesc2    (Field03)
   SKU         (Field04)
   SKUDesc1    (Field05)
   SKUDesc2    (Field06)
   SKU         (Field07)
   SKUDesc1    (Field08)
   SKUDesc2    (Field09)
   Option      (Field10, input)
********************************************************************************/
Step_21:
BEGIN
   IF @nInputKey = 1 -- ENTER
   BEGIN
      DECLARE @cUserSelectedSKU  NVARCHAR( 20)
      EXEC rdt.rdt_MultiSKUBarcode @nMobile, @nFunc, @cLangCode,
         @cInField01 OUTPUT,  @cOutField01 OUTPUT,
         @cInField02 OUTPUT,  @cOutField02 OUTPUT,
         @cInField03 OUTPUT,  @cOutField03 OUTPUT,
         @cInField04 OUTPUT,  @cOutField04 OUTPUT,
         @cInField05 OUTPUT,  @cOutField05 OUTPUT,
         @cInField06 OUTPUT,  @cOutField06 OUTPUT,
         @cInField07 OUTPUT,  @cOutField07 OUTPUT,
         @cInField08 OUTPUT,  @cOutField08 OUTPUT,
         @cInField09 OUTPUT,  @cOutField09 OUTPUT,
         @cInField10 OUTPUT,  @cOutField10 OUTPUT,
         @cInField11 OUTPUT,  @cOutField11 OUTPUT,
         @cInField12 OUTPUT,  @cOutField12 OUTPUT,
         @cInField13 OUTPUT,  @cOutField13 OUTPUT,
         @cInField14 OUTPUT,  @cOutField14 OUTPUT,
         @cInField15 OUTPUT,  @cOutField15 OUTPUT,
         'CHECK',
         @cMultiSKUBarcode,
         @cStorerKey,
         @cUserSelectedSKU    OUTPUT,
         @nErrNo              OUTPUT,
         @cErrMsg             OUTPUT

      IF @nErrNo <> 0
      BEGIN
         IF @nErrNo = -1
            SET @nErrNo = 0
         GOTO Quit
      END

      -- Get SKU info
      SELECT @cSKU_Descr = Descr
      FROM SKU WITH (NOLOCK)
      WHERE StorerKey = @cStorerKey
         AND SKU = @cSKU
   END


      SET @cDefaultPickQty = rdt.RDTGetConfig( @nFunc, 'DefaultPickQty', @cStorerKey)
      IF CAST(@cDefaultPickQty AS INT) <= 0
      BEGIN
         SET @cDefaultPickQty = ''

         IF @cDefaultToAllocatedQty = '1'
         BEGIN
            SET @cDefaultPickQty = @nTotalPickQty
         END

         IF @nQtyToPick > 0
         BEGIN
            IF ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
               SET @cDefaultPickQty = ''
            ELSE
               SET @cDefaultPickQty = CAST(@cDefaultPickQty AS INT) - @nQtyToPick
         END
      END

      -- Get Total Orders left on the current sku that need to pick
      SELECT @nTTL_Ord = ISNULL( COUNT( DISTINCT PD.ORDERKEY), 0) -- (james59)
      FROM dbo.PickDetail PD WITH (NOLOCK)
      JOIN RDT.RDTPickLock RPL WITH (NOLOCK) ON (RPL.StorerKey = PD.StorerKey AND RPL.OrderKey = PD.OrderKey)
      JOIN dbo.LOC L WITH (NOLOCK) ON (PD.LOC = L.LOC)
      JOIN dbo.LOTAttribute LA WITH (NOLOCK) ON (PD.LOT = LA.LOT)
      WHERE (( @nMultiStorer = 1) OR ( RPL.StorerKey = @cStorerKey))
         AND RPL.Status < '5'
         AND RPL.AddWho = @cUserName
         AND RPL.PickQty <= 0
         AND PD.SKU = @cSKU
         AND PD.Status = '0'
         AND (( ISNULL( @cPutAwayZone, '') = 'ALL') OR ( L.PutAwayZone = @cPutAwayZone))
         AND (( ISNULL( @cPickZone, '') = '') OR ( L.PickZone = @cPickZone))
         AND L.Facility = @cFacility
         AND PD.SKU = @cSKU
         AND PD.LOC = @cLOC
         AND (( ISNULL(@cLottable02, '') = '') OR ( LA.Lottable02 = @cLottable02))
         AND (( ISNULL(@dLottable04, '') = '') OR ( ISNULL(LA.Lottable04, '') = @dLottable04))

      -- (james14)
      IF rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
      BEGIN
         SET @cOS_Qty = ''

         IF @cLoadDefaultPickMethod = 'C'
         BEGIN
            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND LPD.LoadKey = @cLoadKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(PD.QTY), 0)
            FROM dbo.PickDetail PD WITH (NOLOCK)
            JOIN dbo.LoadPlanDetail LPD WITH (NOLOCK) ON PD.OrderKey = LPD.OrderKey
            WHERE PD.StorerKey = @cStorerKey
               AND PD.Status >= '3'
               AND LPD.LoadKey = @cLoadKey

            SET @cOS_Qty = 'LOAD QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
         ELSE
         BEGIN
            SELECT @cORD_StorerKey = StorerKey FROM dbo.Orders WITH (NOLOCK) WHERE OrderKey = @cOrderKey

            -- Get the total qty picked per orders
            SELECT @nTTL_Pick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey

            -- Get the total qty unpick per orders
            SELECT @nTTL_UnPick_ORD = ISNULL( SUM(QTY), 0)
            FROM dbo.PickDetail WITH (NOLOCK)
            WHERE (( @nMultiStorer = 1 AND StorerKey = @cORD_StorerKey) OR ( @nMultiStorer <> 1 AND StorerKey = @cStorerKey))
               AND OrderKey = @cOrderKey
               AND Status >= '3'

            SET @cOS_Qty = 'OS QTY: ' + LTRIM(RTRIM(CAST((@nTTL_UnPick_ORD + @nQtyToPick) AS NVARCHAR(5)))) + '/' + LTRIM(RTRIM(CAST(@nTTL_Pick_ORD AS NVARCHAR(5))))
         END
      END

      IF @cClusterPickNike <> ''
      BEGIN
         IF @cClusterPickNike = '1'
         BEGIN
            SET @cTemp_String = ''
            SET @cTemp_UOM = ''
            SET @nTemp_PackQtyIndicator = ''

            SELECT
               @cTemp_UOM = SUBSTRING( PACK.PackUOM3, 1, 2),
               @nTemp_PackQtyIndicator = SUBSTRING( CAST( SKU.PackQtyIndicator AS NVARCHAR( 3)), 1, 3)
            FROM dbo.SKU SKU WITH (NOLOCK)
            JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
            WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
               AND SKU.SKU = @cSKU

            SET @cTemp_String = SUBSTRING(@cColor_Descr, 1, 2) + '  ' + SUBSTRING(ISNULL(@cLottable02, '     '), 1, 5) +
                               '  ' + SUBSTRING(@cTemp_UOM, 1, 2) + '  ' + SUBSTRING((CAST(@nTemp_PackQtyIndicator AS NVARCHAR( 3))), 1, 3)
         END
         ELSE
         BEGIN
            IF EXISTS (SELECT 1 FROM sys.sysobjects WHERE name = @cClusterPickNIKE AND type = 'P')
            BEGIN
               SET @cExtendedInfo2 = ''

               SET @cSQL = 'EXEC rdt.' + RTRIM( @cClusterPickNIKE) +
                  ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

               SET @cSQLParam =
                  '@nMobile       INT, ' +
                  '@nFunc         INT, ' +
                  '@cLangCode     NVARCHAR( 3), ' +
                  '@nStep         INT, ' +
                  '@nInputKey     INT, ' +
                  '@cWaveKey      NVARCHAR( 10), ' +
                  '@cLoadKey      NVARCHAR( 10), ' +
                  '@cOrderKey     NVARCHAR( 10), ' +
                  '@cDropID       NVARCHAR( 20), ' +
                  '@cStorerKey    NVARCHAR( 15), ' +
                  '@cSKU          NVARCHAR( 20), ' +
                  '@cLOC          NVARCHAR( 10), ' +
                  '@cExtendedInfo NVARCHAR( 20) OUTPUT '

               EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
                  @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo2 OUTPUT

               SET @cTemp_String = @cExtendedInfo2
            END
         END
      END

      -- If config turned on (svalue = '1'), check the DropID keyed in must have prefix 'ID'    (james11)
      IF rdt.RDTGetConfig( @nFunc, 'ClusterPickShowPackCfg', @cStorerKey) = '1'
      BEGIN
         SET @cPackCfg = ''

         SELECT @fPack_Qty = PACK.QTY,
                @fPack_InnerPack = PACK.InnerPack,
                @fPack_CaseCnt = PACK.CaseCnt
         FROM dbo.SKU SKU WITH (NOLOCK)
         JOIN dbo.PACK PACK WITH (NOLOCK) ON SKU.PackKey = PACK.PackKey
         WHERE (( @nMultiStorer = 1) OR ( SKU.StorerKey = @cStorerKey))
            AND SKU.SKU = @cSKU

         SET @cPackCfg = SUBSTRING( CAST(@fPack_Qty AS NVARCHAR(1)) + ':' +
                         RTRIM( CAST( @fPack_InnerPack AS NVARCHAR( 3))) + ':' +
                         RTRIM( CAST( @fPack_CaseCnt AS NVARCHAR( 5))), 1, 9)  --INC0139851
      END

      SET @cScanLOT02 = rdt.RDTGetConfig( @nFunc, 'SCANLOT02', @cStorerKey)
      IF ISNULL( @cScanLOT02, '') = '' OR @cScanLOT02 <> '1'
         SET @cScanLOT02 = '0'

      IF @cPrefUOM <> '6'
      BEGIN
         SELECT TOP 1
            @nPrefUOM_Div = CAST( IsNULL(
               CASE @cPrefUOM
                  WHEN '2' THEN Pack.CaseCNT
                  WHEN '3' THEN Pack.InnerPack
                  WHEN '6' THEN Pack.QTY
                  WHEN '1' THEN Pack.Pallet
                  WHEN '4' THEN Pack.OtherUnit1
                  WHEN '5' THEN Pack.OtherUnit2
               END, 1) AS INT)
         FROM dbo.SKU SKU (NOLOCK)
            INNER JOIN dbo.Pack Pack (NOLOCK) ON (SKU.PackKey = Pack.PackKey)
         WHERE StorerKey = @cStorerKey
            AND SKU = @cSKU

         -- Convert to prefer UOM QTY to be picked
         SET @nPrefQTY2Pick = @nQtyToPick / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTY2Pick = @nQtyToPick % @nPrefUOM_Div  -- Calc remaining QTY in master unit

         -- Convert to prefer UOM QTY picked
         SET @nPrefQTYPicked = @nTotalPickQty / @nPrefUOM_Div -- Calc QTY in Pref UOM
         SET @nMstQTYPicked = @nTotalPickQty % @nPrefUOM_Div  -- Calc remaining QTY in master unit

   --SOS334125 Start
         SET @cPreferQty2Display = RTRIM( CAST( @nPrefQTY2Pick AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTY2Pick AS NVARCHAR( 4))) +
                                   '/' +
                                   RTRIM( CAST( @nPrefQTYPicked AS NVARCHAR( 4))) + '-' +
                                   RTRIM( CAST( @nMstQTYPicked AS NVARCHAR( 4)))
   --SOS334125 End

         SET @cDefaultPrefPickQty = CAST( @cDefaultPickQty AS INT) / @nPrefUOM_Div
         SET @cDefaultPickQty = CAST( @cDefaultPickQty AS INT) % @nPrefUOM_Div
      END

      -- Extended info
      IF @cExtendedInfoSP <> ''
      BEGIN
         IF EXISTS( SELECT 1 FROM sys.sysobjects WHERE name = @cExtendedInfoSP AND type = 'P')
         BEGIN
            SET @cExtendedInfo = ''

            SET @cSQL = 'EXEC rdt.' + RTRIM( @cExtendedInfoSP) +
               ' @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT '

            SET @cSQLParam =
               '@nMobile       INT, ' +
               '@nFunc         INT, ' +
               '@cLangCode     NVARCHAR( 3), ' +
               '@nStep         INT, ' +
               '@nInputKey     INT, ' +
               '@cWaveKey      NVARCHAR( 10), ' +
               '@cLoadKey      NVARCHAR( 10), ' +
               '@cOrderKey     NVARCHAR( 10), ' +
               '@cDropID       NVARCHAR( 20), ' +
               '@cStorerKey    NVARCHAR( 15), ' +
               '@cSKU          NVARCHAR( 20), ' +
               '@cLOC          NVARCHAR( 10), ' +
               '@cExtendedInfo NVARCHAR( 20) OUTPUT '

            EXEC sp_ExecuteSQL @cSQL, @cSQLParam,
               @nMobile, @nFunc, @cLangCode, @nStep, @nInputKey, @cWaveKey, @cLoadKey, @cOrderKey, @cDropID, @cStorerKey, @cSKU, @cLOC, @cExtendedInfo OUTPUT
         END
      END

      EXEC [RDT].[rdt_ClusterPickSkuAttribute]
         @nMobile       = @nMobile,
         @nFunc         = @nFunc,
         @cLangCode     = @cLangCode,
         @nStep         = @nStep,
         @nInputKey     = @nInputKey,
         @cStorerKey    = @cStorerKey,
         @cSKU          = @cSKU,
         @cAltSKU       = @cAltSKU       OUTPUT,
         @cDescr        = @cSKU_Descr    OUTPUT,
         @cStyle        = @cStyle        OUTPUT,
         @cColor        = @cColor        OUTPUT,
         @cSize         = @cSize         OUTPUT,
         @cColor_Descr  = @cColor_Descr  OUTPUT,
         @cAttribute01  = @cAttribute01  OUTPUT,
         @cAttribute02  = @cAttribute02  OUTPUT,
         @cAttribute03  = @cAttribute03  OUTPUT,
         @cAttribute04  = @cAttribute04  OUTPUT,
         @cAttribute05  = @cAttribute05  OUTPUT,
         @cAttribute06  = @cAttribute06  OUTPUT,
         @cAttribute07  = @cAttribute07  OUTPUT,
         @cAttribute08  = @cAttribute08  OUTPUT,
         @cAttribute09  = @cAttribute09  OUTPUT,
         @cAttribute10  = @cAttribute10  OUTPUT,
         @nErrNo        = @nErrNo        OUTPUT,
         @cErrMsg       = @cErrMsg       OUTPUT

      IF @nFunc = 1620
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cDropID
         SET @cOutField03 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField04 = @cUserSelectedSKU
         SET @cOutField05 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE @cStyle END
         SET @cOutField06 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE @cColor + @cSize END
         SET @cOutField07 = CASE WHEN @cClusterPickNike NOT IN ('', '0')
                            THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = SUBSTRING(@cConsigneeKey, 1, 14)

         EXEC rdt.rdtSetFocusField @nMobile, 4

         -- Go to next screen
         SET @nScn  = 1877
         SET @nStep = 8
      END
      ELSE
      IF @nFunc = 1621
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = @cSKU
         SET @cOutField03 = @cUserSelectedSKU
         SET @cOutField04 = SUBSTRING(@cSKU_Descr, 1, 20)
         SET @cOutField05 = SUBSTRING(@cSKU_Descr, 21, 20)
         SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cOrderKey
         SET @cOutField10 = @cExternOrderKey
         SET @cOutField11 = @nTTL_Ord

         EXEC rdt.rdtSetFocusField @nMobile, 3

         -- Go to next screen
         SET @nScn  = 1883
         SET @nStep = 8
      END
      ELSE
      IF @nFunc = 1628  -- (james07)
      BEGIN
         -- Prep next screen var
         SET @cOutField01 = CASE WHEN @cLocShowDescr = '1' THEN @cLocDescr ELSE @cLOC END
         SET @cOutField02 = CASE WHEN @cAltSKU <> '' THEN @cAltSKU ELSE @cSKU END
         SET @cOutField03 = @cUserSelectedSKU
         SET @cOutField04 = CASE WHEN @cAttribute01 <> '' THEN @cAttribute01 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cStyle ELSE SUBSTRING(@cSKU_Descr, 1, 20) END END
         SET @cOutField05 = CASE WHEN @cAttribute02 <> '' THEN @cAttribute02 ELSE CASE WHEN ISNULL( @cSKU_Descr, '') = '' THEN @cColor + @cSize ELSE SUBSTRING(@cSKU_Descr, 21, 20) END END
         SET @cOutField06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE @cLottable02 END
         SET @cOutField07 = rdt.rdtFormatDate(@dLottable04)
         SET @cOutField08 = CASE WHEN rdt.RDTGetConfig( @nFunc, 'SHOWQTYPICK/UNPICK', @cStorerKey) = '1'
                                 THEN @cOS_Qty
                                 WHEN ISNULL( @cExtendedInfoSP, '') <> '' THEN @cExtendedInfo -- (james40)
                            ELSE CAST(@nTTL_Qty AS NVARCHAR( 7)) END
         SET @cOutField09 = @cLoadKey
         SET @cOutField10 = CASE WHEN @cClusterPickNike NOT IN ('', '0') THEN @cTemp_String ELSE CASE WHEN @cAttribute03 <> '' THEN @cAttribute03 ELSE @cColor_Descr END END
         SET @cOutField11 = @nTTL_Ord

         EXEC rdt.rdtSetFocusField @nMobile, 3

         -- Go to next screen
         SET @nScn  = 1888
         SET @nStep = 8
      END

      SET @nQtyToPick = 0
      SELECT @nQtyToPick = ISNULL( SUM(PickQty), 0)
      FROM RDT.RDTPickLock WITH (NOLOCK)
      WHERE ( ( @cLoadDefaultPickMethod <> 'C' AND OrderKey = @cOrderKey) OR
               ( @cLoadDefaultPickMethod = 'C' AND LoadKey = @cLoadKey))
         AND SKU = @cSKU
         AND LOC = @cLOC
         AND (( @nMultiStorer = 1) OR ( StorerKey = @cStorerKey))
         AND LOC = @cLOC
         AND Status = '1'
         AND AddWho = @cUserName

      IF @cPrefUOM <> '6'
         SET @cOutField12 = @cPreferQty2Display
      ELSE
         IF @nTotalPickQty > 0
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7))) + '/' + CAST(@nTotalPickQty AS NVARCHAR( 7))
         ELSE
            SET @cOutField12 = RTRIM(CAST(@nQtyToPick AS NVARCHAR( 7)))

  SET @cOutField13 = CASE WHEN ISNULL(@cDefaultPickQty, '') = '' OR @cDefaultPickQty = '0'
                         THEN '' ELSE @cDefaultPickQty END -- Qty to pick
      SET @cOutField14 = CASE WHEN ISNULL(@cPackCfg, '') = '' THEN '' ELSE @cPackCfg END  -- (james11)
      SET @cOutField15 = CASE WHEN @cPrefUOM <> '6' THEN
                              CASE WHEN ISNULL( @cDefaultPrefPickQty, '') = '' OR @cDefaultPrefPickQty = '0' THEN '' ELSE @cDefaultPrefPickQty END
                         ELSE 'QTY: ' END

      SET @cFieldAttr01 = ''        SET @cFieldAttr02 = ''
      SET @cFieldAttr03 = ''
      SET @cFieldAttr04 = ''
      SET @cFieldAttr05 = ''
      SET @cFieldAttr06 = CASE WHEN @cScanLOT02 = '1' THEN '' ELSE 'O' END
      SET @cFieldAttr07 = ''
      SET @cFieldAttr08 = ''
      SET @cFieldAttr09 = ''
      SET @cFieldAttr10 = ''
      SET @cFieldAttr11 = ''
      SET @cFieldAttr12 = ''
      SET @cFieldAttr13 = ''
      SET @cFieldAttr14 = ''
      SET @cFieldAttr15 = CASE WHEN @cPrefUOM <> '6' THEN '' ELSE 'O' END

      -- If config turned on, not allow to change Qty To Pick
      IF @cClusterPickLockQtyToPick = '1'
      BEGIN
         SET @cFieldAttr13 = 'O'
         SET @cInField13 = @cDefaultPickQty
      END

   -- Go to SKU QTY screen
   SET @nScn = @nCurScn
   SET @nStep = @nCurStep

END
GOTO Quit

/********************************************************************************
Quit. Update back to I/O table, ready to be pick up by JBOSS
********************************************************************************/
Quit:
BEGIN
   UPDATE rdt.RDTMOBREC WITH (ROWLOCK) SET
      EditDate = GETDATE(),
      ErrMsg = @cErrMsg,
      Func   = @nFunc,
      Step   = @nStep,
      Scn    = @nScn,

      StorerKey    = @cStorerKey,
      Facility     = @cFacility,
      -- UserName     = @cUserName,
      Printer      = @cPrinter,

      V_Integer2 = @nOrdCount,
      V_Integer3 = @nOrderCnt,
      V_Integer4 = @nTTL_Alloc_Qty,
      V_Integer5 = @nTTL_Ord,
      V_Integer6 = @nQtyToPick,
      V_Integer7 = @nTotalPickQty,
      V_Integer8 = @nTTL_Qty,
      V_Integer9 = @nMultiStorer,
      V_Integer10 = @nFunctionKey,

      V_FromScn   = @nCurScn,
      V_FromStep  = @nCurStep,

      V_PickSlipNo = @cPickSlipNo,
      V_OrderKey   = @cOrderKey,
      V_LoadKey    = @cLoadKey,
      V_LOC        = @cLOC,
      V_LOT        = @cLOT,
      V_ID         = @cID,
      V_ConsigneeKey = @cConsigneeKey,
      V_SKU        = @cSKU,
      V_SKUDescr   = @cSKU_Descr,
      V_QTY        = @nActQty,

      V_Lottable02 = @cLottable02,
      V_Lottable04 = @dLottable04,

      V_String1    = @cWaveKey,
      V_String2    = @cAltSKU,
      V_String3    = @cPutAwayZone01,
      V_String4    = @cPutAwayZone02,
      V_String5    = @cPutAwayZone03,
      V_String6    = @cPutAwayZone04,
      V_String7    = @cPutAwayZone05,
      V_String8    = @cLastOrderKey,
      V_String9    = @cAttribute01,
      V_String10   = @cPutAwayZone,
      V_String11   = @cPickZone,
      V_String12   = @cExternOrderKey,
      V_String13   = @cStyle,
      V_String14   = @cColor,
      V_String15   = @cSize,
      V_String16   = @cColor_Descr,
      V_String17   = @cDropID,
      V_String18   = @cScanLOT02,
      V_String19   = @cMultiSKUBarcode,
      V_String20   = @cDefaultPickQty,
      V_String25   = @cCurrentOrderKey,
      V_String26   = @cClusterPickAllowSkipLoc,
      V_String27   = @cClusterPickScanDropID,
      V_String28   = @cClusterPickLockQtyToPick,
      V_String29   = @cAutoPromptDropID,
      V_String30   = @cDefaultToAllocatedQty,
      V_String31   = @cClusterPickPrintLabel,
      V_String32   = @cPickUsingPrefUOM,
      V_String33   = @cNot_Check_ID_Prefix,
      V_String34   = @cDecodeDropIDSP,
      V_String35   = @cAssignPackLabelToOrdCfg,
      V_String36   = @cLoadDefaultPickMethod,  -- (james07)
      V_String38   = @cPrefUOM,                -- (james32)
      V_String39   = @cCartonType,             -- (james42)
      V_String41   = @cClusterPickNIKE,        -- (james55)
      V_String42   = @cClusterPickGenDropID,
      V_String43   = @cExtendedInfoSP,
      V_String44   = @cExtendedUpdateSP,
      V_String45   = @cExtendedValidateSP,
      V_String46   = @cAutoPromptDropIDIfIDChanged,
      V_String47   = @cLocShowDescr,
      V_String48   = @cLocDescr,
      V_String49   = @cAttribute02,
      V_String50   = @cAttribute03,
		V_String21   = @cExtendedWCSSP,

      I_Field01 = @cInField01,  O_Field01 = @cOutField01,
      I_Field02 = @cInField02,  O_Field02 = @cOutField02,
      I_Field03 = @cInField03,  O_Field03 = @cOutField03,
      I_Field04 = @cInField04,  O_Field04 = @cOutField04,
      I_Field05 = @cInField05,  O_Field05 = @cOutField05,
      I_Field06 = @cInField06,  O_Field06 = @cOutField06,
      I_Field07 = @cInField07,  O_Field07 = @cOutField07,
      I_Field08 = @cInField08,  O_Field08 = @cOutField08,
      I_Field09 = @cInField09,  O_Field09 = @cOutField09,
      I_Field10 = @cInField10,  O_Field10 = @cOutField10,
      I_Field11 = @cInField11,  O_Field11 = @cOutField11,
      I_Field12 = @cInField12,  O_Field12 = @cOutField12,
      I_Field13 = @cInField13,  O_Field13 = @cOutField13,
      I_Field14 = @cInField14,  O_Field14 = @cOutField14,
      I_Field15 = @cInField15,  O_Field15 = @cOutField15,

      FieldAttr01  = @cFieldAttr01,   FieldAttr02  = @cFieldAttr02,
      FieldAttr03  = @cFieldAttr03,   FieldAttr04  = @cFieldAttr04,
      FieldAttr05  = @cFieldAttr05,   FieldAttr06  = @cFieldAttr06,
      FieldAttr07  = @cFieldAttr07,   FieldAttr08  = @cFieldAttr08,
      FieldAttr09  = @cFieldAttr09,   FieldAttr10  = @cFieldAttr10,
      FieldAttr11  = @cFieldAttr11,   FieldAttr12  = @cFieldAttr12,
      FieldAttr13  = @cFieldAttr13,   FieldAttr14  = @cFieldAttr14,
      FieldAttr15  = @cFieldAttr15

   WHERE Mobile = @nMobile
END

GO